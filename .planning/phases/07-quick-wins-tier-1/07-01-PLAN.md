---
phase: 07-quick-wins-tier-1
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - variantcentrifuge/gene_burden.py
  - tests/unit/test_gene_burden_regression.py
  - variantcentrifuge/gene_bed.py
  - variantcentrifuge/filters.py
autonomous: true

must_haves:
  truths:
    - "Dead GT parsing loop (gene_burden.py:220-249) is removed entirely"
    - "Gene burden output is semantically identical before and after dead code removal"
    - "Temp file bed_path in gene_bed.py is cleaned up after sorting"
    - "Deprecated tempfile.mktemp in filters.py replaced with NamedTemporaryFile"
  artifacts:
    - path: "variantcentrifuge/gene_burden.py"
      provides: "Gene burden analysis without dead GT parsing loop"
      contains: "Use the existing aggregated counts"
    - path: "tests/unit/test_gene_burden_regression.py"
      provides: "Regression test proving identical output after dead code removal"
      contains: "assert_frame_equal"
    - path: "variantcentrifuge/gene_bed.py"
      provides: "BED generation with proper temp file cleanup"
      contains: "os.remove(bed_path)"
    - path: "variantcentrifuge/filters.py"
      provides: "Filter with NamedTemporaryFile instead of deprecated mktemp"
      contains: "NamedTemporaryFile"
  key_links:
    - from: "tests/unit/test_gene_burden_regression.py"
      to: "variantcentrifuge/gene_burden.py"
      via: "imports perform_gene_burden_analysis"
      pattern: "from variantcentrifuge.gene_burden import"
---

<objective>
Remove dead code from gene_burden.py and fix all temp file leaks across the codebase.

Purpose: QWIN-01 removes a GT parsing loop (lines 220-249) that wastes 20-30% of gene burden time parsing genotypes into variables that are never used. QWIN-03 fixes temp file leaks in gene_bed.py and replaces deprecated tempfile.mktemp in filters.py with context managers.
Output: Cleaner gene_burden.py with regression test, leak-free temp file handling in gene_bed.py and filters.py.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-quick-wins-tier-1/07-RESEARCH.md
@variantcentrifuge/gene_burden.py
@variantcentrifuge/gene_bed.py
@variantcentrifuge/filters.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove dead GT parsing loop with regression test</name>
  <files>variantcentrifuge/gene_burden.py, tests/unit/test_gene_burden_regression.py</files>
  <action>
  Step 1 — Create regression test FIRST (before any code changes):
  Create `tests/unit/test_gene_burden_regression.py` that:
  - Imports `perform_gene_burden_analysis` from `variantcentrifuge.gene_burden`
  - Creates a synthetic DataFrame with columns: GENE, proband_count, control_count, proband_variant_count, control_variant_count, proband_allele_count, control_allele_count, GT (with realistic "Sample1(0/1);Sample2(1/1)" format entries)
  - Uses at least 3 genes with multiple variants each
  - Calls perform_gene_burden_analysis and captures the output DataFrame
  - Stores a snapshot of expected output values (gene names, p-values, odds ratios, counts) as hardcoded expected values
  - Uses pd.testing.assert_frame_equal with check_exact=False, rtol=1e-9 for float columns
  - Mark with @pytest.mark.unit

  Run the test to confirm it passes with current code: `pytest tests/unit/test_gene_burden_regression.py -v`

  Step 2 — Verify dead code then remove:
  In `variantcentrifuge/gene_burden.py`, the loop at lines 220-249 iterates gene_df rows parsing GT values into `case_samples_with_variants` and `control_samples_with_variants`, but these variables are NEVER used after the loop. Line 251 says "Use the existing aggregated counts for now" and uses `proband_variant_count`, `proband_allele_count`, etc. from existing columns instead.

  Remove the following dead code block entirely:
  - Lines 214-249 (the `case_samples_with_variants`, `control_samples_with_variants`, `case_total_alleles`, `control_total_alleles` variable declarations AND the entire `for _, row in gene_df.iterrows():` loop)
  - Keep line 207 (`for gene, gene_df in df.groupby("GENE"):`) and lines 208-213 (p_count, c_count reads)
  - Keep line 251 onward (the actual aggregation logic using existing columns)
  - Clean removal: no comments about what was removed, git history is the record

  Step 3 — Verify regression test still passes after removal:
  Run `pytest tests/unit/test_gene_burden_regression.py -v` to confirm output is identical.
  Run `pytest -m unit -x` to confirm no other tests break.
  </action>
  <verify>
  `pytest tests/unit/test_gene_burden_regression.py -v` passes
  `pytest -m unit -x` passes (no regressions)
  `grep -n "case_samples_with_variants\|control_samples_with_variants\|case_total_alleles\|control_total_alleles" variantcentrifuge/gene_burden.py` returns empty (dead code fully removed)
  </verify>
  <done>Dead GT parsing loop removed from gene_burden.py. Regression test confirms gene burden output is semantically identical. No iterrows() call remains in the gene-level aggregation loop.</done>
</task>

<task type="auto">
  <name>Task 2: Fix temp file leaks and replace deprecated APIs</name>
  <files>variantcentrifuge/gene_bed.py, variantcentrifuge/filters.py</files>
  <action>
  Fix 1 — gene_bed.py temp file leak:
  In `variantcentrifuge/gene_bed.py`, the `bed_path` created via `tempfile.mkstemp(suffix=".bed")` on line 153 is never cleaned up. The `sorted_bed` (line 182) and `merged_bed` (lines 197/201) are properly handled, but the original `bed_path` leaks.

  Add `os.remove(bed_path)` immediately after line 182 (`os.remove(sorted_bed)`) since `bed_path` is no longer needed once sorting is complete. The cleanup section around line 181-182 should become:
  ```python
  # Clean up intermediate files
  os.remove(sorted_bed)
  os.remove(bed_path)
  ```

  Also wrap the entire temp file workflow (lines 153-204) in a try/finally block to ensure cleanup happens even on subprocess failures. The finally block should remove bed_path, sorted_bed, and merged_bed if they exist (using `os.path.exists()` checks before each `os.remove()`).

  Fix 2 — filters.py deprecated mktemp:
  In `variantcentrifuge/filters.py` line 207, replace:
  ```python
  tmp_vcf = tempfile.mktemp(suffix=".vcf")
  ```
  with:
  ```python
  tmp_fd, tmp_vcf = tempfile.mkstemp(suffix=".vcf")
  os.close(tmp_fd)
  ```

  This replaces the deprecated `mktemp` (security vulnerability — race condition between name generation and file creation) with the safe `mkstemp`. The existing cleanup on line 223-224 (`os.remove(tmp_vcf)`) already handles deletion, so wrap the usage section in try/finally to ensure cleanup on subprocess failure:
  ```python
  tmp_fd, tmp_vcf = tempfile.mkstemp(suffix=".vcf")
  os.close(tmp_fd)
  try:
      # ... existing SnpSift filter, bgzip, bcftools index logic ...
  finally:
      if os.path.exists(tmp_vcf):
          os.remove(tmp_vcf)
  ```
  Remove the standalone `os.remove(tmp_vcf)` that was inside the try block (the finally handles it).
  </action>
  <verify>
  `grep -n "mktemp\b" variantcentrifuge/filters.py` returns empty (no deprecated mktemp)
  `grep -n "os.remove(bed_path)" variantcentrifuge/gene_bed.py` returns a match (leak fixed)
  `grep -n "finally:" variantcentrifuge/gene_bed.py variantcentrifuge/filters.py` returns matches in both files
  `pytest -m unit -x` passes
  `make lint` passes
  </verify>
  <done>bed_path leak in gene_bed.py fixed with cleanup after sorting. Deprecated tempfile.mktemp in filters.py replaced with mkstemp. Both files use try/finally for exception-safe cleanup.</done>
</task>

</tasks>

<verification>
- `pytest -m unit` — all unit tests pass including new regression test
- `grep -rn "case_samples_with_variants" variantcentrifuge/` — returns nothing (dead code removed)
- `grep -rn "mktemp\b" variantcentrifuge/` — returns nothing (no deprecated API)
- `make lint && make typecheck` — no new warnings
</verification>

<success_criteria>
1. Dead GT parsing loop (lines 220-249) completely removed from gene_burden.py
2. Regression test proves gene burden output is identical
3. bed_path temp file leak in gene_bed.py fixed
4. Deprecated tempfile.mktemp in filters.py replaced with mkstemp
5. All temp file operations wrapped in try/finally for exception safety
6. All existing tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/07-quick-wins-tier-1/07-01-SUMMARY.md`
</output>
