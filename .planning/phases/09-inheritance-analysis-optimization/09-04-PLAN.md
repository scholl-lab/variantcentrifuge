---
phase: 09-inheritance-analysis-optimization
plan: 04
type: execute
wave: 4
depends_on: ["09-03"]
files_modified:
  - variantcentrifuge/inheritance/analyzer.py
  - variantcentrifuge/inheritance/parallel_analyzer.py
  - variantcentrifuge/inheritance/comp_het_vectorized.py
  - variantcentrifuge/inheritance/__init__.py
autonomous: true

must_haves:
  truths:
    - "comp_het.py (original) is deleted -- only comp_het_vectorized.py exists"
    - "All imports of comp_het functions throughout the codebase use comp_het_vectorized.py"
    - "parallel_analyzer.py uses vectorized_deduce_patterns for Pass 1 and vectorized Pass 2/3 logic"
    - "No dual code paths or feature flags remain for original vs vectorized"
    - "All tests pass after consolidation"
  artifacts:
    - path: "variantcentrifuge/inheritance/comp_het_vectorized.py"
      provides: "Sole compound het implementation"
      exports: ["analyze_gene_for_compound_het_vectorized", "create_variant_key", "encode_genotypes", "GENOTYPE_ENCODING"]
    - path: "variantcentrifuge/inheritance/parallel_analyzer.py"
      provides: "Parallel analyzer using vectorized implementations"
      contains: "vectorized_deduce_patterns"
  key_links:
    - from: "variantcentrifuge/inheritance/analyzer.py"
      to: "variantcentrifuge/inheritance/comp_het_vectorized.py"
      via: "direct import, no fallback"
      pattern: "from .comp_het_vectorized import"
    - from: "variantcentrifuge/inheritance/parallel_analyzer.py"
      to: "variantcentrifuge/inheritance/vectorized_deducer.py"
      via: "uses vectorized Pass 1"
      pattern: "from .vectorized_deducer import"
---

<objective>
Consolidate compound het implementation and update parallel_analyzer.py.

Purpose: Remove the original comp_het.py (INHER-04), eliminate dual code paths, and update parallel_analyzer.py to use all vectorized implementations. This is cleanup/consolidation work that makes the vectorized code the sole implementation.

Output: Single comp het implementation, updated parallel analyzer, no legacy code paths.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-inheritance-analysis-optimization/09-CONTEXT.md
@.planning/phases/09-inheritance-analysis-optimization/09-03-SUMMARY.md
@variantcentrifuge/inheritance/analyzer.py
@variantcentrifuge/inheritance/parallel_analyzer.py
@variantcentrifuge/inheritance/comp_het.py
@variantcentrifuge/inheritance/comp_het_vectorized.py
@variantcentrifuge/inheritance/__init__.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove comp_het.py and consolidate imports</name>
  <files>variantcentrifuge/inheritance/analyzer.py, variantcentrifuge/inheritance/comp_het_vectorized.py, variantcentrifuge/inheritance/__init__.py</files>
  <action>
**Step 1: Update analyzer.py imports and remove fallback logic.**

Current analyzer.py has:
```python
from .comp_het import analyze_gene_for_compound_het, create_variant_key
try:
    from .comp_het_vectorized import analyze_gene_for_compound_het_vectorized
    VECTORIZED_AVAILABLE = True
except ImportError:
    VECTORIZED_AVAILABLE = False
```

Replace with:
```python
from .comp_het_vectorized import (
    analyze_gene_for_compound_het_vectorized,
    create_variant_key,
    encode_genotypes,
    GENOTYPE_ENCODING,
)
```

Remove all references to:
- `VECTORIZED_AVAILABLE` flag
- `use_vectorized_comp_het` parameter (make vectorized the only path)
- `analyze_gene_for_compound_het` (the original function)
- The `implementation = "vectorized" if ...` conditional
- The `if use_vectorized_comp_het and VECTORIZED_AVAILABLE:` branches

In `analyze_inheritance()`:
- Remove `use_vectorized_comp_het` parameter (keep signature compatible by defaulting or removing)
- Always call `analyze_gene_for_compound_het_vectorized` directly in the gene loop
- Update the log message to remove "using {implementation} implementation" -- just say "Analyzing compound heterozygous patterns"

**Step 2: Ensure comp_het_vectorized.py exports create_variant_key.**

comp_het_vectorized.py already has `create_variant_key` (line 323). Verify it handles both Series and namedtuples (it should -- check the current implementation). If it only handles Series, update it to match the dual-mode version from comp_het.py:
```python
def create_variant_key(variant_row) -> str:
    if isinstance(variant_row, pd.Series):
        chrom = variant_row.get("CHROM", "chr?")
        ...
    else:
        chrom = getattr(variant_row, "CHROM", "chr?")
        ...
```

**Step 3: Remove the compatibility wrapper** in comp_het_vectorized.py.

Delete the `analyze_gene_for_compound_het` wrapper function (lines 417-448 of comp_het_vectorized.py) that falls back to the original. It's no longer needed.

**Step 4: Update __init__.py** if it exports anything from comp_het.py.

Check `variantcentrifuge/inheritance/__init__.py` and update any re-exports to point to comp_het_vectorized.py.

**Step 5: Delete comp_het.py.**

`git rm variantcentrifuge/inheritance/comp_het.py`

**Step 6: Find and fix all remaining imports of comp_het.**

Search the entire codebase for `from .comp_het import` or `from ..inheritance.comp_het import` or `import comp_het` and update them to use comp_het_vectorized.

Check files:
- tests/test_inheritance/*.py (may import comp_het directly)
- variantcentrifuge/inheritance/parallel_analyzer.py (updated in Task 2)
- Any other files referencing comp_het

For tests that import original comp_het functions, update to import from comp_het_vectorized instead. If tests specifically test the original implementation against vectorized, convert them to test vectorized only.
  </action>
  <verify>
    Run: `grep -r "from.*comp_het import" variantcentrifuge/ --include="*.py" | grep -v "comp_het_vectorized"` -- should return NO matches
    Run: `grep -r "comp_het\.py" variantcentrifuge/ --include="*.py"` -- should return NO matches
    Run: `python -c "from variantcentrifuge.inheritance.analyzer import analyze_inheritance; print('OK')"` -- imports without error
    Run: `pytest tests/test_inheritance/ -v` -- all pass
    Run: `make lint` -- clean
  </verify>
  <done>comp_het.py deleted, all imports point to comp_het_vectorized.py, no dual code paths remain</done>
</task>

<task type="auto">
  <name>Task 2: Update parallel_analyzer.py to use vectorized implementations</name>
  <files>variantcentrifuge/inheritance/parallel_analyzer.py</files>
  <action>
Update `parallel_analyzer.py` to use ALL vectorized implementations:

**1. Update imports:**
```python
# Remove:
from .comp_het import analyze_gene_for_compound_het, create_variant_key
from .deducer import deduce_patterns_for_variant
try:
    from .comp_het_vectorized import analyze_gene_for_compound_het_vectorized
    VECTORIZED_AVAILABLE = True
except ImportError:
    VECTORIZED_AVAILABLE = False

# Replace with:
from .comp_het_vectorized import (
    analyze_gene_for_compound_het_vectorized,
    create_variant_key,
)
from .vectorized_deducer import vectorized_deduce_patterns
```

**2. Update Pass 1 in analyze_inheritance_parallel():**
Replace:
```python
df["_inheritance_patterns"] = df.apply(
    lambda row: deduce_patterns_for_variant(row.to_dict(), pedigree_data, sample_list), axis=1
)
```
With:
```python
df["_inheritance_patterns"] = vectorized_deduce_patterns(df, pedigree_data, sample_list)
```

**3. Update Pass 2 gene processing:**
- Remove `use_vectorized` parameter from `_process_gene_group`
- Remove `VECTORIZED_AVAILABLE` checks
- Always call `analyze_gene_for_compound_het_vectorized` directly
- Remove `use_vectorized_comp_het` parameter from `analyze_inheritance_parallel()` (or keep for backward compat but ignore it)

**4. Update Pass 2 application** (apply comp het results):
Apply the same vectorized approach from Plan 03 Task 1 -- vectorized variant key creation + batch lookup.

**5. Update Pass 3** (prioritization):
Apply the same optimization from Plan 03 Task 2 -- pre-extract data, bulk assignment.

**6. Remove all VECTORIZED_AVAILABLE checks and fallback code paths.**

**7. Run full test suite and golden file validation.**
  </action>
  <verify>
    Run: `python scripts/validate_inheritance.py compare` -- exit code 0
    Run: `pytest tests/test_inheritance/ -v` -- all pass
    Run: `pytest -m unit` -- no regressions
    Run: `grep "VECTORIZED_AVAILABLE" variantcentrifuge/inheritance/parallel_analyzer.py` -- no matches
    Run: `grep "deduce_patterns_for_variant" variantcentrifuge/inheritance/parallel_analyzer.py` -- no matches
    Run: `make lint && make typecheck` -- clean
  </verify>
  <done>parallel_analyzer.py uses vectorized Pass 1, vectorized comp het, optimized Pass 2/3, no fallback code paths</done>
</task>

</tasks>

<verification>
1. `git status` confirms comp_het.py is deleted
2. `grep -r "comp_het\.py\|VECTORIZED_AVAILABLE\|analyze_gene_for_compound_het[^_]" variantcentrifuge/ --include="*.py"` -- no matches
3. `python scripts/validate_inheritance.py compare` -- exit code 0
4. `pytest tests/test_inheritance/ -v` -- all pass
5. `pytest -m unit` -- no regressions
6. `make lint && make typecheck` -- clean
</verification>

<success_criteria>
- comp_het.py deleted (original implementation removed)
- comp_het_vectorized.py is the sole compound het implementation
- parallel_analyzer.py uses vectorized_deduce_patterns and vectorized comp het
- No VECTORIZED_AVAILABLE flags, no dual code paths, no feature flags
- All golden file scenarios pass
- All existing tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/09-inheritance-analysis-optimization/09-04-SUMMARY.md`
</output>
