---
phase: 27-association-performance-optimizations
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - variantcentrifuge/association/base.py
  - variantcentrifuge/cli.py
  - variantcentrifuge/stages/analysis_stages.py
  - tests/unit/test_association_workers_config.py
autonomous: true

must_haves:
  truths:
    - "User can pass --association-workers N to set parallel worker count"
    - "association_workers field exists in AssociationConfig with default 1"
    - "Stage config builder reads association_workers from context.config"
    - "--association-workers -1 is accepted (means os.cpu_count())"
  artifacts:
    - path: "variantcentrifuge/association/base.py"
      provides: "AssociationConfig.association_workers field"
      contains: "association_workers"
    - path: "variantcentrifuge/cli.py"
      provides: "--association-workers CLI argument"
      contains: "association-workers"
    - path: "variantcentrifuge/stages/analysis_stages.py"
      provides: "association_workers read in _build_assoc_config_from_context"
      contains: "association_workers"
    - path: "tests/unit/test_association_workers_config.py"
      provides: "Tests for config plumbing"
      contains: "test_association_workers"
  key_links:
    - from: "variantcentrifuge/cli.py"
      to: "variantcentrifuge/stages/analysis_stages.py"
      via: "cfg['association_workers'] flows through context.config"
      pattern: "association_workers"
    - from: "variantcentrifuge/stages/analysis_stages.py"
      to: "variantcentrifuge/association/base.py"
      via: "_build_assoc_config_from_context populates AssociationConfig.association_workers"
      pattern: "association_workers"
---

<objective>
Add the --association-workers CLI argument and AssociationConfig.association_workers field,
wiring the value through the stage config builder. This is pure plumbing -- no parallelization
logic yet (that is Plan 03).

Purpose: Provides the configuration interface that Plan 03's ProcessPoolExecutor logic will
read from. Separating plumbing from parallelization keeps each plan focused.

Output: Modified base.py, cli.py, analysis_stages.py with association_workers support,
plus a unit test validating the config flow.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/27-association-performance-optimizations/27-RESEARCH.md

@variantcentrifuge/association/base.py
@variantcentrifuge/cli.py
@variantcentrifuge/stages/analysis_stages.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add association_workers to config, CLI, and stage builder</name>
  <files>
    variantcentrifuge/association/base.py
    variantcentrifuge/cli.py
    variantcentrifuge/stages/analysis_stages.py
  </files>
  <action>
  1. In `base.py`, add a new field to `AssociationConfig` after the `coast_backend` field
     (around line 174):
     ```python
     # Phase 27: Gene-level parallelization
     association_workers: int = 1
     """Number of parallel worker processes for gene-level association analysis.
     Default: 1 (sequential). Set > 1 for parallel execution via ProcessPoolExecutor.
     Set -1 for os.cpu_count(). Only effective when all registered tests have parallel_safe=True."""
     ```

  2. In `cli.py`, add the `--association-workers` argument to the stats_group section.
     Place it after the `--coast-weights` argument (around line 511, after the coast-weights
     block ends). Follow the exact pattern of existing association arguments:
     ```python
     stats_group.add_argument(
         "--association-workers",
         type=int,
         default=1,
         help=(
             "Number of parallel worker processes for association analysis. "
             "Default: 1 (sequential). Set to -1 for auto (os.cpu_count()). "
             "Only effective with Python backends (R backend is not parallel-safe)."
         ),
     )
     ```

  3. In `cli.py`, add the cfg assignment in the config assignment block (around line 1205,
     after the coast_weights assignment):
     ```python
     cfg["association_workers"] = getattr(args, "association_workers", 1)
     ```

  4. In `analysis_stages.py`, add `association_workers` to the `_build_assoc_config_from_context`
     return statement. Add it after `coast_weights` (around line 2290):
     ```python
     association_workers=_get("association_workers", default=1, nullable=False),
     ```

  Ensure the field name is consistent everywhere: `association_workers` (underscore, not hyphen)
  in Python code, `--association-workers` (hyphen) in CLI.
  </action>
  <verify>
  Run: `pytest -m unit --timeout=120 -x -q` to confirm no regressions.
  Run: `make lint` to confirm no linting errors.
  </verify>
  <done>
  AssociationConfig has `association_workers: int = 1` field. CLI accepts `--association-workers`.
  Stage config builder reads `association_workers` from context.config. All existing tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Unit test for association_workers config flow</name>
  <files>tests/unit/test_association_workers_config.py</files>
  <action>
  Create `tests/unit/test_association_workers_config.py` with these tests:

  1. `test_association_config_default_workers`: Create `AssociationConfig()` with no args,
     assert `config.association_workers == 1`.

  2. `test_association_config_custom_workers`: Create `AssociationConfig(association_workers=4)`,
     assert `config.association_workers == 4`.

  3. `test_association_config_auto_workers`: Create `AssociationConfig(association_workers=-1)`,
     assert `config.association_workers == -1` (resolution to cpu_count happens in engine).

  4. `test_build_assoc_config_reads_workers`: Test that `_build_assoc_config_from_context`
     correctly reads `association_workers` from a mock PipelineContext. Create a minimal mock
     context with `context.config = {"association_workers": 4}` and verify the returned
     AssociationConfig has `association_workers == 4`. Import `_build_assoc_config_from_context`
     from `variantcentrifuge.stages.analysis_stages`.

  Mark all tests with `@pytest.mark.unit`.
  </action>
  <verify>
  Run: `pytest tests/unit/test_association_workers_config.py -v -x`
  All 4 tests pass.
  </verify>
  <done>
  Unit tests confirm: default is 1, custom values are preserved, stage builder reads
  association_workers correctly from context.config. All tests pass.
  </done>
</task>

</tasks>

<verification>
1. `pytest tests/unit/test_association_workers_config.py -v` -- new config tests pass
2. `pytest -m unit --timeout=120` -- full unit suite passes
3. `make lint` -- no linting errors
</verification>

<success_criteria>
1. `AssociationConfig(association_workers=4).association_workers == 4`
2. CLI `--association-workers 4` is accepted and flows to cfg["association_workers"]
3. `_build_assoc_config_from_context` reads association_workers from context.config
4. All existing tests pass without regression
</success_criteria>

<output>
After completion, create `.planning/phases/27-association-performance-optimizations/27-02-SUMMARY.md`
</output>
