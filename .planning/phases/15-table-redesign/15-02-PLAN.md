---
phase: 15-table-redesign
plan: 02
type: execute
wave: 2
depends_on: ["15-01"]
files_modified:
  - variantcentrifuge/templates/index.html
autonomous: true

must_haves:
  truths:
    - "Hovering over a truncated cell shows a Tippy.js tooltip with full content"
    - "GENE column stays visible (sticky) when scrolling horizontally"
    - "Clicking a chevron expands an inline detail panel with grouped variant fields"
    - "Density toggle button cycles between Compact/Regular/Relaxed and persists to localStorage"
    - "CHROM/POS have fixed widths, HGVS has end truncation with monospace, numeric scores are right-aligned"
    - "Variant IDs use middle truncation"
    - "Record count shows prominently as 'Showing X of Y variants'"
  artifacts:
    - path: "variantcentrifuge/templates/index.html"
      provides: "Complete Phase 15 JS behavior"
      contains: "formatChildRow"
  key_links:
    - from: "variantcentrifuge/templates/index.html"
      to: "DataTables FixedColumns"
      via: "fixedColumns config option"
      pattern: "fixedColumns.*left.*1"
    - from: "variantcentrifuge/templates/index.html"
      to: "DataTables child row API"
      via: "row.child() in click handler"
      pattern: "row\\.child\\("
    - from: "variantcentrifuge/templates/index.html"
      to: "localStorage"
      via: "density persistence"
      pattern: "localStorage.*variantTableDensity"
---

<objective>
Wire up all Phase 15 JavaScript behavior: control column with expandable row details, FixedColumns sticky GENE column, intelligent column widths with type-specific render functions, density toggle with localStorage persistence, and enhanced tooltip configuration.

Purpose: Make the table fully interactive with all TABLE-01 through TABLE-10 requirements functional.
Output: Complete working template with all Phase 15 features.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-table-redesign/15-RESEARCH.md
@.planning/phases/15-table-redesign/15-CONTEXT.md
@.planning/phases/15-table-redesign/15-01-SUMMARY.md
@variantcentrifuge/templates/index.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add control column, column intelligence, and FixedColumns config</name>
  <files>variantcentrifuge/templates/index.html</files>
  <action>
Modify the JavaScript section of `variantcentrifuge/templates/index.html`. All changes are within the `<script>` block containing `DOMContentLoaded`.

**CRITICAL: Control column shifts all indices by +1.** The control column (chevron for expandable details) becomes column 0, pushing all data columns right by 1. All `targets: index` references in the existing `columnData.forEach` loop must use `index + 1` instead of `index`.

**1. Before the `columnData.forEach` loop, add the control column definition:**

```javascript
// TABLE-03: Add control column (chevron) as first column
// This shifts ALL data column indices by +1
dtColumnDefs.unshift({
    targets: 0,
    className: 'dt-control',
    orderable: false,
    searchable: false,
    data: null,
    defaultContent: '<span class="chevron">&#x203A;</span>',
    width: '30px'
});
```

**2. Update the hidden columns targets to account for +1 shift:**

Change the hidden columns push from `hiddenColumnIndices.push(index)` to `hiddenColumnIndices.push(index + 1)` (since data columns now start at index 1).

**3. Inside the `columnData.forEach` loop, change ALL `targets: index` to `targets: index + 1`.**

This affects existing badge render functions (IMPACT, ClinVar, Inheritance_Pattern).

**4. Add column intelligence rules inside the `columnData.forEach` loop (after existing badge renderers):**

```javascript
// TABLE-06: Fixed width for CHROM
if (col.original_name === 'CHROM') {
    dtColumnDefs.push({
        targets: index + 1,
        width: '70px',
        className: 'monospace'
    });
}

// TABLE-06: Fixed width for POS, right-aligned
if (col.original_name === 'POS') {
    dtColumnDefs.push({
        targets: index + 1,
        width: '90px',
        className: 'monospace dt-right'
    });
}

// TABLE-06: Grow for GENE (no fixed width)
if (col.original_name === 'GENE') {
    dtColumnDefs.push({
        targets: index + 1,
        className: 'gene-column'
    });
}

// TABLE-08: Monospace for REF/ALT
if (col.original_name === 'REF' || col.original_name === 'ALT') {
    dtColumnDefs.push({
        targets: index + 1,
        className: 'monospace'
    });
}

// TABLE-08: End truncation for HGVS with monospace
if (col.original_name === 'HGVS_C' || col.original_name === 'HGVS_P') {
    dtColumnDefs.push({
        targets: index + 1,
        width: '180px',
        className: 'monospace',
        render: function(data, type, row) {
            if (type === 'display' && data) {
                var str = String(data);
                if (str.length > 30) {
                    var truncated = str.substring(0, 30) + '...';
                    return '<span class="truncated-cell" data-tippy-content="' +
                        str.replace(/"/g, '&quot;') + '">' + truncated + '</span>';
                }
            }
            return data;
        }
    });
}

// TABLE-08: Middle truncation for variant IDs
if (col.original_name === 'VAR_ID') {
    dtColumnDefs.push({
        targets: index + 1,
        width: '120px',
        render: function(data, type, row) {
            if (type === 'display' && data) {
                var str = String(data);
                if (str.length > 18) {
                    var start = str.substring(0, 10);
                    var end = str.substring(str.length - 6);
                    return '<span class="truncated-cell middle-truncate" data-tippy-content="' +
                        str.replace(/"/g, '&quot;') + '">' + start + '...' + end + '</span>';
                }
            }
            return data;
        }
    });
}

// TABLE-06: Right-align numeric score columns
// Match columns with score/phred/AF patterns (but not link columns or text columns)
if (col.original_name.match(/(_score|_phred|_AF|_freq|_frequency|CADD|REVEL|SpliceAI)/) &&
    !col.original_name.match(/(link|url|http)/i)) {
    dtColumnDefs.push({
        targets: index + 1,
        className: 'dt-right',
        render: function(data, type, row) {
            if (type === 'display' && data !== null && data !== '' && !isNaN(data)) {
                return parseFloat(data).toFixed(3);
            }
            return data;
        }
    });
}
```

**5. Add density state variables BEFORE DataTable init (after dtColumnDefs setup):**

```javascript
// TABLE-07: Density mode management
var densityModes = ['compact', 'regular', 'relaxed'];
var savedDensity = localStorage.getItem('variantTableDensity') || 'compact';
var currentDensityIndex = densityModes.indexOf(savedDensity);
if (currentDensityIndex === -1) { currentDensityIndex = 0; savedDensity = 'compact'; }

// Apply density class before DataTable init
var tableElement = document.getElementById('variants_table');
if (tableElement) {
    tableElement.classList.add('density-' + savedDensity);
}
```

**6. Update the DataTable initialization to include FixedColumns and density button:**

Replace the existing `new DataTable(...)` call with:

```javascript
var table = new DataTable('#variants_table', {
    autoWidth: false,
    pageLength: 25,
    scrollX: true,
    fixedColumns: {
        left: 1  // TABLE-02: Freeze first column (control/chevron, GENE is 2nd but FixedColumns freezes leftmost)
    },
    layout: {
        topStart: {
            pageLength: {
                menu: [10, 25, 50, 100, -1]
            }
        },
        topEnd: {
            search: true,
            buttons: [
                {
                    text: 'Density: ' + savedDensity.charAt(0).toUpperCase() + savedDensity.slice(1),
                    action: function(e, dt, node, config) {
                        var tableNode = dt.table().node();
                        tableNode.classList.remove('density-' + densityModes[currentDensityIndex]);
                        currentDensityIndex = (currentDensityIndex + 1) % densityModes.length;
                        var newDensity = densityModes[currentDensityIndex];
                        tableNode.classList.add('density-' + newDensity);
                        localStorage.setItem('variantTableDensity', newDensity);
                        node.text('Density: ' + newDensity.charAt(0).toUpperCase() + newDensity.slice(1));
                        dt.columns.adjust().draw(false);
                    }
                },
                {
                    extend: 'colvis',
                    text: 'Show/Hide Columns'
                }
            ]
        }
    },
    columnDefs: dtColumnDefs,
    initComplete: function() {
        if (skeleton) { skeleton.style.display = 'none'; }
        this.api().columns.adjust();
    },
    drawCallback: function(settings) {
        initTippyTooltips();
    }
});
```

**IMPORTANT about FixedColumns `left: 1`:** This freezes the first visible column. Since we added the control column (chevron) as column 0, the frozen column will be the chevron column. If we want GENE frozen instead, we need `left: 2`. However, the research recommends `left: 1` for the control column behavior. Consider `left: 2` to freeze both chevron AND GENE. Decision: Use `left: 2` to freeze both the chevron control column and the GENE column -- this is the UX intent (GENE stays visible during scroll).

Update to: `fixedColumns: { left: 2 }`

**7. Add the formatChildRow function (BEFORE the DataTable init, after density setup):**

```javascript
// TABLE-03: Format function for expandable row details
function formatChildRow(rowData, columns) {
    // Build field-to-value map using column data
    var fields = {};
    columns.forEach(function(col, i) {
        // rowData is an array; column 0 is control column (null), data starts at index 1
        var value = rowData[i + 1];
        if (value !== null && value !== undefined && String(value).trim() !== '') {
            fields[col.original_name] = String(value);
        }
    });

    // Define field categories
    var categories = {
        'Identifiers': ['CHROM', 'POS', 'REF', 'ALT', 'ID', 'VAR_ID', 'GENE', 'FEATUREID'],
        'Annotations': ['EFFECT', 'IMPACT', 'HGVS_C', 'HGVS_P', 'BIOTYPE', 'RANK', 'ERRORS'],
        'Scores': [],
        'Links': []
    };

    // Auto-categorize remaining fields
    var categorized = {};
    Object.keys(categories).forEach(function(cat) {
        categories[cat].forEach(function(f) { categorized[f] = true; });
    });

    columns.forEach(function(col) {
        var name = col.original_name;
        if (categorized[name]) return;
        if (!fields[name]) return;

        // Detect links (columns with URL values or link-related names)
        if (fields[name] && (fields[name].indexOf('http') === 0 || name.match(/(ClinVar|gnomAD|Varsome|Franklin|SpliceAI_link|autopvs1)/i))) {
            categories['Links'].push(name);
        }
        // Detect scores
        else if (name.match(/(_score|_phred|_AF|_freq|_frequency|CADD|REVEL|GERP|phyloP|SpliceAI|candidate_score|inheritance_score)/i)) {
            categories['Scores'].push(name);
        }
        // Everything else goes to Annotations
        else {
            categories['Annotations'].push(name);
        }
    });

    var html = '<div class="detail-panel">';

    Object.keys(categories).forEach(function(catName) {
        var catFields = categories[catName];
        // Filter to fields that have values
        var fieldsWithValues = catFields.filter(function(f) { return fields[f]; });
        if (fieldsWithValues.length === 0) return;

        html += '<div class="detail-section">';
        html += '<h4>' + catName + '</h4>';
        html += '<dl>';

        fieldsWithValues.forEach(function(fieldName) {
            var value = fields[fieldName];
            var displayName = fieldName.replace(/_/g, ' ');
            html += '<dt>' + displayName + '</dt>';

            // Render links as clickable
            if (value && value.indexOf('http') === 0) {
                html += '<dd><a href="' + value + '" target="_blank" rel="noopener">' + displayName + ' &#x2197;</a></dd>';
            } else {
                html += '<dd>' + value + '</dd>';
            }
        });

        html += '</dl></div>';
    });

    html += '</div>';
    return html;
}
```

**8. Add the child row click handler (AFTER DataTable init, before initTippyTooltips function):**

```javascript
// TABLE-03: Toggle child row on chevron click
table.on('click', 'tbody td.dt-control', function(e) {
    var tr = e.target.closest('tr');
    var row = table.row(tr);

    if (row.child.isShown()) {
        row.child.hide();
        tr.classList.remove('shown');
    } else {
        row.child(formatChildRow(row.data(), columnData)).show();
        tr.classList.add('shown');
    }
});
```

**9. Update initTippyTooltips for TABLE-01 requirements:**

Update the existing `initTippyTooltips` function:

```javascript
function initTippyTooltips() {
    var truncatedCells = document.querySelectorAll('.truncated-cell[data-tippy-content]');
    truncatedCells.forEach(function(cell) {
        if (!cell._tippy) {
            tippy(cell, {
                theme: 'variantcentrifuge',
                placement: 'top',
                allowHTML: false,
                maxWidth: 300,
                interactive: false,
                delay: [0, 0],
                trigger: 'mouseenter focus',
                touch: ['hold', 500],
                appendTo: document.body,
                onShow: function(instance) {
                    // Format content with line breaks at separators
                    var content = instance.props.content;
                    if (content) {
                        content = String(content)
                            .replace(/;/g, ';\n')
                            .replace(/\|/g, '|\n');
                        instance.setContent(content);
                    }
                }
            });
        }
    });
}
```

Note: Removed the `onShow` truncation check since these cells already have `data-tippy-content` only when truncated (set by render functions). Added `trigger: 'mouseenter focus'` for keyboard accessibility, `touch: ['hold', 500]` for mobile, `delay: [0, 0]` for immediate show, and content formatting with line breaks at semicolons/pipes.

**10. Also need to add a `<th>` for the control column in the HTML table header.**

In the Jinja2 `<thead>` section, add an empty `<th></th>` as the FIRST column header before the loop that generates data column headers. Similarly, in the `<tbody>` row loop, add an empty `<td></td>` as the first cell. Look for the `{% for col in column_data %}` loop in `<thead>` and `<tbody>`.

Search for `<thead>` and `<tbody>` in the template to find the exact location. The control column needs an empty header and an empty cell in each row because DataTables `columnDefs` with `data: null` and `defaultContent` will fill it with the chevron, but the HTML table structure must have the matching column count.

**Important edge case:** The `row.data()` call returns data as an array. The control column is index 0 (null), so real data starts at index 1. The `formatChildRow` function accounts for this with `rowData[i + 1]`.

**Do NOT remove the old yellow hover-expand if it still exists** -- it was already replaced with Tippy.js in Phase 13. Just verify there is no yellow background hover CSS remaining.
  </action>
  <verify>
    - `grep -c "dt-control" variantcentrifuge/templates/index.html` returns > 0 (control column)
    - `grep -c "formatChildRow" variantcentrifuge/templates/index.html` returns > 0 (child row formatter)
    - `grep -c "fixedColumns" variantcentrifuge/templates/index.html` returns > 0 (FixedColumns config)
    - `grep -c "variantTableDensity" variantcentrifuge/templates/index.html` returns > 0 (density persistence)
    - `grep -c "index + 1" variantcentrifuge/templates/index.html` returns > 0 (column index shift)
    - `grep -c "monospace" variantcentrifuge/templates/index.html` returns > 0 (monospace class)
    - `grep -c "dt-right" variantcentrifuge/templates/index.html` returns > 0 (right-align class)
    - `grep -c "middle-truncate" variantcentrifuge/templates/index.html` returns > 0 (middle truncation)
    - `grep -c "mouseenter focus" variantcentrifuge/templates/index.html` returns > 0 (keyboard tooltip)
    - `make lint` passes
    - `pytest tests/unit/test_html_report.py tests/unit/test_html_report_assets.py -x -q` passes (existing tests still work)
  </verify>
  <done>
    All Phase 15 JS behavior is wired: control column with +1 index shift, FixedColumns with left:2, expandable child rows with grouped detail panel, density toggle with localStorage, intelligent column widths (CHROM/POS fixed, HGVS end-truncated monospace, VAR_ID middle-truncated, scores right-aligned), enhanced Tippy tooltips with keyboard/touch/immediate trigger.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete Phase 15 table redesign: dark header, zebra striping, sticky columns, expandable row details, density toggle, intelligent column widths, enhanced tooltips</what-built>
  <how-to-verify>
    Generate a test report and open it in a browser. If you have a recent HTML report, open that instead.

    1. **Header (TABLE-05):** Verify table header has dark slate background with white text and blue bottom border
    2. **Zebra (TABLE-04):** Verify alternating row backgrounds (light gray / white)
    3. **Tooltips (TABLE-01):** Hover over a truncated cell (HGVS or long text) -- tooltip should appear immediately with full content. Press Tab to focus a truncated cell -- tooltip should also appear. Press Escape to dismiss.
    4. **Sticky column (TABLE-02):** Scroll horizontally -- GENE column and chevron should stay fixed on the left with a subtle shadow separator
    5. **Expandable rows (TABLE-03):** Click the chevron (>) on any row -- detail panel should slide down showing fields grouped in cards (Identifiers, Annotations, Scores, Links). Click again to collapse.
    6. **Density (TABLE-07):** Click the "Density: Compact" button -- should cycle to Regular (more padding), then Relaxed, then back to Compact. Reload page -- density should persist.
    7. **Column widths (TABLE-06):** CHROM/POS should be narrow fixed width. GENE should grow. HGVS should show truncated monospace text. Numeric scores should be right-aligned.
    8. **Middle truncation (TABLE-08):** Long variant IDs should show start...end format
    9. **Record count (TABLE-09):** "Showing X to Y of Z entries" should be visually prominent (larger, bold text)
    10. **Page length (TABLE-10):** Should default to 25 rows per page (already set, just verify)
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues to fix</resume-signal>
</task>

</tasks>

<verification>
- All 10 TABLE requirements (TABLE-01 through TABLE-10) are addressed
- Control column index shift (+1) applied consistently to all columnDefs
- FixedColumns freezes both chevron and GENE columns (left: 2)
- Density persists via localStorage with proper initialization
- Existing Phase 14 badge rendering preserved (IMPACT, ClinVar, Inheritance_Pattern)
- Existing Phase 13 functionality preserved (DataTables, tooltips, charts)
- Existing tests still pass
</verification>

<success_criteria>
1. Truncated cells show Tippy tooltips on hover AND keyboard focus (TABLE-01)
2. GENE column stays visible during horizontal scroll (TABLE-02)
3. Chevron click expands grouped detail panel (TABLE-03)
4. Zebra striping alternates row backgrounds (TABLE-04)
5. Dark header with white text and blue border (TABLE-05)
6. Column widths match data types (TABLE-06)
7. Density toggle cycles and persists (TABLE-07)
8. Middle truncation for variant IDs, end for HGVS, monospace for genomic notation (TABLE-08)
9. Record count displayed prominently (TABLE-09)
10. Default page length is 25 (TABLE-10)
</success_criteria>

<output>
After completion, create `.planning/phases/15-table-redesign/15-02-SUMMARY.md`
</output>
