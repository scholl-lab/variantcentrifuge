---
phase: 19-covariate-system-burden-tests
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - variantcentrifuge/association/base.py
  - variantcentrifuge/association/covariates.py
  - variantcentrifuge/association/genotype_matrix.py
  - variantcentrifuge/association/weights.py
autonomous: true

must_haves:
  truths:
    - "Covariate file with rows in different order than VCF produces identical aligned matrix as a file in VCF order"
    - "Categorical covariates are one-hot encoded with one level dropped"
    - "High multicollinearity triggers a logged WARNING but does not abort"
    - "VCF samples missing from covariate file raises ValueError before any stats run"
    - "Genotype string 1/2 parses to dosage 1, ./. parses to None, 0|1 parses to 1"
    - "Missing genotypes are imputed to 2*MAF (mean) for continuous, round(2*MAF) for binary"
    - "Beta(MAF;1,25) weights up-weight rare variants relative to common"
    - "Uniform weights produce all-ones vector"
  artifacts:
    - path: "variantcentrifuge/association/covariates.py"
      provides: "load_covariates() with sample alignment, one-hot, multicollinearity check"
      exports: ["load_covariates"]
    - path: "variantcentrifuge/association/genotype_matrix.py"
      provides: "parse_gt_to_dosage(), build_genotype_matrix() with imputation"
      exports: ["parse_gt_to_dosage", "build_genotype_matrix"]
    - path: "variantcentrifuge/association/weights.py"
      provides: "beta_maf_weights(), uniform_weights()"
      exports: ["beta_maf_weights", "uniform_weights"]
    - path: "variantcentrifuge/association/base.py"
      provides: "Extended AssociationConfig with covariate/trait/weight fields"
      contains: "trait_type"
  key_links:
    - from: "variantcentrifuge/association/covariates.py"
      to: "pandas reindex"
      via: "df.reindex(vcf_samples) + NaN assertion"
      pattern: "reindex.*vcf_samples"
    - from: "variantcentrifuge/association/genotype_matrix.py"
      to: "variantcentrifuge/association/weights.py"
      via: "MAFs output feeds into weight computation"
      pattern: "variant_mafs"
    - from: "variantcentrifuge/association/base.py"
      to: "variantcentrifuge/association/covariates.py"
      via: "AssociationConfig.covariate_file drives covariate loading"
      pattern: "covariate_file"
---

<objective>
Create the data infrastructure modules for Phase 19: covariate loading with sample alignment, genotype matrix builder with correct edge-case handling, variant weight schemes, and extend AssociationConfig with new fields.

Purpose: These three modules (covariates.py, genotype_matrix.py, weights.py) plus the config extension are the foundation that the burden test implementations (Plan 02) and the pipeline integration consume. They are self-contained, testable units with no pipeline wiring yet.

Output: Four files — covariates.py, genotype_matrix.py, weights.py (all new), and base.py (extended with new config fields).
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-covariate-system-and-burden-tests/19-CONTEXT.md
@.planning/phases/19-covariate-system-and-burden-tests/19-RESEARCH.md
@variantcentrifuge/association/base.py
@variantcentrifuge/association/__init__.py
@variantcentrifuge/gene_burden.py (for _find_gt_columns pattern and _gt_to_dosage reference — do NOT reuse _gt_to_dosage)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend AssociationConfig and create covariates.py + weights.py</name>
  <files>
    variantcentrifuge/association/base.py
    variantcentrifuge/association/covariates.py
    variantcentrifuge/association/weights.py
  </files>
  <action>
**1a. Extend AssociationConfig in base.py** — add these new fields with defaults (all optional, backward compatible):
- `covariate_file: str | None = None`
- `covariate_columns: list[str] | None = None`
- `categorical_covariates: list[str] | None = None`
- `trait_type: str = "binary"` (values: "binary" or "quantitative")
- `variant_weights: str = "beta:1,25"` (values: "beta:a,b" or "uniform")
- `missing_site_threshold: float = 0.10`
- `missing_sample_threshold: float = 0.80`
- `firth_max_iter: int = 25`

Do NOT change any existing fields or docstrings. Add new fields after the existing ones with their own docstring block.

**1b. Create covariates.py** with `load_covariates(filepath, vcf_samples, covariate_columns=None, categorical_columns=None) -> np.ndarray`:
- Auto-detect delimiter: .tsv/.tab -> tab, .csv -> comma, else csv.Sniffer on first 2KB, fallback tab
- `pd.read_csv(filepath, sep=sep, index_col=0)` — first column = sample ID, header required
- Column selection if `covariate_columns` is not None
- VCF samples missing from covariate file -> `raise ValueError(f"VCF samples missing from covariate file: {sorted(missing)}")`
- Extra covariate samples not in VCF -> `logger.warning(...)` listing up to 5 sample IDs, continue
- `df.reindex(vcf_samples)` then `assert not df_aligned.isnull().any().any()`
- Auto-detect categorical: columns where `not pd.api.types.is_numeric_dtype(col)` AND `nunique() <= 5` (when `categorical_columns` is None)
- One-hot encode with `pd.get_dummies(df_aligned, columns=categorical_columns, drop_first=True, dtype=float)` — MUST use `dtype=float` (pandas 2.x defaults to bool)
- Multicollinearity check: `np.linalg.cond(X)`, warn if > 1000
- Return `X` as `np.ndarray` shape `(n_samples, k)` float64
- Also return a list of covariate column names (useful for diagnostics): `return X, column_names`

Use `logger = logging.getLogger("variantcentrifuge")`.

**1c. Create weights.py** with two functions:
- `beta_maf_weights(mafs: np.ndarray, a: float = 1.0, b: float = 25.0) -> np.ndarray`: uses `scipy.stats.beta.pdf(maf_clipped, a=a, b=b)` with `np.clip(mafs, 1e-8, 1 - 1e-8)` to avoid edge issues
- `uniform_weights(n_variants: int) -> np.ndarray`: returns `np.ones(n_variants)`
- `get_weights(mafs: np.ndarray, weight_spec: str) -> np.ndarray`: parses `weight_spec` string ("beta:1,25" or "uniform"), calls appropriate function. Raise ValueError for unknown spec.

All three modules use `from __future__ import annotations` and standard logging.
  </action>
  <verify>
Run: `python -c "from variantcentrifuge.association.covariates import load_covariates; from variantcentrifuge.association.weights import beta_maf_weights, uniform_weights, get_weights; from variantcentrifuge.association.base import AssociationConfig; c = AssociationConfig(); print(c.trait_type, c.variant_weights, c.covariate_file)"` — should print `binary beta:1,25 None`.

Run: `python -c "import numpy as np; from variantcentrifuge.association.weights import get_weights; w = get_weights(np.array([0.01, 0.05, 0.1]), 'beta:1,25'); print(w.shape, w[0] > w[2])"` — should print `(3,) True`.
  </verify>
  <done>
- AssociationConfig has all 8 new fields with defaults, backward compatible with Phase 18 code
- load_covariates() aligns to VCF sample order, one-hot encodes categoricals, warns on multicollinearity
- beta_maf_weights() and uniform_weights() produce correct weight vectors
- get_weights() parses "beta:a,b" and "uniform" specs
  </done>
</task>

<task type="auto">
  <name>Task 2: Create genotype_matrix.py with parse_gt_to_dosage and build_genotype_matrix</name>
  <files>
    variantcentrifuge/association/genotype_matrix.py
  </files>
  <action>
Create `genotype_matrix.py` with two public functions:

**2a. `parse_gt_to_dosage(gt: str) -> tuple[int | None, bool]`:**
Returns `(dosage, is_multi_allelic)`.
- `'0/0'`, `'0|0'` -> `(0, False)`
- `'0/1'`, `'1/0'`, `'0|1'`, `'1|0'` -> `(1, False)`
- `'1/1'`, `'1|1'` -> `(2, False)`
- `'./.`', `'.|.'`, empty string, None -> `(None, False)`
- `'1/2'`, `'0/2'`, `'2/2'` -> `(1, True)` (multi-allelic: het-equivalent dosage + flag)
- Any allele > 1 -> multi-allelic flag True, dosage = 1
- Phased (`|`) treated identically to unphased (`/`): split on separator, sum alleles
- Handle partial missing like `'./1'` -> `(None, False)`
- Use the research pattern from 19-RESEARCH.md Pattern 3

Do NOT import or reuse `gene_burden._gt_to_dosage()` — that function returns 0 for '1/2' which is wrong for regression.

**2b. `build_genotype_matrix(gene_df, vcf_samples, gt_columns, is_binary=True, missing_site_threshold=0.10, missing_sample_threshold=0.80) -> tuple[np.ndarray, np.ndarray, list[bool], list[str]]`:**
Returns `(G, mafs, sample_mask, warnings_list)`.
- `G`: float64 matrix shape `(n_kept_samples, n_kept_variants)`, fully imputed (no NaN)
- `mafs`: float64 array of per-variant MAF (computed from ALL samples, not stratified by phenotype — SKAT R convention, avoids label leakage)
- `sample_mask`: boolean list of length `len(vcf_samples)` indicating which samples survived the >80% missing filter
- `warnings_list`: list of warning strings (e.g., "Multi-allelic genotypes detected at N variants. Run bcftools norm -m- to split.")

Implementation:
1. Parse all GT values into raw dosage matrix `(n_variants, n_samples)` using parse_gt_to_dosage, tracking multi-allelic count
2. **Layer 1 pre-filter:** Remove variants with > `missing_site_threshold` fraction missing site-wide. Track which variants survive.
3. **Layer 1 pre-filter:** Identify samples with > `missing_sample_threshold` fraction missing across kept variants. Return `sample_mask` for these.
4. **Differential missingness warning:** For each variant, compute missing rate in cases vs controls (requires phenotype_vector to be passed — add optional `phenotype_vector: np.ndarray | None = None` param). If abs(case_missing - control_missing) > 0.05, append warning.
5. **Layer 2 imputation:** For each variant, compute MAF = mean(observed_dosages) / 2.0 from ALL samples. For missing values: if `is_binary`, impute `round(2 * maf)` (bestguess); else impute `2 * maf` (mean).
6. **Transpose** to `(n_samples, n_variants)` before returning.

If multi-allelic genotypes seen, append warning: "Multi-allelic genotypes detected at {count} variant(s). Recommend running bcftools norm -m- to split multi-allelic sites."

Important: MAF is computed from ALL samples (both cases and controls combined) — never stratify by phenotype (label leakage, Pitfall 5 from RESEARCH.md).
  </action>
  <verify>
Run: `python -c "
from variantcentrifuge.association.genotype_matrix import parse_gt_to_dosage
assert parse_gt_to_dosage('0/0') == (0, False)
assert parse_gt_to_dosage('0/1') == (1, False)
assert parse_gt_to_dosage('1/1') == (2, False)
assert parse_gt_to_dosage('./.') == (None, False)
assert parse_gt_to_dosage('1/2') == (1, True)
assert parse_gt_to_dosage('0|1') == (1, False)
assert parse_gt_to_dosage('.|.') == (None, False)
print('All parse_gt_to_dosage tests passed')
"`

Run: `python -c "
import pandas as pd, numpy as np
from variantcentrifuge.association.genotype_matrix import build_genotype_matrix
df = pd.DataFrame({'GENE': ['A','A'], 'GEN_0__GT': ['0/1','1/1'], 'GEN_1__GT': ['0/0','./.'], 'GEN_2__GT': ['1/1','0/1']})
G, mafs, mask, warns = build_genotype_matrix(df, ['s0','s1','s2'], ['GEN_0__GT','GEN_1__GT','GEN_2__GT'], is_binary=True)
print('Shape:', G.shape, 'NaN count:', np.isnan(G).sum(), 'MAFs:', mafs)
assert np.isnan(G).sum() == 0, 'No NaN after imputation'
print('build_genotype_matrix test passed')
"`

Run: `make lint` to check for style issues.
  </verify>
  <done>
- parse_gt_to_dosage correctly handles all edge cases: standard (0/0, 0/1, 1/1), missing (./.), phased (0|1), multi-allelic (1/2, 0/2, 2/2)
- build_genotype_matrix applies two-layer missing strategy (pre-filter + imputation), returns fully imputed matrix with no NaN
- MAF computed from all samples (not stratified by phenotype)
- Multi-allelic genotypes flagged with warning
- Sample mask returned for downstream filtering
  </done>
</task>

</tasks>

<verification>
- `python -c "from variantcentrifuge.association.base import AssociationConfig; c = AssociationConfig(); assert c.trait_type == 'binary'"` passes
- `python -c "from variantcentrifuge.association.covariates import load_covariates"` imports without error
- `python -c "from variantcentrifuge.association.genotype_matrix import parse_gt_to_dosage, build_genotype_matrix"` imports without error
- `python -c "from variantcentrifuge.association.weights import beta_maf_weights, uniform_weights, get_weights"` imports without error
- `make lint` passes with no new errors
- Existing tests still pass: `pytest tests/unit/test_association_base.py tests/unit/test_association_engine.py tests/unit/test_association_fisher.py -x`
</verification>

<success_criteria>
1. AssociationConfig backward compatible — all existing tests pass unchanged
2. load_covariates reindexes to VCF order and asserts no NaN
3. parse_gt_to_dosage returns (1, True) for multi-allelic genotypes
4. build_genotype_matrix returns fully imputed (no NaN) matrix
5. Beta weights upweight rare variants; uniform weights are all 1.0
6. No new lint errors
</success_criteria>

<output>
After completion, create `.planning/phases/19-covariate-system-and-burden-tests/19-01-SUMMARY.md`
</output>
