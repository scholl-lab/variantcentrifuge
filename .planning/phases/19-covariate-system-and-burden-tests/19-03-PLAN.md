---
phase: 19-covariate-system-burden-tests
plan: 03
type: execute
wave: 3
depends_on: ["19-02"]
files_modified:
  - tests/unit/test_association_covariates.py
  - tests/unit/test_association_genotype_matrix.py
  - tests/unit/test_association_weights.py
  - tests/unit/test_association_logistic_burden.py
  - tests/unit/test_association_linear_burden.py
autonomous: true

must_haves:
  truths:
    - "Covariate alignment with shuffled sample order produces same matrix as correctly ordered input"
    - "VCF samples missing from covariate file raises ValueError"
    - "Genotype edge cases (1/2, ./., 0|1) parse to correct dosages"
    - "Logistic burden test output matches manual statsmodels.Logit call on same inputs"
    - "Linear burden test output matches manual statsmodels.OLS call on same inputs"
    - "Firth fallback activates on perfect separation and produces finite estimates"
    - "Beta(MAF;1,25) weights are monotonically decreasing with increasing MAF"
    - "Uniform weights produce identical results to setting all weights to 1.0"
  artifacts:
    - path: "tests/unit/test_association_covariates.py"
      provides: "Tests for covariate loading, alignment, encoding, multicollinearity"
      min_lines: 80
    - path: "tests/unit/test_association_genotype_matrix.py"
      provides: "Tests for parse_gt_to_dosage edge cases and build_genotype_matrix imputation"
      min_lines: 100
    - path: "tests/unit/test_association_weights.py"
      provides: "Tests for beta and uniform weight schemes"
      min_lines: 40
    - path: "tests/unit/test_association_logistic_burden.py"
      provides: "Tests for logistic burden with manual statsmodels validation"
      min_lines: 120
    - path: "tests/unit/test_association_linear_burden.py"
      provides: "Tests for linear burden with manual statsmodels validation"
      min_lines: 80
  key_links:
    - from: "tests/unit/test_association_logistic_burden.py"
      to: "statsmodels.api.Logit"
      via: "Manual reference calculation compared to LogisticBurdenTest output"
      pattern: "sm\\.Logit"
    - from: "tests/unit/test_association_linear_burden.py"
      to: "statsmodels.api.OLS"
      via: "Manual reference calculation compared to LinearBurdenTest output"
      pattern: "sm\\.OLS"
---

<objective>
Comprehensive unit tests for all Phase 19 modules: covariate alignment, genotype matrix edge cases, weight schemes, and burden test outputs validated against manual statsmodels calls.

Purpose: These tests validate all 9 requirements (COV-01..04, BURDEN-01..03, WEIGHT-01..02) with concrete assertions. The manual statsmodels validation tests are the critical acceptance criteria — they prove the burden tests produce statistically correct results, not just "something that runs."

Output: Five new test files in tests/unit/.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-covariate-system-and-burden-tests/19-CONTEXT.md
@.planning/phases/19-covariate-system-and-burden-tests/19-RESEARCH.md
@.planning/phases/19-covariate-system-and-burden-tests/19-01-SUMMARY.md
@.planning/phases/19-covariate-system-and-burden-tests/19-02-SUMMARY.md
@variantcentrifuge/association/covariates.py
@variantcentrifuge/association/genotype_matrix.py
@variantcentrifuge/association/weights.py
@variantcentrifuge/association/tests/logistic_burden.py
@variantcentrifuge/association/tests/linear_burden.py
@variantcentrifuge/association/base.py
@tests/unit/test_association_fisher.py (for test pattern/style reference)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Tests for covariates, genotype matrix, and weights</name>
  <files>
    tests/unit/test_association_covariates.py
    tests/unit/test_association_genotype_matrix.py
    tests/unit/test_association_weights.py
  </files>
  <action>
**1a. test_association_covariates.py** — mark all tests `@pytest.mark.unit`:

- `test_load_covariates_basic`: Create temp TSV with 4 samples, 2 numeric columns. Call load_covariates. Assert shape is (4, 2) and values are correct.
- `test_load_covariates_alignment_shuffled`: Create covariate file with samples in reverse order vs VCF. Call load_covariates with vcf_samples in forward order. Assert output matrix row order matches VCF order, not file order. This is the key COV-01 test.
- `test_load_covariates_alignment_produces_identical_results`: Create same data in two files — one in VCF order, one shuffled. Assert `np.array_equal(result1, result2)`.
- `test_load_covariates_missing_vcf_sample_raises`: Covariate file has samples A,B,C. VCF has A,B,C,D. Assert `pytest.raises(ValueError, match="VCF samples missing")`.
- `test_load_covariates_extra_samples_warns`: Covariate file has samples A,B,C,D,E. VCF has A,B,C. Assert warning logged (use caplog) and result shape is (3, k).
- `test_load_covariates_categorical_auto_detect`: File with "sex" column (M/F values). Assert one-hot encoded: output has sex_M (or sex_F) column as float, not bool.
- `test_load_covariates_categorical_explicit`: Pass categorical_columns=["ethnicity"]. Assert one-hot encoding applied to that column.
- `test_load_covariates_one_hot_dtype_float`: Assert output dtype is float64 (not bool — pandas 2.x pitfall).
- `test_load_covariates_multicollinearity_warning`: Create covariate matrix with perfectly correlated columns (col2 = 2 * col1). Assert warning logged about high condition number.
- `test_load_covariates_csv_detection`: Create .csv file. Assert it loads correctly with comma delimiter.
- `test_load_covariates_column_selection`: File with 5 columns. Pass covariate_columns=["age", "sex"]. Assert only those 2 used.

Use `tmp_path` fixture for temp files. Write files with `pathlib.Path.write_text()`.

**1b. test_association_genotype_matrix.py** — mark all `@pytest.mark.unit`:

- `test_parse_gt_standard`: Assert 0/0->0, 0/1->1, 1/0->1, 1/1->2 with is_multi_allelic=False for all.
- `test_parse_gt_missing`: Assert ./.->None, .|.->None, empty string->None, None handled.
- `test_parse_gt_phased`: Assert 0|0->0, 0|1->1, 1|0->1, 1|1->2, all with is_multi_allelic=False.
- `test_parse_gt_multi_allelic`: Assert 1/2->(1,True), 0/2->(1,True), 2/2->(1,True). This is the critical BURDEN-03 test.
- `test_parse_gt_partial_missing`: Assert ./1->None, 1/.->None.
- `test_build_genotype_matrix_basic`: Create DataFrame with 3 samples, 2 variants, no missing. Assert output shape, no NaN, mafs computed correctly.
- `test_build_genotype_matrix_missing_imputation_binary`: DataFrame with ./. entries. is_binary=True. Assert imputed values are integers (0, 1, or 2) via round(2*MAF).
- `test_build_genotype_matrix_missing_imputation_continuous`: Same but is_binary=False. Assert imputed values are 2*MAF (may be fractional).
- `test_build_genotype_matrix_site_filter`: Create variant with >10% missing. Assert it's removed from output (fewer columns in G).
- `test_build_genotype_matrix_sample_filter`: Create sample with >80% missing across gene. Assert sample_mask reflects removal.
- `test_build_genotype_matrix_maf_from_all_samples`: Verify MAF is computed from all samples (not stratified). Create scenario where case-only vs all-sample MAF would differ. Assert MAF matches all-sample computation.
- `test_build_genotype_matrix_multi_allelic_warning`: Include 1/2 genotype. Assert warnings_list contains multi-allelic message.

**1c. test_association_weights.py** — mark all `@pytest.mark.unit`:

- `test_beta_weights_rare_upweighted`: Assert beta_maf_weights for MAF=0.001 > MAF=0.01 > MAF=0.1.
- `test_beta_weights_monotonic_decreasing`: Array of MAFs from 0.001 to 0.5. Assert weights are monotonically non-increasing.
- `test_beta_weights_custom_params`: Call with a=0.5, b=0.5 (U-shaped). Assert different shape than default.
- `test_uniform_weights`: Assert all values are 1.0 and length matches input.
- `test_get_weights_beta_spec`: Call get_weights(mafs, "beta:1,25"). Assert same as beta_maf_weights(mafs, 1, 25).
- `test_get_weights_uniform_spec`: Call get_weights(mafs, "uniform"). Assert all 1.0.
- `test_get_weights_invalid_spec`: Assert ValueError for get_weights(mafs, "unknown").
- `test_uniform_weights_equivalent_to_equal_weights`: Compare burden score with uniform weights vs manually summing genotype rows. Assert identical.
  </action>
  <verify>
Run: `pytest tests/unit/test_association_covariates.py tests/unit/test_association_genotype_matrix.py tests/unit/test_association_weights.py -v -x`
All tests should pass.

Run: `make lint`
  </verify>
  <done>
- Covariate alignment tests prove shuffled order produces identical output (COV-01)
- Missing VCF sample test proves ValueError raised (COV-01 guard)
- One-hot encoding tests verify categorical handling (COV-02)
- Multicollinearity warning test verifies condition number check (COV-03)
- All genotype edge cases covered: standard, missing, phased, multi-allelic (BURDEN-03)
- Two-layer missing strategy tested: site filter + sample filter + imputation (BURDEN-03)
- MAF from all samples verified (no label leakage)
- Beta and uniform weight schemes tested (WEIGHT-01, WEIGHT-02)
  </done>
</task>

<task type="auto">
  <name>Task 2: Logistic and linear burden test validation against manual statsmodels</name>
  <files>
    tests/unit/test_association_logistic_burden.py
    tests/unit/test_association_linear_burden.py
  </files>
  <action>
**2a. test_association_logistic_burden.py** — mark all `@pytest.mark.unit`:

Create a reusable fixture with synthetic data:
```python
@pytest.fixture
def synthetic_binary_data():
    """Synthetic data: 100 samples, 5 variants, binary phenotype with known signal."""
    np.random.seed(42)
    n = 100
    # Genotype matrix (100 samples, 5 variants) — sparse rare variants
    G = np.zeros((n, 5))
    for v in range(5):
        carriers = np.random.choice(n, size=int(n * 0.05), replace=False)
        G[carriers, v] = 1
    # Phenotype: correlated with burden
    burden_score = G.sum(axis=1)
    prob = 1 / (1 + np.exp(-(burden_score * 1.5 - 0.5)))
    phenotype = (np.random.random(n) < prob).astype(float)
    mafs = G.mean(axis=0) / 2
    return G, phenotype, mafs
```

Tests:

- `test_logistic_burden_matches_manual_statsmodels`: Build burden score manually (G @ weights), fit `sm.Logit(y, sm.add_constant(burden))`, compare p-value, beta, se with LogisticBurdenTest output. Assert `pytest.approx(manual_p, rel=1e-6)`.
- `test_logistic_burden_with_covariates_matches_manual`: Add a 2-column covariate matrix. Build full design matrix manually (intercept + burden + covariates). Fit sm.Logit. Compare p-value for burden coefficient (index 1) with test output. Assert match.
- `test_logistic_burden_odds_ratio`: Assert OR = exp(beta) and CI bounds = exp(ci_beta).
- `test_logistic_burden_perfect_separation_firth`: Create data where all carriers are cases (perfect separation). Assert warning_codes contains "PERFECT_SEPARATION". Assert p_value is not None (Firth should produce a result). Assert effect_size is finite.
- `test_logistic_burden_firth_convergence_fail`: Create degenerate data that causes both standard and Firth to fail (e.g., single variant, all samples same genotype). Assert p_value is None and "FIRTH_CONVERGE_FAIL" in warnings.
- `test_logistic_burden_zero_carriers_one_group`: All carriers are cases, zero carriers in controls. Assert ZERO_CARRIERS_ONE_GROUP warning.
- `test_logistic_burden_low_carrier_count`: Only 2 carriers total. Assert LOW_CARRIER_COUNT warning.
- `test_logistic_burden_no_genotype_matrix`: Pass contingency_data without genotype_matrix key. Assert p_value is None and NO_GENOTYPE_MATRIX in warnings.
- `test_logistic_burden_carrier_counts`: Assert n_carriers, n_carriers_cases, n_carriers_controls in extra dict match manual computation.
- `test_logistic_burden_never_omits_gene`: Run on gene with no carriers. Assert TestResult returned (not exception), with appropriate warning.

**2b. test_association_linear_burden.py** — mark all `@pytest.mark.unit`:

Create fixture:
```python
@pytest.fixture
def synthetic_quantitative_data():
    """Synthetic: 100 samples, 5 variants, continuous phenotype with known signal."""
    np.random.seed(42)
    n = 100
    G = np.zeros((n, 5))
    for v in range(5):
        carriers = np.random.choice(n, size=int(n * 0.1), replace=False)
        G[carriers, v] = 1
    burden = G.sum(axis=1)
    phenotype = 5.0 + 2.0 * burden + np.random.normal(0, 1, n)
    mafs = G.mean(axis=0) / 2
    return G, phenotype, mafs
```

Tests:

- `test_linear_burden_matches_manual_statsmodels`: Build design matrix manually, fit sm.OLS, compare beta, se, p_value with LinearBurdenTest output. Assert `pytest.approx(manual_beta, rel=1e-6)`.
- `test_linear_burden_with_covariates`: Add covariates, verify burden coefficient still extracted correctly from index 1.
- `test_linear_burden_ci_correct`: Assert CI covers the true beta (2.0) at 95% level in the synthetic data (with enough signal this should hold).
- `test_linear_burden_no_genotype_matrix`: Assert p_value=None when genotype_matrix not in contingency_data.
- `test_linear_burden_carrier_count`: Assert n_carriers in extra matches sum(burden > 0).
- `test_linear_burden_effect_size_is_beta_not_or`: Assert effect_size equals beta (not exp(beta)). Linear tests report raw beta as effect size.

For BOTH test files:
- Use `np.random.seed(42)` for reproducibility
- The manual statsmodels comparison is the gold standard: construct the EXACT same inputs (intercept + burden + covariates), fit the model, extract the SAME coefficient index, and compare. This is NOT testing against some known answer — it's testing that LogisticBurdenTest/LinearBurdenTest produce the same result as calling statsmodels directly.
- Use `pytest.approx(expected, rel=1e-6)` for floating point comparisons
  </action>
  <verify>
Run: `pytest tests/unit/test_association_logistic_burden.py tests/unit/test_association_linear_burden.py -v -x`
All tests should pass.

Run: `pytest tests/unit/test_association_covariates.py tests/unit/test_association_genotype_matrix.py tests/unit/test_association_weights.py tests/unit/test_association_logistic_burden.py tests/unit/test_association_linear_burden.py -v`
Full Phase 19 test suite passes.

Run: `make lint`

Run: `pytest tests/unit/test_association_base.py tests/unit/test_association_engine.py tests/unit/test_association_fisher.py tests/unit/test_association_stage.py -x` — existing Phase 18 tests still pass.
  </verify>
  <done>
- Logistic burden test output matches manual statsmodels.Logit (BURDEN-01)
- Linear burden test output matches manual statsmodels.OLS (BURDEN-02)
- Firth fallback tested with perfect separation scenario
- Warning codes tested: PERFECT_SEPARATION, FIRTH_CONVERGE_FAIL, ZERO_CARRIERS_ONE_GROUP, LOW_CARRIER_COUNT
- No gene ever silently omitted — always returns TestResult row
- All Phase 18 tests still pass
  </done>
</task>

</tasks>

<verification>
- `pytest tests/unit/test_association_covariates.py tests/unit/test_association_genotype_matrix.py tests/unit/test_association_weights.py tests/unit/test_association_logistic_burden.py tests/unit/test_association_linear_burden.py -v` — all pass
- `pytest tests/unit/test_association_base.py tests/unit/test_association_engine.py tests/unit/test_association_fisher.py tests/unit/test_association_stage.py -x` — existing tests pass
- `make ci-check` passes (lint + format + typecheck + test-fast)
- Total new test count >= 30 tests across 5 files
</verification>

<success_criteria>
1. Covariate alignment with shuffled order produces identical results (COV-01 proven)
2. Logistic burden p-value matches manual statsmodels.Logit to rel=1e-6 (BURDEN-01 proven)
3. Linear burden beta matches manual statsmodels.OLS to rel=1e-6 (BURDEN-02 proven)
4. All genotype edge cases tested: 1/2, ./., 0|1 (BURDEN-03 proven)
5. Beta weights monotonically decreasing with MAF (WEIGHT-01 proven)
6. Uniform weights equivalent to all-ones (WEIGHT-02 proven)
7. Firth fallback activated and produces finite result on separation
8. No existing tests broken
</success_criteria>

<output>
After completion, create `.planning/phases/19-covariate-system-and-burden-tests/19-03-SUMMARY.md`
</output>
