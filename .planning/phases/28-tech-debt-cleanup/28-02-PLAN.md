---
phase: 28-tech-debt-cleanup
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - variantcentrifuge/cli.py
  - tests/unit/test_cli_association_args.py
autonomous: true

must_haves:
  truths:
    - "User can pass --skat-method SKATO on the CLI to select SKAT-O method"
    - "User can pass --min-cases 100 to change the minimum cases diagnostic threshold"
    - "User can pass --max-case-control-ratio 10 to change the ratio threshold"
    - "User can pass --min-case-carriers 5 to change the per-gene carrier threshold"
    - "CLI values propagate through cfg dict to _build_assoc_config_from_context"
    - "JSON config values still work when CLI args are not provided"
  artifacts:
    - path: "variantcentrifuge/cli.py"
      provides: "Four new CLI arguments in stats_group + cfg assignments"
      contains: "skat-method"
    - path: "tests/unit/test_cli_association_args.py"
      provides: "Tests for CLI arg propagation to AssociationConfig"
  key_links:
    - from: "variantcentrifuge/cli.py"
      to: "variantcentrifuge/stages/analysis_stages.py"
      via: "cfg dict keys matching _get() cli_keys"
      pattern: "cfg\\[.skat_method.\\]"
    - from: "variantcentrifuge/cli.py"
      to: "variantcentrifuge/stages/analysis_stages.py"
      via: "cfg dict keys matching _get() cli_keys"
      pattern: "cfg\\[.association_min_cases.\\]"
---

<objective>
Add four CLI arguments (`--skat-method`, `--min-cases`, `--max-case-control-ratio`, `--min-case-carriers`) to expose JSON-only config fields on the command line, and write tests proving the values propagate to AssociationConfig.

Purpose: These fields are already wired in `_build_assoc_config_from_context()` via `_get()` calls -- the only missing piece is the argparse `add_argument()` declarations in cli.py and the `cfg["key"]` assignments in the config assembly block. This closes the last tech debt gap from the milestone audit.

Output: Updated cli.py with 4 new args + config wiring; new test file validating propagation.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/28-tech-debt-cleanup/28-RESEARCH.md

Key references:
- CLI stats_group: variantcentrifuge/cli.py lines 379-540 (add_argument section)
- Config assembly: variantcentrifuge/cli.py lines 1150-1217 (cfg["key"] = ... section)
- _build_assoc_config_from_context: variantcentrifuge/stages/analysis_stages.py lines 2176-2298
- _get() calls for new fields: analysis_stages.py lines 2278-2290
- Existing pattern: cfg["association_workers"] = getattr(args, "association_workers", 1) at line 1217
- Test pattern: tests/unit/test_json_config.py (_make_context helper, _build_assoc_config_from_context tests)
- VALID_ASSOCIATION_KEYS: analysis_stages.py line 2044 (skat_method already listed)

CRITICAL key mapping (from research):
- --skat-method -> cfg["skat_method"] (NO association_ prefix)
- --min-cases -> cfg["association_min_cases"] (WITH association_ prefix)
- --max-case-control-ratio -> cfg["association_max_case_control_ratio"] (WITH association_ prefix)
- --min-case-carriers -> cfg["association_min_case_carriers"] (WITH association_ prefix)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add CLI arguments and config wiring in cli.py</name>
  <files>variantcentrifuge/cli.py</files>
  <action>
  **Part A: Add four add_argument() calls in the stats_group section.**

  Insert after the `--association-workers` block (around line 522) and before the PCA arguments section (line 523). Add these four arguments:

  ```python
  # Phase 28: SKAT method and diagnostic thresholds
  stats_group.add_argument(
      "--skat-method",
      choices=["SKAT", "Burden", "SKATO"],
      default="SKAT",
      help=(
          "SKAT method variant: 'SKAT' (default), 'Burden' (burden-only), "
          "or 'SKATO' (SKAT-O omnibus). Requires SKAT test in --association-tests."
      ),
  )
  stats_group.add_argument(
      "--min-cases",
      type=int,
      default=200,
      help=(
          "Minimum number of cases for diagnostics warning. "
          "Default: 200. Warns when n_cases < this value."
      ),
  )
  stats_group.add_argument(
      "--max-case-control-ratio",
      type=float,
      default=20.0,
      help=(
          "Maximum case:control ratio for diagnostics warning. "
          "Default: 20.0. Warns when n_controls/n_cases > this value."
      ),
  )
  stats_group.add_argument(
      "--min-case-carriers",
      type=int,
      default=10,
      help=(
          "Minimum case carrier count per gene for diagnostics warning. "
          "Default: 10. Flags genes where case_carriers < this value."
      ),
  )
  ```

  **Part B: Add cfg assignments in the config assembly block.**

  Insert after `cfg["association_workers"] = getattr(args, "association_workers", 1)` (line 1217), before the `# Handle add_chr configuration` comment:

  ```python
  # Phase 28: SKAT method and diagnostic thresholds
  cfg["skat_method"] = getattr(args, "skat_method", "SKAT")
  cfg["association_min_cases"] = getattr(args, "min_cases", 200)
  cfg["association_max_case_control_ratio"] = getattr(args, "max_case_control_ratio", 20.0)
  cfg["association_min_case_carriers"] = getattr(args, "min_case_carriers", 10)
  ```

  This follows the "always write" pattern used by `skat_backend`, `coast_backend`, `association_workers`, and every other association arg. The `_get()` helper in `_build_assoc_config_from_context` handles CLI vs JSON precedence -- when the CLI key is present in cfg, CLI wins; the default values match AssociationConfig defaults so writing them is safe.

  **CRITICAL:** The key for skat_method is `"skat_method"` (NO association_ prefix). The keys for the three diagnostic thresholds use `"association_"` prefix. This matches the `_get()` calls in analysis_stages.py lines 2278-2290.
  </action>
  <verify>
  1. `grep -n "skat-method\|min-cases\|max-case-control-ratio\|min-case-carriers" variantcentrifuge/cli.py` shows all 4 add_argument calls
  2. `grep -n 'cfg\["skat_method"\]\|cfg\["association_min_cases"\]\|cfg\["association_max_case_control_ratio"\]\|cfg\["association_min_case_carriers"\]' variantcentrifuge/cli.py` shows all 4 cfg assignments
  3. `make lint` passes (no ruff errors from new code)
  4. `make format` produces no changes (code already formatted)
  </verify>
  <done>Four new CLI arguments added to stats_group with correct choices/types/defaults. Four cfg assignments wired with correct key names (skat_method without prefix, three thresholds with association_ prefix).</done>
</task>

<task type="auto">
  <name>Task 2: Write tests for CLI arg propagation</name>
  <files>tests/unit/test_cli_association_args.py</files>
  <action>
  Create a new test file `tests/unit/test_cli_association_args.py` that validates the four new CLI args propagate to AssociationConfig via `_build_assoc_config_from_context`.

  Follow the pattern from `tests/unit/test_json_config.py`:
  - Use `_make_context()` helper to build a minimal PipelineContext
  - Set config dict keys matching the cli_keys
  - Call `_build_assoc_config_from_context()` and assert field values

  Tests to write (all marked `@pytest.mark.unit`):

  1. **test_skat_method_from_cli** -- Set `config["skat_method"] = "SKATO"`, build config, assert `assoc_config.skat_method == "SKATO"`.

  2. **test_skat_method_default** -- Empty config (no skat_method key), build config, assert `assoc_config.skat_method == "SKAT"`.

  3. **test_min_cases_from_cli** -- Set `config["association_min_cases"] = 100`, build config, assert `assoc_config.min_cases == 100`.

  4. **test_min_cases_default** -- Empty config, assert `assoc_config.min_cases == 200`.

  5. **test_max_case_control_ratio_from_cli** -- Set `config["association_max_case_control_ratio"] = 10.0`, assert `assoc_config.max_case_control_ratio == 10.0`.

  6. **test_min_case_carriers_from_cli** -- Set `config["association_min_case_carriers"] = 5`, assert `assoc_config.min_case_carriers == 5`.

  7. **test_json_overrides_for_thresholds** -- Set `config["association"] = {"min_cases": 50, "skat_method": "Burden"}` (JSON config path), assert values propagate correctly.

  8. **test_cli_overrides_json** -- Set both `config["association"] = {"min_cases": 50}` AND `config["association_min_cases"] = 300`, assert `assoc_config.min_cases == 300` (CLI wins).

  Use imports:
  ```python
  from variantcentrifuge.association.base import AssociationConfig
  from variantcentrifuge.pipeline_core.context import PipelineContext
  from variantcentrifuge.pipeline_core.workspace import Workspace
  from variantcentrifuge.stages.analysis_stages import _build_assoc_config_from_context
  ```

  Use `_make_context()` helper identical to test_json_config.py.
  </action>
  <verify>
  1. `pytest tests/unit/test_cli_association_args.py -v` -- all tests pass
  2. `make ci-check` -- full CI check passes including new tests
  </verify>
  <done>New test file with 8 tests validates that --skat-method, --min-cases, --max-case-control-ratio, and --min-case-carriers propagate through cfg dict to AssociationConfig fields, with correct defaults and CLI-over-JSON precedence.</done>
</task>

</tasks>

<verification>
1. `pytest tests/unit/test_cli_association_args.py -v` -- all 8 tests pass
2. `pytest tests/unit/test_json_config.py -v` -- existing JSON config tests still pass
3. `make ci-check` -- full CI passes (lint, format, typecheck, tests)
4. `grep "skat-method" variantcentrifuge/cli.py` -- CLI arg exists
5. `grep 'cfg\["skat_method"\]' variantcentrifuge/cli.py` -- cfg wiring exists
</verification>

<success_criteria>
1. `--skat-method` CLI arg accepts SKAT/Burden/SKATO with default SKAT
2. `--min-cases` CLI arg accepts int with default 200
3. `--max-case-control-ratio` CLI arg accepts float with default 20.0
4. `--min-case-carriers` CLI arg accepts int with default 10
5. All four values propagate through cfg to AssociationConfig
6. JSON config values work when CLI defaults are used
7. All existing tests pass; 8 new tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/28-tech-debt-cleanup/28-02-SUMMARY.md`
</output>
