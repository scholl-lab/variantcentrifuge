---
phase: 21-pure-python-skat-backend
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - variantcentrifuge/association/backends/davies.py
  - variantcentrifuge/association/data/qfc.cpp
  - variantcentrifuge/_davies_build.py
  - setup.py
  - pyproject.toml
autonomous: true

must_haves:
  truths:
    - "compute_pvalue returns (p_value, p_method, p_converged) for any valid eigenvalue array"
    - "Liu moment-matching produces p-values for chi-squared mixtures without any C extension"
    - "Kuonen saddlepoint produces more accurate p-values than Liu for p <= 1e-5"
    - "Davies C extension compiles on Linux and is loaded lazily at runtime"
    - "When Davies extension is absent, fallback chain skips to saddlepoint then Liu"
    - "p_method correctly records which tier produced the result"
    - "Build system supports C extension compilation via cffi_modules"
  artifacts:
    - path: "variantcentrifuge/association/backends/davies.py"
      provides: "Three-tier p-value fallback chain"
      exports: ["compute_pvalue", "davies_pvalue"]
    - path: "variantcentrifuge/association/data/qfc.cpp"
      provides: "Bundled CompQuadForm C++ source for Davies method"
    - path: "variantcentrifuge/_davies_build.py"
      provides: "CFFI ffibuilder for qfc.cpp compilation"
    - path: "setup.py"
      provides: "cffi_modules hook with OptionalBuildExt"
    - path: "pyproject.toml"
      provides: "Build backend migrated from hatchling to setuptools"
  key_links:
    - from: "variantcentrifuge/association/backends/davies.py"
      to: "variantcentrifuge._qfc"
      via: "lazy import in _try_load_davies()"
      pattern: "from variantcentrifuge import _qfc"
    - from: "setup.py"
      to: "variantcentrifuge/_davies_build.py"
      via: "cffi_modules parameter"
      pattern: "cffi_modules.*_davies_build"
    - from: "variantcentrifuge/_davies_build.py"
      to: "variantcentrifuge/association/data/qfc.cpp"
      via: "ffibuilder.set_source sources= parameter"
      pattern: "sources=.*qfc"
---

<objective>
Implement the p-value computation layer (davies.py) with the three-tier fallback chain:
Davies -> Kuonen saddlepoint -> Liu moment-matching. Bundle qfc.cpp source, create CFFI
build script, and migrate pyproject.toml from hatchling to setuptools for C extension support.

Purpose: This is the mathematical core that all Python SKAT p-values flow through. Plan 21-02
(PythonSKATBackend) calls compute_pvalue() from this module. Building the p-value layer first
allows it to be unit-tested independently of the full SKAT backend.

Output: Working davies.py with compute_pvalue() API, bundled qfc.cpp, CFFI build infrastructure,
and migrated build system.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-pure-python-skat-backend/21-RESEARCH.md
@.planning/phases/21-pure-python-skat-backend/21-CONTEXT.md
@variantcentrifuge/association/backends/base.py
@variantcentrifuge/association/backends/__init__.py
@pyproject.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: davies.py — Liu, Kuonen saddlepoint, and Davies with fallback chain</name>
  <files>
    variantcentrifuge/association/backends/davies.py
    variantcentrifuge/association/data/qfc.cpp
    variantcentrifuge/_davies_build.py
  </files>
  <action>
Create `variantcentrifuge/association/backends/davies.py` with the full three-tier p-value
computation. Follow the exact algorithms from 21-RESEARCH.md:

1. **`_liu_pvalue(q, lambdas) -> float`**: Liu moment-matching (Get_Liu_Params_Mod_Lambda).
   Uses scipy.stats.ncx2.sf. Match the exact R cumulant formulas from RESEARCH Pattern 1.
   Handle edge cases: all-equal eigenvalues (s1=0 => use chi-squared), negative q_norm.

2. **`_kuonen_pvalue(q, lambdas) -> float | None`**: Lugannani-Rice saddlepoint.
   Use scipy.optimize.brentq to solve K'(t_hat) = q. Return None if q <= mean(lambdas)
   or brentq fails (ValueError). Near-singularity guard: if abs(u) < 1e-8 use norm.sf(w).
   Match RESEARCH Pattern 2 exactly.

3. **`_try_load_davies() -> bool`**: Lazy loader for compiled _qfc extension.
   Global `_DAVIES_AVAILABLE` flag. Respects `VARIANTCENTRIFUGE_NO_C_EXT` env var.
   Import path: `from variantcentrifuge._qfc import lib as _qfc_lib`.

4. **`davies_pvalue(q, lambdas, acc=1e-9, lim=100_000) -> tuple[float | None, int]`**:
   Calls qfc() via cffi. Allocates cffi arrays for eigenvalues, noncentrality params (zeros),
   df (ones), trace (7 doubles), ifault, result. Returns (p_value, ifault).

5. **`compute_pvalue(q, lambdas, acc=1e-9, lim=100_000) -> tuple[float, str, bool]`**:
   Public API. Three-tier fallback with GENESIS+GMMAT hybrid triggering:
   - Try Davies if available. Trigger fallback if: ifault > 0, p >= 1.0,
     p < 1000 * machine_epsilon (~2.22e-13), or p <= 1e-5
   - Try Kuonen saddlepoint. Accept if 0 < p < 1.
   - Liu as last resort. Always returns a value.
   - Log each fallback at INFO level with details.
   - Return (p_value, "davies"|"saddlepoint"|"liu", p_converged).
     p_converged = True only when Davies succeeded without fallback.

Edge cases:
- Empty lambdas array: return (nan, "liu", False)
- All eigenvalues equal: Liu degenerates to simple chi-squared; handle gracefully
- q <= 0: return (1.0, method, converged) since P[Q > 0] ~ 1

Create directory `variantcentrifuge/association/data/` with `__init__.py` (empty).
Download qfc.cpp from the CompQuadForm CRAN package. The file is standalone C++ implementing
the Davies (1980) algorithm for computing P[Q > q] where Q = sum(lambda_j * chi2_1_j).
If unable to download, create a placeholder qfc.cpp with a comment noting it must be obtained
from CompQuadForm CRAN (https://cran.r-project.org/package=CompQuadForm, file src/qfc.cpp).
Ensure the file has `extern "C"` wrapping the `qfc()` function signature so CFFI can link it.

Create `variantcentrifuge/_davies_build.py` with CFFI out-of-line API mode:
- `ffibuilder = FFI()`
- `ffibuilder.cdef(...)` with the qfc signature
- `ffibuilder.set_source("variantcentrifuge._qfc", ...)` pointing to data/qfc.cpp
- `source_extension='.cpp'` since qfc is C++
- Use `os.path.join(os.path.dirname(__file__), ...)` for source path
  </action>
  <verify>
    Run: `python -c "from variantcentrifuge.association.backends.davies import compute_pvalue, _liu_pvalue, _kuonen_pvalue; import numpy as np; lam = np.array([5.0, 3.0, 1.0]); p, m, c = compute_pvalue(15.0, lam); print(f'p={p}, method={m}, converged={c}')"` — should return a valid p-value with method "liu" or "saddlepoint" (Davies won't be available until build system completes).
    Run: `python -c "from variantcentrifuge.association.backends.davies import _liu_pvalue; import numpy as np; p = _liu_pvalue(10.0, np.array([5.0, 3.0, 1.0])); print(f'Liu p={p}')"` — should print a p-value between 0 and 1.
  </verify>
  <done>
    - `compute_pvalue()` returns valid (p_value, p_method, p_converged) tuples
    - Liu works standalone for any eigenvalue array with positive values
    - Kuonen works for q > mean(lambdas) and returns None otherwise
    - Davies attempts lazy import and falls back gracefully when _qfc unavailable
    - All three methods log fallback transitions at INFO level
  </done>
</task>

<task type="auto">
  <name>Task 2: Build system migration — hatchling to setuptools + cffi_modules</name>
  <files>
    pyproject.toml
    setup.py
  </files>
  <action>
Migrate pyproject.toml build backend from hatchling to setuptools:

1. **pyproject.toml changes:**
   - Change `[build-system]` requires from `["hatchling"]` to `["setuptools>=64", "cffi>=1.0.0"]`
   - Change build-backend from `"hatchling.build"` to `"setuptools.build_meta"`
   - Remove `[tool.hatch.version]` section. Replace with `[tool.setuptools.dynamic]`
     version = `{attr = "variantcentrifuge.version.__version__"}`
   - Remove `[tool.hatch.build.targets.wheel]` and `[tool.hatch.build.targets.sdist]`
   - Add `[tool.setuptools.packages.find]` with `where = ["."]` and
     `include = ["variantcentrifuge*"]`
   - Add `cffi` to the `dependencies` list in `[project]`
   - Keep ALL other sections (pytest, ruff, mypy, coverage) unchanged
   - Keep `dynamic = ["version"]` in `[project]`

2. **setup.py** (new file, minimal):
   ```python
   from setuptools import setup
   from setuptools.command.build_ext import build_ext
   import os

   class OptionalBuildExt(build_ext):
       """Allow C extension build to fail gracefully (Liu fallback available)."""
       def build_extension(self, ext):
           try:
               super().build_extension(ext)
           except Exception as e:
               import warnings
               warnings.warn(
                   f"Davies C extension build failed: {e}. "
                   "SKAT will use Liu moment-matching fallback for p-values."
               )

   # cffi_modules only processed when cffi is available
   cffi_modules = []
   if not os.environ.get("VARIANTCENTRIFUGE_NO_C_EXT"):
       try:
           import cffi  # noqa: F401
           cffi_modules = ["variantcentrifuge/_davies_build.py:ffibuilder"]
       except ImportError:
           pass

   setup(
       cffi_modules=cffi_modules,
       cmdclass={"build_ext": OptionalBuildExt},
   )
   ```

3. **Verify the migration preserves all existing behavior:**
   - `pip install -e ".[dev]"` still works
   - `variantcentrifuge --version` still prints the correct version
   - All existing tests still pass
   - The package is still importable

IMPORTANT: Do NOT change the version.py file. The setuptools dynamic version reads
`__version__` from `variantcentrifuge/version.py` — this is the standard pattern.
Do NOT add `cffi` to dev dependencies — it is a runtime dependency.
  </action>
  <verify>
    Run: `cd /mnt/c/development/scholl-lab/variantcentrifuge && uv pip install -e ".[dev]" 2>&1 | tail -5` — must succeed without errors.
    Run: `python -c "import variantcentrifuge; print(variantcentrifuge.__name__)"` — must print "variantcentrifuge".
    Run: `python -c "from variantcentrifuge.version import __version__; print(__version__)"` — must print correct version.
    Run: `make lint` — must pass (no ruff errors in new/modified files).
  </verify>
  <done>
    - pyproject.toml uses setuptools build backend
    - setup.py exists with OptionalBuildExt and cffi_modules
    - `pip install -e ".[dev]"` succeeds
    - Existing tests still pass (`pytest -m unit --timeout=60 -x -q` exits 0)
    - cffi is listed as a runtime dependency
  </done>
</task>

</tasks>

<verification>
1. `python -c "from variantcentrifuge.association.backends.davies import compute_pvalue"` succeeds
2. `compute_pvalue(15.0, np.array([5.0, 3.0, 1.0]))` returns a valid tuple
3. `_liu_pvalue` and `_kuonen_pvalue` are independently callable
4. `pip install -e ".[dev]"` succeeds with setuptools backend
5. `make lint` passes on all new files
6. `pytest -m unit -x -q` passes (no regressions)
</verification>

<success_criteria>
- davies.py exports compute_pvalue() with three-tier fallback
- Liu produces valid p-values for any positive eigenvalue array
- Kuonen saddlepoint produces valid p-values for q > mean(lambdas)
- Build system migrated to setuptools; editable install works
- cffi build infrastructure in place (even if qfc.cpp not yet compiled)
- Zero regressions in existing test suite
</success_criteria>

<output>
After completion, create `.planning/phases/21-pure-python-skat-backend/21-01-SUMMARY.md`
</output>
