---
phase: 22-acat-o-and-diagnostics
plan: 03
type: execute
wave: 3
depends_on: ["22-01", "22-02"]
files_modified:
  - tests/unit/test_association_acat.py
  - tests/unit/test_association_diagnostics.py
  - tests/unit/test_association_engine.py
autonomous: true

must_haves:
  truths:
    - "ACAT Cauchy formula matches published values from Liu & Xie 2020"
    - "Lambda_GC on uniform null p-values falls within [0.9, 1.1]"
    - "Lambda_GC on permuted null phenotype falls within [0.95, 1.05] for 1000+ genes"
    - "Engine output contains acat_o_p_value and acat_o_corrected_p_value columns"
    - "Primary test corrected_p_value is None in engine output (ARCH-03)"
    - "Diagnostics write_diagnostics produces all three output files"
    - "Per-gene warnings column populated for low-carrier genes"
    - "Stage-level diagnostics integration writes files to disk when diagnostics_output is configured"
  artifacts:
    - path: "tests/unit/test_association_acat.py"
      provides: "ACAT formula validation, edge cases, numerical accuracy tests"
      contains: "cauchy_combination"
    - path: "tests/unit/test_association_diagnostics.py"
      provides: "Lambda_GC, QQ data, warnings, write_diagnostics tests, stage integration test"
      contains: "compute_lambda_gc"
    - path: "tests/unit/test_association_engine.py"
      provides: "Updated engine tests reflecting ARCH-03 FDR change"
      contains: "acat_o_p_value"
  key_links:
    - from: "tests/unit/test_association_acat.py"
      to: "variantcentrifuge/association/tests/acat.py"
      via: "direct import and numerical assertions"
      pattern: "from variantcentrifuge.association.tests.acat import"
    - from: "tests/unit/test_association_diagnostics.py"
      to: "variantcentrifuge/association/diagnostics.py"
      via: "direct import and file output assertions"
      pattern: "from variantcentrifuge.association.diagnostics import"
---

<objective>
Validate ACAT-O Cauchy combination, lambda_GC calibration, diagnostics output, and engine integration with comprehensive unit tests.

Purpose: Prove numerical correctness of ACAT formula against published values, verify lambda_GC calibration on null data, confirm diagnostics file output, and ensure ARCH-03 FDR strategy is correctly implemented.

Output: Three test files covering ACAT formula, diagnostics module, and updated engine tests.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-acat-o-and-diagnostics/22-RESEARCH.md
@.planning/phases/22-acat-o-and-diagnostics/22-01-SUMMARY.md
@.planning/phases/22-acat-o-and-diagnostics/22-02-SUMMARY.md
@variantcentrifuge/association/tests/acat.py
@variantcentrifuge/association/diagnostics.py
@variantcentrifuge/association/engine.py
@tests/unit/test_association_engine.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: ACAT formula, diagnostics tests, and stage-level integration test</name>
  <files>
    tests/unit/test_association_acat.py
    tests/unit/test_association_diagnostics.py
  </files>
  <action>
    **Create `tests/unit/test_association_acat.py`** with pytest markers `@pytest.mark.unit`:

    1. **Numerical accuracy tests:**
       - `test_cauchy_equal_inputs`: cauchy_combination([p, p, p]) == pytest.approx(p) for p in [0.01, 0.05, 0.1, 0.5]
       - `test_cauchy_published_values`: cauchy_combination([0.001, 0.01, 0.05]) == pytest.approx(0.00268, abs=0.001) (Liu & Xie 2020 Table 1)
       - `test_cauchy_null_inputs`: cauchy_combination([0.5, 0.5]) == pytest.approx(0.5, abs=0.01)
       - `test_cauchy_very_small_p`: cauchy_combination([1e-20, 0.5]) should return a valid p-value (not NaN/Inf), testing the 1/(p*pi) branch
       - `test_cauchy_weighted`: cauchy_combination([0.01, 0.5], weights=[0.9, 0.1]) should be closer to 0.01 than equal-weighted

    2. **Edge case tests:**
       - `test_cauchy_all_none`: cauchy_combination([None, None]) returns None
       - `test_cauchy_single_value`: cauchy_combination([0.05]) returns 0.05 (pass-through)
       - `test_cauchy_with_nones`: cauchy_combination([0.01, None, 0.05]) correctly filters Nones
       - `test_cauchy_all_ones`: cauchy_combination([1.0, 1.0]) returns 1.0 or None (non-informative)
       - `test_cauchy_empty`: cauchy_combination([]) returns None

    3. **compute_acat_o tests:**
       - `test_acat_o_two_tests`: compute_acat_o({"burden": 0.01, "skat": 0.05}) returns valid combined p
       - `test_acat_o_single_test`: compute_acat_o({"burden": 0.05, "skat": None}) returns 0.05 (pass-through)
       - `test_acat_o_no_tests`: compute_acat_o({"burden": None, "skat": None}) returns None
       - `test_acat_o_three_tests`: compute_acat_o({"fisher": 0.01, "burden": 0.05, "skat": 0.1}) returns combined p

    **Create `tests/unit/test_association_diagnostics.py`** with pytest markers `@pytest.mark.unit`:

    1. **Lambda_GC tests:**
       - `test_lambda_gc_uniform`: lambda_GC on 1000 uniform(0,1) p-values is within [0.85, 1.15] (use np.random.seed for reproducibility)
       - `test_lambda_gc_inflated`: lambda_GC on chi2-derived p-values with inflation factor 1.5 returns ~1.5 (within 0.1)
       - `test_lambda_gc_empty`: returns None for empty input
       - `test_lambda_gc_single`: returns None for single p-value
       - `test_lambda_gc_with_nones`: correctly filters None values

    2. **QQ data tests:**
       - `test_qq_data_shape`: 100 p-values produces DataFrame with 100 rows and correct columns
       - `test_qq_data_columns`: columns are exactly ["test", "expected_neg_log10_p", "observed_neg_log10_p"]
       - `test_qq_data_sort_order`: expected_neg_log10_p is sorted ascending (first row has smallest value)
       - `test_qq_data_empty`: empty input produces empty DataFrame with correct columns
       - `test_qq_data_hazen`: expected values match Hazen quantile formula i/(n+1)

    3. **Sample size warning tests:**
       - `test_warnings_low_cases`: n_cases=100 triggers LOW_CASE_COUNT
       - `test_warnings_imbalanced`: ratio > 20 triggers IMBALANCED_COHORT
       - `test_warnings_none`: adequate sample sizes produce no warnings
       - `test_per_gene_warnings_low_carriers`: case_carriers=5 triggers LOW_CARRIER_COUNT

    4. **write_diagnostics tests (using tmp_path fixture):**
       - `test_write_diagnostics_creates_files`: all three files exist after call
       - `test_lambda_gc_tsv_columns`: lambda_gc.tsv has correct columns
       - `test_qq_data_tsv_content`: qq_data.tsv has rows for each test
       - `test_summary_txt_content`: summary.txt contains sample sizes and lambda_GC values

    5. **Stage-level diagnostics integration test (using tmp_path fixture):**
       - `test_stage_diagnostics_integration`: Exercise the full path from diagnostics_output config through to files on disk:
         - Create a minimal AssociationConfig with diagnostics_output=str(tmp_path / "diag")
         - Build a mock results_df DataFrame with at least 2 genes, containing fisher_p_value and acat_o_p_value columns
         - Call write_diagnostics() with this results_df, test_names=["fisher"], and plausible n_cases/n_controls
         - Assert the diagnostics directory was created
         - Assert lambda_gc.tsv exists and contains rows for "fisher" and "acat_o"
         - Assert qq_data.tsv exists and has rows
         - Assert summary.txt exists and contains "n_cases" text
         - This validates the wiring that the stage will use: config -> write_diagnostics() -> files on disk
  </action>
  <verify>
    Run: `pytest tests/unit/test_association_acat.py tests/unit/test_association_diagnostics.py -x -v`
  </verify>
  <done>
    All ACAT numerical tests pass matching published values.
    All diagnostics tests pass with correct lambda_GC calibration.
    Edge cases handled (None, empty, single value).
    write_diagnostics produces all output files with correct content.
    Stage-level integration test confirms config-to-disk wiring.
  </done>
</task>

<task type="auto">
  <name>Task 2: Engine integration tests update for ARCH-03</name>
  <files>
    tests/unit/test_association_engine.py
  </files>
  <action>
    Read and update `tests/unit/test_association_engine.py`:

    1. **Update existing tests broken by ARCH-03:**
       - Any test asserting `corrected_p_value is not None` for primary tests (fisher, burden) must be updated to assert `corrected_p_value is None`
       - Any test checking `fisher_corrected_p_value` column value must be updated

    2. **Add new ACAT-O integration tests:**
       - `test_engine_acat_o_columns_present`: run_all with fisher test produces acat_o_p_value and acat_o_corrected_p_value columns
       - `test_engine_acat_o_single_test_passthrough`: with only fisher, acat_o_p_value equals fisher_p_value (pass-through for k=1)
       - `test_engine_acat_o_fdr_applied`: acat_o_corrected_p_value is not None for genes with valid ACAT-O p-values
       - `test_engine_primary_tests_no_fdr`: fisher_corrected_p_value is None (ARCH-03)
       - `test_engine_acat_o_none_for_zero_variant_gene`: gene with 0 variants has acat_o_p_value=None

    3. **Preserve all existing tests that don't touch corrected_p_value:**
       - Gene sort order tests
       - Zero-variant skipping tests
       - from_names validation tests
       - Effect column naming tests

    4. **Run full test suite verification:**
       - Run ALL association tests together to check for regressions:
         `pytest tests/unit/test_association_*.py -x -q`

    IMPORTANT: Be precise about which assertions change. Only corrected_p_value assertions on PRIMARY tests change. The raw p_value, effect_size, CI, and column name assertions remain unchanged.
  </action>
  <verify>
    Run: `pytest tests/unit/test_association_engine.py -x -v`
    Run: `pytest tests/unit/test_association_acat.py tests/unit/test_association_diagnostics.py tests/unit/test_association_engine.py -v --tb=short`
    Run: `pytest tests/unit/ -x -q --tb=line` (full unit test suite for regression check)
  </verify>
  <done>
    All engine tests pass with ARCH-03 assertions.
    ACAT-O integration tests verify columns, pass-through, FDR, and edge cases.
    Full unit test suite passes with no regressions.
  </done>
</task>

</tasks>

<verification>
1. `pytest tests/unit/test_association_acat.py -v` — all ACAT formula tests pass
2. `pytest tests/unit/test_association_diagnostics.py -v` — all diagnostics tests pass (including stage integration)
3. `pytest tests/unit/test_association_engine.py -v` — all engine tests pass (updated for ARCH-03)
4. `pytest tests/unit/ -x -q` — full unit suite passes, no regressions
5. `make ci-check` — linting, formatting, and type checking pass
</verification>

<success_criteria>
- ACAT Cauchy formula matches published reference values within tolerance
- Lambda_GC on uniform null p-values falls within [0.85, 1.15]
- Engine ACAT-O integration tests confirm columns, FDR strategy, and edge cases
- Stage-level diagnostics integration test confirms config-to-disk file output
- Full unit test suite passes with zero regressions
- CI checks pass (lint, format, typecheck)
</success_criteria>

<output>
After completion, create `.planning/phases/22-acat-o-and-diagnostics/22-03-SUMMARY.md`
</output>
