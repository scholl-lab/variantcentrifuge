---
phase: 22-acat-o-and-diagnostics
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - variantcentrifuge/association/tests/acat.py
  - variantcentrifuge/association/engine.py
  - variantcentrifuge/association/base.py
  - variantcentrifuge/association/tests/__init__.py
autonomous: true

must_haves:
  truths:
    - "ACAT-O p-value is computed per gene by combining burden + SKAT p-values via Cauchy formula"
    - "FDR correction is applied only to ACAT-O p-values across all genes, not per-test"
    - "Primary test p-values (fisher, burden, skat) have corrected_p_value=None in output"
    - "ACAT-O returns None when fewer than 2 non-None p-values exist for a gene"
    - "Genes with only 1 test p-value get acat_o_p_value = that p-value (pass-through per CONTEXT.md)"
  artifacts:
    - path: "variantcentrifuge/association/tests/acat.py"
      provides: "cauchy_combination() function and compute_acat_o() helper"
      contains: "cauchy.sf"
    - path: "variantcentrifuge/association/engine.py"
      provides: "_compute_acat_o() post-loop method, modified FDR to ACAT-O only"
      contains: "_compute_acat_o"
    - path: "variantcentrifuge/association/base.py"
      provides: "AssociationConfig with warning threshold fields"
      contains: "min_cases"
  key_links:
    - from: "variantcentrifuge/association/engine.py"
      to: "variantcentrifuge/association/tests/acat.py"
      via: "import cauchy_combination in _compute_acat_o"
      pattern: "from.*acat.*import.*cauchy_combination"
    - from: "variantcentrifuge/association/engine.py"
      to: "variantcentrifuge/association/correction.py"
      via: "apply_correction on acat_o p-values only"
      pattern: "apply_correction.*acat"
---

<objective>
Implement the ACAT Cauchy combination formula and integrate ACAT-O as a post-loop meta-test in the association engine, replacing per-test FDR with single ACAT-O FDR (ARCH-03).

Purpose: ACAT-O is the omnibus p-value that combines burden + SKAT results per gene into a single significance measure. Single FDR on ACAT-O is the statistically correct approach (not per-test FDR).

Output: `acat.py` with `cauchy_combination()`, engine.py with `_compute_acat_o()` and modified FDR strategy, AssociationConfig with warning threshold fields.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-acat-o-and-diagnostics/22-RESEARCH.md
@.planning/phases/22-acat-o-and-diagnostics/22-CONTEXT.md
@variantcentrifuge/association/engine.py
@variantcentrifuge/association/base.py
@variantcentrifuge/association/tests/__init__.py
@variantcentrifuge/association/correction.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: ACAT Cauchy combination module + AssociationConfig warning fields</name>
  <files>
    variantcentrifuge/association/tests/acat.py
    variantcentrifuge/association/base.py
    variantcentrifuge/association/tests/__init__.py
  </files>
  <action>
    Create `variantcentrifuge/association/tests/acat.py` with:

    1. `cauchy_combination(p_values, weights=None) -> float | None`:
       - Filter out None/NaN values from p_values array
       - If 0 valid p-values: return None
       - If 1 valid p-value: return that p-value (pass-through per CONTEXT.md decision)
       - Normalize weights (default: equal weights)
       - Filter out p >= 1.0 (non-informative), re-normalize weights after filtering
       - Edge case for p < 1e-16: use `1.0 / (p * np.pi)` instead of `np.tan((0.5 - p) * np.pi)` to avoid overflow (per Liu & Xie 2020)
       - Compute T = weighted sum of transformed p-values
       - Return `float(np.clip(cauchy.sf(T), 0.0, 1.0))`
       - Use `scipy.stats.cauchy` (already in deps)

    2. `compute_acat_o(test_p_values: dict[str, float | None]) -> float | None`:
       - Takes dict mapping test_name -> p_value (e.g. {"burden": 0.01, "skat": 0.05, "fisher": 0.03})
       - Collects non-None p-values
       - Calls `cauchy_combination()` with equal weights
       - Returns None if 0 valid inputs, pass-through if 1 input, combined if 2+

    Add module-level constant `_TINY_P_THRESHOLD = 1e-16`.

    Numerical verification (add as module docstring examples):
    - cauchy_combination([0.05, 0.05, 0.05]) approx 0.05
    - cauchy_combination([0.5, 0.5]) approx 0.5
    - cauchy_combination([0.001, 0.01, 0.05]) approx 0.00268

    Add to `variantcentrifuge/association/tests/__init__.py` lazy import block for acat (same pattern as other tests).

    In `variantcentrifuge/association/base.py`, add these fields to `AssociationConfig` after the existing `skat_method` field:
    ```python
    # Phase 22: ACAT-O + diagnostics fields
    min_cases: int = 200
    """Cohort-level warning threshold: warn if n_cases < this value."""

    max_case_control_ratio: float = 20.0
    """Cohort-level warning threshold: warn if n_controls/n_cases > this value."""

    min_case_carriers: int = 10
    """Per-gene warning threshold: flag genes with case_carriers < this value."""

    diagnostics_output: str | None = None
    """Path to diagnostics output directory. None = no diagnostics output."""
    ```
  </action>
  <verify>
    Run: `python -c "from variantcentrifuge.association.tests.acat import cauchy_combination, compute_acat_o; import numpy as np; p = cauchy_combination(np.array([0.05, 0.05, 0.05])); print(f'Equal inputs: {p:.4f}'); assert abs(p - 0.05) < 0.001; p2 = compute_acat_o({'burden': 0.01, 'skat': 0.05}); print(f'ACAT-O: {p2:.6f}'); assert p2 is not None and p2 < 0.05; p3 = compute_acat_o({'burden': None, 'skat': 0.05}); print(f'Single input: {p3}'); assert p3 == 0.05; print('All checks passed')"`
  </verify>
  <done>
    cauchy_combination() handles all edge cases (None, tiny p, single input, equal inputs).
    compute_acat_o() combines test p-values correctly.
    AssociationConfig has warning threshold fields.
  </done>
</task>

<task type="auto">
  <name>Task 2: Engine ACAT-O post-loop computation + FDR strategy change</name>
  <files>
    variantcentrifuge/association/engine.py
  </files>
  <action>
    Modify `variantcentrifuge/association/engine.py`:

    1. Add private method `_compute_acat_o(self, results_by_test, sorted_data) -> dict[str, TestResult]`:
       - For each gene in sorted_data, collect p-values from all tests in results_by_test
       - Call `compute_acat_o()` with dict of {test_name: p_value}
       - Create a TestResult for each gene with test_name="acat_o", p_value=combined, effect_size=None, se=None, ci_lower=None, ci_upper=None
       - Copy n_cases, n_controls, n_variants from the first available test result for that gene
       - Log INFO count of genes with valid ACAT-O p-values vs total genes
       - If no tests produced any p-values, log WARNING and return empty dict

    2. Modify `run_all()`:
       - REMOVE the existing per-test FDR correction loop (lines ~204-221 in current code) â€” this is the ARCH-03 breaking change
       - After the gene loop and finalize() calls, call `_compute_acat_o()` to get ACAT-O results
       - Store ACAT-O results in results_by_test["acat_o"]
       - Apply FDR correction ONLY to ACAT-O p-values:
         ```python
         acat_o_results = results_by_test.get("acat_o", {})
         testable_genes = [g for g in gene_order if acat_o_results.get(g) and acat_o_results[g].p_value is not None]
         if testable_genes:
             raw_pvals = [acat_o_results[g].p_value for g in testable_genes]
             corrected = apply_correction(raw_pvals, self._config.correction_method)
             for gene, corr_p in zip(testable_genes, corrected, strict=True):
                 acat_o_results[gene].corrected_p_value = float(corr_p)
         ```
       - Primary tests retain corrected_p_value=None (set during TestResult creation, never overwritten)

    3. Modify the DataFrame building section:
       - After building rows for primary tests, add ACAT-O columns:
         ```python
         if "acat_o" in results_by_test:
             acat_res = results_by_test["acat_o"].get(gene)
             if acat_res:
                 row["acat_o_p_value"] = acat_res.p_value
                 row["acat_o_corrected_p_value"] = acat_res.corrected_p_value
         ```
       - Update the significance summary log line to use acat_o_corrected_p_value instead of fisher_corrected_p_value

    4. Add import at top: `from variantcentrifuge.association.tests.acat import compute_acat_o`
       (lazy import inside _compute_acat_o to avoid import at module load)

    IMPORTANT: Do NOT register acat_o in _build_registry() or _TEST_REGISTRY. ACAT-O is a meta-test computed post-loop, not a primary test that runs in the gene loop. It should NOT be in the registry and NOT appear in from_names().
  </action>
  <verify>
    Run: `python -c "
from variantcentrifuge.association.engine import AssociationEngine
from variantcentrifuge.association.base import AssociationConfig
config = AssociationConfig(correction_method='fdr')
engine = AssociationEngine.from_names(['fisher'], config)
# Verify ACAT-O not in registry
try:
    AssociationEngine.from_names(['acat_o'], config)
    print('ERROR: acat_o should not be in registry')
except ValueError as e:
    print(f'Correctly rejected: {e}')
print('Engine construction OK')
"`
    Run existing tests: `pytest tests/unit/test_association_engine.py -x -q`
    Note: Some existing tests that assert `corrected_p_value is not None` for primary tests will now FAIL. This is expected (ARCH-03 breaking change). Update those test assertions to expect `corrected_p_value is None` for primary tests. The test file should be updated as part of this task to match the new FDR strategy.
  </verify>
  <done>
    Engine computes ACAT-O post-loop via _compute_acat_o().
    FDR applied only to ACAT-O p-values (ARCH-03).
    Primary test corrected_p_value is None.
    ACAT-O columns appear in output DataFrame.
    Existing engine tests updated and passing.
  </done>
</task>

</tasks>

<verification>
1. `cauchy_combination([0.05, 0.05, 0.05])` returns ~0.05 (equal inputs identity)
2. `cauchy_combination([0.001, 0.01, 0.05])` returns ~0.00268 (drives toward smallest)
3. `compute_acat_o({"burden": None, "skat": None})` returns None (no valid inputs)
4. `compute_acat_o({"burden": 0.05, "skat": None})` returns 0.05 (pass-through)
5. Engine with fisher test produces acat_o_p_value column in output DataFrame
6. Primary test columns have corrected_p_value=None
7. `pytest tests/unit/test_association_engine.py -x -q` passes with updated assertions
</verification>

<success_criteria>
- ACAT Cauchy combination formula matches published values (Liu & Xie 2020)
- ACAT-O p-values appear as acat_o_p_value and acat_o_corrected_p_value in engine output
- FDR is applied only to ACAT-O (not per-test) per ARCH-03
- No regressions in existing association tests (after updating corrected_p_value assertions)
</success_criteria>

<output>
After completion, create `.planning/phases/22-acat-o-and-diagnostics/22-01-SUMMARY.md`
</output>
