---
phase: 10-output-optimization
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - pyproject.toml
  - variantcentrifuge/converter.py
  - variantcentrifuge/stages/output_stages.py
  - tests/unit/test_converter_xlsxwriter.py
autonomous: true

must_haves:
  truths:
    - "Excel file is generated using xlsxwriter engine for initial write (2-5x faster)"
    - "openpyxl finalization still adds hyperlinks, freeze panes, and auto-filters to all sheets"
    - "Additional sheets (Metadata, Statistics, Gene Burden) are written by xlsxwriter, not openpyxl append mode"
    - "Output Excel file is functionally equivalent to current output (same data, working links, filters)"
  artifacts:
    - path: "variantcentrifuge/converter.py"
      provides: "Two-pass Excel generation: xlsxwriter bulk write + openpyxl finalization"
      contains: "engine='xlsxwriter'"
    - path: "pyproject.toml"
      provides: "xlsxwriter declared as dependency"
      contains: "xlsxwriter"
    - path: "tests/unit/test_converter_xlsxwriter.py"
      provides: "Tests verifying xlsxwriter output has hyperlinks, freeze panes, auto-filters"
      min_lines: 80
  key_links:
    - from: "variantcentrifuge/converter.py:convert_to_excel"
      to: "pd.ExcelWriter(engine='xlsxwriter')"
      via: "xlsxwriter engine parameter"
      pattern: "engine.*xlsxwriter"
    - from: "variantcentrifuge/converter.py:finalize_excel_file"
      to: "openpyxl.load_workbook"
      via: "second pass for formatting"
      pattern: "load_workbook"
    - from: "variantcentrifuge/converter.py:append_tsv_as_sheet"
      to: "xlsxwriter multi-sheet write"
      via: "write all sheets in single xlsxwriter pass OR openpyxl append after xlsxwriter close"
      pattern: "sheet_name"
---

<objective>
Implement two-pass Excel generation: xlsxwriter for fast bulk write, openpyxl for finalization only.

Purpose: Current Excel generation uses openpyxl exclusively which is 2-5x slower than xlsxwriter for write-heavy operations. Switching to xlsxwriter for the initial write while keeping openpyxl for finalization (hyperlinks, freeze panes, auto-filters) provides significant speedup on large variant sets (10K+ rows).

Output: Modified converter.py with xlsxwriter-based write, updated pyproject.toml dependency, tests proving functional equivalence.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-output-optimization/10-CONTEXT.md
@.planning/phases/10-output-optimization/10-RESEARCH.md

Key source files:
@variantcentrifuge/converter.py
@variantcentrifuge/stages/output_stages.py
@pyproject.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add xlsxwriter dependency and refactor convert_to_excel + append_tsv_as_sheet</name>
  <files>
    pyproject.toml
    variantcentrifuge/converter.py
  </files>
  <action>
1. Add `"xlsxwriter>=3.0"` to the dependencies list in pyproject.toml (alongside existing openpyxl).

2. Refactor `convert_to_excel()` in converter.py:
   - Change `df.to_excel(xlsx_file, index=False, sheet_name="Results")` to use xlsxwriter engine:
     ```python
     with pd.ExcelWriter(xlsx_file, engine='xlsxwriter') as writer:
         df.to_excel(writer, sheet_name='Results', index=False)
     ```
   - The `with` block ensures xlsxwriter flushes and closes the file before openpyxl opens it in finalize_excel_file().
   - Keep the existing igv_links column removal logic before writing.

3. Refactor `append_tsv_as_sheet()` in converter.py:
   - Current code opens an existing xlsx with openpyxl in append mode (`engine="openpyxl", mode="a"`). This is correct and MUST stay as openpyxl append mode because xlsxwriter cannot open existing files. xlsxwriter is write-only for new files.
   - However, optimize by using openpyxl's write_only mode if possible, or keep current approach since append is inherently an openpyxl operation.
   - Actually: The better optimization is to collect ALL sheet data upfront and write them all in a single xlsxwriter pass. But this requires changing the call pattern in ExcelReportStage._add_additional_sheets(). This is a more invasive change.
   - **Decision**: Keep append_tsv_as_sheet using openpyxl append mode for now. The main speedup comes from the Results sheet (largest sheet by far). Metadata/Statistics/Gene Burden sheets are tiny. The two-pass strategy already gives us the primary speedup.

4. Ensure finalize_excel_file() still works correctly after xlsxwriter writes the file. Key concern: xlsxwriter and openpyxl use slightly different internal OOXML structures. Verify that openpyxl.load_workbook() can read xlsxwriter-generated files (this is a well-known compatible path per research).

5. The regex `pattern = re.compile(r"([^()]+)\(([^)]+)\)")` at line 286 inside the loop should be moved to module level as a constant since it's recompiled on every row. Add at module level:
   ```python
   GT_PATTERN = re.compile(r"([^()]+)\(([^)]+)\)")
   ```
   Update both usages in finalize_excel_file (line 286) and produce_report_json (line 425) to use the module-level constant.
  </action>
  <verify>
    - `python -c "import xlsxwriter; print(xlsxwriter.__version__)"` succeeds
    - `python -c "from variantcentrifuge.converter import convert_to_excel, finalize_excel_file; print('imports ok')"` succeeds
    - `make lint` passes
    - `pytest tests/unit/ -x -q --no-header` passes (existing tests still work)
  </verify>
  <done>
    - convert_to_excel uses xlsxwriter engine via pd.ExcelWriter
    - GT_PATTERN compiled once at module level, used in both finalize_excel_file and produce_report_json
    - xlsxwriter in pyproject.toml dependencies
    - All existing tests pass
  </done>
</task>

<task type="auto">
  <name>Task 2: Add tests for xlsxwriter Excel output fidelity</name>
  <files>
    tests/unit/test_converter_xlsxwriter.py
  </files>
  <action>
Create test file `tests/unit/test_converter_xlsxwriter.py` with tests verifying the two-pass Excel generation produces functionally equivalent output:

1. `test_convert_to_excel_uses_xlsxwriter()` - Creates a small synthetic DataFrame, calls convert_to_excel(), opens result with openpyxl and verifies:
   - Sheet "Results" exists
   - All data rows present
   - Column headers match

2. `test_finalize_adds_freeze_panes()` - Creates Excel via convert_to_excel(), calls finalize_excel_file(), verifies:
   - `ws.freeze_panes == "A2"` for all sheets

3. `test_finalize_adds_auto_filter()` - Same setup, verifies:
   - `ws.auto_filter.ref` is set and spans full column range

4. `test_finalize_adds_hyperlinks()` - Creates DataFrame with URL columns (e.g., columns containing "https://..." values), calls convert_to_excel() then finalize_excel_file(), verifies:
   - Cells in URL columns have `cell.hyperlink` set
   - Cell style is "Hyperlink"

5. `test_append_tsv_as_sheet()` - Creates Excel, appends a metadata TSV, verifies:
   - Both "Results" and "Metadata" sheets exist
   - Data in Metadata sheet matches input

6. `test_empty_dataframe_handling()` - Empty DataFrame produces valid Excel with headers only.

Use `tmp_path` fixture for temp files. Create minimal config dicts as needed (empty links dict for basic tests, link templates for hyperlink test). Mark all tests with `@pytest.mark.unit`.
  </action>
  <verify>
    `pytest tests/unit/test_converter_xlsxwriter.py -v` passes all tests
  </verify>
  <done>
    - 6+ tests covering xlsxwriter output, freeze panes, auto-filters, hyperlinks, sheet append, empty DataFrame
    - All tests pass and prove functional equivalence of two-pass approach
  </done>
</task>

</tasks>

<verification>
- `make ci-check` passes (lint, format, typecheck, tests)
- Excel files generated by convert_to_excel open correctly in openpyxl
- finalize_excel_file successfully adds formatting to xlsxwriter-generated files
- No regressions in existing converter tests
</verification>

<success_criteria>
- convert_to_excel uses xlsxwriter engine (grep confirms `engine='xlsxwriter'`)
- GT_PATTERN compiled once at module level (not inside loops)
- xlsxwriter in pyproject.toml
- All unit tests pass including new fidelity tests
- Functional equivalence: freeze panes, auto-filters, hyperlinks all verified by tests
</success_criteria>

<output>
After completion, create `.planning/phases/10-output-optimization/10-01-SUMMARY.md`
</output>
