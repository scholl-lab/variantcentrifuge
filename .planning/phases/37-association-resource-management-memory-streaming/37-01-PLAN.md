---
phase: 37-association-resource-management-memory-streaming
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - variantcentrifuge/pipeline_core/context.py
  - variantcentrifuge/pipeline.py
  - variantcentrifuge/stages/analysis_stages.py
  - variantcentrifuge/inheritance/parallel_analyzer.py
  - tests/unit/test_pipeline_context_resource_manager.py
autonomous: true

must_haves:
  truths:
    - "No stage creates its own ResourceManager instance — all use context.resource_manager"
    - "ResourceManager is initialized exactly once per pipeline run, in pipeline.py"
    - "Tests that use PipelineContext can mock or override resource_manager"
    - "Fallback exists for contexts without resource_manager (e.g., tests, edge cases)"
  artifacts:
    - path: "variantcentrifuge/pipeline_core/context.py"
      provides: "resource_manager field on PipelineContext"
      contains: "resource_manager"
    - path: "variantcentrifuge/pipeline.py"
      provides: "One-time ResourceManager initialization"
      contains: "ResourceManager"
    - path: "tests/unit/test_pipeline_context_resource_manager.py"
      provides: "Tests for shared ResourceManager"
  key_links:
    - from: "variantcentrifuge/pipeline.py"
      to: "variantcentrifuge/pipeline_core/context.py"
      via: "context.resource_manager = ResourceManager(config=...)"
      pattern: "context\\.resource_manager"
    - from: "variantcentrifuge/stages/analysis_stages.py"
      to: "variantcentrifuge/pipeline_core/context.py"
      via: "context.resource_manager access with fallback"
      pattern: "context\\.resource_manager"
---

<objective>
Add a single shared ResourceManager to PipelineContext so all stages use one instance instead of creating their own (PERF-04).

Purpose: Eliminates 7 redundant ResourceManager instantiations (each calling psutil.virtual_memory() and reading env vars), ensures consistent resource detection across all stages, and establishes the single source of truth for memory/CPU allocation decisions.

Output: PipelineContext has a `resource_manager` field initialized once in pipeline.py; all stage-local instantiations replaced with context access + fallback.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/37-association-resource-management-memory-streaming/37-RESEARCH.md

@variantcentrifuge/pipeline_core/context.py
@variantcentrifuge/pipeline.py
@variantcentrifuge/stages/analysis_stages.py
@variantcentrifuge/inheritance/parallel_analyzer.py
@variantcentrifuge/memory/resource_manager.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add resource_manager field to PipelineContext and initialize in pipeline.py</name>
  <files>
    variantcentrifuge/pipeline_core/context.py
    variantcentrifuge/pipeline.py
  </files>
  <action>
1. In `variantcentrifuge/pipeline_core/context.py`:
   - The file already has `from typing import TYPE_CHECKING` and a `if TYPE_CHECKING:` block (line 14/18). Add to that block: `from ..memory.resource_manager import ResourceManager`
   - Add field to the PipelineContext dataclass, after `checkpoint_state` (line 168) and before the `_lock` field:
     ```python
     # Shared resource manager for memory/CPU allocation (Fix 4)
     resource_manager: "ResourceManager | None" = None
     ```
   - Do NOT add `resource_manager` to the `merge_from()` method — the parent context's instance must not be overwritten by parallel contexts. The field being absent from merge_from is correct behavior.

2. In `variantcentrifuge/pipeline.py`:
   - After line 527 (`context = PipelineContext(args=args, config=initial_config, workspace=workspace)`), add:
     ```python
     # Fix 4: Initialize shared ResourceManager once for all stages
     from .memory import ResourceManager
     context.resource_manager = ResourceManager(config=initial_config)
     ```
   - This must come BEFORE the checkpoint initialization block (line 530).

Note: `cli.py` (line 1445, --threads auto) and `filters.py` (line 53, SnpSift memory) create ResourceManager BEFORE pipeline.py runs (during CLI arg resolution). These are correctly outside PipelineContext scope — do NOT change them. They run before context exists.
  </action>
  <verify>
    `python -c "from variantcentrifuge.pipeline_core.context import PipelineContext; assert 'resource_manager' in PipelineContext.__dataclass_fields__"`
  </verify>
  <done>PipelineContext has resource_manager field defaulting to None; pipeline.py initializes it once after context creation.</done>
</task>

<task type="auto">
  <name>Task 2: Replace local ResourceManager instantiations with context access</name>
  <files>
    variantcentrifuge/stages/analysis_stages.py
    variantcentrifuge/inheritance/parallel_analyzer.py
    tests/unit/test_pipeline_context_resource_manager.py
  </files>
  <action>
1. In `variantcentrifuge/stages/analysis_stages.py`, replace ALL 4 local ResourceManager instantiations with a context access pattern. At each location, replace:
   ```python
   from ..memory import ResourceManager
   rm = ResourceManager(config=context.config)
   ```
   with:
   ```python
   rm = context.resource_manager
   if rm is None:
       from ..memory import ResourceManager
       rm = ResourceManager(config=context.config)
   ```

   The 4 locations are:
   - Line ~930 (InheritanceAnalysisStage._process)
   - Line ~3031 (ChunkedInheritanceAnalysisStage._prepare_chunked_processing)
   - Lines ~3489-3491 (ChunkedInheritanceAnalysisStage._calculate_chunk_size)
   - Lines ~3761 (ChunkedInheritanceAnalysisStage._process_chunk)

   Remove the `from ..memory import ResourceManager` import at each location ONLY if it's a local import. Keep it in the fallback branch. The fallback ensures backward compatibility when context.resource_manager is None (e.g., in unit tests that create PipelineContext directly without pipeline.py initialization).

2. In `variantcentrifuge/inheritance/parallel_analyzer.py` (line ~189):
   This function receives no PipelineContext — it gets a DataFrame directly. It should keep its own ResourceManager instantiation. Do NOT change this file. (It's called from InheritanceAnalysisStage which already has the shared rm, but parallel_analyzer creates its own for a different purpose — deciding whether to parallelize internally.)

3. Create `tests/unit/test_pipeline_context_resource_manager.py`:
   - Test that PipelineContext accepts resource_manager=None (default)
   - Test that PipelineContext accepts a ResourceManager instance
   - Test that merge_from does NOT overwrite resource_manager on the parent
   - Test the fallback pattern: when resource_manager is None, stages can still create a local one

   Use minimal PipelineContext construction (mock args, config, workspace) following patterns in existing tests.
  </action>
  <verify>
    `cd /mnt/c/development/scholl-lab/variantcentrifuge && python -m pytest tests/unit/test_pipeline_context_resource_manager.py -v && make lint`
  </verify>
  <done>
    All 4 local ResourceManager instantiations in analysis_stages.py use context.resource_manager with fallback. parallel_analyzer.py unchanged (no context access). Tests pass. No lint errors.
  </done>
</task>

</tasks>

<verification>
1. `grep -rn "ResourceManager(config=" variantcentrifuge/stages/analysis_stages.py` should show ONLY fallback lines (inside `if rm is None:` blocks), NOT standalone instantiations
2. `grep -n "resource_manager" variantcentrifuge/pipeline_core/context.py` shows the field definition
3. `grep -n "resource_manager" variantcentrifuge/pipeline.py` shows the initialization
4. `python -m pytest tests/unit/test_pipeline_context_resource_manager.py -v` passes
5. `make ci-check` passes
</verification>

<success_criteria>
- PipelineContext has resource_manager field (Optional, defaults to None)
- pipeline.py initializes ResourceManager once after context creation
- All 4 analysis_stages.py locations use context.resource_manager with fallback
- merge_from does not touch resource_manager
- cli.py and filters.py unchanged (correct — they run before context exists)
- parallel_analyzer.py unchanged (correct — no context access)
- All existing tests pass; new unit tests verify the pattern
</success_criteria>

<output>
After completion, create `.planning/phases/37-association-resource-management-memory-streaming/37-01-SUMMARY.md`
</output>
