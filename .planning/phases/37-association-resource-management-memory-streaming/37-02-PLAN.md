---
phase: 37-association-resource-management-memory-streaming
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - variantcentrifuge/stages/analysis_stages.py
  - variantcentrifuge/gene_burden.py
  - tests/unit/test_gt_lifecycle.py
autonomous: true

must_haves:
  truths:
    - "Per-sample GEN_N__GT columns survive through all analysis stages and reach output stages intact"
    - "VariantAnalysisStage reconstructs GT only on a local copy for its temp TSV — context.current_dataframe retains per-sample columns"
    - "GeneBurdenAnalysisStage reconstructs GT only on a local copy — context.current_dataframe retains per-sample columns"
    - "AssociationAnalysisStage finds per-sample GT columns directly on context.current_dataframe — no recovery from context.variants_df needed"
    - "AssociationAnalysisStage does NOT write back to context.current_dataframe (line 2424 removed)"
    - "TSVOutputStage and ExcelReportStage still reconstruct GT at output time (unchanged, already correct)"
    - "The duplicate _find_gt_columns in gene_burden.py is removed; all callers use _find_per_sample_gt_columns from output_stages.py"
  artifacts:
    - path: "variantcentrifuge/stages/analysis_stages.py"
      provides: "GT lifecycle cleanup in VariantAnalysis, GeneBurden, and Association stages"
    - path: "variantcentrifuge/gene_burden.py"
      provides: "Removed duplicate _find_gt_columns; uses import from output_stages"
    - path: "tests/unit/test_gt_lifecycle.py"
      provides: "Tests verifying per-sample GT columns persist through analysis stages"
  key_links:
    - from: "variantcentrifuge/stages/analysis_stages.py (VariantAnalysisStage)"
      to: "variantcentrifuge/stages/output_stages.py (reconstruct_gt_column)"
      via: "local copy only for temp TSV, not stored back to context"
      pattern: "df_for_tsv.*reconstruct_gt_column"
    - from: "variantcentrifuge/stages/analysis_stages.py (AssociationAnalysisStage)"
      to: "variantcentrifuge/stages/output_stages.py (_find_per_sample_gt_columns)"
      via: "direct access to per-sample columns on context.current_dataframe"
      pattern: "_find_per_sample_gt_columns"
---

<objective>
Eliminate the GT column drop/recover antipattern so per-sample genotype columns flow cleanly through all analysis stages (PERF-05).

Purpose: Currently, VariantAnalysisStage and GeneBurdenAnalysisStage call reconstruct_gt_column() which DROPS per-sample GEN_N__GT columns and packs them into a single GT string. AssociationAnalysisStage then desperately tries to recover the per-sample columns from context.variants_df (a 16 GB DataFrame duplicate). This fix ensures per-sample columns are NEVER dropped from context.current_dataframe — reconstruction happens only on local copies for functions that need the packed format.

Output: Per-sample GT columns persist from DataFrameLoadingStage through all analysis stages to output stages. The context.variants_df recovery fallback in AssociationAnalysisStage is removed. The duplicate `_find_gt_columns` in gene_burden.py is consolidated.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/37-association-resource-management-memory-streaming/37-RESEARCH.md

@variantcentrifuge/stages/analysis_stages.py
@variantcentrifuge/stages/output_stages.py
@variantcentrifuge/gene_burden.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix VariantAnalysisStage, GeneBurdenAnalysisStage, and AssociationAnalysisStage to preserve per-sample GT columns</name>
  <files>
    variantcentrifuge/stages/analysis_stages.py
  </files>
  <action>
THREE stages need changes. Each has ONE clear approach described below.

**A. VariantAnalysisStage._process() (lines ~1461-1627):**

The current code at lines 1464-1471 reconstructs GT on `df` in-place (via copy), then uses that `df` for BOTH the temp TSV AND the merge-back. The problem: after reconstruct, per-sample GEN_N__GT columns are gone.

Fix approach -- use key-column merge to re-attach per-sample GT columns after analysis:

1. At the top of `_process()`, BEFORE any GT reconstruction, save per-sample GT columns:
   ```python
   from ..stages.output_stages import _find_per_sample_gt_columns, reconstruct_gt_column
   _original_gt_cols = _find_per_sample_gt_columns(df)
   if _original_gt_cols:
       # Save per-sample GT columns keyed by variant identity for later re-attachment
       _key_cols_for_gt = [c for c in ["CHROM", "POS", "REF", "ALT", "GENE"] if c in df.columns]
       _gt_backup = df[_key_cols_for_gt + _original_gt_cols].copy()
   ```

2. Leave the existing reconstruct + temp TSV + analyze_variants + merge logic (lines 1464-1627) COMPLETELY UNCHANGED. Do not refactor the merge. The existing code works correctly for producing analysis_df.

3. After `context.current_dataframe = analysis_df` (line 1627), re-attach per-sample GT columns using a KEY-COLUMN MERGE (not positional alignment):
   ```python
   # Fix 5: Re-attach per-sample GT columns that were dropped during
   # reconstruct_gt_column. Use key-column merge for safety (handles
   # row reordering/filtering by analyze_variants).
   if _original_gt_cols and not _find_per_sample_gt_columns(context.current_dataframe):
       # Build merge keys -- use sanitized names if column_rename_map active
       _merge_keys = _key_cols_for_gt
       if context.column_rename_map:
           _merge_keys = [context.column_rename_map.get(k, k) for k in _key_cols_for_gt]
           _gt_backup = _gt_backup.rename(columns=context.column_rename_map)
       # Only merge if key columns exist in both DataFrames
       _keys_in_result = [k for k in _merge_keys if k in context.current_dataframe.columns and k in _gt_backup.columns]
       if _keys_in_result:
           context.current_dataframe = context.current_dataframe.merge(
               _gt_backup, on=_keys_in_result, how="left", suffixes=("", "_gt_dup"),
           )
           # Drop any duplicate columns created by merge
           _dup_cols = [c for c in context.current_dataframe.columns if c.endswith("_gt_dup")]
           if _dup_cols:
               context.current_dataframe = context.current_dataframe.drop(columns=_dup_cols)
           logger.info(f"Re-attached {len(_original_gt_cols)} per-sample GT columns via key merge")
       else:
           logger.warning("Cannot re-attach per-sample GT columns: no matching key columns")
   ```

This approach is safe because: (a) it uses CHROM/POS/REF/ALT/GENE as merge keys, which uniquely identify variants, (b) it handles row filtering/reordering by analyze_variants, (c) it leaves the existing merge logic untouched.

**B. GeneBurdenAnalysisStage._process() (lines ~1827-1835):**

Current code reconstructs GT and writes back to context:
```python
if "GT" not in df.columns and context.vcf_samples:
    gt_cols = _find_per_sample_gt_columns(df)
    if gt_cols:
        df = reconstruct_gt_column(df.copy(), context.vcf_samples)
        context.current_dataframe = df  # <-- drops per-sample cols from context
```

Change to reconstruct on a LOCAL copy only:
```python
df_for_burden = df
if "GT" not in df.columns and context.vcf_samples:
    from ..stages.output_stages import _find_per_sample_gt_columns, reconstruct_gt_column
    gt_cols = _find_per_sample_gt_columns(df)
    if gt_cols:
        logger.info("Reconstructing GT column for gene burden analysis (local copy only)")
        df_for_burden = reconstruct_gt_column(df.copy(), context.vcf_samples)
```

Then use `df_for_burden` (not `df`) in the `if "GT" not in df_for_burden.columns:` check at line 1837 and pass it to `perform_gene_burden_analysis`. Do NOT assign `df_for_burden` back to `context.current_dataframe`. Search the rest of GeneBurdenAnalysisStage._process() for any `context.current_dataframe = df` and ensure per-sample columns are preserved.

**C. AssociationAnalysisStage._process() (lines ~2404-2446):**

TWO changes needed:

1. **CRITICAL: Remove `context.current_dataframe = df` at line 2424.** This line is the ROOT CAUSE of the GT column drop for downstream stages. AssociationAnalysisStage must NOT update context.current_dataframe with the reconstructed (packed GT) DataFrame. Delete this entire line. The reconstructed `df` is only needed locally for aggregation functions.

2. Replace the entire recovery fallback (lines 2404-2446) with direct access:
   ```python
   # Fix 5: Per-sample GT columns are now always present in context.current_dataframe.
   # No reconstruction or recovery from context.variants_df needed.
   from ..stages.output_stages import _find_per_sample_gt_columns, reconstruct_gt_column

   needs_regression = any(
       t in test_names
       for t in ("logistic_burden", "linear_burden", "skat", "skat_python", "coast")
   )

   # Per-sample GT columns are directly available (Fix 5 preserves them)
   df_with_per_sample_gt: pd.DataFrame | None = None
   gt_cols = _find_per_sample_gt_columns(df)
   if needs_regression and gt_cols:
       df_with_per_sample_gt = df

   # Reconstruct packed GT for aggregation functions that need it (local copy)
   if "GT" not in df.columns and context.vcf_samples:
       if gt_cols:
           logger.info("Reconstructing GT column for association aggregation (local copy only)")
           df = reconstruct_gt_column(df.copy(), context.vcf_samples)
   # DO NOT assign df back to context.current_dataframe — per-sample cols must be preserved
   ```

   Note: The `df` variable after reconstruct is used for gene burden aggregation (the `_aggregate_gene_burden_from_columns` / `_aggregate_gene_burden_from_gt` calls downstream). The `df_with_per_sample_gt` is used for genotype matrix building. This preserves the existing two-path pattern but eliminates the context.variants_df recovery.

   Also check for any OTHER `context.current_dataframe = df` later in AssociationAnalysisStage._process() and ensure they do not overwrite per-sample columns. If the stage updates context.current_dataframe at the end (e.g., to add association result columns), that is fine as long as it starts from the original df (with per-sample cols), not the reconstructed one.
  </action>
  <verify>
    `cd /mnt/c/development/scholl-lab/variantcentrifuge && python -m pytest tests/ -m "not slow and not integration" -x -q 2>&1 | tail -20`
  </verify>
  <done>
    VariantAnalysisStage reconstructs GT on local copy only; per-sample cols survive in context.current_dataframe via key-column merge. GeneBurdenAnalysisStage reconstructs GT on local copy only. AssociationAnalysisStage accesses per-sample cols directly without recovery fallback. Line 2424 (`context.current_dataframe = df`) removed.
  </done>
</task>

<task type="auto">
  <name>Task 2: Consolidate duplicate _find_gt_columns and add GT lifecycle tests</name>
  <files>
    variantcentrifuge/stages/analysis_stages.py
    variantcentrifuge/gene_burden.py
    tests/unit/test_gt_lifecycle.py
  </files>
  <action>
1. **Consolidate _find_gt_columns:**

   In `variantcentrifuge/gene_burden.py`:
   - Remove the `_find_gt_columns` function (lines 316-329).
   - Add import at the top: `from .stages.output_stages import _find_per_sample_gt_columns as _find_gt_columns`
   - This preserves the name for internal callers within gene_burden.py.

   In `variantcentrifuge/stages/analysis_stages.py`:
   - The file imports `_find_gt_columns` from `..gene_burden` at line 30. Change this to import from `..stages.output_stages`:
     ```python
     from ..stages.output_stages import _find_per_sample_gt_columns
     ```
   - Replace all uses of `_find_gt_columns(...)` (lines 2549, 2592) with `_find_per_sample_gt_columns(...)`.
   - Remove `_find_gt_columns` from the gene_burden import line (line 30).

   Check for any other imports of `_find_gt_columns` from gene_burden.py in the codebase. If found, update them to use `_find_per_sample_gt_columns` from output_stages.py.

2. **Create GT lifecycle tests** in `tests/unit/test_gt_lifecycle.py`:

   Test the core invariant: per-sample GT columns persist through analysis stages.

   ```python
   """Tests for GT column lifecycle through analysis stages (Fix 5)."""
   import pandas as pd
   import pytest

   from variantcentrifuge.stages.output_stages import (
       _find_per_sample_gt_columns,
       reconstruct_gt_column,
   )


   class TestFindPerSampleGtColumns:
       """Verify the canonical GT column finder works for both name formats."""

       def test_sanitized_names(self):
           df = pd.DataFrame({"GEN_0__GT": ["0/1"], "GEN_1__GT": ["1/1"], "GENE": ["A"]})
           assert _find_per_sample_gt_columns(df) == ["GEN_0__GT", "GEN_1__GT"]

       def test_original_names(self):
           df = pd.DataFrame({"GEN[0].GT": ["0/1"], "GEN[1].GT": ["1/1"], "GENE": ["A"]})
           assert _find_per_sample_gt_columns(df) == ["GEN[0].GT", "GEN[1].GT"]

       def test_no_gt_columns(self):
           df = pd.DataFrame({"GENE": ["A"], "CHROM": ["1"]})
           assert _find_per_sample_gt_columns(df) == []

       def test_sorted_by_index(self):
           df = pd.DataFrame({"GEN_10__GT": ["0/1"], "GEN_2__GT": ["1/1"], "GEN_0__GT": ["0/0"]})
           assert _find_per_sample_gt_columns(df) == ["GEN_0__GT", "GEN_2__GT", "GEN_10__GT"]


   class TestReconstructGtColumnLocalCopy:
       """Verify that reconstruct_gt_column on a copy does not affect the original."""

       def test_original_preserved(self):
           df = pd.DataFrame({
               "GEN_0__GT": ["0/1", "1/1"],
               "GEN_1__GT": ["0/0", "0/1"],
               "GENE": ["A", "B"],
           })
           original_cols = set(df.columns)

           # Reconstruct on a copy (the Fix 5 pattern)
           reconstructed = reconstruct_gt_column(df.copy(), ["Sample1", "Sample2"])

           # Original unchanged
           assert set(df.columns) == original_cols
           assert "GEN_0__GT" in df.columns
           assert "GEN_1__GT" in df.columns

           # Reconstructed has packed GT, no per-sample cols
           assert "GT" in reconstructed.columns
           assert "GEN_0__GT" not in reconstructed.columns


   class TestGtColumnsConsolidation:
       """Verify _find_gt_columns from gene_burden uses the same canonical implementation."""

       def test_gene_burden_find_gt_is_same_function(self):
           from variantcentrifuge.gene_burden import _find_gt_columns
           # After consolidation, _find_gt_columns should be the same as _find_per_sample_gt_columns
           df = pd.DataFrame({"GEN_0__GT": ["0/1"], "GEN_1__GT": ["1/1"]})
           assert _find_gt_columns(df) == _find_per_sample_gt_columns(df)
   ```

   Mark tests with `@pytest.mark.unit`.
  </action>
  <verify>
    `cd /mnt/c/development/scholl-lab/variantcentrifuge && python -m pytest tests/unit/test_gt_lifecycle.py -v && make lint`
  </verify>
  <done>
    _find_gt_columns is consolidated to a single implementation in output_stages.py. All callers updated. GT lifecycle tests pass. Lint clean.
  </done>
</task>

</tasks>

<verification>
1. `grep -rn "reconstruct_gt_column" variantcentrifuge/stages/analysis_stages.py` — each call should be followed by "local copy" pattern, never `context.current_dataframe = df` on the reconstructed version
2. `grep -rn "context.variants_df" variantcentrifuge/stages/analysis_stages.py` — should NOT appear in recovery/fallback patterns (only in existing checkpoint-related code if any)
3. `grep -n "context.current_dataframe = df" variantcentrifuge/stages/analysis_stages.py` — the line at ~2424 in AssociationAnalysisStage must NOT exist
4. `grep -rn "def _find_gt_columns" variantcentrifuge/` — should only appear in gene_burden.py as a re-export, not as a duplicate implementation
5. `python -m pytest tests/unit/test_gt_lifecycle.py -v` passes
6. `python -m pytest tests/ -m "not slow and not integration" -x -q` passes (no regressions)
7. `make ci-check` passes
</verification>

<success_criteria>
- Per-sample GT columns (GEN_N__GT) survive through VariantAnalysisStage, GeneBurdenAnalysisStage, and AssociationAnalysisStage
- reconstruct_gt_column is called only on LOCAL COPIES in analysis stages, never stored back to context.current_dataframe
- The `context.current_dataframe = df` at line 2424 in AssociationAnalysisStage is removed
- The context.variants_df recovery fallback in AssociationAnalysisStage is removed
- VariantAnalysisStage re-attaches per-sample GT columns via key-column merge (CHROM/POS/REF/ALT/GENE), not positional alignment
- _find_gt_columns consolidated to single implementation (output_stages._find_per_sample_gt_columns)
- All existing tests pass with no regressions
</success_criteria>

<output>
After completion, create `.planning/phases/37-association-resource-management-memory-streaming/37-02-SUMMARY.md`
</output>
