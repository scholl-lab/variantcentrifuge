---
phase: 12-parallelization-chunking
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - variantcentrifuge/memory/resource_manager.py
  - variantcentrifuge/memory/__init__.py
  - variantcentrifuge/cli.py
  - tests/unit/memory/test_resource_manager.py
  - tests/unit/memory/__init__.py
autonomous: true

must_haves:
  truths:
    - "Pipeline-wide resource manager detects available memory from CLI, SLURM, PBS, cgroups v1/v2, and psutil fallback"
    - "Resource manager calculates optimal chunk sizes based on variant count, sample count, and available memory"
    - "Resource manager calculates optimal worker count based on CPU cores and memory constraints"
    - "Dead CLI flags removed: --chunks, --vectorized-chunk-size, --genotype-replacement-chunk-size"
    - "Resource manager is pipeline-wide (not inheritance-specific) and usable by any stage"
  artifacts:
    - path: "variantcentrifuge/memory/resource_manager.py"
      provides: "Pipeline-wide resource detection and auto-tuning"
      exports: ["ResourceManager"]
    - path: "tests/unit/memory/test_resource_manager.py"
      provides: "Unit tests for resource manager"
      min_lines: 100
  key_links:
    - from: "variantcentrifuge/memory/resource_manager.py"
      to: "psutil"
      via: "memory and CPU detection"
      pattern: "psutil\\.virtual_memory|psutil\\.cpu_count"
    - from: "variantcentrifuge/memory/__init__.py"
      to: "resource_manager.py"
      via: "public export"
      pattern: "from .resource_manager import ResourceManager"
---

<objective>
Create a pipeline-wide resource manager to replace the inheritance-specific InheritanceMemoryManager, and remove dead CLI flags that are no longer used after Phase 11's pipeline transformation.

Purpose: The current InheritanceMemoryManager is tightly coupled to inheritance analysis. Phase 12 CONTEXT requires a pipeline-wide module usable by any stage. Dead CLI flags (--chunks, --vectorized-chunk-size, --genotype-replacement-chunk-size) reference eliminated functionality and confuse users.

Output: New ResourceManager module with comprehensive tests, cleaned CLI interface.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-parallelization-chunking/12-CONTEXT.md
@.planning/phases/12-parallelization-chunking/12-RESEARCH.md
@variantcentrifuge/memory/inheritance_memory_manager.py
@variantcentrifuge/memory/__init__.py
@variantcentrifuge/cli.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create pipeline-wide ResourceManager</name>
  <files>
    variantcentrifuge/memory/resource_manager.py
    variantcentrifuge/memory/__init__.py
  </files>
  <action>
Create `variantcentrifuge/memory/resource_manager.py` with a `ResourceManager` class that generalizes `InheritanceMemoryManager` for pipeline-wide use.

**Port and improve from InheritanceMemoryManager:**
1. Memory detection hierarchy (same priority order): CLI `--max-memory-gb` > SLURM_MEM_PER_NODE > PBS_RESC_MEM > cgroup v1/v2 > psutil fallback
2. For cgroup v2, also check `/sys/fs/cgroup/memory.max` and handle the "max" string value (unlimited)
3. CPU detection: `psutil.cpu_count(logical=False)` with fallback to `os.cpu_count()` or 4
4. Chunk size calculation: generalize from inheritance-specific to accept configurable `overhead_factor` parameter (default 3.0 for backwards compat)
5. Worker count calculation: `min(memory_constraint, cpu_cores, task_count)`
6. Small dataset threshold: configurable `min_items_for_parallel` parameter (default 100)

**New features NOT in InheritanceMemoryManager:**
1. `auto_workers(task_count, memory_per_task_gb)` method — returns optimal worker count
2. `auto_chunk_size(total_items, num_samples, bytes_per_item=8)` method — returns optimal chunk size
3. `should_parallelize(total_items)` method — returns bool based on min_items_for_parallel threshold
4. `get_summary() -> dict` method — returns dict with detected resources for logging
5. Log all auto-detected values at INFO level on init: "ResourceManager: {cpu_cores} CPUs, {memory_gb:.1f}GB available ({source})"

**Design principles:**
- Stateless methods (detect once at init, reuse)
- No inheritance-specific constants (overhead_factor is a parameter, not hardcoded)
- Thread-safe (no mutable state after init)
- `memory_safety_factor` parameter (default 0.85, was 0.92 * 0.85 = 0.782 effective in old code — use 0.80 as single factor for simplicity)

**Update `__init__.py`:**
- Add `from .resource_manager import ResourceManager`
- Keep `from .inheritance_memory_manager import InheritanceMemoryManager` for now (will be removed in Plan 02 after consumers are migrated)
  </action>
  <verify>
    `python -c "from variantcentrifuge.memory import ResourceManager; rm = ResourceManager(); print(rm.get_summary())"` runs without error and prints detected resources.
  </verify>
  <done>
    ResourceManager class exists with memory detection, CPU detection, chunk size calculation, worker count calculation, and small-dataset threshold. Exported from variantcentrifuge.memory.
  </done>
</task>

<task type="auto">
  <name>Task 2: Remove dead CLI flags and add ResourceManager tests</name>
  <files>
    variantcentrifuge/cli.py
    tests/unit/memory/__init__.py
    tests/unit/memory/test_resource_manager.py
  </files>
  <action>
**Remove dead CLI flags from cli.py:**
1. Remove `--chunks` argument (line ~753, only used for legacy file processing that's now dead)
2. Remove `--vectorized-chunk-size` argument (line ~591, genotype replacement eliminated in Phase 11)
3. Remove `--genotype-replacement-chunk-size` argument (line ~746, same reason)
4. Remove corresponding config mappings in the config building section (lines ~1301-1312): `cfg["chunks"]`, `cfg["vectorized_chunk_size"]`, `cfg["genotype_replacement_chunk_size"]`
5. Verify: grep the ENTIRE codebase for any remaining references to these config keys in production code. If `config["chunks"]` is used in `analysis_stages.py:677` and `analysis_stages.py:2222`, those references need updating:
   - Line 677: `if context.config.get("chunks"):` — this should be removed or replaced with auto-detection logic (defer to Plan 02)
   - Line 2222: `chunk_size = context.config.get("chunks") or 10000` — replace with auto-detection (defer to Plan 02)
   - For NOW: set default chunk_size to 10000 where `config.get("chunks")` was used, so removal doesn't break anything. Add TODO comment referencing Plan 02.

**Create test directory and tests:**
1. Create `tests/unit/memory/__init__.py` (empty)
2. Create `tests/unit/memory/test_resource_manager.py` with comprehensive tests:

Test cases (use `monkeypatch` for environment detection):
- `test_memory_detection_cli_override`: Set config `max_memory_gb=16`, verify returns 16.0
- `test_memory_detection_slurm`: Set `SLURM_MEM_PER_NODE=32768`, verify returns 32.0 GB
- `test_memory_detection_pbs_gb`: Set `PBS_RESC_MEM=16gb`, verify returns 16.0
- `test_memory_detection_pbs_mb`: Set `PBS_RESC_MEM=16000mb`, verify returns ~15.6
- `test_memory_detection_fallback`: No env vars, verify uses psutil (returns > 0)
- `test_cpu_detection`: Verify returns > 0 integer
- `test_auto_chunk_size_small_dataset`: 100 variants, 10 samples — returns reasonable chunk size
- `test_auto_chunk_size_large_dataset`: 1M variants, 5000 samples — returns bounded chunk size
- `test_auto_workers_memory_constrained`: Low memory, many tasks — returns < cpu_count
- `test_auto_workers_cpu_constrained`: High memory, few cores — returns cpu_count
- `test_should_parallelize_small`: 50 items — returns False
- `test_should_parallelize_large`: 500 items — returns True
- `test_get_summary`: Returns dict with expected keys

Mark all tests with `@pytest.mark.unit`.
  </action>
  <verify>
    `pytest tests/unit/memory/test_resource_manager.py -v` passes all tests.
    `python -c "from variantcentrifuge.cli import create_parser; p = create_parser(); p.parse_args([])"` succeeds (no crash from removed args).
    Grep for `--chunks` in cli.py returns no results.
  </verify>
  <done>
    Dead CLI flags removed. 13+ unit tests for ResourceManager pass. No regressions in CLI argument parsing.
  </done>
</task>

</tasks>

<verification>
1. `pytest tests/unit/memory/ -v` — all ResourceManager tests pass
2. `python -c "from variantcentrifuge.memory import ResourceManager"` — import succeeds
3. `make lint` — no linting errors in new/modified files
4. `make ci-check` — full CI passes (existing tests not broken by CLI changes)
</verification>

<success_criteria>
- ResourceManager class exists and is importable from variantcentrifuge.memory
- Memory detection works for CLI override, SLURM, PBS, cgroup v1/v2, psutil fallback
- Dead CLI flags (--chunks, --vectorized-chunk-size, --genotype-replacement-chunk-size) removed
- 13+ unit tests pass for ResourceManager
- Existing tests not broken (InheritanceMemoryManager still available temporarily)
</success_criteria>

<output>
After completion, create `.planning/phases/12-parallelization-chunking/12-01-SUMMARY.md`
</output>
