---
phase: 12-parallelization-chunking
plan: 02
type: execute
wave: 2
depends_on: ["12-01"]
files_modified:
  - variantcentrifuge/stages/analysis_stages.py
  - variantcentrifuge/inheritance/parallel_analyzer.py
  - variantcentrifuge/memory/inheritance_memory_manager.py
  - variantcentrifuge/memory/__init__.py
  - variantcentrifuge/pipeline.py
  - tests/unit/inheritance/test_parallel_analyzer.py
autonomous: true

must_haves:
  truths:
    - "InheritanceAnalysisStage uses ResourceManager instead of InheritanceMemoryManager for memory strategy"
    - "parallel_analyzer sorts genes by variant count descending before submitting to ProcessPoolExecutor (largest first for load balancing)"
    - "Auto-worker detection: inheritance analysis auto-detects optimal worker count from ResourceManager instead of requiring --threads"
    - "InheritanceMemoryManager deleted with no remaining imports anywhere in codebase"
    - "Dead config keys (chunks, vectorized_chunk_size) replaced with ResourceManager auto-detection in analysis_stages.py"
  artifacts:
    - path: "variantcentrifuge/inheritance/parallel_analyzer.py"
      provides: "Parallel inheritance analysis with auto-tuned workers and gene sorting"
      contains: "sort.*reverse.*True"
    - path: "variantcentrifuge/stages/analysis_stages.py"
      provides: "Inheritance stage using ResourceManager"
      contains: "ResourceManager"
  key_links:
    - from: "variantcentrifuge/stages/analysis_stages.py"
      to: "variantcentrifuge/memory/resource_manager.py"
      via: "import and instantiation"
      pattern: "from.*memory.*import.*ResourceManager"
    - from: "variantcentrifuge/inheritance/parallel_analyzer.py"
      to: "variantcentrifuge/memory/resource_manager.py"
      via: "auto_workers call"
      pattern: "ResourceManager|auto_workers|should_parallelize"
---

<objective>
Migrate all consumers from InheritanceMemoryManager to ResourceManager, improve inheritance parallelism with gene sorting for load balance, and delete the old InheritanceMemoryManager with zero dead code.

Purpose: Complete the pipeline-wide memory management migration. Improve compound het parallel processing by submitting largest genes first (avoids stragglers). Remove dead code per CONTEXT requirement.

Output: All inheritance analysis uses ResourceManager, gene sorting implemented, InheritanceMemoryManager deleted.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-parallelization-chunking/12-CONTEXT.md
@.planning/phases/12-parallelization-chunking/12-01-SUMMARY.md
@variantcentrifuge/memory/resource_manager.py
@variantcentrifuge/stages/analysis_stages.py
@variantcentrifuge/inheritance/parallel_analyzer.py
@variantcentrifuge/memory/inheritance_memory_manager.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate analysis_stages.py and parallel_analyzer.py to ResourceManager</name>
  <files>
    variantcentrifuge/stages/analysis_stages.py
    variantcentrifuge/inheritance/parallel_analyzer.py
  </files>
  <action>
**Update InheritanceAnalysisStage (analysis_stages.py):**

1. Replace `from ..memory import InheritanceMemoryManager` with `from ..memory import ResourceManager`
2. In `_process()` method (~line 920-956): Replace `InheritanceMemoryManager(context.config)` with `ResourceManager(config=context.config)`. Replace `memory_manager.get_memory_strategy(len(df), len(vcf_samples))` with equivalent ResourceManager calls:
   - Use `rm.auto_chunk_size(len(df), len(vcf_samples))` for chunk size
   - Use `rm.auto_workers(num_genes, memory_per_gene)` for worker count
   - Use `rm.should_parallelize(len(df))` for parallelism decision
   - Keep the same logic flow: if dataset fits in memory, process as single chunk; otherwise, use chunked approach
3. Replace `config.get("chunks") or 10000` (line ~2222) with ResourceManager auto-detection: `ResourceManager(config=context.config).auto_chunk_size(total_variants, num_samples)` where total_variants and num_samples are available from context
4. Replace `from ..memory import InheritanceMemoryManager` in `_analyze_chunk_inheritance()` (~line 2937) with ResourceManager
5. Remove references to `memory_manager.log_memory_status()` — ResourceManager logs at init

**Update parallel_analyzer.py:**

1. Sort genes by variant count descending before submitting to ProcessPoolExecutor:
   ```python
   genes_with_multiple_variants.sort(key=lambda x: len(x[1]), reverse=True)
   ```
   This ensures largest genes (most work) are submitted first, preventing straggler effects where one large gene blocks completion.

2. Auto-detect worker count when `n_workers is None`:
   ```python
   from ..memory import ResourceManager
   rm = ResourceManager()
   if n_workers is None:
       n_workers = rm.auto_workers(
           task_count=len(genes_with_multiple_variants),
           memory_per_task_gb=rm.estimate_memory(max_gene_size, len(sample_list))
       )
   ```

3. Use `rm.should_parallelize(len(df))` instead of the inline `use_parallel` calculation:
   - Keep `"GENE" in df.columns` check (structural requirement)
   - Replace `len(df) >= min_variants_for_parallel` with `rm.should_parallelize(len(df))`

4. Log the auto-detected configuration at INFO level:
   `logger.info(f"Parallel inheritance: {n_workers} workers, {len(genes_with_multiple_variants)} genes (largest: {max_gene_size} variants)")`

**Update chunked processing in analysis_stages.py (~line 2270):**
- Replace `max_workers = context.config.get("threads", 1)` with auto-detection from ResourceManager when threads is not explicitly set (i.e., when threads=1 which is the default)
- Keep `--threads` CLI flag working as an explicit override

**Update pipeline.py:**
- Line 352: `args.chunks = config.get("chunks")` — remove this line (chunks CLI flag was removed in Plan 01)
  </action>
  <verify>
    `grep -r "InheritanceMemoryManager" variantcentrifuge/` returns NO results (only in memory/ directory for the file itself — but that file will be deleted in Task 2).
    `pytest tests/unit/inheritance/test_parallel_analyzer.py -v` passes.
    `pytest tests/test_inheritance/ -v` passes (inheritance test suite).
    `make lint` passes.
  </verify>
  <done>
    All analysis_stages.py and parallel_analyzer.py code uses ResourceManager. Gene sorting by variant count descending is implemented. Auto-worker detection active.
  </done>
</task>

<task type="auto">
  <name>Task 2: Delete InheritanceMemoryManager and update tests</name>
  <files>
    variantcentrifuge/memory/inheritance_memory_manager.py
    variantcentrifuge/memory/__init__.py
    tests/unit/inheritance/test_parallel_analyzer.py
  </files>
  <action>
**Delete InheritanceMemoryManager:**
1. Delete `variantcentrifuge/memory/inheritance_memory_manager.py` entirely
2. Update `variantcentrifuge/memory/__init__.py`: Remove `from .inheritance_memory_manager import InheritanceMemoryManager`. Keep only `from .resource_manager import ResourceManager`.

**Verify no remaining references:**
- `grep -r "InheritanceMemoryManager" variantcentrifuge/` must return ZERO results
- `grep -r "inheritance_memory_manager" variantcentrifuge/` must return ZERO results
- `grep -r "InheritanceMemoryManager" tests/` must return ZERO results

**Update parallel analyzer tests:**
Review `tests/unit/inheritance/test_parallel_analyzer.py`:
- If any test references InheritanceMemoryManager, update to use ResourceManager
- Add test for gene sorting: verify that genes are submitted largest-first to executor
- Add test for auto-worker detection: mock ResourceManager and verify it's called when n_workers=None

**Run full test suite to verify no breakage:**
- `pytest -m unit` — all unit tests pass
- `pytest tests/test_inheritance/` — all inheritance tests pass
  </action>
  <verify>
    `grep -r "InheritanceMemoryManager" variantcentrifuge/ tests/` returns ZERO results.
    `grep -r "inheritance_memory_manager" variantcentrifuge/ tests/` returns ZERO results (only in .planning/).
    `pytest -m unit --tb=short` passes with no failures.
    `ls variantcentrifuge/memory/inheritance_memory_manager.py` returns "No such file".
  </verify>
  <done>
    InheritanceMemoryManager completely removed. No dead code. All tests pass. ResourceManager is the sole memory management module.
  </done>
</task>

</tasks>

<verification>
1. `grep -r "InheritanceMemoryManager" variantcentrifuge/ tests/` — zero results
2. `pytest -m unit --tb=short` — all unit tests pass
3. `pytest tests/test_inheritance/ -v` — all inheritance tests pass
4. `make ci-check` — full CI passes
</verification>

<success_criteria>
- InheritanceMemoryManager.py deleted, zero references remain in production code or tests
- InheritanceAnalysisStage uses ResourceManager for all memory decisions
- parallel_analyzer.py sorts genes by variant count descending before parallel submission
- Auto-worker detection works when --threads not specified
- All existing tests pass with no regressions
</success_criteria>

<output>
After completion, create `.planning/phases/12-parallelization-chunking/12-02-SUMMARY.md`
</output>
