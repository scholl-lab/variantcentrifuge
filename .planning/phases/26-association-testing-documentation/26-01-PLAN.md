---
phase: 26-association-testing-documentation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - docs/source/guides/association_testing.md
  - docs/source/guides/index.md
autonomous: true

must_haves:
  truths:
    - "User can find the association testing guide from the docs sidebar/index"
    - "User can copy-paste the quick start example and run a Fisher association test"
    - "User can select the right test for their cohort using the comparison table"
    - "User can configure covariates and PCA from the guide instructions"
    - "User can set up SKAT, COAST, and burden tests following the guide"
    - "User can troubleshoot common errors using the troubleshooting section"
    - "User can configure association testing via JSON config using the annotated example"
  artifacts:
    - path: "docs/source/guides/association_testing.md"
      provides: "Comprehensive association testing user guide"
      min_lines: 400
    - path: "docs/source/guides/index.md"
      provides: "Updated guides toctree with association_testing entry"
      contains: "association_testing"
  key_links:
    - from: "docs/source/guides/index.md"
      to: "docs/source/guides/association_testing.md"
      via: "toctree entry"
      pattern: "association_testing"
---

<objective>
Write the comprehensive association testing user guide for VariantCentrifuge v0.15.0.

Purpose: Users need a single authoritative guide covering all association testing functionality added in Phases 18-25: test types, covariates, PCA, weights, diagnostics, JSON config, and troubleshooting. This is the primary user-facing deliverable of the documentation phase.

Output: `docs/source/guides/association_testing.md` (new file, 400+ lines) and updated `docs/source/guides/index.md` toctree.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/26-association-testing-documentation/26-CONTEXT.md
@.planning/phases/26-association-testing-documentation/26-RESEARCH.md

# Source files for accurate CLI flags, defaults, and output columns
@variantcentrifuge/cli.py
@variantcentrifuge/association/__init__.py
@variantcentrifuge/association/base.py
@variantcentrifuge/association/engine.py
@variantcentrifuge/association/diagnostics.py
@variantcentrifuge/association/weights.py
@variantcentrifuge/association/pca.py
@variantcentrifuge/association/covariates.py
@variantcentrifuge/association/tests/fisher.py
@variantcentrifuge/association/tests/logistic_burden.py
@variantcentrifuge/association/tests/linear_burden.py
@variantcentrifuge/association/tests/skat_python.py
@variantcentrifuge/association/tests/allelic_series_python.py
@variantcentrifuge/association/tests/acat.py

# Existing guide for style reference
@docs/source/guides/cohort_analysis.md
@docs/source/guides/index.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Write association testing guide</name>
  <files>docs/source/guides/association_testing.md</files>
  <action>
Create `docs/source/guides/association_testing.md` in MyST Markdown format following the structure and decisions from 26-CONTEXT.md and 26-RESEARCH.md.

**Section ordering (from CONTEXT.md decisions):**

1. **Quick Start** (5-10 lines, copy-paste-ready)
   - Minimal Fisher example with generic placeholders (`input.vcf.gz`, `phenotypes.tsv`)
   - Show expected output columns (gene, fisher_p_value, acat_o_corrected_p_value, etc.)

2. **Setup: Covariates**
   - Covariate file format (TSV/CSV, first col = sample ID, header row)
   - `--covariate-file`, `--covariates` (subset), `--categorical-covariates`
   - Auto-detection of categorical columns (non-numeric, <=5 unique values)
   - Example CLI invocation + 2-3 lines of representative output

3. **Setup: PCA**
   - `--pca-file` with supported formats (PLINK .eigenvec, AKT, generic TSV)
   - `--pca-tool akt` for AKT subprocess invocation
   - `--pca-components N` (default 10, warn if >20)
   - PCA columns merge into covariate matrix automatically

4. **Simple Tests: Fisher's Exact Test**
   - One paragraph: 2x2 contingency, carrier enrichment, no covariate adjustment
   - When appropriate: any cohort size, first-pass screening
   - CLI example, output columns (fisher_p_value, fisher_or, fisher_or_ci_lower/upper)
   - Collapsing modes: `samples` vs `alleles` (via gene_burden_mode)

5. **Simple Tests: Burden Tests (Logistic and Linear)**
   - Logistic burden: binary trait, weighted burden score -> logistic regression, Firth fallback
   - Linear burden: quantitative trait, OLS regression
   - `--trait-type binary|quantitative`
   - CLI example with covariates, output columns (beta, SE, CI)
   - Note: burden tests report beta+SE (not OR) — differs from Fisher

6. **Advanced Tests: SKAT / SKAT-O**
   - One paragraph: score-based kernel test, heterogeneous effects, optimal rho
   - Python backend (default, thread-safe) vs R backend (deprecated)
   - `--skat-backend python|r|auto`
   - ACAT-V per-variant score computed automatically within SKAT
   - Output: p-value only (no effect size for SKAT), skat_o_rho

7. **Advanced Tests: COAST**
   - One paragraph: allelic series, BMV/DMV/PTV categories, ordered effect hypothesis
   - Requires SIFT and PolyPhen annotations in VCF
   - `--coast-backend python|r|auto`, `--coast-weights`
   - Variant classification criteria (PTV: HIGH impact, DMV: missense+SIFT D/PolyPhen P/D, BMV: missense+SIFT T+PolyPhen B)
   - Output: coast_p_value, per-category counts

8. **Combining Tests: ACAT-O**
   - Cauchy combination of all primary test p-values per gene
   - Single FDR correction on ACAT-O p-values across all genes
   - `acat_o_corrected_p_value` is THE primary significance measure
   - Individual test p-values are for diagnostic signal decomposition only

9. **Tuning: Variant Weights**
   - Table of weight schemes: beta:a,b, uniform, cadd, revel, combined
   - `--variant-weights`, `--variant-weight-params` (JSON string)
   - Fallback behavior for missing annotations

10. **Tuning: Diagnostics**
    - `--diagnostics-output dir/`
    - lambda_gc.tsv, qq_data.tsv, summary.txt, optional qq_plot.png
    - lambda_GC interpretation (~1.0 = well-calibrated, >1.05 = investigate)

11. **Tuning: JSON Config**
    - Full annotated JSON example with `"association"` section in main config
    - All 28 valid keys with comments explaining each
    - Precedence: CLI > JSON > defaults
    - Pass via existing `-c`/`--config` flag (no separate --association-config)

12. **Test Selection Reference**
    - Comparison table: test name, CLI name, trait type, sample size need, what it detects, computational cost, when to use
    - Data from 26-RESEARCH.md "Test Comparison Table"

13. **Troubleshooting**
    - R not found (use Python default)
    - Low sample size warnings (min_cases, min_case_carriers)
    - Convergence failures (Firth fallback, separation)
    - lambda_GC interpretation (unreliable < 100 genes)
    - COAST NO_CLASSIFIABLE_VARIANTS (need SIFT/PolyPhen annotations)
    - Sample ID mismatch between VCF and covariate file
    - ACAT-O = single test p-value pass-through when only one test active

**Style guidelines:**
- Dual audience: bioinformaticians and clinical geneticists
- Practical and direct tone: "Run this. You'll see this. If X, do Y."
- Command + output snippet style (CLI invocation + 2-5 representative output lines)
- Generic placeholders for data files
- MyST Markdown format (match existing guides style)
- Use MyST admonitions (`:::{note}`, `:::{warning}`, `:::{tip}`) for important callouts
- Moderate theory per test: one paragraph explaining the statistical model, when appropriate, and assumptions

**Critical accuracy requirements — read source code, do NOT guess:**
- All CLI flag names from cli.py (lines 408-530)
- All output column names from engine.py
- All JSON config keys from VALID_ASSOCIATION_KEYS in analysis_stages.py
- Default values from AssociationConfig in base.py
- Weight scheme names from weights.py
- PCA format details from pca.py
  </action>
  <verify>
1. File exists at docs/source/guides/association_testing.md
2. File has 400+ lines
3. Contains all 13 sections (Quick Start through Troubleshooting)
4. All CLI flags match cli.py definitions (spot-check: --perform-association, --association-tests, --skat-backend, --coast-backend, --covariate-file, --variant-weights, --pca-file, --diagnostics-output)
5. JSON config example contains "association" key (not a separate config file)
6. Test comparison table present with all 6 test types
7. MyST Markdown syntax (not rST)
  </verify>
  <done>
A comprehensive association testing guide exists at docs/source/guides/association_testing.md with all sections from the CONTEXT.md structure, accurate CLI flags from source, test comparison table, annotated JSON config, and troubleshooting section. Content is accurate to the implemented code.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add guide to guides index toctree</name>
  <files>docs/source/guides/index.md</files>
  <action>
Read `docs/source/guides/index.md` and add `association_testing` to the toctree. Place it in a logical position — after cohort_analysis (since association testing is an extension of cohort analysis workflows) or as the last guide entry. Follow the existing toctree format exactly.
  </action>
  <verify>
1. `docs/source/guides/index.md` contains `association_testing` in its toctree
2. No syntax errors in the toctree directive
  </verify>
  <done>
The guides index toctree includes association_testing, making it discoverable from the docs sidebar.
  </done>
</task>

</tasks>

<verification>
1. `docs/source/guides/association_testing.md` exists with 400+ lines
2. `docs/source/guides/index.md` references association_testing in toctree
3. Guide follows MyST Markdown format (not rST)
4. CLI flag names in guide match `cli.py` definitions
5. Output column names match engine.py
6. JSON config uses `"association"` key in main config (not separate file)
</verification>

<success_criteria>
- The association testing guide is complete, accurate, and follows the structure from CONTEXT.md
- The guide is linked from the guides index toctree
- All CLI flags, output columns, config keys, and defaults are verified against source code
- Dual audience (bioinformaticians + clinical geneticists) with practical, direct tone
</success_criteria>

<output>
After completion, create `.planning/phases/26-association-testing-documentation/26-01-SUMMARY.md`
</output>
