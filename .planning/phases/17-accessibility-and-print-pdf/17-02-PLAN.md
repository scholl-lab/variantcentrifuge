---
phase: 17-accessibility-and-print-pdf
plan: 02
type: execute
wave: 2
depends_on: ["17-01"]
files_modified:
  - variantcentrifuge/templates/index.html
autonomous: true

must_haves:
  truths:
    - "Screen reader users can access chart data via hidden data tables"
    - "Printing the report hides all interactive controls and shows a clean table layout"
    - "A Download PDF button triggers the browser print dialog"
    - "Canvas chart elements are hidden from screen readers"
    - "FixedColumns clones collapse to normal flow in print mode"
  artifacts:
    - path: "variantcentrifuge/templates/index.html"
      provides: "Chart data tables, @media print stylesheet, PDF export button"
      contains: "@media print"
  key_links:
    - from: "canvas elements"
      to: "sr-only data tables"
      via: "aria-hidden on canvas, sr-only class on fallback table"
      pattern: "aria-hidden.*canvas|chart-data-table.*sr-only"
    - from: "PDF export button"
      to: "window.print()"
      via: "click event listener"
      pattern: "window\\.print"
---

<objective>
Add chart text alternatives for screen readers (data table fallbacks) and implement print/PDF support with a comprehensive @media print stylesheet and a Download PDF button.

Purpose: Covers A11Y-03 (chart text alternatives), PRINT-01 (print stylesheet), PRINT-02 (PDF export button) -- the remaining Phase 17 requirements.
Output: Updated index.html with chart accessibility and full print optimization.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-accessibility-and-print-pdf/17-RESEARCH.md
@.planning/phases/17-accessibility-and-print-pdf/17-01-SUMMARY.md
@variantcentrifuge/templates/index.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add chart data table fallbacks for screen readers</name>
  <files>variantcentrifuge/templates/index.html</files>
  <action>
  A11Y-03: Every Chart.js chart needs `aria-hidden="true"` on its canvas element and a screen-reader-accessible data table fallback.

  1. Impact Distribution chart (canvas id="impact_chart", around line 496):
     - Add `aria-hidden="true"` to the canvas element
     - After the canvas's parent `<div class="chart-container-sm">`, add an accessible data table:
       ```html
       <table class="chart-data-table sr-only" aria-label="Impact distribution data">
         <thead><tr><th scope="col">Impact Level</th><th scope="col">Variant Count</th></tr></thead>
         <tbody>
         {% for level, count in summary.impact_counts.items() %}
           <tr><td>{{ level }}</td><td>{{ count }}</td></tr>
         {% endfor %}
         </tbody>
       </table>
       ```
     The sr-only class (added in Plan 01) hides this visually but exposes it to screen readers.

  2. Inheritance Distribution chart (canvas id="inheritance_chart", around line 503):
     - Add `aria-hidden="true"` to the canvas element
     - After its container, add:
       ```html
       <table class="chart-data-table sr-only" aria-label="Inheritance pattern distribution data">
         <thead><tr><th scope="col">Inheritance Pattern</th><th scope="col">Variant Count</th></tr></thead>
         <tbody>
         {% for pattern, count in summary.inheritance_distribution.items() %}
           {% if pattern != 'none' and pattern != 'reference' %}
           <tr><td>{{ pattern|replace('_', ' ') }}</td><td>{{ count }}</td></tr>
           {% endif %}
         {% endfor %}
         </tbody>
       </table>
       ```

  3. Add heading IDs for `aria-labelledby` on charts:
     - The chart wrapper `<h3>` elements should have IDs (e.g., `id="impact-chart-heading"`, `id="inheritance-chart-heading"`)
     - Canvas elements can reference them: `aria-labelledby="impact-chart-heading"` (in addition to aria-hidden, which takes precedence for AT but provides context if AT processes differently)

  NOTE: Phase 16 will add more charts (variant type, chromosome, allele frequency). Those charts will need the same treatment. For now, only the two Phase 14 dashboard charts exist.
  </action>
  <verify>
  - `grep 'aria-hidden="true"' variantcentrifuge/templates/index.html` finds canvas elements
  - `grep 'chart-data-table' variantcentrifuge/templates/index.html` finds data table fallbacks
  - `grep 'sr-only' variantcentrifuge/templates/index.html` finds sr-only usage on chart tables
  - Existing tests still pass: `pytest tests/unit/test_html_report.py -x -q`
  </verify>
  <done>Both dashboard charts have aria-hidden="true" on canvas, and each has an sr-only data table fallback with actual data from the template context, allowing screen readers to access the chart information.</done>
</task>

<task type="auto">
  <name>Task 2: Add @media print stylesheet and PDF export button</name>
  <files>variantcentrifuge/templates/index.html</files>
  <action>
  PRINT-01: Add a comprehensive `@media print` stylesheet block at the end of the main `<style>` section.

  The print stylesheet must:
  1. Hide all interactive controls:
     ```css
     @media print {
       .dataTables_wrapper .dataTables_filter,
       .dataTables_wrapper .dataTables_length,
       .dataTables_wrapper .dataTables_paginate,
       .dataTables_wrapper .dataTables_info,
       .dataTables_wrapper .dt-buttons,
       .buttons-colvis,
       .density-toggle,
       .skip-link,
       #export-pdf-btn,
       .metadata-footer { display: none !important; }
     ```

  2. Collapse FixedColumns to normal flow (prevents duplicate columns):
     ```css
       .dtfc-fixed-left,
       .dtfc-fixed-right {
         position: static !important;
         box-shadow: none !important;
       }
     ```

  3. Optimize table for print:
     ```css
       /* Repeat headers on each page */
       #variants_table thead { display: table-header-group; }
       #variants_table tfoot { display: table-footer-group; }

       /* Prevent page breaks inside rows */
       #variants_table tbody tr {
         page-break-inside: avoid;
         break-inside: avoid;
       }

       /* Collapse child rows (detail panels) by default */
       .detail-panel { display: none !important; }
     ```

  4. Optimize badges for grayscale printing:
     ```css
       .badge {
         border: 1px solid #333 !important;
         color: #000 !important;
         background-color: #fff !important;
         -webkit-print-color-adjust: exact;
         print-color-adjust: exact;
       }
     ```

  5. Show chart data tables instead of canvas:
     ```css
       canvas { display: none !important; }
       .chart-data-table {
         position: static !important;
         left: auto !important;
         width: auto !important;
         height: auto !important;
         overflow: visible !important;
         clip: auto !important;
       }
     ```

  6. Show URLs for external links:
     ```css
       a[href^="http"]:not(.skip-link)::after {
         content: " (" attr(href) ")";
         font-size: 9pt;
         color: #555;
       }
     ```

  7. General print optimization:
     ```css
       body { background-color: #fff; }
       .container { max-width: 100%; padding: 0; }
       header { box-shadow: none; border-radius: 0; }
       .table-section { box-shadow: none; border-radius: 0; }

       /* Reduce zebra striping contrast */
       #variants_table tbody tr:nth-child(odd) {
         background-color: #f5f5f5 !important;
       }
     ```

  PRINT-02: Add a "Download PDF" button.

  1. Add the button in the toolbar area (near the table section header, before the DataTables wrapper). Use a simple button with an inline SVG download icon:
     ```html
     <button id="export-pdf-btn" type="button" style="float: right; margin-bottom: 10px; padding: 6px 16px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 13px; display: inline-flex; align-items: center; gap: 6px;">
       <svg aria-hidden="true" focusable="false" width="14" height="14" viewBox="0 0 16 16" fill="currentColor">
         <path d="M8 12l-4-4h2.5V2h3v6H12L8 12z"/>
         <path d="M14 14H2v-2h12v2z"/>
       </svg>
       Download PDF
     </button>
     ```

  2. Add the click handler in the `<script>` section (outside DOMContentLoaded to keep it simple, or inside -- either works):
     ```javascript
     document.getElementById('export-pdf-btn').addEventListener('click', function() {
       window.print();
     });
     ```

  3. The button itself is hidden in print mode (already covered by the `#export-pdf-btn` selector in the print stylesheet above).

  4. Add `aria-label="Download report as PDF"` to the button for accessibility.
  </action>
  <verify>
  - `grep '@media print' variantcentrifuge/templates/index.html` finds the print stylesheet
  - `grep 'export-pdf-btn' variantcentrifuge/templates/index.html` finds the button
  - `grep 'window.print' variantcentrifuge/templates/index.html` finds the handler
  - `grep 'dataTables_paginate' variantcentrifuge/templates/index.html` finds it in print hide rules
  - `grep 'page-break-inside' variantcentrifuge/templates/index.html` finds row break prevention
  - `grep 'dtfc-fixed-left.*static' variantcentrifuge/templates/index.html` finds FixedColumns collapse
  - Existing tests still pass: `pytest tests/unit/test_html_report.py -x -q`
  - `make lint` passes
  </verify>
  <done>Print stylesheet hides interactive controls, collapses FixedColumns, optimizes table for paper, shows data tables instead of canvas charts, adds URL display for links. PDF export button triggers window.print(). Detail panels collapsed by default in print.</done>
</task>

</tasks>

<verification>
- Chart canvas elements have aria-hidden="true"
- Each chart has an sr-only data table fallback with real data
- @media print stylesheet hides: filters, pagination, density toggle, column toggle, skip-link, PDF button
- Print mode collapses FixedColumns to static positioning
- Print mode shows chart data tables instead of canvas
- PDF export button exists and calls window.print()
- Detail panels hidden in print mode
- Existing test suite passes
</verification>

<success_criteria>
- A11Y-03: Both dashboard charts have aria-hidden canvas + sr-only data table fallback
- PRINT-01: @media print stylesheet hides interactive controls, optimizes table, handles FixedColumns
- PRINT-02: Download PDF button visible in normal mode, triggers window.print(), hidden in print mode
</success_criteria>

<output>
After completion, create `.planning/phases/17-accessibility-and-print-pdf/17-02-SUMMARY.md`
</output>
