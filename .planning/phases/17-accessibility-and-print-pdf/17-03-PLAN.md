---
phase: 17-accessibility-and-print-pdf
plan: 03
type: execute
wave: 3
depends_on: ["17-01", "17-02"]
files_modified:
  - tests/unit/test_html_report.py
autonomous: true

must_haves:
  truths:
    - "Tests verify skip-link exists as first body element"
    - "Tests verify ARIA role assignment code is present"
    - "Tests verify emoji link icons are fully replaced with SVG"
    - "Tests verify badge colors pass WCAG AA contrast"
    - "Tests verify chart data table fallbacks exist"
    - "Tests verify print stylesheet hides interactive controls"
    - "Tests verify PDF export button and handler exist"
  artifacts:
    - path: "tests/unit/test_html_report.py"
      provides: "Phase 17 accessibility and print test coverage"
      contains: "class TestPhase17"
  key_links:
    - from: "test assertions"
      to: "template patterns"
      via: "string/regex matching on template source and rendered HTML"
      pattern: "assert.*skip-link|assert.*role.*table"
---

<objective>
Add comprehensive tests for all Phase 17 accessibility and print features, covering ARIA roles, skip-link, SVG icons, color contrast, chart fallbacks, print stylesheet, and PDF export.

Purpose: Verify all A11Y and PRINT requirements are correctly implemented and prevent regressions.
Output: New test class(es) in test_html_report.py covering Phase 17 features.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-accessibility-and-print-pdf/17-RESEARCH.md
@.planning/phases/17-accessibility-and-print-pdf/17-01-SUMMARY.md
@.planning/phases/17-accessibility-and-print-pdf/17-02-SUMMARY.md
@variantcentrifuge/templates/index.html
@tests/unit/test_html_report.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Phase 17 accessibility tests</name>
  <files>tests/unit/test_html_report.py</files>
  <action>
  Add a new test class `TestPhase17Accessibility` to `tests/unit/test_html_report.py`. Follow the existing pattern of class-scoped fixtures and pattern-based template source testing established in Phase 14-03 and 15-03.

  Use two testing approaches:
  A) **Template source tests** (read index.html as string, check patterns) for CSS/JS features
  B) **Rendered HTML tests** (use existing rendered HTML fixture) for Jinja template output

  Tests to write:

  **Skip-link (A11Y-04):**
  - `test_skip_link_css_exists`: Template source contains `.skip-link` and `.skip-link:focus` CSS rules
  - `test_skip_link_html_exists`: Rendered HTML contains `<a href="#main-content" class="skip-link">` as early body element
  - `test_main_content_target_exists`: Rendered HTML contains element with `id="main-content"` and `tabindex="-1"`

  **ARIA roles (A11Y-01):**
  - `test_aria_role_table_assignment`: Template JS contains code setting `role` to `table` (NOT `grid`) on the variants table
  - `test_aria_labels_on_controls`: Template JS contains aria-label assignments for search input, page length select, and colvis button
  - `test_aria_live_region`: Template JS contains `aria-live` and `role` assignment on dataTables_info

  **Keyboard tooltips (A11Y-02):**
  - `test_truncated_cell_tabindex`: Rendered HTML contains `tabindex="0"` on truncated-cell spans
  - `test_tooltip_focus_trigger`: Template JS contains `trigger` config including `focus` (already from Phase 15, confirm still present)

  **SVG icons (A11Y-05):**
  - `test_no_emoji_link_icons`: Rendered HTML does NOT contain the emoji character `ðŸ”—`
  - `test_svg_icon_sprite_exists`: Rendered HTML contains `<symbol id="icon-external-link"`
  - `test_svg_icons_have_aria_hidden`: Template source contains `aria-hidden="true"` on SVG icon usage
  - `test_sr_only_link_text`: Rendered HTML contains `class="sr-only"` near link text for screen reader users

  **Color contrast (A11Y-06):**
  - `test_badge_colors_wcag_aa`: For each badge color in the template source, compute contrast ratio against white (#ffffff) and assert >= 4.5. Write a small helper function `contrast_ratio(hex1, hex2)` that:
    1. Converts hex to RGB
    2. Computes relative luminance: L = 0.2126*R + 0.7152*G + 0.0722*B (where R,G,B are linearized)
    3. Returns (L1 + 0.05) / (L2 + 0.05) where L1 is lighter
    Extract all badge hex colors from template source using regex on the badge render functions, then verify each one.
  - `test_old_failing_colors_removed`: Template source does NOT contain `#fd7e14` (old orange) or the original failing colors

  **sr-only class:**
  - `test_sr_only_css_class`: Template source contains `.sr-only` CSS class definition
  </action>
  <verify>
  - `pytest tests/unit/test_html_report.py -k "Phase17Accessibility" -v` -- all tests pass
  - At least 12 test methods in the class
  </verify>
  <done>All A11Y requirement tests pass, covering skip-link, ARIA roles, keyboard tooltips, SVG icons, and color contrast validation.</done>
</task>

<task type="auto">
  <name>Task 2: Add Phase 17 chart accessibility and print tests</name>
  <files>tests/unit/test_html_report.py</files>
  <action>
  Add a new test class `TestPhase17ChartAndPrint` to `tests/unit/test_html_report.py`.

  Tests to write:

  **Chart text alternatives (A11Y-03):**
  - `test_chart_canvas_aria_hidden`: Template source / rendered HTML has `aria-hidden="true"` on both chart canvas elements (impact_chart, inheritance_chart)
  - `test_impact_chart_data_table`: Rendered HTML contains a data table with `aria-label="Impact distribution data"` and class `sr-only`
  - `test_inheritance_chart_data_table`: Rendered HTML contains a data table with `aria-label="Inheritance pattern distribution data"` and class `sr-only`
  - `test_chart_headings_have_ids`: Template source has `id` attributes on chart heading elements for aria-labelledby

  **Print stylesheet (PRINT-01):**
  - `test_print_media_query_exists`: Template source contains `@media print`
  - `test_print_hides_pagination`: Print stylesheet contains `dataTables_paginate` in a `display: none` rule
  - `test_print_hides_filters`: Print stylesheet contains `dataTables_filter` in hide rules
  - `test_print_hides_length`: Print stylesheet contains `dataTables_length` in hide rules
  - `test_print_hides_buttons`: Print stylesheet contains `dt-buttons` in hide rules
  - `test_print_collapses_fixed_columns`: Print stylesheet contains `dtfc-fixed-left` with `position: static`
  - `test_print_prevents_row_breaks`: Print stylesheet contains `page-break-inside: avoid` or `break-inside: avoid`
  - `test_print_repeats_headers`: Print stylesheet contains `table-header-group`
  - `test_print_hides_canvas`: Print stylesheet contains `canvas` with `display: none`
  - `test_print_shows_chart_data_tables`: Print stylesheet contains `chart-data-table` with `position: static`
  - `test_print_hides_detail_panels`: Print stylesheet contains `detail-panel` with `display: none`

  **PDF export (PRINT-02):**
  - `test_pdf_export_button_exists`: Template source contains `export-pdf-btn`
  - `test_pdf_export_calls_window_print`: Template JS contains `window.print()`
  - `test_pdf_button_has_aria_label`: Template source contains aria-label on the PDF button
  - `test_pdf_button_hidden_in_print`: Print stylesheet hides `export-pdf-btn`

  Run full test suite to confirm no regressions: `pytest tests/unit/test_html_report.py -v`
  </action>
  <verify>
  - `pytest tests/unit/test_html_report.py -k "Phase17ChartAndPrint" -v` -- all tests pass
  - At least 15 test methods in the class
  - `pytest tests/unit/test_html_report.py -v` -- full file passes (no regressions)
  - `make test-fast` passes
  </verify>
  <done>All chart accessibility and print/PDF tests pass, covering canvas aria-hidden, data table fallbacks, comprehensive print stylesheet rules, and PDF export button functionality.</done>
</task>

</tasks>

<verification>
- All Phase 17 tests pass: `pytest tests/unit/test_html_report.py -k "Phase17" -v`
- No regressions in existing tests: `pytest tests/unit/test_html_report.py -v`
- Full fast test suite passes: `make test-fast`
- At least 27 test methods across both test classes
</verification>

<success_criteria>
- TestPhase17Accessibility covers: skip-link, ARIA roles, keyboard tooltips, SVG icons, contrast validation, sr-only class
- TestPhase17ChartAndPrint covers: chart aria-hidden, data table fallbacks, print stylesheet (all interactive controls hidden, FixedColumns collapsed, row breaks prevented, headers repeated, canvas hidden, chart tables shown), PDF export button and handler
- All tests pass, no regressions
</success_criteria>

<output>
After completion, create `.planning/phases/17-accessibility-and-print-pdf/17-03-SUMMARY.md`
</output>
