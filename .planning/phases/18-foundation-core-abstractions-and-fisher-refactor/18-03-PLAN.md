---
phase: 18-foundation-core-abstractions-and-fisher-refactor
plan: 03
type: execute
wave: 3
depends_on: ["18-02"]
files_modified:
  - variantcentrifuge/cli.py
  - variantcentrifuge/stages/output_stages.py
autonomous: true

must_haves:
  truths:
    - "CLI accepts --perform-association and --association-tests flags"
    - "Running --association-tests without --perform-association is a parser error"
    - "Running --perform-association without --association-tests defaults to fisher"
    - "ExcelReportStage adds 'Association' sheet when --perform-association produced output"
    - "ExcelReportStage still adds 'Gene Burden' sheet when --perform-gene-burden is active (no regression)"
  artifacts:
    - path: "variantcentrifuge/cli.py"
      provides: "CLI args for association framework"
      contains: "--perform-association"
    - path: "variantcentrifuge/stages/output_stages.py"
      provides: "Association sheet in Excel"
      contains: "Association"
  key_links:
    - from: "variantcentrifuge/cli.py"
      to: "variantcentrifuge/stages/analysis_stages.py"
      via: "context.config keys"
      pattern: 'cfg\["perform_association"\]'
    - from: "variantcentrifuge/stages/output_stages.py"
      to: "variantcentrifuge/pipeline_core/context.py"
      via: "context.config['association_output']"
      pattern: "association_output"
---

<objective>
Add CLI arguments (--perform-association, --association-tests, --skat-backend) and extend ExcelReportStage to generate an "Association" sheet when association results exist.

Purpose: This completes the user-facing interface for Phase 18 — users can invoke the association framework from the command line and see results in Excel output.

Output: CLI args wired to context.config; ExcelReportStage generates Association sheet alongside existing Gene Burden sheet.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-foundation-core-abstractions-and-fisher-refactor/18-CONTEXT.md
@.planning/phases/18-foundation-core-abstractions-and-fisher-refactor/18-RESEARCH.md
@.planning/phases/18-foundation-core-abstractions-and-fisher-refactor/18-02-SUMMARY.md
@variantcentrifuge/cli.py
@variantcentrifuge/stages/output_stages.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add CLI arguments for association framework</name>
  <files>
    variantcentrifuge/cli.py
  </files>
  <action>
    In `create_parser()`, add arguments to the existing `stats_group` (after line 407, after --stats-config):

    ```python
    # Association Analysis
    stats_group.add_argument(
        "--perform-association",
        action="store_true",
        help="Perform association analysis using the modular association framework",
    )
    stats_group.add_argument(
        "--association-tests",
        type=str,
        default=None,
        help="Comma-separated list of association tests to run (default: fisher). Available: fisher",
    )
    stats_group.add_argument(
        "--skat-backend",
        choices=["auto", "r", "python"],
        default="auto",
        help="SKAT computation backend: auto (prefer R, fall back to Python), r, or python",
    )
    ```

    In `main()`, after the gene burden config mapping (after line 1014), add:

    ```python
    # Association analysis configuration
    cfg["perform_association"] = args.perform_association
    if args.association_tests:
        cfg["association_tests"] = [t.strip() for t in args.association_tests.split(",")]
    else:
        cfg["association_tests"] = ["fisher"] if args.perform_association else []
    cfg["skat_backend"] = getattr(args, "skat_backend", "auto")
    ```

    Add validation after arg parsing (in the validation section of main(), before pipeline execution begins):
    - If `args.association_tests` is set but `args.perform_association` is False:
      ```python
      if args.association_tests and not args.perform_association:
          parser.error("--association-tests requires --perform-association to be set")
      ```
    - Place this validation near the other parser.error calls in main().

    IMPORTANT: The `--perform-association` and `--perform-gene-burden` flags are independent. Both can be active simultaneously — CONTEXT.md specifies they produce independent output.
  </action>
  <verify>
    `python -c "from variantcentrifuge.cli import create_parser; p = create_parser(); args = p.parse_args(['--perform-association', '--association-tests', 'fisher', '--input', 'x.vcf', '--genes', 'BRCA1']); print(args.perform_association, args.association_tests)"` prints `True fisher`.
    `python -c "from variantcentrifuge.cli import create_parser; p = create_parser(); args = p.parse_args(['--input', 'x.vcf', '--genes', 'BRCA1']); print(args.perform_association, args.association_tests)"` prints `False None`.
    Verify error case: `python -c "import sys; from variantcentrifuge.cli import create_parser; p = create_parser(); args = p.parse_args(['--association-tests', 'fisher', '--input', 'x.vcf', '--genes', 'BRCA1'])" 2>&1 | grep -i "error\|association"` — should show parser error about --association-tests requiring --perform-association. Note: This validation happens in main(), not parse_args, so alternatively test via: `python -c "from variantcentrifuge.cli import create_parser; p = create_parser(); args = p.parse_args(['--association-tests', 'fisher', '--input', 'x.vcf', '--genes', 'BRCA1']); assert args.association_tests == 'fisher' and not args.perform_association; print('NEEDS_VALIDATION_IN_MAIN')"` — confirms the args parse, and the validation in main() will catch this combination.
    `make lint` passes on cli.py.
  </verify>
  <done>
    - --perform-association, --association-tests, --skat-backend accepted by CLI
    - Config keys perform_association, association_tests, skat_backend flow to context.config
    - --association-tests without --perform-association is a parser error (validated in main())
    - --perform-association alone defaults association_tests to ["fisher"]
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Association sheet to ExcelReportStage</name>
  <files>
    variantcentrifuge/stages/output_stages.py
  </files>
  <action>
    Two changes to ExcelReportStage in output_stages.py:

    1. Update `soft_dependencies` (line 675-678) to include association_analysis:
       ```python
       @property
       def soft_dependencies(self) -> set[str]:
           return {"gene_burden_analysis", "association_analysis"}
       ```

    2. After the Gene Burden sheet block (after line 804), add the Association sheet block following the EXACT same pattern:
       ```python
       # Add Association sheet (if association analysis was performed and file exists)
       if context.config.get("perform_association"):
           assoc_file = context.config.get("association_output")
           if (
               assoc_file
               and Path(assoc_file).exists()
               and Path(assoc_file).stat().st_size > 0
           ):
               try:
                   append_tsv_as_sheet(xlsx_file, assoc_file, sheet_name="Association")
                   logger.info("Successfully added Association sheet to Excel file")
               except Exception as e:
                   logger.error(f"Failed to add Association sheet: {e}")
           else:
               logger.debug(
                   "Association file not found or empty, skipping Association sheet"
               )
       ```

    This is a direct mirror of the Gene Burden sheet pattern (lines 790-804). Both sheets can coexist in the same Excel file when both --perform-gene-burden and --perform-association are active.
  </action>
  <verify>
    `python -c "from variantcentrifuge.stages.output_stages import ExcelReportStage; s = ExcelReportStage(); print(s.soft_dependencies)"` prints a set containing both `gene_burden_analysis` and `association_analysis`.
    `make lint` passes on output_stages.py.
  </verify>
  <done>
    - ExcelReportStage has association_analysis as soft dependency
    - "Association" sheet is added to Excel when perform_association is active and output file exists
    - Gene Burden sheet logic is untouched (no regression)
  </done>
</task>

</tasks>

<verification>
1. CLI argument parsing works for all combinations: --perform-association alone, with --association-tests, neither
2. --association-tests without --perform-association triggers validation error in main()
3. ExcelReportStage soft_dependencies includes association_analysis
4. All existing tests pass: `pytest tests/ -m unit -x -q`
5. `make lint` passes
</verification>

<success_criteria>
- Users can invoke `--perform-association --association-tests fisher` from CLI
- Invalid flag combinations produce clear parser errors
- Excel output gains Association sheet when association is active
- Zero regression to existing Gene Burden sheet or CLI behavior
</success_criteria>

<output>
After completion, create `.planning/phases/18-foundation-core-abstractions-and-fisher-refactor/18-03-SUMMARY.md`
</output>
