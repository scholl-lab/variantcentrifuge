---
phase: 30-dead-code-cleanup
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - variantcentrifuge/stages/processing_stages.py
  - variantcentrifuge/stages/analysis_stages.py
  - variantcentrifuge/stages/output_stages.py
  - variantcentrifuge/stages/stage_registry.py
  - variantcentrifuge/stages/__init__.py
  - variantcentrifuge/pipeline.py
  - variantcentrifuge/pipeline_core/runner.py
  - variantcentrifuge/pipeline_core/error_handling.py
  - variantcentrifuge/analyze_variants.py
  - tests/unit/stages/test_processing_stages_critical.py
  - tests/unit/stages/test_processing_stages.py
  - tests/unit/test_parallel_stage_resume.py
  - tests/unit/test_pca.py
  - tests/unit/stages/test_analysis_stages.py
  - tests/unit/stages/test_output_stages_simple.py
autonomous: true

must_haves:
  truths:
    - "make test-fast passes with 0 failures after all dead stage classes are removed"
    - "No string 'refactored_pipeline' appears in pipeline.py, runner.py, or any checkpoint default"
    - "No 'old pipeline' or 'Refactored' comments/docstrings remain in production stage files, error_handling.py, or analyze_variants.py"
    - "Stage registry imports and __all__ entries contain no reference to any of the 8 removed stage class names"
  artifacts:
    - path: "variantcentrifuge/stages/processing_stages.py"
      provides: "Live processing stages only"
      must_not_contain: ["ParallelVariantExtractionStage", "BCFToolsPrefilterStage", "TranscriptFilterStage", "StreamingDataProcessingStage", "PCAComputationStage"]
    - path: "variantcentrifuge/stages/analysis_stages.py"
      provides: "Live analysis stages only"
      must_not_contain: ["GenotypeFilterStage", "ParallelAnalysisOrchestrator"]
    - path: "variantcentrifuge/stages/output_stages.py"
      provides: "Live output stages only"
      must_not_contain: ["ParallelReportGenerationStage"]
    - path: "variantcentrifuge/stages/stage_registry.py"
      provides: "Registry with only live stage registrations"
      must_not_contain: ["BCFToolsPrefilterStage", "ParallelVariantExtractionStage", "TranscriptFilterStage", "StreamingDataProcessingStage", "PCAComputationStage", "GenotypeFilterStage", "ParallelAnalysisOrchestrator", "ParallelReportGenerationStage"]
    - path: "variantcentrifuge/stages/__init__.py"
      provides: "Clean public API for stages package"
      must_not_contain: ["BCFToolsPrefilterStage", "ParallelVariantExtractionStage", "StreamingDataProcessingStage", "ParallelAnalysisOrchestrator", "ParallelReportGenerationStage"]
    - path: "variantcentrifuge/pipeline.py"
      provides: "Pipeline with 'pipeline' as default version string"
      must_not_contain: ["refactored_pipeline"]
    - path: "variantcentrifuge/pipeline_core/runner.py"
      provides: "Runner with 'pipeline' as default version string"
      must_not_contain: ["refactored_pipeline"]
  key_links:
    - from: "variantcentrifuge/stages/stage_registry.py"
      to: "variantcentrifuge/stages/processing_stages.py"
      via: "import and register_stage() calls"
      pattern: "register_stage\\("
    - from: "variantcentrifuge/stages/__init__.py"
      to: "variantcentrifuge/stages/processing_stages.py"
      via: "from .processing_stages import"
      pattern: "from \\.processing_stages import"
    - from: "tests/"
      to: "variantcentrifuge/stages/"
      via: "test imports of stage classes"
      pattern: "from variantcentrifuge\\.stages"
---

<objective>
Remove 8 dead stage classes, their registry entries, imports, __all__ exports, test classes, and cross-references in live stages. Then normalize all "refactored_pipeline", "old pipeline", and "Refactored" naming artifacts.

Purpose: Eliminate dead code that creates noise for all subsequent v0.16.0 phases. The 8 stage classes are never instantiated by the pipeline but clutter source files, registry, and tests.

Output: A clean codebase where only live stages exist in source, registry, and tests; all legacy naming artifacts are gone.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/30-dead-code-cleanup/30-RESEARCH.md

@variantcentrifuge/stages/processing_stages.py
@variantcentrifuge/stages/analysis_stages.py
@variantcentrifuge/stages/output_stages.py
@variantcentrifuge/stages/stage_registry.py
@variantcentrifuge/stages/__init__.py
@variantcentrifuge/pipeline.py
@variantcentrifuge/pipeline_core/runner.py
@variantcentrifuge/pipeline_core/error_handling.py
@variantcentrifuge/analyze_variants.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove 8 dead stage classes, registry entries, imports, tests, and cross-references</name>
  <files>
    variantcentrifuge/stages/processing_stages.py
    variantcentrifuge/stages/analysis_stages.py
    variantcentrifuge/stages/output_stages.py
    variantcentrifuge/stages/stage_registry.py
    variantcentrifuge/stages/__init__.py
    tests/unit/stages/test_processing_stages_critical.py
    tests/unit/stages/test_processing_stages.py
    tests/unit/test_parallel_stage_resume.py
    tests/unit/test_pca.py
    tests/unit/stages/test_analysis_stages.py
    tests/unit/stages/test_output_stages_simple.py
  </files>
  <action>
    Remove the following 8 dead stage class definitions (entire class including all methods):

    From `variantcentrifuge/stages/processing_stages.py`:
    - `ParallelVariantExtractionStage` (class def + all methods)
    - `BCFToolsPrefilterStage` (class def + all methods)
    - `TranscriptFilterStage` (class def + all methods)
    - `StreamingDataProcessingStage` (class def + all methods)
    - `PCAComputationStage` (class def + all methods)

    From `variantcentrifuge/stages/analysis_stages.py`:
    - `GenotypeFilterStage` (class def + all methods)
    - `ParallelAnalysisOrchestrator` (class def + all methods)

    From `variantcentrifuge/stages/output_stages.py`:
    - `ParallelReportGenerationStage` (class def + all methods)

    Remove their registry entries from `variantcentrifuge/stages/stage_registry.py`:
    - In `_register_processing_stages()`: remove imports of BCFToolsPrefilterStage, ParallelVariantExtractionStage, PCAComputationStage, StreamingDataProcessingStage, TranscriptFilterStage AND their `register_stage()` calls
    - In `_register_analysis_stages()`: remove imports of GenotypeFilterStage, ParallelAnalysisOrchestrator AND their `register_stage()` calls
    - In `_register_output_stages()`: remove import of ParallelReportGenerationStage AND its `register_stage()` call

    Remove from `variantcentrifuge/stages/__init__.py`:
    - Remove imports: ParallelAnalysisOrchestrator, ParallelReportGenerationStage, BCFToolsPrefilterStage, ParallelVariantExtractionStage, StreamingDataProcessingStage
    - Remove __all__ entries: "BCFToolsPrefilterStage", "ParallelAnalysisOrchestrator", "ParallelReportGenerationStage", "ParallelVariantExtractionStage"

    Clean cross-references in live stages:
    - `SnpSiftFilterStage` in processing_stages.py (~line 722): remove `"parallel_variant_extraction"` from `soft_dependencies`
    - `FieldExtractionStage` in processing_stages.py (~line 790): remove `"transcript_filtering"` from `soft_dependencies`
    - `VariantAnalysisStage` in analysis_stages.py (~line 1511): remove `"genotype_filtering"` from `soft_dependencies`
    - `ParallelCompleteProcessingStage` in processing_stages.py (~lines 1447, 1491): remove `context.mark_complete("parallel_variant_extraction")` calls

    Remove test classes (remove entire test class + its imports):
    - `tests/unit/stages/test_processing_stages_critical.py`: remove `TestBCFToolsPrefilterStage`, `TestStreamingDataProcessingStage` classes and their imports
    - `tests/unit/stages/test_processing_stages.py`: remove `TestParallelVariantExtractionStage` class and its import
    - `tests/unit/test_parallel_stage_resume.py`: remove `TestParallelVariantExtractionStage` class and its import
    - `tests/unit/test_pca.py`: DELETE entire file (dedicated entirely to PCAComputationStage)
    - `tests/unit/stages/test_analysis_stages.py`: remove `TestParallelAnalysisOrchestrator` class and its import
    - `tests/unit/stages/test_output_stages_simple.py`: remove `TestParallelReportGenerationStage` class and its import

    IMPORTANT PITFALLS:
    - Do NOT remove `"bcftools_prefilter"` string from checkpoint.py, cli.py, or filters.py — those are config parameter keys, not stage names
    - Do NOT remove `refactored_args` variable in cli.py — it is a local variable name, not a naming artifact
    - Do NOT remove DataSortingStage or ClinVarPM5Stage — they are live stages (used in pipeline.py)
    - After all removals, grep for each of the 8 class names across the entire codebase to verify no stale references remain

    Run `make format` after edits to ensure ruff formatting compliance.
  </action>
  <verify>
    1. `grep -rn "ParallelVariantExtractionStage\|BCFToolsPrefilterStage\|TranscriptFilterStage\|StreamingDataProcessingStage\|PCAComputationStage\|GenotypeFilterStage\|ParallelAnalysisOrchestrator\|ParallelReportGenerationStage" variantcentrifuge/ tests/` returns NO matches
    2. `make test-fast` passes with 0 failures
    3. `make lint` passes
  </verify>
  <done>
    All 8 dead stage classes are removed from source, registry, __init__.py, and tests. No stale references to any of the 8 class names exist anywhere in the codebase. All tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Normalize naming artifacts — replace "refactored_pipeline", "old pipeline", and "Refactored" strings</name>
  <files>
    variantcentrifuge/pipeline.py
    variantcentrifuge/pipeline_core/runner.py
    variantcentrifuge/pipeline_core/error_handling.py
    variantcentrifuge/analyze_variants.py
    variantcentrifuge/stages/analysis_stages.py
    variantcentrifuge/stages/output_stages.py
    variantcentrifuge/stages/processing_stages.py
  </files>
  <action>
    CLEAN-04 / TD-06 — Replace "refactored_pipeline" defaults (2 occurrences):
    - `variantcentrifuge/pipeline.py` (~line 509): change `"refactored_pipeline"` to `"pipeline"` in `initial_config.get("pipeline_version", "refactored_pipeline")`
    - `variantcentrifuge/pipeline_core/runner.py` (~line 119): change `"refactored_pipeline"` to `"pipeline"` in `context.config.get("pipeline_version", "refactored_pipeline")`

    CLEAN-06 — Update "Refactored" docstrings (2 occurrences):
    - `variantcentrifuge/pipeline_core/error_handling.py` (line 2): change `"Enhanced error handling utilities for the refactored pipeline."` to `"Enhanced error handling utilities for the pipeline."`
    - `variantcentrifuge/analyze_variants.py` (line 7): change `"Refactored to be more modular:"` to `"Modular design:"`

    CLEAN-05 — Reword "old pipeline" comments (11 occurrences). For each, remove the "like the old pipeline" / "old pipeline" phrase and describe current behavior instead:
    - `variantcentrifuge/pipeline.py` (~line 492): `# Map igv argument to igv_enabled for consistency with old pipeline` -> `# Map igv argument to igv_enabled for backward compatibility`
    - `variantcentrifuge/stages/analysis_stages.py` (~line 1375): `# Create default stats file path like the old pipeline does` -> `# Create default stats file path`
    - `variantcentrifuge/stages/output_stages.py` (~line 186): `# Use VAR_ID to match old pipeline` -> `# Use VAR_ID as the variant identifier column`
    - `variantcentrifuge/stages/output_stages.py` (~line 194): `# Generate IDs based on key fields with hash like old pipeline` -> `# Generate IDs based on key fields with hash`
    - `variantcentrifuge/stages/output_stages.py` (~line 244): `id_column = "VAR_ID"  # Match the old pipeline` -> `id_column = "VAR_ID"  # Default variant identifier column`
    - `variantcentrifuge/stages/output_stages.py` (~line 741): `# Add additional sheets like the old pipeline does` -> `# Add additional sheets (summary, statistics, metadata)`
    - `variantcentrifuge/stages/output_stages.py` (~line 753): docstring `Add additional sheets to the Excel file like the old pipeline does.` -> `Add additional sheets to the Excel file.`
    - `variantcentrifuge/stages/output_stages.py` (~line 1028): `# Create TSV metadata file like the old pipeline` -> `# Create TSV metadata file`
    - `variantcentrifuge/stages/output_stages.py` (~line 1033): `# Write metadata in TSV format like the old pipeline` -> `# Write metadata in TSV format`
    - `variantcentrifuge/stages/processing_stages.py` (~line 1327): docstring `This stage replicates the old pipeline's behavior where each chunk` -> `This stage processes each chunk` (preserve rest of sentence)
    - `variantcentrifuge/stages/processing_stages.py` (~line 1927): `# Use the sort function from old pipeline` -> `# Use the standard sort function`

    IMPORTANT: Do NOT rename `refactored_args` variable in cli.py — it is a local variable name, not a naming artifact.

    Run `make format` after edits.
  </action>
  <verify>
    1. `grep -rn "refactored_pipeline" variantcentrifuge/` returns NO matches
    2. `grep -rn "old pipeline" variantcentrifuge/` returns NO matches
    3. `grep -rn "Refactored" variantcentrifuge/pipeline_core/error_handling.py variantcentrifuge/analyze_variants.py` returns NO matches
    4. `grep -rn "refactored_args" variantcentrifuge/cli.py` still returns matches (variable name preserved)
    5. `make test-fast` passes with 0 failures
    6. `make lint` passes
  </verify>
  <done>
    No "refactored_pipeline" string defaults remain in pipeline.py or runner.py. No "old pipeline" comments remain in any production stage file. No "Refactored" docstrings remain in error_handling.py or analyze_variants.py. The `refactored_args` variable in cli.py is untouched. All tests pass.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:
1. `grep -rn "ParallelVariantExtractionStage\|BCFToolsPrefilterStage\|TranscriptFilterStage\|StreamingDataProcessingStage\|PCAComputationStage\|GenotypeFilterStage\|ParallelAnalysisOrchestrator\|ParallelReportGenerationStage" variantcentrifuge/ tests/` — 0 matches
2. `grep -rn "refactored_pipeline\|old pipeline" variantcentrifuge/` — 0 matches (excluding variable names)
3. `grep -rn "Refactored" variantcentrifuge/pipeline_core/error_handling.py variantcentrifuge/analyze_variants.py` — 0 matches
4. `make test-fast` — 0 failures
5. `make lint` — passes
6. `make ci-check` — passes (final comprehensive check)
</verification>

<success_criteria>
- All 8 dead stage classes removed from source, registry, __init__.py, and tests
- No stale references to removed classes anywhere in the codebase
- "refactored_pipeline" default strings replaced with "pipeline"
- All 11 "old pipeline" comments reworded
- Both "Refactored" docstrings updated
- `make ci-check` passes cleanly
- Requirements CLEAN-01 through CLEAN-06 and TD-06 are all satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/30-dead-code-cleanup/30-01-SUMMARY.md`
</output>
