---
phase: 11-pipeline-io-elimination
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - variantcentrifuge/extractor.py
  - variantcentrifuge/stages/processing_stages.py
  - tests/unit/test_bcftools_extractor.py
autonomous: true

must_haves:
  truths:
    - "bcftools query extracts VCF fields to TSV with per-sample GT columns"
    - "ANN[0].* subfields parsed in Python from raw ANN string"
    - "Missing values normalized from '.' to 'NA'"
    - "Dynamic format string built from config.json fields_to_extract"
    - "Header row includes correct column names including per-sample names from VCF"
  artifacts:
    - path: "variantcentrifuge/extractor.py"
      provides: "bcftools query-based field extraction with ANN parsing"
      contains: "bcftools"
    - path: "tests/unit/test_bcftools_extractor.py"
      provides: "Unit tests for bcftools extraction and ANN parsing"
      min_lines: 80
  key_links:
    - from: "variantcentrifuge/stages/processing_stages.py"
      to: "variantcentrifuge/extractor.py"
      via: "FieldExtractionStage calls extract_fields_bcftools()"
      pattern: "extract_fields_bcftools"
    - from: "variantcentrifuge/extractor.py"
      to: "bcftools query"
      via: "subprocess.run"
      pattern: "bcftools.*query"
---

<objective>
Replace SnpSift extractFields with bcftools query for VCF-to-TSV field extraction (19x faster, measured).

Purpose: SnpSift extractFields takes 2.7 hours on large cohorts. bcftools query (C-based) does the same in ~8 minutes. This plan replaces the extraction backend while keeping the same output contract. bcftools outputs per-sample GT in separate columns (one per sample), which is exactly the format needed for Phase 11's genotype elimination strategy.

Output: Rewritten extractor.py using bcftools query + Python ANN parsing, updated FieldExtractionStage, unit tests.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-pipeline-io-elimination/11-CONTEXT.md
@.planning/phases/11-pipeline-io-elimination/11-RESEARCH.md

@variantcentrifuge/extractor.py
@variantcentrifuge/stages/processing_stages.py (lines 1019-1118: FieldExtractionStage)
@variantcentrifuge/config.json (fields_to_extract format)
@variantcentrifuge/utils.py (normalize_vcf_headers, ensure_fields_in_extract)
@variantcentrifuge/pipeline_core/context.py (context.vcf_samples, context.extracted_tsv)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite extractor.py with bcftools query + ANN parsing</name>
  <files>variantcentrifuge/extractor.py</files>
  <action>
Replace the `extract_fields()` function with a new `extract_fields_bcftools()` function that:

1. **Build bcftools format string dynamically from config fields**:
   - Map config field names to bcftools format specifiers:
     - Fixed VCF fields (CHROM, POS, REF, ALT, ID, FILTER, QUAL) -> `%CHROM`, `%POS`, etc.
     - INFO fields (AC, dbNSFP_*, splice_*, ClinVar_*, hgmd_*) -> `%INFO/AC`, `%INFO/dbNSFP_REVEL_score`, etc.
     - ANN[0].* fields (GENE, FEATUREID, EFFECT, IMPACT, HGVS_C, HGVS_P, AA_POS, AA_LEN) -> extract raw `%INFO/ANN` once, parse subfields in Python
     - NMD[0].PERC -> extract `%INFO/NMD`, parse in Python (same pipe-delimited format as ANN)
     - GEN[*].GT -> `[\t%GT]` (per-sample extraction, one column per VCF sample)
     - GEN[*].DP, GEN[*].AD, etc. -> `[\t%DP]`, `[\t%AD]` (for --append-extra-sample-fields)
   - Deduplicate: if multiple ANN[0].* fields requested, only add `%INFO/ANN` once
   - Return both the format string and ordered column name list for header construction

2. **Run bcftools query**:
   - Command: `bcftools query -u -f '{format_string}' {vcf_path}`
   - `-u` flag prints "." for undefined tags (explicit missing values)
   - Write raw output to temp file
   - If the input VCF is the output of SnpSift filter (which produces VCF), bcftools query reads it directly

3. **Post-process the raw output**:
   - Read raw TSV with pandas: `pd.read_csv(temp_file, sep='\t', header=None, dtype=str, na_values=['.'])`
   - Assign column headers: for fixed/INFO fields use the config field name; for per-sample GT columns use `context.vcf_samples` names; for ANN use "ANN" temporarily
   - **Parse ANN subfields**: For each ANN[0].* field requested in config:
     - Take first annotation: `ann_col.str.split(',').str[0]`
     - Split by pipe: `.str.split('|', expand=True)`
     - Extract subfields by SnpEff ANN spec position index:
       - Allele=0, Annotation/EFFECT=1, Annotation_Impact/IMPACT=2, Gene_Name/GENE=3, Gene_ID=4, Feature_Type=5, Feature_ID/FEATUREID=6, Transcript_BioType=7, Rank=8, HGVS.c/HGVS_C=9, HGVS.p/HGVS_P=10, cDNA.pos=11, CDS.pos=12, AA.pos/AA_POS=13, AA.len/AA_LEN=14 (note: AA_POS and AA_LEN are from the "AA.pos/AA.length" field at index 13, which contains "pos/length" — split on "/" to get pos and length separately)
     - Create columns named with original config field names (ANN[0].GENE, ANN[0].EFFECT, etc.)
     - Drop raw ANN column after parsing
   - **Parse NMD similarly** if NMD[0].PERC is requested (NMD format is same pipe-delimited structure — extract PERC subfield)
   - **Normalize missing values**: `df.fillna('NA')` and also replace literal "." strings with "NA"
   - **Handle AA_POS/AA_LEN parsing**: The ANN spec stores these as "AA.pos/AA.length" at a single index. If both ANN[0].AA_POS and ANN[0].AA_LEN are requested, split the compound field.

4. **Write output TSV** (compressed if gzip_intermediates is True):
   - Write with header row to the output file
   - Use gzip compression level 1 for intermediate files (matching current behavior)
   - The header must match what downstream stages expect: original field names from config + sample names for GT columns

5. **Keep the old `extract_fields()` function** but rename it to `extract_fields_snpsift()` as a fallback. The new `extract_fields_bcftools()` becomes the default called by FieldExtractionStage.

Important implementation notes:
- The `vcf_samples` list is needed for column naming. Pass it via the cfg dict or as a parameter. FieldExtractionStage has access to `context.vcf_samples`.
- bcftools `[\t%GT]` outputs one column per sample in VCF header order — this matches `context.vcf_samples` order exactly.
- The format string for per-sample fields uses `[\t%GT]` (with brackets for per-sample expansion). Multiple per-sample fields like GT+DP produce: `[\t%GT\t%DP]` — interleaved per sample. Handle this by reshaping: if N samples and M format fields, output has N*M per-sample columns that need to be de-interleaved.
- Do NOT use `run_command()` from utils — use `subprocess.run()` directly for better error handling and stdout capture.
  </action>
  <verify>
    Run `python -c "from variantcentrifuge.extractor import extract_fields_bcftools; print('import OK')"` succeeds.
    Run `ruff check variantcentrifuge/extractor.py` passes with no errors.
  </verify>
  <done>
    extractor.py contains extract_fields_bcftools() that builds bcftools format string from config, runs bcftools query, parses ANN subfields in Python, normalizes missing values, and writes output TSV with correct headers.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update FieldExtractionStage + unit tests</name>
  <files>variantcentrifuge/stages/processing_stages.py, tests/unit/test_bcftools_extractor.py</files>
  <action>
**Update FieldExtractionStage** (processing_stages.py, around line 1045):
- Change the import from `extract_fields` to `extract_fields_bcftools` (add `extract_fields_bcftools` to the import from `..extractor`)
- In `_process()`, call `extract_fields_bcftools()` instead of `extract_fields()`:
  - Pass `context.vcf_samples` as a parameter (needed for per-sample column naming)
  - Pass the fields string and config as before
  - The output file path stays the same (`.extracted.tsv` or `.extracted.tsv.gz`)
- Remove the `extract_config` dict construction that included `extract_fields_separator` (no longer needed — bcftools doesn't use SnpSift separators)
- Keep the `ensure_fields_in_extract()` call for extra sample fields

**Create unit tests** (tests/unit/test_bcftools_extractor.py):
- Test `build_bcftools_format_string()` with various field configs:
  - Fixed fields (CHROM, POS, REF, ALT) -> correct format specifiers
  - INFO fields (AC, dbNSFP_REVEL_score) -> %INFO/AC, %INFO/dbNSFP_REVEL_score
  - ANN[0].* fields -> single %INFO/ANN (deduplicated)
  - GEN[*].GT -> [\t%GT]
  - Mixed fields matching config.json's fields_to_extract
- Test `parse_ann_subfields()`:
  - Single annotation: "G|missense_variant|MODERATE|BRCA2|..." -> correct subfield extraction
  - Multiple annotations (comma-separated): takes first only
  - Missing ANN (empty/NA) -> NA for all subfields
  - Malformed ANN (fewer pipe fields than expected) -> NA for missing positions
- Test missing value normalization: "." -> "NA", empty -> "NA"
- Test column naming with sample list: per-sample columns named correctly
- Mark all tests with `@pytest.mark.unit`
- Do NOT test actual bcftools execution (that's integration) — mock subprocess.run for the bcftools call
  </action>
  <verify>
    `pytest tests/unit/test_bcftools_extractor.py -v` passes all tests.
    `ruff check variantcentrifuge/stages/processing_stages.py tests/unit/test_bcftools_extractor.py` passes.
    `ruff format --check variantcentrifuge/stages/processing_stages.py tests/unit/test_bcftools_extractor.py variantcentrifuge/extractor.py` passes.
  </verify>
  <done>
    FieldExtractionStage calls extract_fields_bcftools(). Unit tests cover format string building, ANN parsing, missing value normalization, and column naming. All tests pass.
  </done>
</task>

</tasks>

<verification>
- `python -c "from variantcentrifuge.extractor import extract_fields_bcftools"` imports cleanly
- `pytest tests/unit/test_bcftools_extractor.py -v` all pass
- `make lint` passes
- `make format` passes (run `ruff format` then verify)
- `pytest -m unit --timeout=60` existing unit tests still pass (no regressions)
</verification>

<success_criteria>
- extract_fields_bcftools() builds dynamic bcftools format string from any fields_to_extract config
- ANN[0].* subfields correctly parsed from raw ANN string using pipe-split
- Missing values normalized from "." to "NA"
- Per-sample GT columns named from vcf_samples list
- FieldExtractionStage wired to new function
- Unit tests cover format building, ANN parsing, edge cases
- No regressions in existing unit tests
</success_criteria>

<output>
After completion, create `.planning/phases/11-pipeline-io-elimination/11-01-SUMMARY.md`
</output>
