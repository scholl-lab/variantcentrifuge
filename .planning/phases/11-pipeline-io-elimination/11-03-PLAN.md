---
phase: 11-pipeline-io-elimination
plan: 03
type: execute
wave: 3
depends_on: ["11-02"]
files_modified:
  - tests/unit/test_gt_reconstruction.py
  - tests/unit/test_phenotype_sample_columns.py
  - tests/unit/test_pipeline_io_elimination.py
  - variantcentrifuge/stages/processing_stages.py
  - variantcentrifuge/stages/stage_registry.py
autonomous: true

must_haves:
  truths:
    - "GT reconstruction produces identical output format as old genotype replacement"
    - "Phenotype extraction from per-sample columns matches old packed-GT extraction"
    - "All golden file tests still pass with new pipeline path"
    - "Full pipeline path works: bcftools query -> analysis -> GT reconstruct -> output"
    - "Stage registry updated to reflect GenotypeReplacementStage deprecation"
  artifacts:
    - path: "tests/unit/test_gt_reconstruction.py"
      provides: "Tests proving GT reconstruction output matches old format"
      min_lines: 60
    - path: "tests/unit/test_phenotype_sample_columns.py"
      provides: "Tests proving phenotype extraction from per-sample columns"
      min_lines: 40
    - path: "tests/unit/test_pipeline_io_elimination.py"
      provides: "Integration-style tests for full new pipeline data flow"
      min_lines: 60
  key_links:
    - from: "tests/unit/test_gt_reconstruction.py"
      to: "variantcentrifuge/stages/output_stages.py"
      via: "Tests reconstruct_gt_column()"
      pattern: "reconstruct_gt_column"
    - from: "tests/unit/test_pipeline_io_elimination.py"
      to: "variantcentrifuge/stages/processing_stages.py"
      via: "Tests GenotypeReplacementStage no-op behavior"
      pattern: "GenotypeReplacementStage"
---

<objective>
Validate the full Phase 11 pipeline with comprehensive tests proving output equivalence, and clean up stage registry.

Purpose: Phase 11 changes the core data flow. This plan proves the new path (bcftools query -> per-sample columns -> analysis -> GT reconstruction at output) produces identical output to the old path (SnpSift -> packed GT -> replacement -> analysis -> output). It also cleans up the stage registry and removes dead imports.

Output: Comprehensive test suite for GT reconstruction, phenotype extraction, and full pipeline data flow. Stage registry cleanup.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-pipeline-io-elimination/11-CONTEXT.md
@.planning/phases/11-pipeline-io-elimination/11-01-SUMMARY.md
@.planning/phases/11-pipeline-io-elimination/11-02-SUMMARY.md

@variantcentrifuge/stages/output_stages.py (reconstruct_gt_column)
@variantcentrifuge/stages/processing_stages.py (GenotypeReplacementStage, PhenotypeIntegrationStage)
@variantcentrifuge/phenotype.py (extract_phenotypes_from_sample_columns)
@variantcentrifuge/stages/stage_registry.py
@tests/test_inheritance/conftest.py (fixtures for sample DataFrames)
@tests/unit/test_sample_column_creation.py (existing sample column tests — reference for patterns)
</context>

<tasks>

<task type="auto">
  <name>Task 1: GT reconstruction and phenotype extraction tests</name>
  <files>tests/unit/test_gt_reconstruction.py, tests/unit/test_phenotype_sample_columns.py</files>
  <action>
**A. Create tests/unit/test_gt_reconstruction.py:**

Test the `reconstruct_gt_column()` function from output_stages.py. Tests must prove the new output matches old genotype replacement format exactly.

Test cases:
1. **Basic reconstruction**: DataFrame with per-sample columns (Sample1=0/1, Sample2=0/0, Sample3=1/1). Expected GT: "Sample1(0/1);Sample3(1/1)" (Sample2 skipped — reference 0/0).
2. **All reference genotypes**: All samples are 0/0 or ./. -> GT is empty string ""
3. **Missing values**: Some samples have NA/NaN/"."/empty -> those samples skipped
4. **Single sample**: Only one sample in vcf_samples -> GT is "SampleA(0/1)" (no semicolons)
5. **Many samples**: 10+ samples, mix of variant and reference -> correct subset in GT
6. **Phased genotypes**: 0|1, 1|0 -> included (not reference)
7. **Hemizygous**: 1 (single allele, X-linked) -> included
8. **Per-sample columns dropped**: After reconstruction, per-sample columns are removed from DataFrame, only GT column remains
9. **Column ordering**: GT column placed at correct position (verify it's where expected)
10. **Empty DataFrame**: Zero rows -> no error, returns DataFrame with GT column (empty)

Use `@pytest.mark.unit` on all tests. Create synthetic DataFrames directly (no file I/O).

**B. Create tests/unit/test_phenotype_sample_columns.py:**

Test `extract_phenotypes_from_sample_columns()` from phenotype.py.

Test cases:
1. **Basic extraction**: Row with Sample1=0/1, Sample2=0/0. Phenotypes: {Sample1: {"HPO:001"}}. Expected: "Sample1(HPO:001)"
2. **Multiple phenotypes per sample**: Sample1 has {HPO:001, HPO:002} -> "Sample1(HPO:001,HPO:002)" (sorted)
3. **Multiple samples with variants**: Sample1=0/1, Sample3=1/1 both have phenotypes -> "Sample1(...);Sample3(...)"
4. **Sample with variant but no phenotypes**: Sample2=0/1 but no entry in phenotypes dict -> "Sample2()"
5. **All reference**: All 0/0 or ./. -> empty string ""
6. **Missing/NA values**: Samples with NA, ".", empty -> skipped
7. **Comparison with old function**: For a known input, verify `extract_phenotypes_from_sample_columns()` produces same output as `extract_phenotypes_for_gt_row()` would have with the equivalent packed GT string. This is the critical equivalence test.

Use `@pytest.mark.unit` on all tests.
  </action>
  <verify>
    `pytest tests/unit/test_gt_reconstruction.py tests/unit/test_phenotype_sample_columns.py -v` all pass.
    `ruff check tests/unit/test_gt_reconstruction.py tests/unit/test_phenotype_sample_columns.py` passes.
  </verify>
  <done>
    GT reconstruction tests prove output matches old format. Phenotype extraction tests prove equivalence with old function. All tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Pipeline data flow test + stage registry cleanup</name>
  <files>tests/unit/test_pipeline_io_elimination.py, variantcentrifuge/stages/processing_stages.py, variantcentrifuge/stages/stage_registry.py</files>
  <action>
**A. Create tests/unit/test_pipeline_io_elimination.py:**

End-to-end data flow test (unit-level, no external tools) proving the full Phase 11 pipeline path works:

1. **Test GenotypeReplacementStage no-op**: Create a mock PipelineContext with data. Call GenotypeReplacementStage._process(). Verify it returns context immediately without modifying data or creating genotype_replaced_tsv.

2. **Test full data flow simulation**:
   - Create a synthetic DataFrame mimicking bcftools query output: columns = [CHROM, POS, REF, ALT, ANN[0].GENE, ANN[0].EFFECT, GEN_0__GT (sanitized sample column name), GEN_1__GT, etc.] with real-looking variant data
   - Verify create_sample_columns_from_gt_intelligent() correctly detects that sample columns already exist and skips creation (the "sample_columns_exist" path)
   - Verify reconstruct_gt_column() produces correct packed GT from the per-sample columns
   - Verify the per-sample columns are dropped from the final output
   - Verify the output DataFrame has the same column structure as the old pipeline would produce

3. **Test backwards compatibility**: If a DataFrame with old-style packed GT column (no per-sample columns) is loaded, verify:
   - create_sample_columns_from_gt_intelligent() still creates per-sample columns from GT (existing behavior)
   - The pipeline doesn't crash

4. **Test golden file compatibility**: Import and run the existing golden file validation tests to confirm they still pass. This verifies inheritance analysis still produces correct results with the new data flow. (This test may need to be marked `@pytest.mark.slow` if it takes >10s.)

**B. Stage registry cleanup (stage_registry.py):**

- Update the GenotypeReplacementStage registration comment to indicate it's deprecated (no-op since Phase 11)
- Keep the registration (removing it would break the stage dependency graph since other stages reference "genotype_replacement" in soft_dependencies)
- Add a comment: `# Deprecated (Phase 11): stage no-ops, kept for dependency graph compatibility`

**C. Clean up processing_stages.py imports:**

- The `replace_genotypes` import was removed in Plan 02 Task 1. Verify it's gone.
- Remove any other unused imports that resulted from the changes (e.g., if `select_optimal_processing_method` or other genotype replacement helpers are no longer called)
- Check: `from ..replacer import replace_genotypes` should be gone
- Check: any imports only used by GenotypeReplacementStage's processing methods (vectorized, chunked, parallel, streaming, sequential) that are now unreachable

**D. Run full test suite:**

Run `make ci-check` (or equivalent) to verify:
- All unit tests pass
- All inheritance tests pass (golden files)
- Lint passes
- Format passes
- Type check passes (non-blocking)
  </action>
  <verify>
    `pytest tests/unit/test_pipeline_io_elimination.py -v` all pass.
    `pytest tests/test_inheritance/ -v` all golden file tests pass.
    `pytest -m unit --timeout=120` all unit tests pass.
    `make ci-check` passes (lint, format, typecheck, test-fast).
  </verify>
  <done>
    Full pipeline data flow validated end-to-end. GenotypeReplacementStage confirmed as no-op. Golden file tests pass. Stage registry annotated. All CI checks pass. Phase 11 complete.
  </done>
</task>

</tasks>

<verification>
- `pytest tests/unit/test_gt_reconstruction.py tests/unit/test_phenotype_sample_columns.py tests/unit/test_pipeline_io_elimination.py -v` all pass
- `pytest tests/test_inheritance/ -v` golden file tests pass
- `make ci-check` passes
- No regressions across entire test suite
- GT reconstruction output verified identical to old genotype replacement format
- Phenotype extraction equivalence proven
</verification>

<success_criteria>
- GT reconstruction tests prove byte-equivalent output format
- Phenotype extraction equivalence test passes (old vs new function produce same output)
- Golden file tests pass (inheritance analysis unaffected)
- Full pipeline data flow test proves end-to-end correctness
- Stage registry updated with deprecation comments
- Dead imports removed from processing_stages.py
- `make ci-check` passes with zero failures
</success_criteria>

<output>
After completion, create `.planning/phases/11-pipeline-io-elimination/11-03-SUMMARY.md`
</output>
