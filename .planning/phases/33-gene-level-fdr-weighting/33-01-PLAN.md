---
phase: 33-gene-level-fdr-weighting
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - variantcentrifuge/association/correction.py
  - variantcentrifuge/association/base.py
  - variantcentrifuge/association/diagnostics.py
  - variantcentrifuge/association/engine.py
  - variantcentrifuge/stages/analysis_stages.py
  - variantcentrifuge/cli.py
  - tests/unit/test_weighted_correction.py
autonomous: true

must_haves:
  truths:
    - "Passing --gene-prior-weights weights.tsv applies weighted BH with weights renormalized to mean=1.0; q-values differ from unweighted BH in proportion to weight variation"
    - "Genes absent from the weight file receive weight=1.0 (neutral)"
    - "If more than 50% of tested genes are missing from the weight file, a warning is emitted"
    - "If more than 80% missing, a stronger warning is emitted"
    - "Effective number of tests (sum(w)^2 / sum(w^2)) appears in diagnostics output"
    - "Running without --gene-prior-weights produces identical results to current plain BH"
    - "Zero or negative weights cause an immediate error naming offending genes"
    - "Single gene tested skips weighted BH with info log"
  artifacts:
    - path: "variantcentrifuge/association/correction.py"
      provides: "load_gene_weights() and apply_weighted_correction() functions"
      contains: "def apply_weighted_correction"
    - path: "variantcentrifuge/association/base.py"
      provides: "gene_prior_weights and gene_prior_weight_column fields on AssociationConfig"
      contains: "gene_prior_weights"
    - path: "variantcentrifuge/association/diagnostics.py"
      provides: "write_fdr_weight_diagnostics() function"
      contains: "def write_fdr_weight_diagnostics"
    - path: "variantcentrifuge/association/engine.py"
      provides: "Weighted correction path in run_all FDR pass"
      contains: "apply_weighted_correction"
    - path: "variantcentrifuge/cli.py"
      provides: "--gene-prior-weights and --gene-prior-weight-column CLI flags"
      contains: "gene-prior-weights"
    - path: "variantcentrifuge/stages/analysis_stages.py"
      provides: "Weight loading, fdr_weight column, diagnostics wiring"
      contains: "gene_prior_weights"
    - path: "tests/unit/test_weighted_correction.py"
      provides: "Unit tests for weighted BH correction and weight loading"
      min_lines: 80
  key_links:
    - from: "variantcentrifuge/cli.py"
      to: "variantcentrifuge/stages/analysis_stages.py"
      via: "cfg['gene_prior_weights'] set by CLI, read by _build_assoc_config_from_context"
      pattern: "gene_prior_weights"
    - from: "variantcentrifuge/stages/analysis_stages.py"
      to: "variantcentrifuge/association/correction.py"
      via: "load_gene_weights() called in AssociationAnalysisStage.run()"
      pattern: "load_gene_weights"
    - from: "variantcentrifuge/association/engine.py"
      to: "variantcentrifuge/association/correction.py"
      via: "apply_weighted_correction() called in FDR pass when weights present"
      pattern: "apply_weighted_correction"
    - from: "variantcentrifuge/association/engine.py"
      to: "variantcentrifuge/association/diagnostics.py"
      via: "fdr_weight column added to results_df rows"
      pattern: "fdr_weight"
---

<objective>
Implement weighted Benjamini-Hochberg FDR correction with per-gene biological prior weights.

Purpose: Users with biological prior knowledge (pLI scores, GWAS signals) can increase statistical power by providing per-gene weights that upweight biologically plausible genes and downweight implausible ones during FDR correction.

Output: Working --gene-prior-weights CLI flag, weighted BH math in correction.py, fdr_weight column in association output, weight diagnostics in diagnostics output, comprehensive unit tests.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/33-gene-level-fdr-weighting/33-CONTEXT.md
@.planning/phases/33-gene-level-fdr-weighting/33-RESEARCH.md
@variantcentrifuge/association/correction.py
@variantcentrifuge/association/base.py
@variantcentrifuge/association/diagnostics.py
@variantcentrifuge/association/engine.py
@variantcentrifuge/stages/analysis_stages.py
@variantcentrifuge/cli.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Core weighted BH implementation — correction.py, base.py, diagnostics.py</name>
  <files>
    variantcentrifuge/association/correction.py
    variantcentrifuge/association/base.py
    variantcentrifuge/association/diagnostics.py
    tests/unit/test_weighted_correction.py
  </files>
  <action>
**correction.py — add two new functions:**

1. `load_gene_weights(filepath: str, weight_column: str = "weight") -> dict[str, float]`:
   - Read TSV with pandas (header row required)
   - First column = gene identifier, column named `weight_column` = weight value
   - Validate all weights are strictly positive (> 0). If any zero or negative: raise ValueError naming the offending genes (list up to 10, then "and N more")
   - Return dict mapping gene name -> raw weight (DO NOT normalize here; normalization happens at correction time on the subset of testable genes)
   - Log info: "Loaded {N} gene weights from {filepath}"

2. `apply_weighted_correction(pvals: list[float] | np.ndarray, genes: list[str], weight_map: dict[str, float], method: str = "fdr") -> tuple[np.ndarray, np.ndarray]`:
   - `genes` is a list of gene names aligned 1:1 with `pvals`
   - For each gene, look up weight from `weight_map`; missing genes get weight=1.0
   - Compute coverage: count genes found vs missing. If >50% missing, log WARNING. If >80% missing, log stronger WARNING ("STRONG WARNING: >80% of tested genes...")
   - Renormalize weights to mean=1.0: `w_norm = raw_weights * m / raw_weights.sum()` where `m = len(pvals)`
   - Warn if max/min ratio exceeds 100, or if any single normalized weight exceeds 10
   - Special case: if m == 1, log info "Single gene tested — FDR weighting has no effect, skipping" and return `(pvals_array, np.array([1.0]))`
   - For FDR: compute `p_adj = np.clip(pvals / w_norm, 0.0, 1.0)`, then `corrected = smm.multipletests(p_adj, method="fdr_bh")[1]`
   - For Bonferroni: compute `corrected = np.clip(pvals * m / w_norm, 0.0, 1.0)` (weighted Bonferroni: min(p_i * m / w_i, 1.0))
   - Return tuple: `(corrected_pvals, w_norm)` — caller needs normalized weights for output column
   - If statsmodels is None, warn and return `(pvals_array, w_norm)` unchanged (same graceful degradation as apply_correction)
   - Compute and log effective number of tests: `n_eff = sum(w)^2 / sum(w^2)` using normalized weights

**base.py — add two new fields to AssociationConfig:**

```python
# Phase 33: Gene-level FDR weighting
gene_prior_weights: str | None = None
"""Path to gene-to-weight TSV file for weighted BH FDR correction.
None = standard (unweighted) BH/Bonferroni (backward-compatible default)."""

gene_prior_weight_column: str = "weight"
"""Column name in the weight file containing weight values. Default: 'weight'."""
```

Add these after `coast_classification` and before `association_workers`.

**diagnostics.py — add one new function:**

`write_fdr_weight_diagnostics(genes: list[str], raw_weights: dict[str, float], normalized_weights: np.ndarray, unweighted_corrected: np.ndarray, weighted_corrected: np.ndarray, fdr_threshold: float, diagnostics_dir: str | Path) -> None`:
   - Write `fdr_weight_diagnostics.tsv` with columns: gene, raw_weight, normalized_weight, unweighted_q, weighted_q, significance_change
   - `significance_change`: "gained" if crossed threshold with weighting, "lost" if lost significance, "" if unchanged
   - Log summary: "FDR weighting impact: {N} genes gained significance, {M} genes lost significance (threshold={fdr_threshold})"
   - Log weight distribution: min, max, median, mean of normalized weights
   - Log coverage: N genes with weights from file, M genes at default weight=1.0
   - Log effective number of tests

**tests/unit/test_weighted_correction.py — comprehensive unit tests:**

- Test `load_gene_weights`: valid file, missing weight column error, zero weight error, negative weight error
- Test `apply_weighted_correction` with known inputs:
  - Uniform weights (all 1.0) produce same result as `apply_correction`
  - Non-uniform weights produce different results
  - Missing genes default to weight=1.0
  - Single gene returns input unchanged
  - >50% missing coverage warning (use caplog)
  - >80% missing coverage stronger warning
  - Extreme weight ratio warning (max/min > 100)
  - Empty pvals returns empty array
  - Bonferroni method path
- Test backward compatibility: `apply_correction` is unchanged (no signature change)
- Use pytest parametrize for method variations (fdr, bonferroni)
  </action>
  <verify>
    pytest tests/unit/test_weighted_correction.py -v && make lint && make typecheck
  </verify>
  <done>
    - load_gene_weights reads TSV and validates weights (errors on zero/negative)
    - apply_weighted_correction renormalizes to mean=1.0, clips p/w to [0,1], delegates to statsmodels
    - Uniform weights produce identical output to apply_correction
    - Coverage warnings at 50% and 80% thresholds
    - Effective number of tests computed and logged
    - Single-gene edge case handled
    - write_fdr_weight_diagnostics writes per-gene detail TSV
    - All unit tests pass, lint clean, typecheck clean
  </done>
</task>

<task type="auto">
  <name>Task 2: CLI flags, engine wiring, stage integration</name>
  <files>
    variantcentrifuge/cli.py
    variantcentrifuge/association/engine.py
    variantcentrifuge/stages/analysis_stages.py
  </files>
  <action>
**cli.py — add two CLI flags to stats_group:**

After the existing `--correction-method` flag (around line 404):

```python
stats_group.add_argument(
    "--gene-prior-weights",
    default=None,
    help="TSV file with per-gene weights for weighted Benjamini-Hochberg FDR correction. "
         "First column: gene name, weight column (default: 'weight'): positive float. "
         "Genes not in the file receive weight=1.0. Activates weighted BH automatically.",
)
stats_group.add_argument(
    "--gene-prior-weight-column",
    default="weight",
    help="Column name in the gene weight file containing weight values (default: 'weight')",
)
```

In the config mapping section (around line 1212), add:
```python
cfg["gene_prior_weights"] = args.gene_prior_weights
cfg["gene_prior_weight_column"] = args.gene_prior_weight_column
```

Validate that the file exists (if provided) — add after arg parsing validation section:
```python
if args.gene_prior_weights and not os.path.isfile(args.gene_prior_weights):
    parser.error(f"--gene-prior-weights file not found: {args.gene_prior_weights}")
```

**analysis_stages.py — wire weight loading and diagnostics:**

1. In `_build_assoc_config_from_context()`, add the two new fields to the AssociationConfig constructor:
```python
gene_prior_weights=_get("gene_prior_weights", default=None, nullable=True),
gene_prior_weight_column=_get("gene_prior_weight_column", default="weight", nullable=False),
```

2. In `AssociationAnalysisStage.run()`, AFTER `engine.run_all()` returns `results_df` but BEFORE writing output:
   - If `assoc_config.gene_prior_weights` is set, load the weight map:
     ```python
     from ..association.correction import load_gene_weights
     weight_map = load_gene_weights(assoc_config.gene_prior_weights, assoc_config.gene_prior_weight_column)
     ```
   - Map normalized weights to results: for each gene in results_df, look up from the normalized weights returned by engine (stored in results_df['fdr_weight'] column — see engine changes below)
   - If diagnostics_output is set, call `write_fdr_weight_diagnostics` with the per-gene data

3. In `_validate_association_config_dict()` (around line 2059), add validation for gene_prior_weights if it appears in JSON config — it should be a string path, not a number.

**engine.py — modify FDR correction pass to support weights:**

In `run_all()`, modify the "Step 2: Apply FDR correction" section (lines ~435-449):

1. Check if `self._config.gene_prior_weights` is set (not None)
2. If weights are set:
   - Load weight map via `from variantcentrifuge.association.correction import load_gene_weights, apply_weighted_correction`
   - Call `load_gene_weights(self._config.gene_prior_weights, self._config.gene_prior_weight_column)`
   - Call `apply_weighted_correction(raw_pvals, testable_genes, weight_map, self._config.correction_method)`
   - Unpack `(corrected, normalized_weights)` from the return
   - Store normalized weights in a dict `fdr_weights_by_gene = dict(zip(testable_genes, normalized_weights))`
   - Also compute unweighted correction for diagnostics comparison: `unweighted = apply_correction(raw_pvals, self._config.correction_method)`
   - Store both for diagnostics
3. If weights are NOT set: use existing `apply_correction` path unchanged
4. In the DataFrame row-building loop, add `fdr_weight` column:
   - If weights were applied: `row["fdr_weight"] = fdr_weights_by_gene.get(gene, 1.0)`
   - If no weights: do NOT add `fdr_weight` column (backward compatible — column only appears when weights are used)
5. After building results_df, if weights were used AND diagnostics_output is set, call `write_fdr_weight_diagnostics`:
   ```python
   if self._config.diagnostics_output and fdr_weights_by_gene:
       from variantcentrifuge.association.diagnostics import write_fdr_weight_diagnostics
       write_fdr_weight_diagnostics(
           genes=testable_genes,
           raw_weights=weight_map,
           normalized_weights=normalized_weights_array,
           unweighted_corrected=unweighted,
           weighted_corrected=corrected,
           fdr_threshold=0.05,
           diagnostics_dir=self._config.diagnostics_output,
       )
   ```

**IMPORTANT constraints:**
- Do NOT move weight loading to the stage — keep it in engine.py where the correction happens, to maintain the existing pattern where engine owns all correction logic
- The stage only passes the config through; it does NOT call load_gene_weights itself
- Keep apply_correction() signature UNCHANGED — it remains the unweighted path
- The fdr_weight column uses NORMALIZED weights (post-renormalization), not raw
  </action>
  <verify>
    pytest tests/unit/test_weighted_correction.py -v && make lint && make typecheck && make test-fast
  </verify>
  <done>
    - --gene-prior-weights and --gene-prior-weight-column CLI flags are functional
    - File existence validation happens at CLI parse time
    - Weight file path flows through AssociationConfig to engine
    - engine.run_all() applies weighted BH when weights are provided
    - fdr_weight column appears in output only when weights are used
    - Diagnostics file written when both weights and diagnostics_output are set
    - No weights = identical behavior to current codebase (backward compatible)
    - All existing tests pass (make test-fast)
  </done>
</task>

</tasks>

<verification>
1. `make test-fast` — all existing tests pass (backward compatibility)
2. `pytest tests/unit/test_weighted_correction.py -v` — all weighted correction tests pass
3. `make lint && make typecheck` — no new lint or type errors
4. Manual verification: create a dummy weight file and confirm:
   - `--gene-prior-weights weights.tsv` is accepted
   - Missing file is rejected at CLI parse time
   - Zero/negative weight file causes clear error
</verification>

<success_criteria>
1. Weighted BH produces mathematically correct results: p_i/w_i passed to BH, weights renormalized to mean=1.0
2. Unweighted run produces byte-identical output to pre-change codebase
3. fdr_weight column shows normalized weights when --gene-prior-weights is used
4. Effective number of tests appears in log output and diagnostics file
5. Coverage warnings emitted at >50% and >80% missing thresholds
6. IHW is NOT implemented — no flag, no stub, no error message
7. All CI checks pass (lint, format, typecheck, test-fast)
</success_criteria>

<output>
After completion, create `.planning/phases/33-gene-level-fdr-weighting/33-01-SUMMARY.md`
</output>
