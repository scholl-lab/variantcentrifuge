---
phase: 32-region-restriction-and-pca-wiring
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - variantcentrifuge/cli.py
  - variantcentrifuge/stages/processing_stages.py
  - tests/unit/stages/test_processing_stages.py
autonomous: true

must_haves:
  truths:
    - "Passing --regions-bed capture_kit.bed restricts variant extraction to those BED regions"
    - "Chromosome naming mismatch between gene BED and restriction BED triggers a clear error"
    - "Intersection happens once in GeneBedCreationStage before chunk splitting"
    - "Empty intersection result raises a clear error (not silent 0-variant pipeline)"
  artifacts:
    - path: "variantcentrifuge/cli.py"
      provides: "--regions-bed CLI argument"
      contains: "regions-bed"
    - path: "variantcentrifuge/stages/processing_stages.py"
      provides: "BED intersection logic in GeneBedCreationStage"
      contains: "bedtools intersect"
    - path: "tests/unit/stages/test_processing_stages.py"
      provides: "Unit tests for region restriction"
      contains: "regions_bed"
  key_links:
    - from: "variantcentrifuge/cli.py"
      to: "variantcentrifuge/stages/processing_stages.py"
      via: "cfg['regions_bed'] config key"
      pattern: "regions_bed"
    - from: "variantcentrifuge/stages/processing_stages.py"
      to: "context.gene_bed_file"
      via: "Overwrites gene_bed_file with intersected BED"
      pattern: "context\\.gene_bed_file"
---

<objective>
Implement the --regions-bed BED prefilter that restricts variant extraction to callable regions.

Purpose: Users with exome/panel capture kits need to restrict analysis to captured regions. Without this, the pipeline processes all gene regions including non-callable intronic/intergenic variants, reducing specificity.

Output: CLI flag --regions-bed, bedtools intersect logic in GeneBedCreationStage, chromosome mismatch detection, unit tests.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/32-region-restriction-and-pca-wiring/32-RESEARCH.md

@variantcentrifuge/cli.py
@variantcentrifuge/stages/processing_stages.py (GeneBedCreationStage class, lines 43-141)
@variantcentrifuge/gene_bed.py
@variantcentrifuge/pipeline_core/workspace.py
@tests/unit/stages/test_processing_stages.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add --regions-bed CLI flag and config mapping</name>
  <files>variantcentrifuge/cli.py</files>
  <action>
Add a `--regions-bed` argument to the CLI parser in the "Core Input/Output" or a new "Region Restriction" argument group:

```python
parser.add_argument(
    "--regions-bed",
    help="BED file to restrict variant extraction to specified regions (e.g., capture kit BED). "
         "The gene BED is intersected with this file before variant extraction.",
    default=None,
)
```

In the config mapping section (around line 1226 where PCA config is mapped), add:
```python
cfg["regions_bed"] = getattr(args, "regions_bed", None)
```

Also add validation: if --regions-bed is provided, check the file exists at parse time:
```python
if getattr(args, "regions_bed", None) and not os.path.isfile(args.regions_bed):
    parser.error(f"--regions-bed file not found: {args.regions_bed}")
```
  </action>
  <verify>
Run `python -c "from variantcentrifuge.cli import create_parser; p = create_parser(); a = p.parse_args(['--vcf-file', 'x.vcf', '-g', 'BRCA1', '--regions-bed', '/dev/null']); print(a.regions_bed)"` — should print `/dev/null`.
Run `make lint` — no errors.
  </verify>
  <done>--regions-bed is accepted by the CLI, mapped to cfg["regions_bed"], and validated for file existence.</done>
</task>

<task type="auto">
  <name>Task 2: Implement BED intersection in GeneBedCreationStage with tests</name>
  <files>variantcentrifuge/stages/processing_stages.py, tests/unit/stages/test_processing_stages.py</files>
  <action>
In `GeneBedCreationStage`, add three helper methods and modify `_process()`:

1. Add `_read_chromosomes(self, bed_file: Path) -> set[str]`:
   - Read first column of each non-comment line (`#`, `track`, `browser` prefixes skipped).
   - Return set of chromosome names.

2. Add `_count_regions(self, bed_file: Path) -> int`:
   - Count non-comment, non-empty lines.

3. Add `_intersect_with_restriction_bed(self, gene_bed: Path, restriction_bed: str, context: PipelineContext) -> Path`:
   - Validate restriction BED exists (raise FileNotFoundError if not).
   - Read chromosomes from both BED files. Detect chr-prefix mismatch: if one set has chr-prefixed names and the other does not, raise ValueError with clear message including both prefix states.
   - Run `subprocess.run(["bedtools", "intersect", "-a", str(gene_bed), "-b", restriction_bed], stdout=out_f, check=True)` writing to `context.workspace.get_intermediate_path(f"{context.workspace.base_name}.restricted.bed")`.
   - If output file is empty (size 0), raise ValueError explaining no regions overlap.
   - Log INFO with region count summary: "Region restriction: {new} of {orig} gene regions retained after intersection with {restriction_bed}".
   - Return output Path.

4. In `_process()`, after `context.gene_bed_file = Path(bed_file)` (line 132), add:
   ```python
   # Region restriction: intersect gene BED with restriction BED
   regions_bed = context.config.get("regions_bed")
   if regions_bed:
       context.gene_bed_file = self._intersect_with_restriction_bed(
           context.gene_bed_file, regions_bed, context
       )
       logger.info(f"Gene BED restricted to regions: {context.gene_bed_file}")
   ```

In tests, add a test class `TestGeneBedCreationRegionRestriction`:

- `test_read_chromosomes`: Write a temp BED with chr1, chr2, chrX lines. Verify returns `{"chr1", "chr2", "chrX"}`. Include comment lines to verify they're skipped.
- `test_count_regions`: Write a temp BED with 5 data lines + 2 comment lines. Verify returns 5.
- `test_chr_mismatch_detection`: Create two temp BED files, one with "chr1" and one with "1". Mock subprocess to avoid actual bedtools call. Call `_intersect_with_restriction_bed()`. Assert ValueError with "Chromosome naming mismatch" in message.
- `test_empty_intersection_raises`: Mock subprocess.run to create empty output file. Assert ValueError with "produced no regions" in message.
- `test_successful_intersection`: Mock subprocess.run to write 3 lines to output file. Verify the method returns the output path and context.gene_bed_file would be updated.

Use `tmp_path` fixtures for temp BED files. Mock `subprocess.run` where bedtools is called to avoid requiring bedtools in test environment.
  </action>
  <verify>
Run `pytest tests/unit/stages/test_processing_stages.py -v -k "region" --no-header` — all region restriction tests pass.
Run `make lint` — no errors.
Run `make ci-check` — all checks pass.
  </verify>
  <done>
GeneBedCreationStage intersects gene BED with restriction BED when --regions-bed is set. Chromosome naming mismatches produce a clear ValueError. Empty intersections produce a clear ValueError. Unit tests cover all paths.
  </done>
</task>

</tasks>

<verification>
- `python -c "from variantcentrifuge.cli import create_parser; p = create_parser(); print([a.option_strings for a in p._actions if '--regions-bed' in getattr(a, 'option_strings', [])])"` shows the flag exists
- `pytest tests/unit/stages/test_processing_stages.py -v -k "region"` — all pass
- `make ci-check` — all CI checks pass
- Grep for `regions_bed` in cli.py confirms config mapping
- Grep for `bedtools intersect` in processing_stages.py confirms intersection logic
</verification>

<success_criteria>
1. --regions-bed CLI flag is accepted and mapped to config
2. GeneBedCreationStage intersects gene BED with restriction BED before returning
3. Chromosome naming mismatch raises clear ValueError
4. Empty intersection raises clear ValueError
5. Region count summary logged at INFO level
6. All existing tests still pass (no regressions)
7. 5+ new unit tests covering region restriction paths
</success_criteria>

<output>
After completion, create `.planning/phases/32-region-restriction-and-pca-wiring/32-01-SUMMARY.md`
</output>
