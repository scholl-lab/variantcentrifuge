---
phase: 23-pca-functional-weights-allelic-series-json-config
plan: 03
type: execute
wave: 3
depends_on: ["23-02"]
files_modified:
  - variantcentrifuge/association/tests/allelic_series.py
  - variantcentrifuge/association/engine.py
  - variantcentrifuge/association/base.py
  - variantcentrifuge/stages/analysis_stages.py
  - variantcentrifuge/cli.py
  - tests/unit/test_coast.py
autonomous: true

must_haves:
  truths:
    - "User can run --association-tests coast and get COAST allelic series results per gene"
    - "Variants are classified as BMV/DMV/PTV from SnpEff EFFECT/IMPACT and dbNSFP SIFT/PolyPhen annotations"
    - "Missing SIFT/PolyPhen predictions cause variants to be excluded from COAST only (not SKAT/burden)"
    - "COAST omnibus p-value feeds into ACAT-O combination"
    - "Genes missing any variant category (zero BMV, DMV, or PTV) are skipped with None p-value"
    - "COAST category weights are configurable (default w=1,2,3)"
    - "Output includes coast_burden_p_value, coast_skat_p_value, coast_p_value, and variant counts"
  artifacts:
    - path: "variantcentrifuge/association/tests/allelic_series.py"
      provides: "COASTTest AssociationTest subclass with variant classification"
      exports: ["COASTTest", "classify_variants"]
    - path: "tests/unit/test_coast.py"
      provides: "Unit tests for COAST classification and test wrapper"
      min_lines: 100
  key_links:
    - from: "variantcentrifuge/association/engine.py"
      to: "variantcentrifuge/association/tests/allelic_series.py"
      via: "coast registered in _build_registry()"
      pattern: '"coast".*COASTTest'
    - from: "variantcentrifuge/association/tests/allelic_series.py"
      to: "R AllelicSeries::COAST()"
      via: "rpy2 importr call"
      pattern: "importr.*AllelicSeries"
    - from: "variantcentrifuge/association/engine.py"
      to: "variantcentrifuge/association/tests/acat.py"
      via: "COAST omnibus p-value included in ACAT-O combination"
      pattern: "coast.*acat_o|_compute_acat_o"
---

<objective>
Implement the COAST allelic series test: variant classification (BMV/DMV/PTV) from annotation columns, R AllelicSeries::COAST() wrapper via rpy2, engine registry integration with ACAT-O feeding, and configurable category weights.

Purpose: Enable the COAST ordered alternative test that has higher power when effect magnitude increases with variant damage severity (BMV < DMV < PTV), as shown in McCaw et al. AJHG 2023.
Output: allelic_series.py with COASTTest + classify_variants, engine registration, ACAT-O integration, CLI args, unit tests.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-pca-functional-weights-allelic-series-json-config/23-CONTEXT.md
@.planning/phases/23-pca-functional-weights-allelic-series-json-config/23-RESEARCH.md
@.planning/phases/23-pca-functional-weights-allelic-series-json-config/23-01-SUMMARY.md
@.planning/phases/23-pca-functional-weights-allelic-series-json-config/23-02-SUMMARY.md

Key source files:
@variantcentrifuge/association/tests/skat_r.py (rpy2 pattern to follow)
@variantcentrifuge/association/engine.py (_build_registry, _compute_acat_o)
@variantcentrifuge/association/base.py (AssociationTest ABC, AssociationConfig)
@variantcentrifuge/association/tests/acat.py (compute_acat_o)
@variantcentrifuge/stages/analysis_stages.py (AssociationAnalysisStage._process, needs_regression list)
@variantcentrifuge/cli.py (--association-tests help text)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create COASTTest with variant classification and rpy2 wrapper</name>
  <files>
    variantcentrifuge/association/tests/allelic_series.py
    variantcentrifuge/association/base.py
    variantcentrifuge/cli.py
  </files>
  <action>
    1. **Create `variantcentrifuge/association/tests/allelic_series.py`**:

    **classify_variants()** public function:
    ```python
    PTV_EFFECTS = frozenset({
        "stop_gained", "frameshift_variant",
        "splice_acceptor_variant", "splice_donor_variant",
    })
    MISSENSE_EFFECT = "missense_variant"
    SIFT_DAMAGING = frozenset({"deleterious"})
    POLYPHEN_DAMAGING = frozenset({"probably_damaging", "possibly_damaging"})
    SIFT_BENIGN = frozenset({"tolerated"})
    POLYPHEN_BENIGN = frozenset({"benign"})

    # Possible column names for SIFT/PolyPhen (try in order)
    SIFT_COLUMN_CANDIDATES = ["dbNSFP_SIFT_pred", "SIFT_pred", "sift_pred"]
    POLYPHEN_COLUMN_CANDIDATES = [
        "dbNSFP_Polyphen2_HDIV_pred", "dbNSFP_Polyphen2_HVAR_pred",
        "Polyphen2_HDIV_pred", "Polyphen2_HVAR_pred",
        "polyphen2_hdiv_pred", "polyphen2_hvar_pred",
    ]
    ```

    Function signature: `classify_variants(gene_df, effect_col, impact_col) -> tuple[np.ndarray, np.ndarray]`
    - Returns (annotation_codes, include_mask).
    - annotation_codes: int array, 3=PTV, 2=DMV, 1=BMV, 0=unclassified.
    - include_mask: bool array, True for variants included in COAST (BMV/DMV/PTV).
    - PTV: impact == "HIGH" AND effect in PTV_EFFECTS -> code 3.
    - DMV: effect == "missense_variant" AND (SIFT in SIFT_DAMAGING OR PolyPhen in POLYPHEN_DAMAGING) -> code 2.
    - BMV: effect == "missense_variant" AND SIFT in SIFT_BENIGN AND PolyPhen in POLYPHEN_BENIGN -> code 1.
    - Missense without SIFT/PolyPhen predictions -> code 0, include_mask = False (excluded from COAST).
    - Auto-detect SIFT/PolyPhen column names from gene_df.columns using candidate lists.
    - If no SIFT or PolyPhen columns found at all, log error and return all-zero codes with all-False mask.
    - Log warning per gene with count of excluded missense variants.

    **COASTTest** class (AssociationTest subclass):
    - `name` property: "coast"
    - `parallel_safe` attribute or property: False (rpy2, same as RSKATTest)
    - `check_dependencies()`:
      - Try `importr("AllelicSeries")` — raise ImportError with install instructions if missing.
      - Also check rpy2 available (import rpy2.robjects).
    - `effect_column_names()`: return all None values (COAST has no single effect size):
      ```python
      return {"effect": None, "se": None, "ci_lower": None, "ci_upper": None}
      ```
    - `run(gene, contingency_data, config)` -> TestResult:
      - Extract gene_df from contingency_data (the gene DataFrame with per-variant rows).
      - Find EFFECT and IMPACT columns (case-insensitive search, try "EFFECT", "ANN_0__EFFECT", etc.).
      - Call `classify_variants()` to get annotation codes and include mask.
      - Filter genotype matrix and annotation codes to include_mask only.
      - Check that all 3 categories present (n_bmv>0, n_dmv>0, n_ptv>0). If any missing, return TestResult with p_value=None, skip_reason in extra.
      - Call R AllelicSeries::COAST() via rpy2:
        ```python
        import rpy2.robjects as ro
        from rpy2.robjects.packages import importr
        import rpy2.robjects.numpy2ri as numpy2ri
        numpy2ri.activate()

        allelic_series = importr("AllelicSeries")
        # Build R matrix for genotype
        r_geno = ro.r.matrix(geno_filtered.T.ravel(), nrow=n_samples, ncol=n_variants_filtered)
        r_anno = ro.IntVector(anno_codes_filtered)
        r_pheno = ro.FloatVector(phenotype)

        coast_weights = config.coast_weights or [1.0, 2.0, 3.0]
        result = allelic_series.COAST(
            anno=r_anno, geno=r_geno, pheno=r_pheno,
            covar=covar_r if covar is not None else ro.NULL,
            weights=ro.FloatVector(coast_weights),
            is_pheno_binary=ro.BoolVector([config.trait_type == "binary"]),
        )
        ```
      - Extract p-values from result.slots["Pvals"]:
        - burden_p, skat_p, omnibus_p (column names verified at runtime)
      - Extract counts: n_bmv, n_dmv, n_ptv from annotation codes.
      - Return TestResult with:
        - p_value = omnibus_p (this feeds into ACAT-O)
        - extra = {"coast_burden_p_value": burden_p, "coast_skat_p_value": skat_p, "coast_n_bmv": n_bmv, "coast_n_dmv": n_dmv, "coast_n_ptv": n_ptv}
    - `prepare()` and `finalize()`: mirror RSKATTest pattern for R lifecycle management (GC every 100 genes).

    2. **Extend AssociationConfig** in base.py:
    ```python
    coast_weights: list[float] | None = None
    """Category weights for COAST allelic series (default: [1.0, 2.0, 3.0] for BMV, DMV, PTV)."""
    ```

    3. **Update CLI** --association-tests help to include "coast":
    Update the help string to list coast as available test.
    Also add `"coast"` to the `needs_regression` check in analysis_stages.py (COAST needs genotype matrix).
  </action>
  <verify>
    `python -c "from variantcentrifuge.association.tests.allelic_series import COASTTest, classify_variants; print('OK')"` succeeds.
    `make lint && make format` passes.
  </verify>
  <done>
    COASTTest class with variant classification (BMV/DMV/PTV) and rpy2 AllelicSeries wrapper.
    classify_variants handles multiple SIFT/PolyPhen column name patterns.
    AssociationConfig has coast_weights field.
    CLI help updated with coast test.
  </done>
</task>

<task type="auto">
  <name>Task 2: Engine registration, ACAT-O integration, and unit tests</name>
  <files>
    variantcentrifuge/association/engine.py
    variantcentrifuge/stages/analysis_stages.py
    tests/unit/test_coast.py
  </files>
  <action>
    1. **Register COAST in engine.py** `_build_registry()`:
    ```python
    from variantcentrifuge.association.tests.allelic_series import COASTTest
    # Add to registry dict:
    "coast": COASTTest,
    ```
    COAST IS in the registry (unlike ACAT-O). This means ACAT-O's _compute_acat_o loop will automatically include coast_p_value when combining per-test p-values, because it iterates over self._tests. The COAST omnibus p-value feeds into ACAT-O as a single entry (not its burden/SKAT components separately — those are in TestResult.extra for diagnostic output only).

    2. **Wire COAST into AssociationAnalysisStage** in analysis_stages.py:
    - Add "coast" to the `needs_regression` tuple (line ~2164):
      ```python
      needs_regression = any(
          t in test_names for t in ("logistic_burden", "linear_burden", "skat", "skat_python", "coast")
      )
      ```
    - Add `coast_weights` to the AssociationConfig construction:
      ```python
      coast_weights=context.config.get("coast_weights"),
      ```
    - Ensure the COAST extra columns (coast_burden_p_value, coast_skat_p_value, coast_n_bmv, coast_n_dmv, coast_n_ptv) flow through the engine's row-building logic. These are in TestResult.extra and the engine already writes extra keys to the output row (line ~383 in engine.py: `for extra_key, extra_val in res.extra.items()`).

    3. **Unit tests** in tests/unit/test_coast.py:
    - Test `classify_variants()`:
      - PTV classification: frameshift_variant + HIGH impact -> code 3
      - DMV classification: missense + SIFT deleterious -> code 2
      - DMV classification: missense + PolyPhen probably_damaging -> code 2
      - BMV classification: missense + SIFT tolerated + PolyPhen benign -> code 1
      - Missing SIFT/PolyPhen on missense -> code 0, excluded (include_mask False)
      - No SIFT/PolyPhen columns at all -> all-zero codes, all-False mask, error logged
      - Mixed variants: PTV + DMV + BMV + unclassified -> correct codes and masks
    - Test COASTTest properties:
      - `name` == "coast"
      - `effect_column_names()` returns all None values
    - Test COASTTest.check_dependencies():
      - Mock rpy2 and AllelicSeries available -> no error
      - Mock AllelicSeries NOT available -> ImportError with install instructions
    - Test COASTTest.run() with mocked rpy2 (same mock pattern as test_skat_r.py):
      - Mock AllelicSeries::COAST() returning mock Pvals slot
      - Verify TestResult has correct p_value (omnibus) and extra dict keys
      - Verify gene with missing category returns p_value=None with skip reason
    - Test ACAT-O integration: verify that when coast is in test list, coast_p_value is included in ACAT-O combination (test via engine.run_all with mocked tests).
    - Mark tests with `@pytest.mark.unit` and `@pytest.mark.coast` (new marker, add to pyproject.toml).
    - Skip tests requiring rpy2 with `pytest.importorskip("rpy2")` or mock-based approach.
  </action>
  <verify>
    `pytest tests/unit/test_coast.py -v` passes all tests.
    `make lint && make format` passes.
    `make test-fast` passes (no regressions).
  </verify>
  <done>
    COASTTest registered in engine as "coast".
    COAST omnibus p-value automatically feeds into ACAT-O combination.
    COAST extra columns (burden_p, skat_p, counts) written to output.
    Unit tests cover classification logic, rpy2 mock wrapper, ACAT-O integration.
    All existing tests pass.
  </done>
</task>

</tasks>

<verification>
1. `python -c "from variantcentrifuge.association.tests.allelic_series import COASTTest, classify_variants"` imports cleanly
2. `pytest tests/unit/test_coast.py -v` — all COAST tests pass
3. `make test-fast` — no regressions in existing tests
4. `make lint && make format` — clean
</verification>

<success_criteria>
- classify_variants correctly classifies PTV (code 3), DMV (code 2), BMV (code 1) from EFFECT/IMPACT/SIFT/PolyPhen columns
- Missing SIFT/PolyPhen excludes missense from COAST only (include_mask=False)
- COASTTest wraps R AllelicSeries::COAST() via rpy2 with proper matrix formatting
- Missing AllelicSeries R package raises clear ImportError with install instructions
- Genes missing any variant category return p_value=None (not spurious p)
- COAST omnibus feeds into ACAT-O; burden/SKAT components in extra dict for diagnostics
- Category weights configurable via coast_weights (default 1,2,3)
- All unit tests pass; no regressions
</success_criteria>

<output>
After completion, create `.planning/phases/23-pca-functional-weights-allelic-series-json-config/23-03-SUMMARY.md`
</output>
