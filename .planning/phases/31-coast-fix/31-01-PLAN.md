---
phase: 31-coast-fix
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - variantcentrifuge/stages/analysis_stages.py
  - variantcentrifuge/association/tests/allelic_series.py
  - variantcentrifuge/association/tests/allelic_series_python.py
  - tests/unit/test_coast_partial_category.py
  - tests/unit/test_genotype_matrix_fallback.py
autonomous: true

must_haves:
  truths:
    - "COAST returns a numeric p-value for genes with only 1 or 2 of 3 variant categories present"
    - "COAST logs missing categories at DEBUG level and reports coast_status in extra dict"
    - "COAST INFO summary reports complete/partial/skipped counts after all genes tested"
    - "Genotype matrix is available to COAST when GT column exists but context.variants_df is None"
  artifacts:
    - path: "variantcentrifuge/stages/analysis_stages.py"
      provides: "Fixed genotype matrix fallback in branch 2 of GT reconstruction"
      contains: "_find_per_sample_gt_columns(df)"
    - path: "variantcentrifuge/association/tests/allelic_series_python.py"
      provides: "Partial-category fallback and finalize summary"
      contains: "coast_status"
    - path: "variantcentrifuge/association/tests/allelic_series.py"
      provides: "Partial-category fallback for R backend and _resolve_effect function"
      contains: "coast_status"
    - path: "tests/unit/test_coast_partial_category.py"
      provides: "Tests for partial-category fallback behavior"
    - path: "tests/unit/test_genotype_matrix_fallback.py"
      provides: "Tests for GT matrix recovery when variants_df is None"
  key_links:
    - from: "variantcentrifuge/association/tests/allelic_series_python.py"
      to: "variantcentrifuge/association/backends/coast_python.py"
      via: "partial-category genotype matrix passed to backend.test_gene()"
      pattern: "self._backend.test_gene"
    - from: "variantcentrifuge/stages/analysis_stages.py"
      to: "variantcentrifuge/association/tests/allelic_series_python.py"
      via: "genotype_matrix key in gene_data dict"
      pattern: "genotype_matrix"
---

<objective>
Fix the two bugs that cause COAST to return p_value=None for nearly every gene in real-world cohorts:
(1) genotype matrix not available when GT is already reconstructed and variants_df is None (COAST-01),
(2) all genes with fewer than 3 variant categories skipped instead of running with present categories (COAST-03).

Purpose: Without these fixes, COAST produces zero usable results on real cohorts where most genes lack all 3 BMV/DMV/PTV categories. This is the critical-path blocker for Phase 31.

Output: Fixed analysis_stages.py GT fallback, fixed partial-category logic in both COAST backends, unit tests for both fixes.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/31-coast-fix/31-CONTEXT.md
@.planning/phases/31-coast-fix/31-RESEARCH.md
@variantcentrifuge/stages/analysis_stages.py
@variantcentrifuge/association/tests/allelic_series.py
@variantcentrifuge/association/tests/allelic_series_python.py
@variantcentrifuge/association/backends/coast_python.py
@variantcentrifuge/association/base.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix genotype matrix fallback (COAST-01) and partial-category logic (COAST-03)</name>
  <files>
    variantcentrifuge/stages/analysis_stages.py
    variantcentrifuge/association/tests/allelic_series_python.py
    variantcentrifuge/association/tests/allelic_series.py
  </files>
  <action>
  **COAST-01 — Fix GT matrix fallback in analysis_stages.py:**

  In `AssociationAnalysisStage._process()`, find the `elif "GT" in df.columns and needs_regression and context.vcf_samples:` branch (~line 2375). Currently it only checks `context.variants_df` for per-sample GT columns. When `variants_df` is None or lacks GT columns, `df_with_per_sample_gt` stays None and no genotype matrix is built.

  Fix: After checking variants_df, also check `df` itself as a final fallback. The corrected branch:

  ```python
  elif "GT" in df.columns and needs_regression and context.vcf_samples:
      from ..stages.output_stages import _find_per_sample_gt_columns

      fallback_df = context.variants_df
      gt_cols_fb = _find_per_sample_gt_columns(fallback_df) if fallback_df is not None else []
      if gt_cols_fb:
          logger.info(
              f"Association analysis: recovered {len(gt_cols_fb)} "
              "per-sample GT columns from variants_df for genotype matrix"
          )
          df_with_per_sample_gt = fallback_df
      else:
          # df itself may still have per-sample GT columns alongside the packed GT string
          gt_cols_df = _find_per_sample_gt_columns(df)
          if gt_cols_df:
              logger.info(
                  f"Association analysis: recovered {len(gt_cols_df)} "
                  "per-sample GT columns from current DataFrame for genotype matrix"
              )
              df_with_per_sample_gt = df
  ```

  Also update the comment at ~line 2523 that lists regression tests to include "coast".

  **COAST-03 — Fix partial-category fallback in allelic_series_python.py:**

  In `PurePythonCOASTTest.run()`, find the "Guard: all 3 categories required" block (~line 342). Replace the `if n_bmv == 0 or n_dmv == 0 or n_ptv == 0:` guard with partial-category logic:

  ```python
  missing = [cat for cat, n in [("BMV", n_bmv), ("DMV", n_dmv), ("PTV", n_ptv)] if n == 0]
  present = [cat for cat, n in [("BMV", n_bmv), ("DMV", n_dmv), ("PTV", n_ptv)] if n > 0]

  if len(present) == 0:
      return TestResult(
          gene=gene, test_name=self.name, p_value=None,
          corrected_p_value=None, effect_size=None, ci_lower=None,
          ci_upper=None, se=None, n_cases=n_cases, n_controls=n_controls,
          n_variants=n_variants,
          extra={"coast_skip_reason": "ALL_CATEGORIES_EMPTY",
                 "coast_n_bmv": 0, "coast_n_dmv": 0, "coast_n_ptv": 0,
                 "coast_status": "skipped"},
      )

  coast_status = "complete" if not missing else "partial"
  if missing:
      logger.debug(
          f"Python COAST [{gene}]: partial -- missing {', '.join(missing)} "
          f"(BMV={n_bmv}, DMV={n_dmv}, PTV={n_ptv})"
      )
  ```

  Update the extra dict in the successful test result to include `coast_status` and conditionally `coast_missing_categories`:

  ```python
  extra_base = {
      "coast_n_bmv": n_bmv, "coast_n_dmv": n_dmv, "coast_n_ptv": n_ptv,
      "coast_status": coast_status,
  }
  if missing:
      extra_base["coast_missing_categories"] = ",".join(missing)
  ```

  Merge `extra_base` into the existing extra dict that gets returned with the TestResult.

  Add instance counters for finalize summary:
  - In `prepare()`: `self._n_complete = 0`, `self._n_partial = 0`, `self._n_skipped = 0`
  - After successful test: increment `_n_complete` or `_n_partial` based on `coast_status`
  - On skip (ALL_CATEGORIES_EMPTY or other skip reasons): increment `_n_skipped`
  - In `finalize()`: `logger.info(f"COAST: {n_tested} genes tested ({self._n_complete} complete, {self._n_partial} partial, {self._n_skipped} skipped)")`

  **COAST-03 — Same fix in allelic_series.py (R backend):**

  Apply the identical partial-category logic change to `COASTTest.run()` (~line 550). Same pattern: replace the `or` guard with `len(present) == 0`, add `coast_status`, add counters and finalize summary. The R AllelicSeries::COAST() function handles partial categories natively (drop_empty=TRUE), so once the Python guard stops short-circuiting, R COAST will produce valid results for partial genes.

  Add the same prepare/finalize counter pattern to COASTTest.
  </action>
  <verify>
  Run: `python -m pytest tests/unit/test_coast_partial_category.py tests/unit/test_genotype_matrix_fallback.py -v` (will be created in Task 2)
  Run: `python -m pytest tests/ -k "coast" -v --no-header` to verify no existing COAST tests break
  Run: `make lint` to verify no ruff errors
  </verify>
  <done>
  - The `elif` branch in analysis_stages.py checks `df` as a fallback when `variants_df` has no GT columns
  - Both allelic_series.py and allelic_series_python.py allow COAST to proceed with 1 or 2 categories present
  - Both backends skip only when ALL categories are empty (len(present) == 0)
  - coast_status ("complete"/"partial"/"skipped") and coast_missing_categories appear in TestResult.extra
  - finalize() logs INFO summary with complete/partial/skipped counts
  </done>
</task>

<task type="auto">
  <name>Task 2: Unit tests for genotype matrix fallback and partial-category behavior</name>
  <files>
    tests/unit/test_coast_partial_category.py
    tests/unit/test_genotype_matrix_fallback.py
  </files>
  <action>
  **test_coast_partial_category.py:**

  Test the partial-category fallback behavior of PurePythonCOASTTest. Use the existing test patterns from `tests/test_inheritance/` and `tests/unit/` for fixture style.

  Test cases (use mocked backend to avoid needing real statistical computation):
  1. `test_all_three_categories_present` — n_bmv>0, n_dmv>0, n_ptv>0 => coast_status == "complete", p_value is numeric
  2. `test_only_ptv_present` — n_bmv=0, n_dmv=0, n_ptv>0 => coast_status == "partial", coast_missing_categories == "BMV,DMV", p_value is numeric (not None)
  3. `test_only_bmv_and_dmv_present` — n_ptv=0 => coast_status == "partial", coast_missing_categories == "PTV", p_value is numeric
  4. `test_all_categories_empty` — n_bmv=0, n_dmv=0, n_ptv=0 => p_value is None, coast_skip_reason == "ALL_CATEGORIES_EMPTY"
  5. `test_finalize_summary_counts` — Run multiple genes with different category states, verify finalize logs correct counts

  For tests 1-4: Mock the PythonCOASTBackend.test_gene to return a known TestResult (so tests don't need rpy2 or full SKAT). Set up a minimal classify_variants return with controlled anno_codes and include_mask. The key assertion is that the `run()` method does NOT return early with p_value=None when 1-2 categories are present.

  Strategy: Patch `classify_variants` to return controlled codes, patch `self._backend.test_gene` to return a fixed result. Then call `run()` with a gene_data dict that has the necessary keys (genotype_matrix, gene_df, etc.). Assert on the returned TestResult.extra fields.

  Mark tests with `@pytest.mark.unit`.

  **test_genotype_matrix_fallback.py:**

  Test the GT matrix recovery logic in AssociationAnalysisStage._process(). This is harder to unit-test directly (large method), so test the specific branches:

  1. `test_fallback_to_df_when_variants_df_is_none` — Create a mock context where `context.variants_df` is None but `df` has per-sample GT columns (`GEN_0__GT`, `GEN_1__GT`). Verify that after the branch logic, `df_with_per_sample_gt` is set to `df`.
  2. `test_fallback_to_variants_df_when_available` — Create a mock context where `context.variants_df` has GT columns. Verify `df_with_per_sample_gt` is set to `variants_df`.
  3. `test_no_fallback_when_no_gt_columns_anywhere` — Neither df nor variants_df has GT columns. Verify `df_with_per_sample_gt` is None.

  Strategy: Extract the GT fallback logic into a helper function or test the branch logic directly using a focused test that calls just the relevant code path. If extraction is impractical, create a focused integration-style test that sets up minimal context/df and calls the relevant portion. Use `@pytest.mark.unit`.
  </action>
  <verify>
  Run: `python -m pytest tests/unit/test_coast_partial_category.py tests/unit/test_genotype_matrix_fallback.py -v`
  All tests pass.
  Run: `make lint` passes.
  Run: `make test-fast` passes (no regressions).
  </verify>
  <done>
  - test_coast_partial_category.py has 5+ test cases covering all category combinations
  - test_genotype_matrix_fallback.py has 3+ test cases covering the GT recovery branches
  - All new tests pass, all existing tests pass
  </done>
</task>

</tasks>

<verification>
1. `python -m pytest tests/unit/test_coast_partial_category.py tests/unit/test_genotype_matrix_fallback.py -v` — all new tests pass
2. `python -m pytest tests/ -k "coast" -v` — no existing COAST tests broken
3. `make ci-check` — full CI passes (lint, format, typecheck, test-fast)
4. Verify coast_status field appears in TestResult.extra by inspecting test assertions
</verification>

<success_criteria>
- COAST-01 satisfied: genotype matrix is available when GT exists but variants_df is None (branch 2 fallback)
- COAST-03 satisfied: COAST proceeds with 1 or 2 categories; only skips when all 3 are empty
- Both R and Python COAST backends have identical partial-category behavior
- finalize() logs COAST summary with complete/partial/skipped counts at INFO level
- All tests pass (new and existing)
</success_criteria>

<output>
After completion, create `.planning/phases/31-coast-fix/31-01-SUMMARY.md`
</output>
