---
phase: 16-column-level-filtering-and-visualization
plan: 03
type: execute
wave: 3
depends_on: ["16-02"]
files_modified:
  - tests/unit/test_html_report.py
  - tests/unit/test_html_report_assets.py
autonomous: true

must_haves:
  truths:
    - "Tests verify noUiSlider assets are vendored and loadable"
    - "Tests verify all Phase 16 HTML structural elements exist in rendered template"
    - "Tests verify filter-related JavaScript patterns are present in rendered HTML"
    - "Tests verify chart initialization code for all 3 new charts exists"
    - "Tests verify reactive chart update wiring (draw.dt event handler)"
  artifacts:
    - path: "tests/unit/test_html_report.py"
      provides: "Updated tests covering Phase 16 HTML report features"
    - path: "tests/unit/test_html_report_assets.py"
      provides: "Updated asset tests covering noUiSlider"
  key_links:
    - from: "tests/unit/test_html_report_assets.py"
      to: "variantcentrifuge/assets/js/nouislider.min.js"
      via: "Asset loading test"
      pattern: "nouislider"
    - from: "tests/unit/test_html_report.py"
      to: "variantcentrifuge/templates/index.html"
      via: "Template rendering test with fixture data"
      pattern: "generate_html_report"
---

<objective>
Add comprehensive tests for Phase 16 column-level filtering and visualization features.

Purpose: Verify that all Phase 16 structural elements (filter controls, chips, visualization section, chart canvases) and behavioral patterns (noUiSlider init, custom search functions, reactive updates, collapsible toggle) exist in the generated HTML report. Tests follow the established pattern from Phases 13-15.

Output: Extended test files covering noUiSlider asset loading, HTML structure, and JS behavior patterns.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-column-level-filtering-and-visualization/16-02-SUMMARY.md
@tests/unit/test_html_report.py
@tests/unit/test_html_report_assets.py
@variantcentrifuge/templates/index.html
@variantcentrifuge/generate_html_report.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add noUiSlider asset tests</name>
  <files>tests/unit/test_html_report_assets.py</files>
  <action>
    Extend the existing asset test file to cover noUiSlider. Follow the established pattern used for other vendored assets (DataTables, Chart.js, Tippy.js, FixedColumns).

    Add tests verifying:
    1. `nouislider.min.js` exists in `variantcentrifuge/assets/js/` and is non-empty
    2. `nouislider.min.css` exists in `variantcentrifuge/assets/css/` and is non-empty
    3. JS file contains "noUiSlider" string (validates content is correct)
    4. CSS file contains ".noUi-" selectors (validates content is correct)
    5. `_load_assets()` returns keys `js/nouislider.min` and `css/nouislider.min`
    6. The loaded JS asset content is non-empty string
    7. The loaded CSS asset content is non-empty string

    Use `@pytest.mark.unit` marker consistent with existing tests.
  </action>
  <verify>
    ```bash
    pytest tests/unit/test_html_report_assets.py -x -v --tb=short
    ```
  </verify>
  <done>noUiSlider asset tests pass, verifying both file existence and content validity</done>
</task>

<task type="auto">
  <name>Task 2: Add Phase 16 HTML report structure and behavior tests</name>
  <files>tests/unit/test_html_report.py</files>
  <action>
    Extend the existing HTML report test file to cover Phase 16 features. Follow the established class-scoped fixture pattern (rendering HTML once per test class, then checking for patterns/elements).

    Add a new test class `TestPhase16FilteringAndVisualization` (or extend existing class if there's one that renders the full report). The class should use the same fixture pattern as Phase 14/15 tests: render a report with sample data including IMPACT, GENE, CHROM, POS, REF, ALT, AF, ClinVar, Inheritance_Pattern columns so that filter controls would be generated for each type.

    **Test fixture data requirements:**
    - At least 5 variant rows with diverse values
    - Include: GENE (text filter), IMPACT (categorical), Inheritance_Pattern (categorical), a numeric score or AF column (numeric slider)
    - Include CHROM with at least 2 different chromosomes
    - Include REF/ALT with mix of SNVs and indels (for variant type chart)
    - Summary dict with impact_distribution and inheritance_distribution

    **HTML Structure Tests:**
    1. `test_visualization_section_exists` -- rendered HTML contains `visualization-section` class and `viz-content` id
    2. `test_three_chart_canvases_exist` -- HTML contains `variant_type_chart`, `chromosome_chart`, `af_histogram_chart` canvas ids
    3. `test_collapse_toggle_exists` -- HTML contains `collapse-toggle` class with `aria-expanded="false"`
    4. `test_filter_controls_container_exists` -- HTML contains `filter-controls` id and `filter-row` id
    5. `test_filter_toggle_button_exists` -- HTML contains `filter-toggle-btn` id
    6. `test_filter_chip_strip_exists` -- HTML contains `active-filters-strip` id and `btn-reset-all` id
    7. `test_missing_values_toggle_exists` -- HTML contains `include-missing-toggle` id with `checked` attribute
    8. `test_nouislider_css_inlined` -- HTML contains `.noUi-` CSS rules (from inlined nouislider.min.css)
    9. `test_nouislider_js_inlined` -- HTML contains `noUiSlider` in a script tag (from inlined nouislider.min.js)

    **JavaScript Behavior Pattern Tests** (check that JS code patterns exist in rendered HTML):
    10. `test_filter_initialization_pattern` -- HTML contains `noUiSlider.create` (slider creation pattern)
    11. `test_custom_search_function_pattern` -- HTML contains `ext.search.push` (DataTables filter registration)
    12. `test_missing_values_set` -- HTML contains `MISSING_VALUES` and the standard set values ('N/A', 'NA', '.')
    13. `test_active_filters_map` -- HTML contains `activeFilters` and `updateFilterChips`
    14. `test_reactive_chart_update` -- HTML contains `draw.dt` event handler and `updateAllCharts` or equivalent function
    15. `test_chart_update_no_animation` -- HTML contains `update('none')` pattern
    16. `test_debounce_pattern` -- HTML contains `setTimeout` and `clearTimeout` (text input debounce)
    17. `test_log_scale_histogram` -- HTML contains `logarithmic` (Chart.js log scale config)
    18. `test_collapsible_section_localStorage` -- HTML contains `vizSectionExpanded` localStorage key
    19. `test_include_missing_toggle_wiring` -- HTML contains `include-missing-toggle` with `change` event handler pattern
    20. `test_reset_all_button_wiring` -- HTML contains `btn-reset-all` with click handler pattern

    **Use string matching (html.find(), `in html`, regex) rather than DOM parsing**, consistent with the Phase 14/15 test pattern (14-03-02 decision: "String position comparison for layout testing").

    All tests should use `@pytest.mark.unit` marker.
  </action>
  <verify>
    ```bash
    pytest tests/unit/test_html_report.py -x -v --tb=short -k "Phase16 or phase16 or filter or visualization"
    # Then run all tests
    pytest tests/unit/test_html_report.py tests/unit/test_html_report_assets.py -x -v --tb=short
    ```
  </verify>
  <done>All Phase 16 tests pass, covering HTML structure (9 tests) and JavaScript behavior patterns (11 tests) for a total of 20+ new tests</done>
</task>

</tasks>

<verification>
1. `pytest tests/unit/test_html_report_assets.py -x -v` -- all asset tests pass including noUiSlider
2. `pytest tests/unit/test_html_report.py -x -v` -- all HTML report tests pass including Phase 16
3. `pytest -m unit -x` -- all unit tests pass
4. `make ci-check` -- full CI check passes
</verification>

<success_criteria>
- noUiSlider asset tests verify file existence, content validity, and _load_assets() integration
- HTML structure tests verify all Phase 16 DOM elements exist in rendered report
- JS behavior tests verify all critical patterns (filter init, search functions, reactive updates, debounce, log scale, localStorage)
- All existing tests continue to pass (no regressions)
- `make ci-check` passes
</success_criteria>

<output>
After completion, create `.planning/phases/16-column-level-filtering-and-visualization/16-03-SUMMARY.md`
</output>
