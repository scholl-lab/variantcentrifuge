---
phase: 16-column-level-filtering-and-visualization
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - variantcentrifuge/assets/js/nouislider.min.js
  - variantcentrifuge/assets/css/nouislider.min.css
  - variantcentrifuge/templates/index.html
  - variantcentrifuge/generate_html_report.py
autonomous: true

must_haves:
  truths:
    - "noUiSlider JS and CSS assets are vendored and inlined into generated HTML"
    - "A collapsible Visualizations section exists between the dashboard and the table"
    - "Filter control row HTML exists in the table section with placeholders for each filterable column type"
    - "A filter chip strip container exists above the table for active filter display"
    - "A global 'Include missing values' toggle exists near the filter controls"
    - "CSS styles for all new UI elements (sliders, dropdowns, chips, collapsible section, charts) are defined"
  artifacts:
    - path: "variantcentrifuge/assets/js/nouislider.min.js"
      provides: "noUiSlider range slider library"
    - path: "variantcentrifuge/assets/css/nouislider.min.css"
      provides: "noUiSlider default styles"
    - path: "variantcentrifuge/templates/index.html"
      provides: "Updated template with filter UI scaffolding and visualization section"
      contains: "nouislider"
    - path: "variantcentrifuge/generate_html_report.py"
      provides: "Updated report generator loading nouislider assets"
  key_links:
    - from: "variantcentrifuge/generate_html_report.py"
      to: "variantcentrifuge/assets/js/nouislider.min.js"
      via: "_load_assets() auto-discovers files in assets/js/"
      pattern: "assets_dir.*assets"
    - from: "variantcentrifuge/templates/index.html"
      to: "assets dict"
      via: "Jinja2 {{ assets['js/nouislider.min'] }}"
      pattern: "assets\\['js/nouislider"
---

<objective>
Vendor the noUiSlider library and build all HTML/CSS scaffolding for Phase 16's column-level filtering and expanded visualization features.

Purpose: Establishes the structural foundation (HTML elements, CSS styles, vendored assets) that Plan 02 will wire up with JavaScript behavior. Separating structure from behavior keeps each plan within context budget.

Output: Updated index.html template with filter controls row, filter chip strip, collapsible visualization section (3 new chart canvases), global missing values toggle, and all associated CSS. noUiSlider vendored as inlined asset.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-column-level-filtering-and-visualization/16-CONTEXT.md
@.planning/phases/16-column-level-filtering-and-visualization/16-RESEARCH.md
@variantcentrifuge/templates/index.html
@variantcentrifuge/generate_html_report.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Vendor noUiSlider assets</name>
  <files>
    variantcentrifuge/assets/js/nouislider.min.js
    variantcentrifuge/assets/css/nouislider.min.css
  </files>
  <action>
    Download noUiSlider 15.7.1 minified JS and CSS from jsDelivr CDN:

    ```bash
    curl -o variantcentrifuge/assets/js/nouislider.min.js \
      https://cdn.jsdelivr.net/npm/nouislider@15.7.1/dist/nouislider.min.js

    curl -o variantcentrifuge/assets/css/nouislider.min.css \
      https://cdn.jsdelivr.net/npm/nouislider@15.7.1/dist/nouislider.min.css
    ```

    The existing `_load_assets()` in `generate_html_report.py` auto-discovers all files in `assets/js/` and `assets/css/` directories, so no code change is needed for asset loading. The assets will be available as `assets['js/nouislider.min']` and `assets['css/nouislider.min']` in the template.

    Verify both files are non-empty and contain expected content (noUiSlider for JS, .noUi- selectors for CSS).
  </action>
  <verify>
    ```bash
    test -s variantcentrifuge/assets/js/nouislider.min.js && echo "JS OK"
    test -s variantcentrifuge/assets/css/nouislider.min.css && echo "CSS OK"
    grep -q "noUiSlider" variantcentrifuge/assets/js/nouislider.min.js && echo "JS content OK"
    grep -q ".noUi-" variantcentrifuge/assets/css/nouislider.min.css && echo "CSS content OK"
    ```
  </verify>
  <done>noUiSlider 15.7.1 JS and CSS files exist in assets directories, contain valid content, and will be auto-loaded by _load_assets()</done>
</task>

<task type="auto">
  <name>Task 2: Add HTML scaffolding and CSS for filter UI and visualization section</name>
  <files>
    variantcentrifuge/templates/index.html
  </files>
  <action>
    Modify the index.html template to add all structural HTML and CSS for Phase 16. This task adds NO JavaScript behavior -- only HTML elements and CSS styles. Plan 02 will wire up the JS.

    **CSS additions (in the existing `<style>` block):**

    1. **noUiSlider inline CSS asset** -- Add `<style>{{ assets['css/nouislider.min'] }}</style>` after the fixedcolumns CSS line in the `<head>`.

    2. **Filter controls section CSS:**
       - `.filter-controls` -- Container for the filter toggle button and filter row
       - `.filter-toggle-btn` -- Button to show/hide filter row (styled like the existing Density button -- consistent with Phase 15 toolbar buttons)
       - `.filter-row` -- Hidden by default (`display: none`), contains per-column filter controls
       - `.filter-control` -- Individual filter control wrapper (label + widget)
       - `.slider-container` -- Container for noUiSlider instances, min height 40px
       - `.slider-values` -- Min/max value display below sliders, flex with space-between
       - `.category-dropdown` -- Styled select element for categorical filters (IMPACT, ClinVar, Inheritance)
       - `.filter-text-input` -- Text input for GENE search

    3. **Filter chip strip CSS:**
       - `.filter-strip` -- Container strip between toolbar and table, hidden by default (`display: none`)
       - `.filter-chips-container` -- Flex container with wrap, gap 6px, align-items center
       - `.filter-count` -- "N filters active" badge, font-weight 600, font-size 13px
       - `.filter-chip` -- Pill-shaped chip: background #e3f2fd, border 1px solid #2196f3, border-radius 16px, padding 4px 8px 4px 12px, font-size 13px, color #1976d2
       - `.chip-remove` -- X button: background none, border none, color #1976d2, font-size 18px, cursor pointer, hover darkens to #0d47a1
       - `.btn-reset-all` -- "Reset All Filters" button: background #f8d7da, color #721c24, border 1px solid #f5c6cb, border-radius 16px, padding 4px 12px, font-size 13px, cursor pointer, hover darkens

    4. **Missing values toggle CSS:**
       - `.missing-toggle` -- Flex container with align-items center, gap 6px, font-size 13px
       - `.missing-toggle input[type="checkbox"]` -- Accent color #2196f3

    5. **Collapsible visualization section CSS:**
       - `.visualization-section` -- Margin-bottom 20px, placed between dashboard and table-section
       - `.collapse-toggle` -- Full width button: background white, border 1px solid #dee2e6, border-radius 8px, padding 12px 16px, text-align left, cursor pointer, display flex, align-items center, gap 8px, font-size 16px, font-weight 600. Hover: background #f8f9fa
       - `.collapse-toggle .chevron-icon` -- Use a different class name than `.chevron` (which is used by table row expansion). Font-size 12px, transition transform 200ms
       - `.collapse-toggle[aria-expanded="true"] .chevron-icon` -- Transform rotate(90deg)
       - `.collapse-content[hidden]` -- display none
       - `.charts-grid-3col` -- Grid with `repeat(auto-fit, minmax(300px, 1fr))`, gap 16px. Reuse existing `.chart-wrapper` and `.chart-container-sm` styles for individual chart wrappers

    **HTML additions:**

    1. **noUiSlider JS asset** -- Add `<script>{{ assets['js/nouislider.min'] }}</script>` in the script section, AFTER jquery.slim.min and BEFORE datatables.min (noUiSlider has no dependencies, but should load before our custom code).

    2. **Collapsible Visualization Section** -- Insert between `</div><!-- end dashboard -->` and `<div class="table-section">`:
       ```html
       <!-- Visualization Section (Phase 16) -->
       <div class="visualization-section">
           <button class="collapse-toggle" aria-expanded="false" aria-controls="viz-content">
               <span class="chevron-icon">&#x25B6;</span>
               Visualizations
               <span style="font-weight:normal;color:#6c757d;font-size:13px;">3 charts</span>
           </button>
           <div id="viz-content" class="collapse-content" hidden>
               <div class="charts-grid-3col">
                   <div class="chart-wrapper">
                       <h3>Variant Type Breakdown</h3>
                       <div class="chart-container-sm">
                           <canvas id="variant_type_chart"></canvas>
                       </div>
                   </div>
                   <div class="chart-wrapper">
                       <h3>Chromosome Distribution</h3>
                       <div class="chart-container-sm">
                           <canvas id="chromosome_chart"></canvas>
                       </div>
                   </div>
                   <div class="chart-wrapper">
                       <h3>Allele Frequency</h3>
                       <div class="chart-container-sm">
                           <canvas id="af_histogram_chart"></canvas>
                       </div>
                   </div>
               </div>
           </div>
       </div>
       ```

    3. **Filter Controls and Chip Strip** -- Insert inside `.table-section`, after `<h2>Variants Table</h2>` and before the loading skeleton:
       ```html
       <!-- Filter Controls (Phase 16) -->
       <div class="filter-controls" id="filter-controls">
           <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;">
               <button class="filter-toggle-btn" id="filter-toggle-btn" type="button">
                   &#x1F50D; Filters
               </button>
               <div class="missing-toggle">
                   <label>
                       <input type="checkbox" id="include-missing-toggle" checked>
                       Include missing values
                   </label>
               </div>
           </div>
           <div class="filter-row" id="filter-row" style="display:none;">
               <!-- Filter controls will be dynamically populated by JS in Plan 02 -->
           </div>
       </div>

       <!-- Active Filter Chips (Phase 16) -->
       <div class="filter-strip" id="active-filters-strip" style="display:none;">
           <div class="filter-chips-container">
               <span class="filter-count"></span>
               <!-- Chips inserted dynamically by JS -->
               <button class="btn-reset-all" id="btn-reset-all" type="button">Reset All Filters</button>
           </div>
       </div>
       ```

    **Important considerations:**
    - The `.chevron-icon` class MUST be different from the existing `.chevron` class used for table row expansion (Phase 15). Use `chevron-icon` for the collapsible section toggle.
    - The filter row is `display:none` by default -- the toggle button shows/hides it.
    - Filter controls within the row will be dynamically created by JS in Plan 02 (based on column data). The empty `#filter-row` div is the mount point.
    - Do NOT add any `<script>` code beyond the asset inlining. All behavior is Plan 02.
  </action>
  <verify>
    ```bash
    # Check template contains all new HTML elements
    grep -c "visualization-section\|filter-controls\|active-filters-strip\|collapse-toggle\|variant_type_chart\|chromosome_chart\|af_histogram_chart\|include-missing-toggle\|btn-reset-all\|filter-row\|nouislider" variantcentrifuge/templates/index.html
    # Should return 11+ matches

    # Verify noUiSlider assets are referenced
    grep "nouislider" variantcentrifuge/templates/index.html

    # Verify no JS behavior was added (only asset inlining)
    # The new HTML should contain no addEventListener or function declarations
    ```
  </verify>
  <done>
    index.html contains: noUiSlider CSS/JS asset inlines, collapsible visualization section with 3 canvas elements, filter controls container with toggle button, filter chip strip with reset button, missing values toggle checkbox, and all CSS styles for these elements. No JavaScript behavior added.
  </done>
</task>

</tasks>

<verification>
1. `python -c "from variantcentrifuge.generate_html_report import _load_assets; a = _load_assets(); assert 'js/nouislider.min' in a; assert 'css/nouislider.min' in a; print('Assets load OK')"` -- noUiSlider assets discoverable
2. Template contains all structural elements: `visualization-section`, `filter-controls`, `active-filters-strip`, `collapse-toggle`, 3 chart canvases, missing toggle, reset button
3. `make lint` passes (Python files unchanged except possibly generate_html_report.py if needed)
4. `pytest tests/unit/test_html_report_assets.py -x` -- existing asset tests still pass
</verification>

<success_criteria>
- noUiSlider 15.7.1 JS and CSS vendored in assets directories
- index.html has all HTML scaffolding for filters, chips, visualizations, and missing toggle
- All new CSS styles defined in the template's style block
- noUiSlider assets inlined via Jinja2 template tags
- Existing tests still pass
- No JavaScript behavior added (that's Plan 02)
</success_criteria>

<output>
After completion, create `.planning/phases/16-column-level-filtering-and-visualization/16-01-SUMMARY.md`
</output>
