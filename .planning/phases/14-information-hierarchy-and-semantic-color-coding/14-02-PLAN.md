---
phase: 14-information-hierarchy-and-semantic-color-coding
plan: 02
type: execute
wave: 2
depends_on: ["14-01"]
files_modified:
  - variantcentrifuge/templates/index.html
autonomous: true

must_haves:
  truths:
    - "IMPACT column values render as colored pill badges (HIGH=red, MODERATE=orange, LOW=amber, MODIFIER=gray)"
    - "ClinVar classification values render as colored pill badges (Pathogenic=red through Benign=green)"
    - "Inheritance pattern values render as colored pill badges (de_novo=red, compound_het=purple, AD=blue, AR=green, X-linked=teal)"
    - "Missing ClinVar data shows empty cell (no badge), missing inheritance shows gray 'Unknown' badge"
    - "Sorting and filtering still work correctly on badge columns (raw data used for sort/filter, HTML only for display)"
    - "A metadata footer at the bottom shows filter criteria, VCF source, reference genome, pipeline version, run date"
  artifacts:
    - path: "variantcentrifuge/templates/index.html"
      provides: "Badge CSS, DataTables columnDefs render functions, metadata footer HTML"
      contains: "badge"
  key_links:
    - from: "variantcentrifuge/templates/index.html (JS)"
      to: "DataTables columnDefs"
      via: "render function checks type === 'display' before returning badge HTML"
      pattern: "type === .display."
    - from: "variantcentrifuge/templates/index.html (footer)"
      to: "template variables"
      via: "Jinja2 variables filter_expression, vcf_source, reference_genome"
      pattern: "filter_expression|vcf_source|reference_genome"
---

<objective>
Add semantic color-coded pill badges to IMPACT, ClinVar, and Inheritance Pattern columns in the DataTables variant table, and add a metadata footer at the bottom of the report.

Purpose: Color-coded badges enable rapid visual scanning of clinical significance. The metadata footer provides traceability for the report's origin and parameters.

Output: Updated index.html with badge CSS, DataTables column render functions for three badge types, and a metadata footer with pipeline run information.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-information-hierarchy-and-semantic-color-coding/14-CONTEXT.md
@.planning/phases/14-information-hierarchy-and-semantic-color-coding/14-RESEARCH.md
@.planning/phases/14-information-hierarchy-and-semantic-color-coding/14-01-SUMMARY.md
@variantcentrifuge/templates/index.html
@variantcentrifuge/inheritance/prioritizer.py (lines 14-68, PATTERN_PRIORITY for all pattern string values)
@variantcentrifuge/config.json (line 5 for field names including ClinVar_CLNSIG and dbNSFP_clinvar_clnsig)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add pill badge CSS and DataTables column render functions for IMPACT, ClinVar, and Inheritance</name>
  <files>variantcentrifuge/templates/index.html</files>
  <action>
**CSS additions** -- add to the existing `<style>` block in index.html:

```css
/* Pill Badge Base */
.badge {
    display: inline-block;
    padding: 3px 10px;
    font-size: 11px;
    font-weight: 600;
    line-height: 1.2;
    text-align: center;
    white-space: nowrap;
    border-radius: 12px;
    color: white;
    vertical-align: middle;
}
```

No individual badge color classes needed -- colors are applied via inline styles in the render functions for maintainability (the color maps are in JS, not duplicated in CSS).

**JavaScript changes** -- in the DataTables initialization section, modify the `dtColumnDefs` array construction.

After the existing code that builds `hiddenColumnIndices` and before the DataTable initialization, add column render functions. The key is to iterate `columnData` and detect badge-eligible columns by their `original_name`:

```javascript
// Badge render functions for semantic color coding
columnData.forEach(function(col, index) {
    // IMPACT column badge rendering
    if (col.original_name === 'IMPACT') {
        dtColumnDefs.push({
            targets: index,
            render: function(data, type, row) {
                if (type === 'display' && data) {
                    var colors = {
                        'HIGH': '#dc3545',
                        'MODERATE': '#fd7e14',
                        'LOW': '#f59e0b',      // Darker amber for WCAG contrast
                        'MODIFIER': '#6c757d'
                    };
                    var color = colors[data] || '#6c757d';
                    return '<span class="badge" style="background-color:' + color + ';">' + data + '</span>';
                }
                return data;
            }
        });
    }

    // ClinVar classification badge rendering
    // Column names: dbNSFP_clinvar_clnsig OR ClinVar_CLNSIG
    if (col.original_name === 'dbNSFP_clinvar_clnsig' || col.original_name === 'ClinVar_CLNSIG') {
        dtColumnDefs.push({
            targets: index,
            render: function(data, type, row) {
                if (type === 'display' && data && String(data).trim() !== '') {
                    var str = String(data);
                    // ClinVar values may contain underscores or slashes
                    // Normalize for matching: lowercase, replace separators
                    var lower = str.toLowerCase();
                    var color = '#6c757d'; // default gray
                    if (lower.indexOf('pathogenic') !== -1 && lower.indexOf('likely') === -1 && lower.indexOf('conflicting') === -1) {
                        color = '#dc3545'; // Red
                    } else if (lower.indexOf('likely_pathogenic') !== -1 || lower.indexOf('likely pathogenic') !== -1) {
                        color = '#e8590c'; // Orange-red
                    } else if (lower.indexOf('uncertain') !== -1 || lower === 'vus') {
                        color = '#f59e0b'; // Darker amber for WCAG
                    } else if (lower.indexOf('likely_benign') !== -1 || lower.indexOf('likely benign') !== -1) {
                        color = '#7cb342'; // Light green
                    } else if (lower.indexOf('benign') !== -1 && lower.indexOf('likely') === -1) {
                        color = '#4caf50'; // Green
                    } else if (lower.indexOf('conflicting') !== -1) {
                        color = '#ff9800'; // Orange for conflicting
                    }
                    // Display cleaned text (replace underscores with spaces)
                    var displayText = str.replace(/_/g, ' ');
                    return '<span class="badge" style="background-color:' + color + ';">' + displayText + '</span>';
                }
                return ''; // Empty cell for missing ClinVar data
            }
        });
    }

    // Inheritance Pattern badge rendering
    if (col.original_name === 'Inheritance_Pattern') {
        dtColumnDefs.push({
            targets: index,
            render: function(data, type, row) {
                if (type === 'display') {
                    if (!data || String(data).trim() === '' || data === 'none' || data === 'reference') {
                        return '<span class="badge" style="background-color:#6c757d;">Unknown</span>';
                    }
                    var str = String(data);
                    var lower = str.toLowerCase();
                    var color = '#6c757d'; // default gray
                    if (lower === 'de_novo' || lower === 'de_novo_candidate') {
                        color = '#dc3545'; // Red
                    } else if (lower.indexOf('compound_heterozygous') !== -1) {
                        color = '#9c27b0'; // Purple
                    } else if (lower.indexOf('autosomal_dominant') !== -1) {
                        color = '#2196f3'; // Blue
                    } else if (lower.indexOf('autosomal_recessive') !== -1) {
                        color = '#4caf50'; // Green
                    } else if (lower.indexOf('x_linked') !== -1) {
                        color = '#00acc1'; // Teal
                    } else if (lower === 'mitochondrial') {
                        color = '#ff9800'; // Orange
                    } else if (lower === 'homozygous') {
                        color = '#78909c'; // Blue-gray
                    } else if (lower === 'non_mendelian') {
                        color = '#ef5350'; // Light red
                    }
                    // Display cleaned text
                    var displayText = str.replace(/_/g, ' ');
                    return '<span class="badge" style="background-color:' + color + ';">' + displayText + '</span>';
                }
                return data;
            }
        });
    }
});
```

**Critical: type === 'display' check.** The render function is called with different `type` values by DataTables:
- `'display'` -- return badge HTML
- `'sort'` -- return raw data for correct alphabetical/custom sorting
- `'filter'` -- return raw data so search finds "HIGH" not `<span class="badge"...`
- `'type'` -- return raw data for type detection

Only apply badge HTML when `type === 'display'`. All other types must return raw `data`.

**ClinVar matching order matters.** Check "likely_pathogenic" BEFORE "pathogenic" (or check that "likely" is absent). The current logic handles this by checking `indexOf('likely') === -1` for the pathogenic match.

**LOW impact uses #f59e0b (darker amber)** instead of #ffc107 because #ffc107 with white text fails WCAG AA contrast (1.8:1). #f59e0b with bold text at 11px achieves ~3.9:1 which passes for large/bold text (3:1 threshold). The badge uses font-weight: 600 which qualifies as bold.

**Also update the impact chart color map** to use #f59e0b for LOW instead of #ffc107, for consistency between badges and chart.
  </action>
  <verify>
Run `make lint` to ensure no formatting issues in the template. Visually inspect the JS code to confirm:
1. Three columnDefs render functions are added (IMPACT, ClinVar, Inheritance_Pattern)
2. All render functions check `type === 'display'` before returning HTML
3. ClinVar render returns empty string for missing data
4. Inheritance render returns "Unknown" badge for missing/none/reference values
5. Badge CSS class `.badge` is defined in the style block
  </verify>
  <done>
IMPACT, ClinVar, and Inheritance Pattern columns render as colored pill badges in the DataTables variant table. Sorting and filtering work correctly on raw data values. Missing ClinVar shows empty cell, missing inheritance shows gray "Unknown" badge.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add metadata footer with filter criteria, VCF source, reference genome, version, and run date</name>
  <files>variantcentrifuge/templates/index.html</files>
  <action>
**CSS additions** -- add to the existing `<style>` block:

```css
/* Metadata Footer */
.metadata-footer {
    background-color: #f8f9fa;
    border-top: 1px solid #dee2e6;
    padding: 12px 20px;
    margin-top: 30px;
    font-size: 11px;
    color: #6c757d;
}
.metadata-content {
    display: flex;
    flex-wrap: wrap;
    gap: 16px;
    max-width: 95%;
    margin: 0 auto;
    align-items: baseline;
}
.metadata-item { display: inline-block; }
.metadata-item strong { color: #495057; }
.filter-expr {
    background-color: #e9ecef;
    padding: 2px 6px;
    border-radius: 3px;
    font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
    font-size: 10px;
    max-width: 500px;
    display: inline-block;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    vertical-align: middle;
}
```

**HTML changes:**

Replace the existing simple footer (lines 318-320 in current template):
```html
<footer>
    <p>Created with VariantCentrifuge</p>
</footer>
```

With the metadata footer. Place it inside `.container`, just before the closing `</div>` of `.container`:

```html
<footer class="metadata-footer">
    <div class="metadata-content">
        <div class="metadata-item">
            <strong>Filter:</strong>
            <code class="filter-expr" title="{{ filter_expression | default('None', true) }}">{{ filter_expression | default('None', true) }}</code>
        </div>
        <div class="metadata-item">
            <strong>VCF:</strong> {{ vcf_source | default('Unknown', true) }}
        </div>
        <div class="metadata-item">
            <strong>Reference:</strong> {{ reference_genome | default('Unknown', true) }}
        </div>
        <div class="metadata-item">
            <strong>Pipeline:</strong> VariantCentrifuge v{{ version }}
        </div>
        <div class="metadata-item">
            <strong>Generated:</strong> {{ generation_date }}
        </div>
    </div>
</footer>
```

**Key design decisions:**
- Footer is in document flow (not `position: fixed` or sticky) -- it appears at the bottom of the page when you scroll down
- `title` attribute on the filter expression code block shows the full filter string on hover (native browser tooltip) for when it's truncated by `text-overflow: ellipsis`
- Uses Jinja2 `default()` filter to gracefully handle missing template variables
- Monospace font for the filter expression since it's a code/query string
- Small text (11px) and muted gray color -- reference material, not a focal point
- `max-width: 500px` on filter expression prevents very long filter strings from dominating the footer
  </action>
  <verify>
Run `make lint` to confirm no issues. Visually inspect the template to verify:
1. Metadata footer appears at the bottom of the page (inside .container, replacing old footer)
2. Footer has 5 items: Filter, VCF, Reference, Pipeline, Generated
3. Filter expression uses monospace `<code>` tag with truncation
4. All values use Jinja2 `default()` for graceful fallback
5. Footer CSS uses flexbox wrap for responsive layout
  </verify>
  <done>
Metadata footer at the bottom of the report displays filter criteria (with truncation for long expressions), VCF source filename, reference genome, pipeline version, and generation date. Footer uses subtle gray styling and compact layout.
  </done>
</task>

</tasks>

<verification>
1. `make lint` passes
2. `pytest tests/ -m unit -x -q` passes with no regressions
3. Template has badge CSS (.badge class) and three DataTables column render functions
4. All render functions use `type === 'display'` guard
5. Metadata footer renders with 5 metadata items
6. LOW impact badge uses #f59e0b (WCAG-compliant amber), not #ffc107
</verification>

<success_criteria>
1. IMPACT column shows colored pill badges (HIGH=red, MODERATE=orange, LOW=amber, MODIFIER=gray)
2. ClinVar column shows colored pill badges matching clinical significance
3. Inheritance Pattern column shows colored pill badges matching pattern category
4. DataTables sorting and filtering still work on badge columns (using raw data)
5. Metadata footer shows filter, VCF, reference, version, date at page bottom
</success_criteria>

<output>
After completion, create `.planning/phases/14-information-hierarchy-and-semantic-color-coding/14-02-SUMMARY.md`
</output>
