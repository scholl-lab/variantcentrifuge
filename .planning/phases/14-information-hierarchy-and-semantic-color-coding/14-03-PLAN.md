---
phase: 14-information-hierarchy-and-semantic-color-coding
plan: 03
type: execute
wave: 3
depends_on: ["14-02"]
files_modified:
  - tests/unit/test_html_report.py
  - tests/unit/test_converter_summary.py
autonomous: true

must_haves:
  truths:
    - "Tests verify summary.json contains inheritance_distribution, top_genes, num_samples fields"
    - "Tests verify HTML report contains dashboard section above the variant table"
    - "Tests verify badge CSS and render functions exist in the rendered HTML"
    - "Tests verify metadata footer renders with filter, VCF, reference, version, date"
  artifacts:
    - path: "tests/unit/test_converter_summary.py"
      provides: "Tests for expanded summary.json data"
      contains: "inheritance_distribution"
    - path: "tests/unit/test_html_report.py"
      provides: "Tests for dashboard layout, badges, and metadata footer in rendered HTML"
      contains: "dashboard"
  key_links:
    - from: "tests/unit/test_converter_summary.py"
      to: "variantcentrifuge/converter.py"
      via: "Tests call produce_report_json and verify output"
      pattern: "produce_report_json"
    - from: "tests/unit/test_html_report.py"
      to: "variantcentrifuge/generate_html_report.py"
      via: "Tests call generate_html_report or render template and verify HTML output"
      pattern: "generate_html_report|dashboard|badge|metadata-footer"
---

<objective>
Add tests verifying the expanded summary data, dashboard layout, badge rendering setup, and metadata footer in the HTML report.

Purpose: Ensure Phase 14 changes are regression-tested so future phases (15-17) don't accidentally break the dashboard or badge rendering.

Output: Two test files covering summary.json expansion and HTML template rendering.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-information-hierarchy-and-semantic-color-coding/14-01-SUMMARY.md
@.planning/phases/14-information-hierarchy-and-semantic-color-coding/14-02-SUMMARY.md
@variantcentrifuge/converter.py
@variantcentrifuge/generate_html_report.py
@variantcentrifuge/templates/index.html
@tests/unit/ (check existing test patterns for HTML report tests)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Test expanded summary.json generation</name>
  <files>tests/unit/test_converter_summary.py</files>
  <action>
Create `tests/unit/test_converter_summary.py` to test the expanded `produce_report_json` function.

Check if there are existing tests for `produce_report_json` first (grep for it in tests/). If so, add to the existing file. If not, create a new test file.

Tests should use `tmp_path` fixture and create a minimal TSV file with known data, then call `produce_report_json` and verify the output summary.json.

**Test cases:**

1. **test_summary_has_inheritance_distribution**: Create a TSV with an `Inheritance_Pattern` column containing values like `de_novo`, `autosomal_dominant`, `autosomal_recessive`, `none`. Call `produce_report_json`. Load the resulting `summary.json`. Assert `inheritance_distribution` key exists and contains correct counts. Assert "none" and "reference" are excluded.

2. **test_summary_has_top_genes**: Create a TSV with a `GENE` column with repeated gene names. Call `produce_report_json`. Assert `top_genes` is a list of dicts with `gene` and `count` keys. Assert genes are sorted by count descending. Assert max 10 entries.

3. **test_summary_has_num_samples**: Create a TSV with a `GT` column containing entries like `Sample1(0/1);Sample2(0/0);Sample3(1/1)`. Call `produce_report_json`. Assert `num_samples` equals the number of unique sample IDs parsed from the GT column.

4. **test_summary_empty_dataframe**: Create an empty TSV (header only). Call `produce_report_json`. Assert `inheritance_distribution` is `{}`, `top_genes` is `[]`, `num_samples` is 0.

5. **test_summary_no_inheritance_column**: Create a TSV without `Inheritance_Pattern` column. Assert `inheritance_distribution` is `{}`.

**TSV creation helper:**
```python
import pandas as pd

def _create_test_tsv(tmp_path, data_dict):
    """Create a minimal TSV file from a dict of column->values."""
    df = pd.DataFrame(data_dict)
    tsv_path = tmp_path / "test_variants.tsv"
    df.to_csv(tsv_path, sep="\t", index=False)
    return str(tsv_path)
```

Each test should:
1. Create TSV with `_create_test_tsv`
2. Call `produce_report_json(tsv_path, str(tmp_path))`
3. Load `tmp_path / "report" / "summary.json"` with `json.load`
4. Assert expected fields and values

Mark all tests with `@pytest.mark.unit`.
  </action>
  <verify>
Run `pytest tests/unit/test_converter_summary.py -v` to confirm all tests pass. Run `make lint` to confirm code style.
  </verify>
  <done>
5 unit tests verify that `produce_report_json` correctly generates expanded summary.json with inheritance_distribution (excluding none/reference), top_genes (sorted, max 10), num_samples (from GT column), and handles empty/missing data gracefully.
  </done>
</task>

<task type="auto">
  <name>Task 2: Test HTML report dashboard, badges, and metadata footer</name>
  <files>tests/unit/test_html_report.py</files>
  <action>
Create or extend `tests/unit/test_html_report.py` to test the rendered HTML output. Check existing tests first -- Phase 13 (plan 13-03) created HTML report tests. If `test_html_report.py` already exists, ADD tests to it. If the file uses class-scoped fixtures for rendered HTML, follow the same pattern.

**Approach:** Generate a real HTML report using `generate_html_report` with mock data (JSON files), then parse the HTML and verify structure.

**Setup fixture:**
Create minimal `variants.json` and `summary.json` files with test data:
- `summary.json`: Include all new fields (num_variants, num_genes, num_samples, impact_distribution, inheritance_distribution, top_genes)
- `variants.json`: Include a few rows with IMPACT, ClinVar_CLNSIG, Inheritance_Pattern columns

Create a minimal config dict with required keys:
```python
cfg = {
    "html_report_default_hidden_columns": [],
    "links": {},
    "html_report_truncate_settings": {},
    "filters": "(ANN[0].IMPACT has 'HIGH')",
    "vcf_file": "/data/test_sample.vcf.gz",
    "reference": "hg38",
}
```

Call `generate_html_report(variants_json, summary_json, output_dir, cfg)` and read the resulting `index.html`.

**Test cases:**

1. **test_dashboard_above_table**: Assert that the string `class="dashboard"` appears BEFORE `id="variants_table"` in the HTML. This verifies the layout order.

2. **test_dashboard_has_cards**: Assert the HTML contains metric cards: check for strings like `Total Variants`, `Unique Genes`, `Samples`, `Impact Breakdown`, `Top Genes`.

3. **test_dashboard_has_charts**: Assert the HTML contains `id="impact_chart"` and either `id="inheritance_chart"` or the placeholder message about inheritance not being available.

4. **test_badge_css_exists**: Assert the HTML contains the `.badge` CSS class definition (check for `badge` in a style block).

5. **test_badge_render_functions**: Assert the HTML contains JavaScript that references `col.original_name === 'IMPACT'` and `type === 'display'` -- confirming the badge render functions are present.

6. **test_metadata_footer_exists**: Assert the HTML contains `class="metadata-footer"` and the metadata items: `Filter:`, `VCF:`, `Reference:`, `Pipeline:`, `Generated:`.

7. **test_metadata_footer_values**: Assert the rendered HTML contains the actual filter expression `(ANN[0].IMPACT has 'HIGH')` and VCF filename `test_sample.vcf.gz` and reference `hg38`.

8. **test_inheritance_placeholder_when_empty**: Create summary.json with empty `inheritance_distribution: {}`. Assert the rendered HTML contains the placeholder text "Inheritance analysis not available".

Mark all tests with `@pytest.mark.unit`.

**Important:** Use string searching (`in html_content`) rather than full DOM parsing to keep tests simple and avoid adding html parser dependencies. For order checks (dashboard before table), use `html_content.index('dashboard') < html_content.index('variants_table')`.
  </action>
  <verify>
Run `pytest tests/unit/test_html_report.py -v` to confirm all tests pass. Run `make lint` to confirm code style.
  </verify>
  <done>
8 unit tests verify the HTML report contains the dashboard above the table, metric cards, chart canvases, badge CSS and render functions, metadata footer with correct values, and inheritance placeholder for empty data.
  </done>
</task>

</tasks>

<verification>
1. `pytest tests/unit/test_converter_summary.py tests/unit/test_html_report.py -v` -- all tests pass
2. `make lint` passes
3. `pytest tests/ -m unit -x -q` -- full unit test suite passes (no regressions)
</verification>

<success_criteria>
1. All new tests pass
2. No existing tests broken
3. Tests cover: summary data expansion, dashboard layout order, card content, badge rendering setup, metadata footer content, inheritance placeholder
</success_criteria>

<output>
After completion, create `.planning/phases/14-information-hierarchy-and-semantic-color-coding/14-03-SUMMARY.md`
</output>
