---
phase: 14-information-hierarchy-and-semantic-color-coding
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - variantcentrifuge/converter.py
  - variantcentrifuge/generate_html_report.py
  - variantcentrifuge/templates/index.html
autonomous: true

must_haves:
  truths:
    - "Opening the report shows summary cards and charts ABOVE the variant table"
    - "Summary cards display Total Variants, Unique Genes, Samples, Impact breakdown, Top Genes"
    - "Impact distribution chart and inheritance distribution chart render side by side"
    - "When inheritance analysis was not run, a placeholder message appears instead of the inheritance chart"
    - "All dashboard content fits above the fold on 1080p (~600px vertical budget)"
  artifacts:
    - path: "variantcentrifuge/converter.py"
      provides: "Expanded summary.json with inheritance_distribution, top_genes, num_samples, metadata"
      contains: "inheritance_distribution"
    - path: "variantcentrifuge/generate_html_report.py"
      provides: "Passes metadata (filter, VCF source, reference, version) to template"
      contains: "filter_expression"
    - path: "variantcentrifuge/templates/index.html"
      provides: "Dashboard layout with cards row + charts row above variant table"
      contains: "dashboard"
  key_links:
    - from: "variantcentrifuge/converter.py"
      to: "summary.json"
      via: "produce_report_json writes expanded summary data"
      pattern: "inheritance_distribution|top_genes|num_samples"
    - from: "variantcentrifuge/generate_html_report.py"
      to: "variantcentrifuge/templates/index.html"
      via: "template.render passes metadata variables"
      pattern: "filter_expression|vcf_source|reference_genome"
    - from: "variantcentrifuge/templates/index.html"
      to: "summary data"
      via: "Jinja2 variables render cards and Chart.js inheritance chart"
      pattern: "summary\\.inheritance_distribution|summary\\.top_genes"
---

<objective>
Expand backend summary data and restructure the HTML template to show a dashboard (metric cards + dual charts) above the variant table.

Purpose: Users currently see the raw variant table first with summary/charts below. This plan inverts the hierarchy so clinically meaningful overview data appears first, matching modern dashboard-first UX patterns.

Output: Expanded summary.json with inheritance distribution, top genes, sample count, and pipeline metadata. Restructured index.html with CSS Grid dashboard (cards row + charts row) positioned above the variant table.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-information-hierarchy-and-semantic-color-coding/14-CONTEXT.md
@.planning/phases/14-information-hierarchy-and-semantic-color-coding/14-RESEARCH.md
@variantcentrifuge/converter.py
@variantcentrifuge/generate_html_report.py
@variantcentrifuge/templates/index.html
@variantcentrifuge/stages/output_stages.py (lines 830-889, HTMLReportStage._process)
@variantcentrifuge/inheritance/prioritizer.py (lines 14-68, PATTERN_PRIORITY and PATTERN_CATEGORIES)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Expand summary.json with inheritance distribution, top genes, sample count, and metadata</name>
  <files>variantcentrifuge/converter.py, variantcentrifuge/generate_html_report.py</files>
  <action>
In `converter.py`, expand the `produce_report_json` function to add these fields to `summary_data`:

1. **`num_samples`**: Count unique sample IDs from the GT column. The GT column format is `SampleID(genotype);SampleID2(genotype2)`. Parse all unique sample IDs across all variants. If GT column missing, set to 0.

2. **`inheritance_distribution`**: If `Inheritance_Pattern` column exists in df, compute `df["Inheritance_Pattern"].value_counts().to_dict()`. Exclude "none" and "reference" values (they mean no pattern was assigned). If column doesn't exist, set to empty dict `{}`.

3. **`top_genes`**: If `GENE` column exists, compute top 10 genes by variant count: `df["GENE"].value_counts().head(10)`. Store as list of dicts: `[{"gene": "BRCA1", "count": 15}, ...]`. If column missing, set to empty list `[]`.

4. **`filter_criteria`**: This data isn't available in `produce_report_json` (it only gets the TSV path and output_dir). Instead, pass it through `generate_html_report`. See below.

5. **`vcf_source`**: Same -- pass through generate_html_report.

6. **`reference_genome`**: Same -- pass through generate_html_report.

In `generate_html_report.py`, update the `generate_html_report` function:

1. Extract metadata from cfg and pass to template:
   - `filter_expression = cfg.get("filters", "None")`
   - `vcf_source = os.path.basename(cfg.get("vcf_file", cfg.get("input_vcf", "Unknown")))` -- note: check `cfg` dict for the key that stores the VCF path. In cli.py, `args.vcf_file` is used but may not be stored in cfg. If not available in cfg, fall back to "Unknown".
   - `reference_genome = cfg.get("reference", "Unknown")`

2. Add these to the `template.render()` call:
   ```python
   html_content = template.render(
       variants=variants_data,
       summary=summary,
       column_data=column_data_for_template,
       default_hidden_columns=default_hidden_columns,
       generation_date=pd.Timestamp.now().strftime("%Y-%m-%d %H:%M:%S"),
       version=__version__,
       assets=assets,
       filter_expression=filter_expression,
       vcf_source=vcf_source,
       reference_genome=reference_genome,
   )
   ```

Also in `cli.py` (if needed): ensure `cfg["vcf_file"] = args.vcf_file` is set. Check if this already exists -- grep for `cfg["vcf_file"]` or `cfg["input_vcf"]`. If not set, add `cfg["vcf_file"] = args.vcf_file` near line 1065 where other cfg values are set.

**Important notes:**
- The GT column format uses the compiled regex `GT_PATTERN = re.compile(r"([^()]+)\(([^)]+)\)")` already at module level. Reuse it for sample ID extraction.
- For `inheritance_distribution`, filter out "none" and "reference" before calling value_counts() since these aren't real patterns.
- For `top_genes`, handle NaN gene values by dropping them before counting.
  </action>
  <verify>
Run `pytest tests/ -m unit -x -q` to ensure no regressions. Manually inspect the code to confirm:
1. `summary_data` dict in `produce_report_json` has keys: num_variants, num_genes, num_samples, impact_distribution, inheritance_distribution, top_genes
2. `generate_html_report` passes filter_expression, vcf_source, reference_genome to template.render()
  </verify>
  <done>
`produce_report_json` generates summary.json with num_samples, inheritance_distribution, and top_genes fields. `generate_html_report` passes pipeline metadata (filter, VCF source, reference genome) to the template context.
  </done>
</task>

<task type="auto">
  <name>Task 2: Restructure HTML template with dashboard above variant table</name>
  <files>variantcentrifuge/templates/index.html</files>
  <action>
Restructure `index.html` to move summary content ABOVE the variant table and expand it into a full dashboard. The current layout is: header -> table -> summary -> chart -> footer. The new layout must be: header -> dashboard (cards + charts) -> table -> footer.

**CSS additions** (add to the existing `<style>` block):

1. Dashboard grid layout:
```css
.dashboard { margin-bottom: 24px; }
.cards-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 12px;
    margin-bottom: 16px;
}
.charts-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
}
```

2. Metric card styling (replace old `.stats-card`):
```css
.metric-card {
    background: white;
    border-radius: 8px;
    padding: 14px 16px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.06);
}
.metric-card h3 {
    margin: 0 0 4px 0;
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: #6c757d;
    font-weight: 600;
}
.metric-card .metric-value {
    margin: 0;
    font-size: 1.75rem;
    font-weight: 700;
    line-height: 1.2;
}
.metric-card .gene-list {
    list-style: none;
    padding: 0;
    margin: 0;
    font-size: 13px;
    line-height: 1.5;
}
.metric-card .gene-list li {
    display: flex;
    justify-content: space-between;
}
```

3. Chart wrapper styling:
```css
.chart-wrapper {
    background: white;
    border-radius: 8px;
    padding: 14px 16px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.06);
}
.chart-wrapper h3 {
    margin: 0 0 8px 0;
    font-size: 14px;
    font-weight: 600;
    color: #333;
}
.chart-container-sm {
    position: relative;
    height: 220px;
    width: 100%;
}
```

4. Impact breakdown mini-list styling:
```css
.impact-breakdown { list-style: none; padding: 0; margin: 0; font-size: 13px; }
.impact-breakdown li { display: flex; justify-content: space-between; align-items: center; padding: 2px 0; }
.impact-dot { display: inline-block; width: 10px; height: 10px; border-radius: 50%; margin-right: 6px; }
```

**HTML restructure:**

Remove the old `.summary-section` (lines 297-309) and `.chart-section` (lines 311-316) from their current positions below the table.

Insert a new dashboard section BETWEEN the header (line 225) and the `.table-section` (line 227):

```html
<!-- Dashboard Section -->
<div class="dashboard">
    <!-- Cards Row -->
    <div class="cards-grid">
        <div class="metric-card">
            <h3>Total Variants</h3>
            <p class="metric-value" style="color: #007bff;">{{ summary.num_variants }}</p>
        </div>
        <div class="metric-card">
            <h3>Unique Genes</h3>
            <p class="metric-value" style="color: #17a2b8;">{{ summary.num_genes }}</p>
        </div>
        <div class="metric-card">
            <h3>Samples</h3>
            <p class="metric-value" style="color: #28a745;">{{ summary.num_samples | default(0) }}</p>
        </div>
        <div class="metric-card">
            <h3>Impact Breakdown</h3>
            <ul class="impact-breakdown">
                {% for level in ['HIGH', 'MODERATE', 'LOW', 'MODIFIER'] %}
                <li>
                    <span><span class="impact-dot" style="background-color: {{ {'HIGH':'#dc3545','MODERATE':'#fd7e14','LOW':'#ffc107','MODIFIER':'#6c757d'}[level] }};"></span>{{ level }}</span>
                    <strong>{{ summary.impact_distribution.get(level, 0) if summary.impact_distribution is mapping else 0 }}</strong>
                </li>
                {% endfor %}
            </ul>
        </div>
        <div class="metric-card">
            <h3>Top Genes</h3>
            {% if summary.top_genes is defined and summary.top_genes|length > 0 %}
            <ul class="gene-list">
                {% for gene_info in summary.top_genes[:5] %}
                <li><span>{{ gene_info.gene }}</span><strong>{{ gene_info.count }}</strong></li>
                {% endfor %}
            </ul>
            {% else %}
            <p style="color: #6c757d; font-size: 13px; margin: 0;">No gene data available</p>
            {% endif %}
        </div>
    </div>

    <!-- Charts Row -->
    <div class="charts-grid">
        <div class="chart-wrapper">
            <h3>Impact Distribution</h3>
            <div class="chart-container-sm">
                <canvas id="impact_chart"></canvas>
            </div>
        </div>
        <div class="chart-wrapper">
            <h3>Inheritance Patterns</h3>
            <div class="chart-container-sm" id="inheritance_chart_container">
                {% if summary.inheritance_distribution is defined and summary.inheritance_distribution|length > 0 %}
                <canvas id="inheritance_chart"></canvas>
                {% else %}
                <p style="color: #6c757d; font-style: italic; text-align: center; padding-top: 80px;">Inheritance analysis not available (no pedigree provided)</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>
```

**JavaScript changes:**

1. Update the impact chart to use `.chart-container-sm` height (220px instead of 300px). The chart config itself stays the same.

2. Add inheritance distribution chart after the impact chart code block. Use the research example (Pattern 3 in RESEARCH.md) as the base. Key points:
   - Get data: `var inheritanceDistribution = {{ summary.inheritance_distribution | tojson }};`
   - Only initialize chart if canvas exists: `if (document.getElementById('inheritance_chart')) { ... }`
   - Color map for inheritance patterns -- use PATTERN_CATEGORIES to group patterns:
     ```javascript
     var inheritanceColorMap = {
         'de_novo': '#dc3545',
         'de_novo_candidate': '#e57373',
         'compound_heterozygous': '#9c27b0',
         'compound_heterozygous_possible': '#ba68c8',
         'compound_heterozygous_possible_no_pedigree': '#ba68c8',
         'compound_heterozygous_possible_missing_parents': '#ba68c8',
         'compound_heterozygous_possible_missing_parent_genotypes': '#ba68c8',
         'autosomal_recessive': '#4caf50',
         'autosomal_recessive_possible': '#81c784',
         'autosomal_dominant': '#2196f3',
         'autosomal_dominant_possible': '#64b5f6',
         'x_linked_recessive': '#00acc1',
         'x_linked_dominant': '#00acc1',
         'x_linked_recessive_possible': '#4dd0e1',
         'x_linked_dominant_possible': '#4dd0e1',
         'mitochondrial': '#ff9800',
         'homozygous': '#78909c',
         'non_mendelian': '#ef5350',
         'unknown': '#6c757d'
     };
     ```
   - Horizontal bar chart (indexAxis: 'y'), responsive: true, maintainAspectRatio: false
   - Use ChartDataLabels plugin same as impact chart
   - Replace underscores with spaces in labels for readability: `labels.map(l => l.replace(/_/g, ' '))`

3. Remove the old `.chart-container` CSS rule (height: 300px) if it's no longer used, or keep it and add `.chart-container-sm` alongside.

**Important constraints:**
- Total dashboard height must stay under ~600px on 1080p. Cards row ~120px + gap 16px + charts row ~260px (220px chart + padding) + gap 12px = ~408px. This leaves room for the table header.
- Keep the old `.chart-container` height rule as well (it won't be used by the dashboard but removing it is unnecessary churn).
- Remove old `.summary-section`, `.summary-grid`, `.stats-card` CSS rules since they're replaced by dashboard styles.
  </action>
  <verify>
Run `pytest tests/ -m unit -x -q` to confirm no Python test regressions. Visually inspect `index.html` template to verify:
1. Dashboard section appears between header and table-section in the HTML
2. Cards grid has 5 cards (Total Variants, Unique Genes, Samples, Impact Breakdown, Top Genes)
3. Charts grid has 2 chart containers (impact_chart, inheritance_chart)
4. Old summary-section and chart-section are removed from below the table
5. JavaScript initializes both impact and inheritance charts
  </verify>
  <done>
HTML template shows a CSS Grid dashboard above the variant table with metric cards (variants, genes, samples, impact breakdown, top genes) and side-by-side charts (impact distribution, inheritance patterns). Dashboard fits within 600px vertical budget for above-the-fold on 1080p.
  </done>
</task>

</tasks>

<verification>
1. `make lint` passes (ruff check + format on modified Python files)
2. `pytest tests/ -m unit -x -q` passes with no regressions
3. Template renders without Jinja2 errors (verified by test suite or manual inspection)
4. Dashboard HTML structure: header -> dashboard -> table (not header -> table -> summary)
5. Summary.json includes: num_variants, num_genes, num_samples, impact_distribution, inheritance_distribution, top_genes
</verification>

<success_criteria>
1. summary.json has inheritance_distribution, top_genes, and num_samples fields
2. Dashboard with cards + charts appears above the variant table in the HTML template
3. Impact distribution and inheritance distribution charts render side by side
4. When no inheritance data exists, placeholder message appears instead of chart
5. All existing tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/14-information-hierarchy-and-semantic-color-coding/14-01-SUMMARY.md`
</output>
