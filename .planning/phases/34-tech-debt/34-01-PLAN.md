---
phase: 34-tech-debt
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - variantcentrifuge/pipeline.py
  - variantcentrifuge/association/diagnostics.py
  - tests/integration/test_create_stages_from_config.py
autonomous: true

must_haves:
  truths:
    - "create_stages_from_config({'perform_association': True}) returns a stage list containing AssociationAnalysisStage"
    - "create_stages_from_config({'perform_gene_burden': True}) returns a stage list containing GeneBurdenAnalysisStage"
    - "compute_lambda_gc docstring explains Fisher exemption from correction and over-correction risk"
  artifacts:
    - path: "variantcentrifuge/pipeline.py"
      provides: "Config key mappings for perform_association and perform_gene_burden"
      contains: "perform_association"
    - path: "variantcentrifuge/association/diagnostics.py"
      provides: "Lambda_GC documentation comments"
      contains: "Fisher.*exempt"
    - path: "tests/integration/test_create_stages_from_config.py"
      provides: "Integration test for config mapping"
      contains: "AssociationAnalysisStage"
  key_links:
    - from: "variantcentrifuge/pipeline.py"
      to: "build_pipeline_stages"
      via: "args.perform_association attribute set before call"
      pattern: "args\\.perform_association.*config\\.get"
---

<objective>
Fix create_stages_from_config() missing config key mappings (TD-02) and add lambda_GC documentation to diagnostics.py (TD-05).

Purpose: TD-02 fixes a silent bug where config dicts with perform_association=True never activate the association stage. TD-05 documents the Fisher exemption from lambda_GC correction for maintainers.
Output: Fixed pipeline.py, documented diagnostics.py, new integration test.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/34-tech-debt/34-RESEARCH.md
@variantcentrifuge/pipeline.py
@variantcentrifuge/association/diagnostics.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix create_stages_from_config mappings and add integration test (TD-02)</name>
  <files>variantcentrifuge/pipeline.py, tests/integration/test_create_stages_from_config.py</files>
  <action>
In variantcentrifuge/pipeline.py, function create_stages_from_config() (around line 352-373):

1. Add the missing config key mappings BEFORE the `return build_pipeline_stages(args)` line:
   ```python
   args.perform_gene_burden = config.get("perform_gene_burden", False)
   args.perform_association = config.get("perform_association", False)
   args.no_stats = config.get("no_stats", False)
   args.no_metadata = config.get("no_metadata", False)
   ```

2. Add a docstring mapping table to the function showing config key -> stage(s):
   ```
   Config key -> Stage mapping:
     perform_association  -> AssociationAnalysisStage
     perform_gene_burden  -> GeneBurdenAnalysisStage
     scoring_config_path  -> VariantScoringStage
     ped_file             -> PedigreeLoadingStage
     xlsx                 -> ExcelReportStage
     html_report          -> HTMLReportStage
     igv_report           -> IGVReportStage
     pca                  -> PCAComputationStage
   ```

3. Audit other potentially missing mappings by comparing what build_pipeline_stages() checks via hasattr against what create_stages_from_config sets. If any are missing, add them. Pay attention to naming mismatches (e.g., does build_pipeline_stages check `args.igv` vs `args.igv_report`?).

4. Create tests/integration/test_create_stages_from_config.py with:
   - Test that config with perform_association=True produces a stage list containing AssociationAnalysisStage
   - Test that config with perform_gene_burden=True produces a stage list containing GeneBurdenAnalysisStage
   - Test that empty config (no association/burden keys) does NOT include those stages
   - Mark tests with @pytest.mark.integration
   - Import from variantcentrifuge.pipeline import create_stages_from_config
   - Import stage classes from variantcentrifuge.stages.analysis_stages
  </action>
  <verify>Run `pytest tests/integration/test_create_stages_from_config.py -v` and confirm all tests pass.</verify>
  <done>create_stages_from_config correctly activates AssociationAnalysisStage when perform_association=True and GeneBurdenAnalysisStage when perform_gene_burden=True, confirmed by integration tests.</done>
</task>

<task type="auto">
  <name>Task 2: Document lambda_GC Fisher exemption and over-correction risk (TD-05)</name>
  <files>variantcentrifuge/association/diagnostics.py</files>
  <action>
In variantcentrifuge/association/diagnostics.py, update the compute_lambda_gc() function docstring (around line 41-79):

1. Add a Notes section to the existing docstring with these key points:
   - Fisher's exact test p-values should NOT be lambda_GC-corrected (exact test, not asymptotic — applying GC correction would be statistically invalid)
   - This function computes lambda_GC for ALL tests (diagnostic use only); apply correction only to score-based asymptotic tests (SKAT, burden)
   - lambda_GC near 1.0 = well-calibrated
   - lambda_GC > 1.2 = significant inflation — investigate population stratification or cryptic relatedness
   - Over-correction risk: in large studies, GC correction can reduce power for true associations (cite Devlin and Roeder 1999, Gorroochurn et al. 2025)

2. Also add a brief inline comment in write_diagnostics() (around line 336-345) where the p-value columns are iterated, noting that lambda_GC is computed for Fisher as a diagnostic but should not be used for correction.

Keep comments concise — no full threshold tables, no exhaustive references.
  </action>
  <verify>Run `make lint` to ensure no formatting issues. Read the updated docstring to confirm it covers all four points.</verify>
  <done>compute_lambda_gc() docstring documents Fisher exemption from correction, score-test applicability, inflation threshold guidance, and over-correction risk.</done>
</task>

</tasks>

<verification>
- `pytest tests/integration/test_create_stages_from_config.py -v` passes
- `make lint` passes
- `make test-fast` passes (no regressions)
</verification>

<success_criteria>
- create_stages_from_config maps perform_association and perform_gene_burden config keys
- Integration test confirms association and gene burden stages activate from config
- compute_lambda_gc docstring explains Fisher exemption and over-correction risk
- All existing tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/34-tech-debt/34-01-SUMMARY.md`
</output>
