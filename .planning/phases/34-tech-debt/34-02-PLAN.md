---
phase: 34-tech-debt
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - variantcentrifuge/association/engine.py
  - variantcentrifuge/association/diagnostics.py
  - variantcentrifuge/association/tests/allelic_series_python.py
  - variantcentrifuge/association/tests/allelic_series.py
  - variantcentrifuge/stages/analysis_stages.py
  - docs/source/guides/association_testing.md
  - docs/source/faq.md
  - tests/unit/test_association_engine.py
  - tests/unit/test_association_diagnostics.py
  - tests/unit/test_association_fisher.py
  - tests/unit/test_association_stage.py
  - tests/unit/test_engine_skat_integration.py
  - tests/unit/test_coast.py
  - tests/unit/test_coast_partial_category.py
  - tests/unit/test_coast_python.py
  - tests/unit/test_coast_python_comparison.py
  - tests/unit/test_association_correction.py
  - tests/unit/test_association_base.py
  - tests/unit/test_association_acat.py
  - tests/unit/test_skat_python_backend.py
  - tests/unit/test_qq_plot.py
  - tests/unit/test_parallel_association.py
  - tests/unit/test_gene_burden_regression.py
  - tests/test_gene_burden_integration.py
  - tests/performance/benchmark_gene_burden.py
  - tests/performance/benchmark_pipeline_macro.py
autonomous: true

must_haves:
  truths:
    - "All association p-value columns use _pvalue suffix (no underscore before value)"
    - "ACAT-O corrected column is named acat_o_qvalue (not acat_o_corrected_p_value)"
    - "SKAT-O runs produce skat_o_pvalue column (not skat_pvalue)"
    - "COAST extra columns use coast_burden_pvalue and coast_skat_pvalue"
    - "All existing tests pass with new column names"
  artifacts:
    - path: "variantcentrifuge/association/engine.py"
      provides: "Column name generation with new convention"
      contains: "pvalue"
    - path: "variantcentrifuge/association/diagnostics.py"
      provides: "Column lookup with new names"
      contains: "_pvalue"
    - path: "variantcentrifuge/stages/analysis_stages.py"
      provides: "Q-value column detection"
      contains: "_qvalue"
    - path: "docs/source/guides/association_testing.md"
      provides: "Updated column name documentation"
      contains: "fisher_pvalue"
  key_links:
    - from: "variantcentrifuge/association/engine.py"
      to: "variantcentrifuge/association/diagnostics.py"
      via: "Column names in DataFrame"
      pattern: "_pvalue"
    - from: "variantcentrifuge/association/engine.py"
      to: "variantcentrifuge/stages/analysis_stages.py"
      via: "acat_o_qvalue column"
      pattern: "_qvalue"
---

<objective>
Standardize all association output column names to the new convention (TD-04): `_p_value` becomes `_pvalue`, `_corrected_p_value` becomes `_qvalue`, and SKAT-O runs produce `skat_o_pvalue` instead of `skat_pvalue`.

Purpose: Consistent column naming across all association test outputs. Clean break with no backward compatibility aliases (per CONTEXT decision).
Output: Renamed columns in engine, diagnostics, stages, docs, and all test files.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/34-tech-debt/34-RESEARCH.md
@variantcentrifuge/association/engine.py
@variantcentrifuge/association/diagnostics.py
@variantcentrifuge/stages/analysis_stages.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rename columns in source files and add SKAT-O post-processing</name>
  <files>
    variantcentrifuge/association/engine.py,
    variantcentrifuge/association/diagnostics.py,
    variantcentrifuge/association/tests/allelic_series_python.py,
    variantcentrifuge/association/tests/allelic_series.py,
    variantcentrifuge/stages/analysis_stages.py
  </files>
  <action>
**Column naming convention (clean break, no aliases):**
- `{test}_p_value` -> `{test}_pvalue` (e.g., `fisher_pvalue`, `skat_pvalue`, `coast_pvalue`)
- `acat_o_p_value` -> `acat_o_pvalue`
- `acat_o_corrected_p_value` -> `acat_o_qvalue`
- `coast_burden_p_value` -> `coast_burden_pvalue`
- `coast_skat_p_value` -> `coast_skat_pvalue`
- SKAT-O: when `skat_method` in extra is "SKATO", rename `skat_pvalue` -> `skat_o_pvalue`

**engine.py changes:**
1. Update the module docstring (lines 11-31) to show new column names
2. Line 538: `f"{test_name}_p_value"` -> `f"{test_name}_pvalue"`
3. Line 562: `"acat_o_p_value"` -> `"acat_o_pvalue"`
4. Lines 563-564: `"acat_o_corrected_p_value"` -> `"acat_o_qvalue"`
5. Line 578: `result_df.get("acat_o_corrected_p_value"...)` -> `result_df.get("acat_o_qvalue"...)`
6. Add SKAT-O post-processing AFTER building each row (after the test loop, before ACAT-O columns):
   If `row.get("skat_method") == "SKATO"`, rename `row["skat_pvalue"]` to `row["skat_o_pvalue"]` via pop+assign.
   Also rename any `skat_o_rho` and other skat extras — these likely already have the correct prefix since they come from res.extra with "skat_o_rho" key.

**diagnostics.py changes:**
1. Line 337 comment: `{test_name}_p_value` -> `{test_name}_pvalue`
2. Line 339: `"acat_o_p_value"` -> `"acat_o_pvalue"`
3. Line 345: `f"{tid}_p_value"` -> `f"{tid}_pvalue"`
4. Line 317-318 docstring: update column name references

**allelic_series_python.py changes:**
- Rename extra dict keys: `"coast_burden_p_value"` -> `"coast_burden_pvalue"`, `"coast_skat_p_value"` -> `"coast_skat_pvalue"`
- Update docstrings/comments referencing old names

**allelic_series.py changes (R backend, deprecated but still in codebase):**
- Same extra dict key renames: `"coast_burden_p_value"` -> `"coast_burden_pvalue"`, `"coast_skat_p_value"` -> `"coast_skat_pvalue"`

**analysis_stages.py change:**
- Line 2767: `c.endswith("_corrected_p_value")` -> `c.endswith("_qvalue")`

Do NOT rename the `corrected_p_value` field in base.py TestResult dataclass — that is an internal Python attribute, not a DataFrame column name.
Do NOT rename variable names like `skat_p_value` or `burden_p_values` inside coast_python.py backend — those are internal variables, not column names.
  </action>
  <verify>Run `ruff check variantcentrifuge/association/engine.py variantcentrifuge/association/diagnostics.py variantcentrifuge/stages/analysis_stages.py variantcentrifuge/association/tests/allelic_series_python.py variantcentrifuge/association/tests/allelic_series.py` to check for syntax errors.</verify>
  <done>All source files use new column naming convention. SKAT-O post-processing renames skat_pvalue to skat_o_pvalue when method is SKATO.</done>
</task>

<task type="auto">
  <name>Task 2: Update all test files and documentation to use new column names</name>
  <files>
    tests/unit/test_association_engine.py,
    tests/unit/test_association_diagnostics.py,
    tests/unit/test_association_fisher.py,
    tests/unit/test_association_stage.py,
    tests/unit/test_engine_skat_integration.py,
    tests/unit/test_coast.py,
    tests/unit/test_coast_partial_category.py,
    tests/unit/test_coast_python.py,
    tests/unit/test_coast_python_comparison.py,
    tests/unit/test_association_correction.py,
    tests/unit/test_association_base.py,
    tests/unit/test_association_acat.py,
    tests/unit/test_skat_python_backend.py,
    tests/unit/test_qq_plot.py,
    tests/unit/test_parallel_association.py,
    tests/unit/test_gene_burden_regression.py,
    tests/test_gene_burden_integration.py,
    tests/performance/benchmark_gene_burden.py,
    tests/performance/benchmark_pipeline_macro.py,
    docs/source/guides/association_testing.md,
    docs/source/faq.md
  </files>
  <action>
Mechanical find-and-replace across all test files and docs. The replacements are:

**In test files (all files listed above):**
1. `_p_value` -> `_pvalue` for ALL DataFrame column name references (string literals in assertions, DataFrame construction, column lookups)
2. `acat_o_corrected_p_value` -> `acat_o_qvalue` (do this FIRST as it's more specific)
3. `acat_o_p_value` -> `acat_o_pvalue`
4. `coast_burden_p_value` -> `coast_burden_pvalue`
5. `coast_skat_p_value` -> `coast_skat_pvalue`

**IMPORTANT: Do NOT rename these (they are Python variable names or dataclass fields, not column names):**
- `corrected_p_value=None` in TestResult construction (dataclass field)
- `res.p_value`, `res.corrected_p_value` (attribute access)
- `test_p_values` parameter in ACAT functions
- `p_value` in function signatures or local variables
- `burden_p_values` list variable in coast_python.py
- `skat_p_value` variable in coast_python.py
- `raw_p_value` and `corrected_p_value` in tests/conftest.py (gene burden context, not association)
- `test_scoring_inheritance.py` references (scoring context, not association columns)

**Strategy:** For each file, read it first, identify which strings are column name references (inside quotes as string literals) vs Python identifiers, and only rename the column name strings.

**In docs/source/guides/association_testing.md:**
- Replace all `_p_value` column references with `_pvalue`
- Replace `acat_o_corrected_p_value` with `acat_o_qvalue`
- Update the sample output table headers
- Update the column reference tables

**In docs/source/faq.md:**
- Replace `acat_o_corrected_p_value` with `acat_o_qvalue` in the FAQ heading and body text

After all replacements, run `make test-fast` to verify nothing is broken.
  </action>
  <verify>Run `make test-fast` and confirm all tests pass. Then run `ruff check tests/` to verify no formatting issues. Grep for any remaining `_p_value` string literals in test files that should have been renamed: `grep -rn '".*_p_value"' tests/unit/test_association*.py tests/unit/test_coast*.py tests/unit/test_engine*.py` — should return 0 matches (only TestResult dataclass field refs remain, which are attribute access not string literals).</verify>
  <done>All test files and documentation use new _pvalue/_qvalue column naming convention. make test-fast passes with zero failures.</done>
</task>

</tasks>

<verification>
- `make test-fast` passes with zero failures
- `make lint` passes
- `grep -rn '"fisher_p_value\|"skat_p_value\|"coast_p_value\|"acat_o_p_value\|"acat_o_corrected_p_value' variantcentrifuge/ tests/` returns no matches (old column names fully eliminated from string literals)
- `grep -rn '"fisher_pvalue\|"skat_pvalue\|"acat_o_pvalue\|"acat_o_qvalue' variantcentrifuge/association/engine.py` confirms new names present
</verification>

<success_criteria>
- All association p-value DataFrame columns use _pvalue suffix
- ACAT-O corrected column is acat_o_qvalue
- SKAT-O produces skat_o_pvalue when skat_method=SKATO
- COAST extras use coast_burden_pvalue and coast_skat_pvalue
- All 2000+ tests pass
- Documentation reflects new column names
</success_criteria>

<output>
After completion, create `.planning/phases/34-tech-debt/34-02-SUMMARY.md`
</output>
