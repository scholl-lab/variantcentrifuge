---
phase: 13-js-stack-modernization
plan: 03
type: execute
wave: 2
depends_on: ["13-01"]
files_modified:
  - tests/unit/test_html_report_assets.py
  - tests/unit/stages/test_output_stages.py
autonomous: true

must_haves:
  truths:
    - "Asset loading is tested -- all expected files load correctly"
    - "Template rendering produces valid HTML with modern stack markers"
    - "Existing HTML report stage tests still pass"
    - "No regressions in CI checks"
  artifacts:
    - path: "tests/unit/test_html_report_assets.py"
      provides: "Unit tests for asset loading and template rendering"
  key_links:
    - from: "tests/unit/test_html_report_assets.py"
      to: "variantcentrifuge/generate_html_report.py"
      via: "imports _load_assets, generate_html_report"
      pattern: "from variantcentrifuge.generate_html_report import"
---

<objective>
Add tests verifying the modernized JS stack: asset loading, template rendering with inlined assets, and absence of CDN/jQuery/Plotly references. Update existing tests if needed.

Purpose: Ensure the migration is verifiable and regressions are caught. Tests validate the key Phase 13 success criteria programmatically.
Output: New test file for asset/template verification, passing CI checks.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-js-stack-modernization/13-01-SUMMARY.md
@variantcentrifuge/generate_html_report.py
@tests/unit/stages/test_output_stages.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create asset and template tests</name>
  <files>tests/unit/test_html_report_assets.py</files>
  <action>
    Create a new test file: tests/unit/test_html_report_assets.py

    Tests to write (all marked @pytest.mark.unit):

    1. test_load_assets_returns_all_expected_keys:
       - Call _load_assets()
       - Assert the returned dict contains keys for all expected assets (jquery.slim, datatables, chart.umd, tippy-bundle.umd, etc.)
       - Assert each value is a non-empty string
       - Assert total number of assets >= 10 (7 JS + 3 CSS)

    2. test_asset_files_are_valid_js_css:
       - For each JS asset, verify it does NOT start with "<!DOCTYPE" or "<html" (would indicate error page)
       - For each CSS asset, verify it contains at least one "{" (basic CSS validity)

    3. test_template_renders_with_assets:
       - Load the template via Jinja2 FileSystemLoader
       - Call _load_assets()
       - Render with minimal test data:
         variants=[{"GENE": "TEST", "igv_links": []}],
         summary={"num_variants": 1, "num_genes": 1, "impact_distribution": {"HIGH": 1}},
         column_data=[{"original_name": "GENE", "display_name": "GENE", "is_standard_link_column": False, "is_igv_link_column": False, "link_display_text": None, "apply_hover_expand": False, "max_width_px": None}, {"original_name": "igv_links", "display_name": "IGV Links", "is_standard_link_column": False, "is_igv_link_column": True, "link_display_text": None, "apply_hover_expand": False, "max_width_px": None}],
         default_hidden_columns=[],
         generation_date="2026-01-01",
         version="0.14.0",
         assets=_load_assets()
       - Assert rendered HTML is non-empty string

    4. test_no_cdn_links_in_rendered_html:
       - Render template (reuse fixture from test 3)
       - Assert "cdn.datatables.net" not in html
       - Assert "cdn.plot.ly" not in html
       - Assert "code.jquery.com" not in html
       - Assert 'src="http' not in html (no external script sources)

    5. test_no_plotly_in_rendered_html:
       - Assert "Plotly" not in rendered html
       - Assert "plotly" not in rendered html.lower() (in script sections)

    6. test_modern_stack_markers_in_rendered_html:
       - Assert "new DataTable" in html (DataTables v2 vanilla init)
       - Assert "new Chart" in html (Chart.js)
       - Assert "tippy(" in html (Tippy.js init function)
       - Assert "skeleton" in html (loading skeleton)

    7. test_template_renders_empty_variants:
       - Render with variants=[] and empty summary
       - Assert no error raised
       - Assert "No variants found" in html (the alert message)
       - Assert "new DataTable" NOT in html (table shouldn't init with no data)

    Use a pytest fixture for the rendered HTML to avoid re-rendering in each test:
    ```python
    @pytest.fixture(scope="module")
    def rendered_html():
        # ... render once, return html string
    ```

    Import from variantcentrifuge.generate_html_report import _load_assets
  </action>
  <verify>
    Run: `pytest tests/unit/test_html_report_assets.py -v` -- all tests pass.
    Run: `pytest tests/unit/stages/test_output_stages.py -k html -v` -- existing tests still pass.
    Run: `make ci-check` -- full CI passes.
  </verify>
  <done>7+ unit tests verify asset loading, template rendering, absence of CDN/jQuery/Plotly, presence of modern stack markers, and empty-variant handling. All tests pass. CI green.</done>
</task>

</tasks>

<verification>
- `pytest tests/unit/test_html_report_assets.py -v` -- all tests pass
- `pytest tests/unit/stages/test_output_stages.py -k html -v` -- existing tests pass
- `make ci-check` -- full CI suite passes
</verification>

<success_criteria>
1. New test file with 7+ tests covering asset loading and template rendering
2. All new tests pass
3. All existing tests pass (no regressions)
4. `make ci-check` passes cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/13-js-stack-modernization/13-03-SUMMARY.md`
</output>
