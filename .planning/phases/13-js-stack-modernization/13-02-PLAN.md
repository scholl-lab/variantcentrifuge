---
phase: 13-js-stack-modernization
plan: 02
type: execute
wave: 2
depends_on: ["13-01"]
files_modified:
  - variantcentrifuge/templates/index.html
autonomous: true

must_haves:
  truths:
    - "The HTML report uses inlined JS/CSS from assets instead of CDN links"
    - "DataTables v2 initializes with vanilla JS API (new DataTable, not $.DataTable)"
    - "No jQuery code is written in the template (no $() calls, no jQuery event handlers)"
    - "Chart.js renders a horizontal bar chart with semantic colors replacing the Plotly chart"
    - "Tippy.js handles hover-expand cells instead of the old yellow CSS popup"
    - "A loading skeleton with shimmer animation shows during DataTable init"
  artifacts:
    - path: "variantcentrifuge/templates/index.html"
      provides: "Complete modernized HTML report template"
      contains: "new DataTable"
  key_links:
    - from: "variantcentrifuge/templates/index.html"
      to: "assets dict from generate_html_report.py"
      via: "Jinja2 {{ assets['key'] }} variables"
      pattern: "assets\\["
    - from: "variantcentrifuge/templates/index.html"
      to: "DataTables v2 API"
      via: "new DataTable('#variants_table', {...})"
      pattern: "new DataTable"
    - from: "variantcentrifuge/templates/index.html"
      to: "Chart.js"
      via: "new Chart(ctx, {...})"
      pattern: "new Chart"
    - from: "variantcentrifuge/templates/index.html"
      to: "Tippy.js"
      via: "tippy() calls in drawCallback"
      pattern: "tippy\\("
---

<objective>
Rewrite the index.html template to use the modern JS stack: inline all assets from the assets dict, initialize DataTables v2 with vanilla JS, replace Plotly with Chart.js horizontal bar chart, migrate hover-expand to Tippy.js, and add a loading skeleton.

Purpose: This is the core migration -- transforming the template from jQuery+DataTables v1+Plotly to vanilla JS+DataTables v2+Chart.js+Tippy.js while preserving all existing functionality.
Output: Fully modernized index.html template.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-js-stack-modernization/13-01-SUMMARY.md
@variantcentrifuge/templates/index.html
@variantcentrifuge/generate_html_report.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite template head -- inline assets, modern CSS</name>
  <files>variantcentrifuge/templates/index.html</files>
  <action>
    Rewrite the entire index.html template. This is a FULL REWRITE, not incremental edits, because nearly every line changes.

    HEAD section changes:

    1. Replace all CDN `<link>` and `<script src="...">` tags with inlined content from the `assets` Jinja2 variable:
       ```html
       <style>{{ assets['datatables'] }}</style>
       <style>{{ assets['buttons.dataTables'] }}</style>
       <style>{{ assets['tippy'] }}</style>
       <script>{{ assets['jquery.slim'] }}</script>
       <script>{{ assets['datatables'] }}</script>
       <script>{{ assets['datatables.buttons'] }}</script>
       <script>{{ assets['buttons.colVis'] }}</script>
       <script>{{ assets['chart.umd'] }}</script>
       <script>{{ assets['chartjs-plugin-datalabels'] }}</script>
       <script>{{ assets['tippy-bundle.umd'] }}</script>
       ```
       Note: The asset dict keys are the file stems (filename without extension). If _load_assets uses f.stem, then `jquery.slim.min.js` becomes key `jquery.slim.min`. Adjust the template keys to match whatever _load_assets() actually produces. Read the 13-01-SUMMARY.md to confirm the exact key format.

    2. CRITICAL script order: jQuery -> DataTables -> Buttons -> ColVis -> Chart.js -> datalabels -> Tippy.js

    3. Keep existing body CSS styles (font-family, container, header, summary-section, chart-section, table-section, stats-card, footer, link-icon, igv-individual-link). Refresh header styling slightly: use Inter/system font stack, cleaner spacing.

    4. REMOVE old hover-expand CSS classes (.hover-expand-cell, .hover-expand-content, .hover-expand-content.can-expand, .hover-expand-content.expanded). These are replaced by Tippy.js.

    5. ADD loading skeleton CSS:
       ```css
       .skeleton-table { width: 100%; border-collapse: collapse; }
       .skeleton-row td { padding: 10px 12px; }
       .skeleton-cell {
         height: 14px;
         background: linear-gradient(90deg, #e0e0e0 25%, #f0f0f0 50%, #e0e0e0 75%);
         background-size: 200% 100%;
         animation: shimmer 1.5s infinite;
         border-radius: 4px;
       }
       @keyframes shimmer {
         0% { background-position: 200% 0; }
         100% { background-position: -200% 0; }
       }
       #skeleton-container { /* shown initially */ }
       #skeleton-container.hidden { display: none; }
       #variants_table_wrapper.loading { visibility: hidden; height: 0; overflow: hidden; }
       ```

    BODY section -- keep the existing structure but with these changes:

    6. Header: Keep blue gradient, update to show "VariantCentrifuge Report" (drop "Interactive"), slightly modernize spacing. Keep generation_date and version display.

    7. Add loading skeleton BEFORE the table:
       ```html
       <div id="skeleton-container">
         <table class="skeleton-table">
           {% for i in range(7) %}
           <tr class="skeleton-row">
             <td><div class="skeleton-cell" style="width:60px"></div></td>
             <td><div class="skeleton-cell" style="width:80px"></div></td>
             <td><div class="skeleton-cell" style="width:120px"></div></td>
             <td><div class="skeleton-cell" style="width:90px"></div></td>
             <td><div class="skeleton-cell" style="width:150px"></div></td>
             <td><div class="skeleton-cell" style="width:70px"></div></td>
           </tr>
           {% endfor %}
         </table>
       </div>
       ```

    8. Keep the variants table HTML structure EXACTLY as-is (thead, tbody with Jinja2 loops, column_data iteration, igv_links handling, standard_link handling). The table structure works -- only the JS initialization changes.

    9. Keep the summary section and chart section HTML structure. Change chart div from `<div id="impact_chart" class="chart-container">` to `<canvas id="impact_chart"></canvas>` wrapped in a container div with appropriate sizing.

    10. Keep the empty-variants alert section unchanged.

    SCRIPT section -- complete rewrite:

    11. Replace `$(document).ready(function() { ... })` with:
        ```javascript
        document.addEventListener('DOMContentLoaded', function() { ... });
        ```

    12. Early exit check: Replace `$('#variants_table').length === 0` with:
        ```javascript
        if (!document.getElementById('variants_table')) return;
        ```

    13. DataTables v2 initialization -- replace `$('#variants_table').DataTable({...})` with:
        ```javascript
        var table = new DataTable('#variants_table', {
            autoWidth: false,
            pageLength: 25,     // Changed from 10 to 25 per requirements
            scrollX: true,
            layout: {           // v2 uses layout instead of dom
                topStart: 'pageLength',
                topEnd: 'search',
                top2Start: {
                    buttons: [{
                        extend: 'colvis',
                        text: 'Show/Hide Columns'
                    }]
                }
            },
            lengthMenu: [[10, 25, 50, 100, -1], [10, 25, 50, 100, "All"]],
            columnDefs: dtColumnDefs,
            initComplete: function() {
                // Hide skeleton, show table
                var skeleton = document.getElementById('skeleton-container');
                if (skeleton) skeleton.classList.add('hidden');
                var wrapper = document.getElementById('variants_table_wrapper');
                if (wrapper) wrapper.classList.remove('loading');
            },
            drawCallback: function(settings) {
                this.api().columns.adjust();
                initTippyTooltips();
            }
        });
        ```
        Note: DataTables v2 auto-wraps the table in a div with id `{tableId}_wrapper`, so `variants_table_wrapper` will exist automatically.

    14. Column visibility (hidden columns) logic -- keep the same logic for building hiddenColumnIndices from defaultHiddenColumnOriginalNames, but use plain JS:
        ```javascript
        var allColumnOriginalNames = {{ column_data | map(attribute='original_name') | list | tojson }};
        var defaultHiddenColumnOriginalNames = {{ default_hidden_columns | tojson }};
        var columnData = {{ column_data | tojson }};
        var hiddenColumnIndices = [];
        var dtColumnDefs = [];

        defaultHiddenColumnOriginalNames.forEach(function(name) {
            var idx = allColumnOriginalNames.indexOf(name);
            if (idx !== -1) hiddenColumnIndices.push(idx);
        });

        if (hiddenColumnIndices.length > 0) {
            dtColumnDefs.push({ targets: hiddenColumnIndices, visible: false });
        }
        ```

    15. Hover-expand columns -- migrate from jQuery CSS popup to Tippy.js:
        For columns with apply_hover_expand, keep the columnDefs render function to truncate content with a max-width span, but:
        - Remove the `createdCell` that adds `hover-expand-cell` class
        - In the render function, wrap truncated content in a span with `data-tippy-content` attribute containing the full text:
          ```javascript
          render: function(data, type, row) {
              if (type === 'display' && data != null && typeof data === 'string') {
                  var safeData = data.replace(/</g, '&lt;').replace(/>/g, '&gt;');
                  return '<span class="truncated-cell" style="display:inline-block;max-width:' +
                         colInfo.max_width_px + 'px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" ' +
                         'data-tippy-content="' + safeData.replace(/"/g, '&quot;') + '">' +
                         safeData + '</span>';
              }
              return data;
          }
          ```
        - Remove the old mouseenter/mouseleave event delegation entirely
        - Add a function to initialize Tippy on truncated cells:
          ```javascript
          function initTippyTooltips() {
              document.querySelectorAll('.truncated-cell').forEach(function(el) {
                  if (el.offsetWidth < el.scrollWidth && !el._tippy) {
                      tippy(el, {
                          theme: 'dark',       // dark bg, white text
                          placement: 'top',
                          maxWidth: 400,
                          allowHTML: true,
                          appendTo: document.body
                      });
                  }
              });
          }
          ```
          This is called from drawCallback so it runs after every page/sort/filter.

    16. Chart.js horizontal bar chart -- replace Plotly:
        ```javascript
        var impactDistribution = {{ summary.impact_distribution | tojson }};
        var labels = Object.keys(impactDistribution);
        var values = Object.values(impactDistribution);

        // Semantic colors per impact level
        var colorMap = {
            'HIGH': 'rgba(220, 53, 69, 0.85)',
            'MODERATE': 'rgba(255, 152, 0, 0.85)',
            'LOW': 'rgba(255, 193, 7, 0.85)',
            'MODIFIER': 'rgba(158, 158, 158, 0.85)'
        };
        var defaultColor = 'rgba(0, 123, 255, 0.7)';
        var bgColors = labels.map(function(l) { return colorMap[l] || defaultColor; });

        var ctx = document.getElementById('impact_chart').getContext('2d');
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    data: values,
                    backgroundColor: bgColors,
                    borderWidth: 0
                }]
            },
            options: {
                indexAxis: 'y',  // horizontal bar
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    title: { display: true, text: 'Variant Impact Distribution', font: { size: 16 } },
                    datalabels: {
                        anchor: 'end',
                        align: 'right',
                        color: '#333',
                        font: { weight: 'bold' }
                    }
                },
                scales: {
                    x: { title: { display: true, text: 'Number of Variants' }, beginAtZero: true },
                    y: { title: { display: false } }
                }
            },
            plugins: [ChartDataLabels]
        });
        ```

    17. Remove ALL `$()` jQuery calls. The ONLY jQuery present should be the slim library loaded for DataTables internal use. No user-written jQuery code.

    IMPORTANT NOTES:
    - Preserve ALL Jinja2 template variables and logic (column_data loop, variants loop, igv_links, standard links, empty variant handling)
    - Keep the same HTML structure for summary cards, chart section, footer
    - The `<canvas>` element for Chart.js needs a container div with height set (e.g., 300px)
    - Test with the `{{ summary.impact_distribution | tojson }}` Jinja2 expression -- this must produce valid JSON for Chart.js
  </action>
  <verify>
    Run: `cd /mnt/c/development/scholl-lab/variantcentrifuge && python -c "
from jinja2 import Environment, FileSystemLoader
from pathlib import Path
from variantcentrifuge.generate_html_report import _load_assets

assets = _load_assets()
templates_dir = Path('variantcentrifuge/templates')
env = Environment(loader=FileSystemLoader(str(templates_dir)))
template = env.get_template('index.html')

# Minimal render test
html = template.render(
    variants=[{'GENE': 'BRCA1', 'CHROM': '17', 'POS': '12345', 'igv_links': []}],
    summary={'num_variants': 1, 'num_genes': 1, 'impact_distribution': {'HIGH': 1}},
    column_data=[
        {'original_name': 'GENE', 'display_name': 'GENE', 'is_standard_link_column': False, 'is_igv_link_column': False, 'link_display_text': None, 'apply_hover_expand': False, 'max_width_px': None},
        {'original_name': 'igv_links', 'display_name': 'IGV Links', 'is_standard_link_column': False, 'is_igv_link_column': True, 'link_display_text': None, 'apply_hover_expand': False, 'max_width_px': None}
    ],
    default_hidden_columns=[],
    generation_date='2026-01-01',
    version='0.14.0',
    assets=assets
)

# Verify key elements
assert 'new DataTable' in html, 'Missing DataTables v2 init'
assert 'new Chart' in html, 'Missing Chart.js init'
assert 'tippy(' in html, 'Missing Tippy.js init'
assert 'jQuery' not in html.split('</script>')[-1], 'jQuery code found outside library'  # crude check
assert 'Plotly' not in html, 'Plotly reference still present'
assert 'cdn.datatables.net' not in html, 'CDN link still present'
assert 'cdn.plot.ly' not in html, 'Plotly CDN still present'
assert 'skeleton' in html, 'Missing loading skeleton'
print('All template checks passed!')
"
    `
    Run: `make lint` to confirm template-related Python still passes lint.
  </verify>
  <done>index.html template fully rewritten: all assets inlined via Jinja2, DataTables v2 with vanilla JS API, Chart.js horizontal bar chart with semantic colors, Tippy.js tooltips, loading skeleton, zero jQuery user code, zero CDN links, zero Plotly references.</done>
</task>

</tasks>

<verification>
- Template renders without Jinja2 errors
- No CDN links in generated HTML (grep for "cdn." or "https://")
- No Plotly references (grep for "Plotly" or "plotly")
- DataTables v2 initialization uses `new DataTable` not `$.DataTable`
- Chart.js creates horizontal bar with semantic colors
- Tippy.js initializes in drawCallback
- Loading skeleton HTML present with shimmer animation CSS
- `make lint` passes
</verification>

<success_criteria>
1. The template renders valid HTML with all assets inlined
2. DataTables v2 initializes with vanilla JS API and all features (sort, paginate, search, colvis, scrollX)
3. Chart.js renders horizontal impact distribution bar with HIGH=red, MODERATE=orange, LOW=amber, MODIFIER=gray
4. Tippy.js replaces the old yellow hover-expand popup with dark-themed tooltips
5. Loading skeleton shows 7 shimmer rows, hidden on DataTable initComplete
6. No jQuery user code, no CDN links, no Plotly
</success_criteria>

<output>
After completion, create `.planning/phases/13-js-stack-modernization/13-02-SUMMARY.md`
</output>
