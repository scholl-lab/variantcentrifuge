---
phase: 25-python-default-backends-and-quick-wins
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - variantcentrifuge/association/backends/__init__.py
  - variantcentrifuge/association/engine.py
  - variantcentrifuge/association/base.py
  - variantcentrifuge/cli.py
  - variantcentrifuge/association/tests/skat_r.py
  - variantcentrifuge/association/tests/allelic_series.py
  - variantcentrifuge/association/backends/davies.py
  - tests/unit/test_json_config.py
autonomous: true

must_haves:
  truths:
    - "--skat-backend auto uses Python backend by default (no R probe)"
    - "--coast-backend auto uses Python backend by default (no R probe)"
    - "--skat-backend r still works and emits DeprecationWarning"
    - "--coast-backend r still works and emits DeprecationWarning"
    - "Davies out-of-range falls back to saddlepoint before Liu"
  artifacts:
    - path: "variantcentrifuge/association/backends/__init__.py"
      provides: "get_skat_backend auto returns PythonSKATBackend directly"
      contains: "PythonSKATBackend"
    - path: "variantcentrifuge/association/backends/davies.py"
      provides: "saddlepoint-before-Liu fallback in compute_pvalue"
      contains: "_kuonen_pvalue"
    - path: "variantcentrifuge/association/tests/skat_r.py"
      provides: "RSKATTest with DeprecationWarning"
      contains: "DeprecationWarning"
    - path: "variantcentrifuge/association/tests/allelic_series.py"
      provides: "COASTTest with DeprecationWarning"
      contains: "DeprecationWarning"
  key_links:
    - from: "variantcentrifuge/association/backends/__init__.py"
      to: "variantcentrifuge/association/backends/python_backend.py"
      via: "get_skat_backend('auto') returns PythonSKATBackend()"
      pattern: "auto.*PythonSKATBackend"
    - from: "variantcentrifuge/association/engine.py"
      to: "variantcentrifuge/association/tests/skat_python.py"
      via: "from_names SKAT auto swap uses PurePythonSKATTest"
      pattern: "auto.*PurePythonSKATTest"
    - from: "variantcentrifuge/association/backends/davies.py"
      to: "variantcentrifuge/association/backends/davies.py"
      via: "compute_pvalue out-of-range calls _kuonen_pvalue before Liu"
      pattern: "_kuonen_pvalue.*liu"
---

<objective>
Swap SKAT and COAST default backends from R-first to Python-first, add deprecation
warnings to R backend test wrappers, and insert saddlepoint as intermediate fallback
when Davies returns out-of-range p-values.

Purpose: Python backends are validated (Phase 21/24), thread-safe, and have no R
dependency. Making Python the default eliminates deployment friction. Saddlepoint
fallback improves extreme-tail accuracy (matches SAIGE-GENE+ best practice).

Output: Modified factory, engine, CLI, base config, R test wrappers, davies.py.
All existing tests updated to match new default behavior.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/ASSOCIATION_REMAINING_WORK.md
@.planning/phases/25-python-default-backends-and-quick-wins/25-RESEARCH.md

@variantcentrifuge/association/backends/__init__.py
@variantcentrifuge/association/engine.py
@variantcentrifuge/association/base.py
@variantcentrifuge/cli.py
@variantcentrifuge/association/tests/skat_r.py
@variantcentrifuge/association/tests/allelic_series.py
@variantcentrifuge/association/backends/davies.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Swap default backends to Python and add R deprecation warnings</name>
  <files>
    variantcentrifuge/association/backends/__init__.py
    variantcentrifuge/association/engine.py
    variantcentrifuge/association/base.py
    variantcentrifuge/cli.py
    variantcentrifuge/association/tests/skat_r.py
    variantcentrifuge/association/tests/allelic_series.py
  </files>
  <action>
    Five locations need the default swap, plus two locations for deprecation warnings:

    1. **backends/__init__.py** — `get_skat_backend("auto")` (line 73-95):
       Replace the R-probe-then-fallback block with:
       ```python
       if backend_name == "auto":
           from variantcentrifuge.association.backends.python_backend import PythonSKATBackend
           return PythonSKATBackend()
       ```
       Update docstring for "auto" to: `"auto" — Use Python backend (default). R backend available via "r".`

    2. **engine.py** — `from_names()` SKAT auto block (lines 137-148):
       Use the UNIFIED pattern `if skat_backend in ("python", "auto"):` for both Python
       and auto. This matches the research prescription and is consistent with the COAST
       block (see item 3). Replace any separate `elif skat_backend == "auto":` branch with:
       ```python
       if skat_backend in ("python", "auto"):
           from variantcentrifuge.association.tests.skat_python import PurePythonSKATTest
           registry["skat"] = PurePythonSKATTest
       ```
       No logger.info needed — this is the default path now.

    3. **engine.py** — `from_names()` COAST auto block (lines 159-173):
       Use the UNIFIED pattern `if coast_backend in ("python", "auto"):` for both Python
       and auto. This is identical in structure to the SKAT block above. Replace any
       separate `elif coast_backend == "auto":` branch with:
       ```python
       if coast_backend in ("python", "auto"):
           from variantcentrifuge.association.tests.allelic_series_python import PurePythonCOASTTest
           registry["coast"] = PurePythonCOASTTest
       ```

       IMPORTANT: Both SKAT and COAST blocks MUST use the `if ... in ("python", "auto"):`
       pattern — NOT two separate `if backend == "python": ... elif backend == "auto": ...`
       branches. The unified pattern ensures auto and python follow identical code paths
       and avoids divergence if the default is changed later.

    4. **base.py** — `AssociationConfig` defaults (lines 139, 174):
       Change `skat_backend: str = "auto"` to `skat_backend: str = "python"`.
       Change `coast_backend: str = "auto"` to `coast_backend: str = "python"`.
       Update docstrings to reflect Python as default.

    5. **cli.py** — argparse defaults (lines 424-434):
       Change both `default="auto"` to `default="python"`.
       Update help text:
       - SKAT: `"SKAT computation backend: python (default), r (deprecated), or auto"`
       - COAST: `"COAST computation backend: python (default), r (deprecated), or auto"`

    6. **skat_r.py** — `RSKATTest.__init__()` (line 81):
       Add at the start of __init__:
       ```python
       import warnings
       warnings.warn(
           "RSKATTest (R SKAT backend) is deprecated and will be removed in v0.17.0. "
           "Use --skat-backend python (default).",
           DeprecationWarning,
           stacklevel=2,
       )
       ```
       Add `# DEPRECATED` as first line of class docstring.

    7. **allelic_series.py** — `COASTTest.__init__()` (line 278):
       Add at the start of __init__:
       ```python
       import warnings
       warnings.warn(
           "COASTTest (R COAST backend) is deprecated and will be removed in v0.17.0. "
           "Use --coast-backend python (default).",
           DeprecationWarning,
           stacklevel=2,
       )
       ```
       Add `# DEPRECATED` as first line of class docstring.

    IMPORTANT: Do NOT add warnings to RSKATBackend.__init__() — only to the test
    wrapper classes. Research finding: RSKATTest.check_dependencies() constructs
    RSKATBackend, which would cause double-warning if both had warnings.

    IMPORTANT: Keep `--skat-backend r` and `--coast-backend r` fully functional.
    The R backends are deprecated, not removed.
  </action>
  <verify>
    Run `make lint` and `make format` to ensure no lint errors.
    Run `pytest tests/unit/test_json_config.py -v` to check config validation still passes.
    Run `python -c "from variantcentrifuge.association.backends import get_skat_backend; b = get_skat_backend('auto'); print(type(b).__name__)"` — should print "PythonSKATBackend".
    Run `python -c "import warnings; warnings.simplefilter('always'); from variantcentrifuge.association.tests.skat_r import RSKATTest; t = RSKATTest()"` — should emit DeprecationWarning.
  </verify>
  <done>
    get_skat_backend("auto") returns PythonSKATBackend.
    engine.from_names auto paths use Python implementations via unified `in ("python", "auto")` pattern.
    CLI defaults are "python". Config defaults are "python".
    RSKATTest() and COASTTest() emit DeprecationWarning.
    All R backend paths still functional with explicit --skat-backend r / --coast-backend r.
  </done>
</task>

<task type="auto">
  <name>Task 2: Saddlepoint-before-Liu fallback in compute_pvalue</name>
  <files>
    variantcentrifuge/association/backends/davies.py
  </files>
  <action>
    In `compute_pvalue()` (davies.py), modify the Davies out-of-range fallback block
    (lines 401-409). Currently when Davies returns p > 1 or p <= 0, it falls back
    directly to Liu. Change it to try saddlepoint first:

    Replace the block at lines 401-409:
    ```python
    # R: if p > 1 or p <= 0, fall back to Liu
    if p_val > 1.0 or p_val <= 0.0:
        logger.info(
            "Davies p=%s out of range (ifault=%d); using Liu fallback (p=%s)",
            p_val,
            ifault,
            p_liu,
        )
        return p_liu, "liu", False
    ```

    With:
    ```python
    # Davies out of range: try saddlepoint first, then Liu
    if p_val > 1.0 or p_val <= 0.0:
        p_sp = _kuonen_pvalue(q, lambdas)
        if p_sp is not None and 0.0 < p_sp < 1.0:
            logger.info(
                "Davies p=%s out of range (ifault=%d); "
                "using saddlepoint fallback (p=%s)",
                p_val,
                ifault,
                p_sp,
            )
            return float(p_sp), "saddlepoint", False
        logger.info(
            "Davies p=%s out of range (ifault=%d); "
            "saddlepoint also failed; using Liu fallback (p=%s)",
            p_val,
            ifault,
            p_liu,
        )
        return p_liu, "liu", False
    ```

    Also update the function docstring to mention the three-tier fallback when
    Davies is available: Davies -> saddlepoint -> Liu (instead of Davies -> Liu).

    Do NOT implement the proactive saddlepoint threshold (_PROACTIVE_THRESHOLD).
    Research confirmed: Phase 25 only adds the out-of-range fallback. The proactive
    threshold (IMPL-26) is declared but NOT implemented in this phase.
  </action>
  <verify>
    Run `pytest tests/ -k "davies or pvalue or liu or saddlepoint" -v --no-header` to check p-value tests pass.
    Run `make lint` to verify no lint issues.
    Manually inspect that `_PROACTIVE_THRESHOLD` is still defined but unused (no behavioral change from proactive threshold).
  </verify>
  <done>
    compute_pvalue() tries saddlepoint before Liu when Davies returns out-of-range.
    Existing p-value tests pass (Davies in-range behavior unchanged).
    _PROACTIVE_THRESHOLD remains defined but unused.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update tests for new defaults and add deprecation/fallback tests</name>
  <files>
    tests/unit/test_json_config.py
    tests/unit/test_backend_defaults.py
    tests/unit/test_davies_fallback.py
  </files>
  <action>
    1. **test_json_config.py**: Two categories of assertions exist — DEFAULT-CHECKING and
       ENUM-VALIDATION. Only default-checking assertions must change:

       - **DEFAULT-CHECKING** (line ~186): `assert config.skat_backend == "auto"` →
         change to `assert config.skat_backend == "python"`. These assertions verify
         what value AssociationConfig() constructs with when no argument is passed.
         Change any similar assertions for `coast_backend` default.

       - **ENUM-VALIDATION** (line ~65): `"skat_backend": "auto"` in tests that verify
         "auto" is an accepted enum value — DO NOT CHANGE THESE. "auto" is still a
         valid enum option; these tests verify the validator accepts it. Changing them
         would incorrectly remove validation coverage for the "auto" option.

       Summary: grep for `skat_backend.*auto` and `coast_backend.*auto` in the file,
       then apply judgment: if the assertion tests the DEFAULT VALUE of a constructed
       config, change "auto" to "python"; if it tests that "auto" is a VALID INPUT,
       leave it unchanged.

    2. **test_backend_defaults.py** (NEW file): Create unit tests for default backend behavior:
       ```python
       """Tests for Python-first default backend selection (Phase 25)."""
       import warnings
       import pytest
       from variantcentrifuge.association.backends import get_skat_backend
       from variantcentrifuge.association.base import AssociationConfig

       class TestBackendDefaults:
           def test_get_skat_backend_auto_returns_python(self):
               """auto mode returns PythonSKATBackend without probing R."""
               backend = get_skat_backend("auto")
               assert type(backend).__name__ == "PythonSKATBackend"

           def test_get_skat_backend_python_explicit(self):
               backend = get_skat_backend("python")
               assert type(backend).__name__ == "PythonSKATBackend"

           def test_config_defaults_python(self):
               config = AssociationConfig()
               assert config.skat_backend == "python"
               assert config.coast_backend == "python"

           def test_rskat_test_deprecation_warning(self):
               with warnings.catch_warnings(record=True) as w:
                   warnings.simplefilter("always")
                   from variantcentrifuge.association.tests.skat_r import RSKATTest
                   RSKATTest()
                   depr = [x for x in w if issubclass(x.category, DeprecationWarning)]
                   assert len(depr) >= 1
                   assert "deprecated" in str(depr[0].message).lower()
                   assert "v0.17.0" in str(depr[0].message)

           def test_coast_test_deprecation_warning(self):
               with warnings.catch_warnings(record=True) as w:
                   warnings.simplefilter("always")
                   from variantcentrifuge.association.tests.allelic_series import COASTTest
                   COASTTest()
                   depr = [x for x in w if issubclass(x.category, DeprecationWarning)]
                   assert len(depr) >= 1
                   assert "deprecated" in str(depr[0].message).lower()
                   assert "v0.17.0" in str(depr[0].message)
       ```
       Mark all tests with `@pytest.mark.unit`.

    3. **test_davies_fallback.py** (NEW file): Create unit test for saddlepoint-before-Liu:
       ```python
       """Tests for saddlepoint-before-Liu fallback in compute_pvalue (Phase 25)."""
       import numpy as np
       import pytest
       from unittest.mock import patch
       from variantcentrifuge.association.backends.davies import compute_pvalue, _kuonen_pvalue

       @pytest.mark.unit
       class TestSaddlepointBeforeLiu:
           def test_davies_out_of_range_tries_saddlepoint(self):
               """When Davies returns p > 1, saddlepoint should be tried before Liu."""
               lambdas = np.array([5.0, 3.0, 1.0])
               q = 20.0  # a value that gives a valid saddlepoint result

               # Mock davies_pvalue to return out-of-range
               with patch("variantcentrifuge.association.backends.davies.davies_pvalue") as mock_davies, \
                    patch("variantcentrifuge.association.backends.davies._try_load_davies", return_value=True):
                   mock_davies.return_value = (1.5, 1)  # p > 1, ifault=1

                   p_val, method, converged = compute_pvalue(q, lambdas)

                   # Should use saddlepoint (if q > mean) or liu as fallback
                   assert method in ("saddlepoint", "liu")
                   assert 0.0 <= p_val <= 1.0
                   assert not converged

           def test_davies_in_range_unchanged(self):
               """Davies in valid range should return directly (no saddlepoint)."""
               lambdas = np.array([5.0, 3.0, 1.0])
               q = 15.0

               with patch("variantcentrifuge.association.backends.davies.davies_pvalue") as mock_davies, \
                    patch("variantcentrifuge.association.backends.davies._try_load_davies", return_value=True):
                   mock_davies.return_value = (0.05, 0)  # valid p, ifault=0

                   p_val, method, converged = compute_pvalue(q, lambdas)

                   assert method == "davies"
                   assert p_val == 0.05
                   assert converged

           def test_saddlepoint_valid_for_large_q(self):
               """Saddlepoint should produce valid results for q > mean(lambdas)."""
               lambdas = np.array([10.0, 5.0, 2.0, 1.0])
               q = 30.0  # well above mean = 18
               p = _kuonen_pvalue(q, lambdas)
               assert p is not None
               assert 0.0 < p < 1.0
       ```

    Run `make ci-check` after all changes to verify nothing is broken.
  </action>
  <verify>
    `pytest tests/unit/test_backend_defaults.py -v` — all tests pass.
    `pytest tests/unit/test_davies_fallback.py -v` — all tests pass.
    `pytest tests/unit/test_json_config.py -v` — all tests pass.
    `make ci-check` — full CI passes (lint, format, typecheck, test-fast).
  </verify>
  <done>
    test_json_config.py updated: only default-checking assertions changed to "python";
    enum-validation assertions for "auto" left unchanged.
    test_backend_defaults.py covers: auto returns Python, config defaults, deprecation warnings.
    test_davies_fallback.py covers: saddlepoint-before-Liu fallback, Davies in-range unchanged.
    Full CI passes.
  </done>
</task>

</tasks>

<verification>
1. `make ci-check` passes with no errors.
2. `python -c "from variantcentrifuge.association.backends import get_skat_backend; print(type(get_skat_backend('auto')).__name__)"` prints "PythonSKATBackend".
3. `python -c "from variantcentrifuge.association.base import AssociationConfig; c = AssociationConfig(); print(c.skat_backend, c.coast_backend)"` prints "python python".
4. No existing tests broken by default swap.
</verification>

<success_criteria>
- Python is the default backend for both SKAT and COAST (auto and explicit default).
- R backends work with explicit --skat-backend r / --coast-backend r.
- R test wrappers emit DeprecationWarning on instantiation.
- Davies out-of-range uses saddlepoint before Liu.
- All tests pass including new tests for defaults and fallback behavior.
</success_criteria>

<output>
After completion, create `.planning/phases/25-python-default-backends-and-quick-wins/25-01-SUMMARY.md`
</output>
