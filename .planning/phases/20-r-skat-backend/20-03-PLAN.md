---
phase: 20-r-skat-backend
plan: 03
type: execute
wave: 3
depends_on: ["20-02"]
files_modified:
  - tests/unit/test_skat_r_backend.py
  - tests/unit/test_skat_r_test.py
  - tests/unit/test_engine_skat_integration.py
autonomous: true

must_haves:
  truths:
    - "RSKATBackend detect_environment raises ImportError with R_HOME hint when rpy2 unavailable"
    - "RSKATBackend detect_environment raises ImportError with install.packages hint when SKAT missing"
    - "test_gene calls SKATBinary for binary and SKAT for continuous — verified by mock inspection"
    - "SKAT-O extracts rho from result.rx2('param').rx2('rho')"
    - "NA_Real from R maps to p_value=None in TestResult"
    - "GC called every 100 genes — verified by mock spy count"
    - "Thread safety guard raises RuntimeError from non-main thread"
    - "Engine produces correct columns for SKAT (no effect/SE/CI columns, has extra columns)"
    - "Null model fitted exactly once across multiple gene calls"
    - "R infrastructure exception aborts immediately (not caught)"
  artifacts:
    - path: "tests/unit/test_skat_r_backend.py"
      provides: "Unit tests for RSKATBackend with mocked rpy2"
      min_lines: 150
    - path: "tests/unit/test_skat_r_test.py"
      provides: "Unit tests for RSKATTest with mocked backend"
      min_lines: 100
    - path: "tests/unit/test_engine_skat_integration.py"
      provides: "Engine integration tests verifying SKAT column output"
      min_lines: 80
  key_links:
    - from: "tests/unit/test_skat_r_backend.py"
      to: "variantcentrifuge/association/backends/r_backend.py"
      via: "mocked rpy2 modules"
      pattern: "mock.*rpy2|patch.*rpy2"
    - from: "tests/unit/test_skat_r_test.py"
      to: "variantcentrifuge/association/tests/skat_r.py"
      via: "mocked RSKATBackend"
      pattern: "mock.*RSKATBackend|MagicMock"
    - from: "tests/unit/test_engine_skat_integration.py"
      to: "variantcentrifuge/association/engine.py"
      via: "engine.run_all with mocked SKAT test"
      pattern: "engine.*run_all|mock.*skat"
---

<objective>
Comprehensive unit tests for the R SKAT backend, RSKATTest, and engine integration.
All tests use mocked rpy2 (no actual R installation required) to verify the correct
R functions are called, NA handling, memory management, thread safety, and output column
structure.

Purpose: Validate all SKAT-01 through SKAT-09 requirements without requiring R to be
installed in CI. Tests verify behavior via mock inspection — the actual R integration
is validated by the user on their R-equipped system.

Output: Three test files covering backend, test wrapper, and engine integration.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-r-skat-backend/20-RESEARCH.md
@.planning/phases/20-r-skat-backend/20-01-SUMMARY.md
@.planning/phases/20-r-skat-backend/20-02-SUMMARY.md
@variantcentrifuge/association/backends/r_backend.py
@variantcentrifuge/association/tests/skat_r.py
@variantcentrifuge/association/engine.py
@variantcentrifuge/association/base.py
@tests/unit/test_association_engine.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: RSKATBackend unit tests with mocked rpy2</name>
  <files>tests/unit/test_skat_r_backend.py</files>
  <action>
Create comprehensive unit tests for RSKATBackend. ALL rpy2 calls must be mocked —
these tests run in CI without R installed.

Use `unittest.mock.patch` to mock `rpy2.robjects`, `rpy2.robjects.packages`, and
`rpy2.rinterface`. The mocking strategy: patch at the import site inside the method
bodies (since r_backend.py does deferred imports).

**Test cases for detect_environment():**

1. `test_detect_environment_no_rpy2`:
   - Mock `import rpy2.robjects` to raise ImportError
   - Assert detect_environment() raises ImportError
   - Assert error message contains "R_HOME" and diagnostic hint

2. `test_detect_environment_no_skat_package`:
   - Mock rpy2.robjects import succeeds
   - Mock `isinstalled("SKAT")` returns False
   - Assert ImportError with "install.packages('SKAT')" in message

3. `test_detect_environment_success`:
   - Mock all rpy2 imports succeed, isinstalled returns True, importr works
   - Assert no exception raised
   - Assert `_skat_pkg` and `_base_pkg` cached on instance

**Test cases for log_environment():**

4. `test_log_environment_versions` (with caplog):
   - Mock R version string, SKAT version, rpy2 version
   - Assert INFO log contains all three versions and R_HOME
   - Assert WARNING logged when R < 4.0

**Test cases for fit_null_model():**

5. `test_fit_null_model_binary_with_covariates`:
   - Mock SKAT_Null_Model
   - Call with binary trait, 2-column covariate matrix
   - Assert SKAT_Null_Model called with `out_type="D"`, `Adjustment=True`
   - Assert R globals cleaned up (rm called with pattern)

6. `test_fit_null_model_continuous_no_covariates`:
   - Assert SKAT_Null_Model called with `out_type="C"`, formula `"._vc_y ~ 1"`

7. `test_fit_null_model_asserts_main_thread`:
   - Run from a threading.Thread
   - Assert RuntimeError raised with "main thread" in message

**Test cases for test_gene():**

8. `test_test_gene_binary_calls_skatbinary`:
   - Create NullModelResult with trait_type="binary"
   - Mock SKATBinary to return mock result with p.value=0.05
   - Assert SKATBinary called (not SKAT)
   - Assert returned dict has p_value=0.05

9. `test_test_gene_continuous_calls_skat`:
   - Create NullModelResult with trait_type="quantitative"
   - Assert SKAT called (not SKATBinary)

10. `test_test_gene_skat_o_extracts_rho`:
    - Mock result.rx2("param").rx2("rho") to return [0.5]
    - Call with method="SKATO"
    - Assert returned dict has rho=0.5

11. `test_test_gene_na_real_returns_none`:
    - Mock result.rx2("p.value") to return [NA_Real mock]
    - Assert returned dict has p_value=None

12. `test_test_gene_captures_r_warnings`:
    - Mock withCallingHandlers result with warnings=["moment adjustment applied"]
    - Assert returned dict warnings list contains the warning

13. `test_test_gene_matrix_column_major`:
    - Provide 3x2 numpy array, verify the FloatVector call uses ravel(order='F')
    - Verify nrow=3, ncol=2 passed to R matrix()

14. `test_test_gene_r_exception_propagates`:
    - Mock R call to raise rpy2.rinterface_lib.embedded.RRuntimeError
    - Assert the exception propagates (not caught) — per phase context "abort on R crash"

**Test cases for memory management:**

15. `test_gc_called_at_interval`:
    - Create backend, call a mock _run_r_gc spy
    - Simulate 250 gene calls by calling the GC check logic
    - Assert gc called exactly 2 times (at 100 and 200)

16. `test_check_r_heap_returns_mb`:
    - Mock gc(verbose=FALSE) return matrix with known Vcells value
    - Assert _check_r_heap() returns correct MB value

17. `test_cleanup_calls_gc`:
    - Call cleanup(), assert _run_r_gc called

**Test case for thread safety:**

18. `test_assert_main_thread_from_worker`:
    - Run _assert_main_thread from ThreadPoolExecutor worker
    - Assert RuntimeError raised

Use `@pytest.mark.unit` marker on all tests.
  </action>
  <verify>
    `pytest tests/unit/test_skat_r_backend.py -v --timeout=30` — all tests pass
  </verify>
  <done>
    18+ test cases covering: R detection (3 scenarios), environment logging,
    null model fitting (binary/continuous/thread check), gene testing
    (SKATBinary vs SKAT dispatch, SKAT-O rho, NA_Real, warnings, column-major,
    R exception propagation), memory management (GC interval, heap check, cleanup),
    and thread safety. All use mocked rpy2.
  </done>
</task>

<task type="auto">
  <name>Task 2: RSKATTest + engine integration tests</name>
  <files>
    tests/unit/test_skat_r_test.py
    tests/unit/test_engine_skat_integration.py
  </files>
  <action>
**test_skat_r_test.py — RSKATTest unit tests with mocked backend:**

Mock RSKATBackend entirely (not rpy2). Test the RSKATTest wrapper logic.

1. `test_name_is_skat`:
   - Assert RSKATTest().name == "skat"

2. `test_effect_column_names_all_none`:
   - Assert all values in effect_column_names() are None

3. `test_null_model_fitted_once`:
   - Create RSKATTest with mocked backend
   - Call run() for 3 different genes
   - Assert backend.fit_null_model called exactly once

4. `test_run_no_genotype_matrix_returns_none_pvalue`:
   - Call run() with contingency_data missing genotype_matrix
   - Assert result.p_value is None

5. `test_run_zero_variants_returns_none_pvalue`:
   - Call with genotype_matrix shape (100, 0)
   - Assert result.p_value is None

6. `test_run_returns_skat_extra_columns`:
   - Mock backend.test_gene to return {"p_value": 0.03, "rho": 0.5, "warnings": ["w1"]}
   - Assert result.extra contains skat_o_rho, skat_warnings, skat_method

7. `test_prepare_large_panel_warning` (with caplog):
   - Call prepare(3000)
   - Assert WARNING logged about large panel

8. `test_prepare_sets_log_interval`:
   - Call prepare(500) -> log_interval should be 50
   - Call prepare(30) -> log_interval should be 10

9. `test_finalize_logs_timing` (with caplog):
   - Set _genes_processed and _start_time
   - Call finalize()
   - Assert INFO log with "R SKAT complete" and gene count

10. `test_gc_triggered_every_100_genes`:
    - Mock backend with spy on _run_r_gc
    - Call run() 150 times with mock data
    - Assert _run_r_gc called once (at gene 100)

**test_engine_skat_integration.py — Engine + SKAT column output:**

Test the engine produces correct output columns when SKAT is registered.
Mock the RSKATTest entirely to avoid any rpy2 dependency.

1. `test_engine_skat_no_effect_columns`:
   - Create mock SKAT test that returns TestResult with effect_size=None
   - Register in engine, run on 3 genes
   - Assert output DataFrame does NOT contain "skat_None", "skat_or", "skat_beta" columns
   - Assert output DataFrame DOES contain "skat_p_value", "skat_corrected_p_value"

2. `test_engine_skat_extra_columns_written`:
   - Mock SKAT test returns extra={"skat_o_rho": 0.5, "skat_method": "SKATO"}
   - Assert output DataFrame contains "skat_o_rho" and "skat_method" columns
   - Assert values are correct

3. `test_engine_skat_and_fisher_together`:
   - Register both Fisher (real) and SKAT (mocked) tests
   - Run on 3 genes with both contingency table data and genotype matrix data
   - Assert output has both fisher_p_value and skat_p_value columns
   - Assert fisher effect columns present (fisher_or) but skat effect columns absent

4. `test_engine_skat_none_pvalue_excluded_from_correction`:
   - Mock SKAT returning p_value=None for 1 gene, real p-values for 2 genes
   - Assert corrected_p_value is None for the skipped gene
   - Assert corrected_p_value is not None for the tested genes

5. `test_engine_prepare_finalize_hooks_called`:
   - Mock test with prepare() and finalize() methods
   - Run engine.run_all()
   - Assert prepare called with correct gene count
   - Assert finalize called once after gene loop

Use `@pytest.mark.unit` marker on all tests.
  </action>
  <verify>
    - `pytest tests/unit/test_skat_r_test.py tests/unit/test_engine_skat_integration.py -v --timeout=30` — all pass
    - `pytest tests/unit/ -x -q --timeout=60` — full unit suite passes (no regressions)
    - `make lint` passes
  </verify>
  <done>
    15+ test cases across two files covering RSKATTest wrapper logic (null model
    caching, skip conditions, extra columns, progress, timing) and engine integration
    (column output correctness, multi-test scenarios, correction behavior, lifecycle hooks).
    All tests use mocked backends — no R required in CI.
  </done>
</task>

</tasks>

<verification>
1. `pytest tests/unit/test_skat_r_backend.py tests/unit/test_skat_r_test.py tests/unit/test_engine_skat_integration.py -v --timeout=60` — all pass
2. `pytest tests/unit/ -x -q --timeout=120` — full unit suite passes, no regressions
3. `make lint` passes
4. `make ci-check` passes (lint + format + typecheck + test-fast)
</verification>

<success_criteria>
- 30+ unit tests covering all SKAT requirements (SKAT-01 through SKAT-09)
- R detection: 3 error scenarios tested (no rpy2, no SKAT pkg, success)
- Binary/continuous dispatch: SKATBinary vs SKAT verified by mock inspection
- SKAT-O rho extraction verified
- NA_Real -> None mapping verified
- GC interval (100 genes) verified by mock spy
- Thread safety: RuntimeError from non-main thread verified
- Engine column output: no "skat_None" columns, extra columns written correctly
- Null model fitted exactly once across multiple genes
- All tests run without R installed (mocked rpy2)
- No regressions in existing test suite
</success_criteria>

<output>
After completion, create `.planning/phases/20-r-skat-backend/20-03-SUMMARY.md`
</output>
