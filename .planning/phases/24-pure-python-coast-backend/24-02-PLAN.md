---
phase: 24-pure-python-coast-backend
plan: 02
type: execute
wave: 2
depends_on: ["24-01"]
files_modified:
  - variantcentrifuge/association/base.py
  - variantcentrifuge/association/engine.py
  - variantcentrifuge/cli.py
autonomous: true

must_haves:
  truths:
    - "--coast-backend python routes 'coast' to PurePythonCOASTTest in engine registry"
    - "--coast-backend auto tries R first, falls back to Python COAST"
    - "--coast-backend r keeps COASTTest (existing R behavior)"
    - "AssociationConfig has coast_backend field with default 'auto'"
    - "Backend swap runs BEFORE unknown-name check in from_names()"
  artifacts:
    - path: "variantcentrifuge/association/base.py"
      provides: "coast_backend field on AssociationConfig"
      contains: "coast_backend"
    - path: "variantcentrifuge/association/engine.py"
      provides: "coast backend-aware swap in from_names()"
      contains: "coast_backend"
    - path: "variantcentrifuge/cli.py"
      provides: "--coast-backend CLI argument"
      contains: "coast-backend"
  key_links:
    - from: "variantcentrifuge/cli.py"
      to: "variantcentrifuge/association/base.py"
      via: "CLI arg --coast-backend stored in cfg, passed to AssociationConfig"
      pattern: "coast_backend"
    - from: "variantcentrifuge/association/engine.py"
      to: "variantcentrifuge/association/tests/allelic_series_python.py"
      via: "Backend swap replaces registry['coast'] with PurePythonCOASTTest"
      pattern: "PurePythonCOASTTest"
---

<objective>
Wire PurePythonCOASTTest into the engine registry, CLI, and config — enabling `--coast-backend python|r|auto` backend selection that mirrors the SKAT backend pattern.

Purpose: Users can select the COAST backend via CLI; auto mode falls back to Python when R is unavailable.
Output: Modified base.py, engine.py, and cli.py with coast backend support.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/24-pure-python-coast-backend/24-RESEARCH.md

# Key files to modify:
@variantcentrifuge/association/base.py
@variantcentrifuge/association/engine.py
@variantcentrifuge/cli.py

# Pattern reference (SKAT backend swap):
@variantcentrifuge/association/tests/skat_python.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: AssociationConfig coast_backend field + engine backend swap</name>
  <files>variantcentrifuge/association/base.py, variantcentrifuge/association/engine.py</files>
  <action>
**base.py:** Add `coast_backend` field to `AssociationConfig` dataclass, immediately after the existing `coast_weights` field:

```python
# Phase 24: COAST backend field
coast_backend: str = "auto"
"""COAST computation backend: "r" (R via rpy2), "python", or "auto" (try r first)."""
```

**engine.py:** Add coast backend-aware swap logic in `from_names()`, immediately after the existing SKAT backend swap block (lines 132-148), BEFORE the unknown-name check (line 150-157).

The pattern mirrors the SKAT swap exactly:

```python
# Backend-aware swap: --coast-backend python routes "coast" to PurePythonCOASTTest.
# This runs BEFORE the unknown-name check so that "coast" resolves correctly.
coast_backend = getattr(config, "coast_backend", "auto")
if coast_backend == "python":
    from variantcentrifuge.association.tests.allelic_series_python import (
        PurePythonCOASTTest,
    )
    registry["coast"] = PurePythonCOASTTest
elif coast_backend == "auto":
    # Try R first; if rpy2/AllelicSeries unavailable, fall back to Python
    try:
        import rpy2.robjects  # noqa: F401
        from rpy2.robjects.packages import importr
        importr("AllelicSeries")
        # If we reach here, R backend is available; keep COASTTest
    except (ImportError, RuntimeError, Exception):
        from variantcentrifuge.association.tests.allelic_series_python import (
            PurePythonCOASTTest,
        )
        registry["coast"] = PurePythonCOASTTest
        logger.info(
            "R/AllelicSeries unavailable; using Python COAST backend (auto mode)"
        )
```

CRITICAL: The coast swap block must be AFTER the skat swap block and BEFORE `available = sorted(registry.keys())` (the unknown-name check). This matches the existing IMPL-29 decision.

Also update the module docstring comment in the registry section:
```python
# Phase 24: "coast" can be swapped to PurePythonCOASTTest via --coast-backend python|auto
```
  </action>
  <verify>
`python -c "from variantcentrifuge.association.base import AssociationConfig; c = AssociationConfig(); print(c.coast_backend)"` prints `auto`.
`ruff check variantcentrifuge/association/base.py variantcentrifuge/association/engine.py` passes.
  </verify>
  <done>
AssociationConfig has coast_backend field defaulting to "auto". Engine from_names() swaps "coast" registry entry to PurePythonCOASTTest when coast_backend is "python" or when auto mode detects R/AllelicSeries unavailable.
  </done>
</task>

<task type="auto">
  <name>Task 2: CLI --coast-backend argument + config wiring</name>
  <files>variantcentrifuge/cli.py</files>
  <action>
Add `--coast-backend` argument to the stats argument group in cli.py, immediately after the existing `--skat-backend` argument (around line 427):

```python
stats_group.add_argument(
    "--coast-backend",
    choices=["auto", "r", "python"],
    default="auto",
    help=(
        "COAST computation backend: auto (prefer R, fall back to Python), "
        "r, or python"
    ),
)
```

Then wire it into the cfg dict. Find where `cfg["skat_backend"]` is set (around line 1139) and add immediately after:

```python
cfg["coast_backend"] = getattr(args, "coast_backend", "auto")
```

Also ensure the AssociationConfig construction in `analysis_stages.py` (or wherever AssociationConfig is built from cfg) picks up `coast_backend`. Search for where `AssociationConfig(` is instantiated from cfg and add `coast_backend=cfg.get("coast_backend", "auto")`.

Check `variantcentrifuge/stages/analysis_stages.py` for the AssociationConfig construction — it likely reads from `context.config`. The cfg dict flows through pipeline context, so `coast_backend` should be available via `context.config.get("coast_backend", "auto")`.

If there's a JSON config validation in Phase 23 (VALID_ASSOCIATION_KEYS or similar), add "coast_backend" to that set.
  </action>
  <verify>
`python -c "from variantcentrifuge.cli import build_parser; p = build_parser(); args = p.parse_args(['--perform-association', '--coast-backend', 'python']); print(args.coast_backend)"` prints `python` (or adjust for actual parser function name).
`ruff check variantcentrifuge/cli.py` passes.
`ruff format --check variantcentrifuge/cli.py` passes.
  </verify>
  <done>
`--coast-backend` CLI argument exists with choices [auto, r, python], defaults to auto. Value flows through cfg dict to AssociationConfig. JSON config validation includes coast_backend.
  </done>
</task>

</tasks>

<verification>
1. `ruff check variantcentrifuge/association/base.py variantcentrifuge/association/engine.py variantcentrifuge/cli.py` passes
2. `ruff format --check variantcentrifuge/association/base.py variantcentrifuge/association/engine.py variantcentrifuge/cli.py` passes
3. `pytest tests/unit/test_coast.py -x` (existing tests still pass)
4. `pytest tests/unit/ -k "engine" -x` (engine tests still pass)
5. `python -c "from variantcentrifuge.association.base import AssociationConfig; c = AssociationConfig(coast_backend='python'); print(c.coast_backend)"` prints `python`
</verification>

<success_criteria>
- `--coast-backend python` causes engine to use PurePythonCOASTTest instead of COASTTest
- `--coast-backend auto` tries R first, falls back to Python (default behavior)
- `--coast-backend r` keeps the existing R behavior (COASTTest)
- No regression in any existing tests
- Backend swap happens BEFORE unknown-name validation in engine.py
</success_criteria>

<output>
After completion, create `.planning/phases/24-pure-python-coast-backend/24-02-SUMMARY.md`
</output>
