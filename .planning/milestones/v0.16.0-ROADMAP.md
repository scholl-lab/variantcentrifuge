# Milestone v0.16.0: Association Hardening & Multi-Cohort Features

**Status:** SHIPPED 2026-02-26
**Phases:** 30-37
**Total Plans:** 12

## Overview

Harden the v0.15.0 association framework for real-world multi-cohort use — fix COAST p=None bugs that block scientific validation, add gene-level FDR priors, BED region restriction, PCA pipeline wiring, and streaming genotype matrices to prevent OOM. Every new feature is backward-compatible; existing CLI and output formats unchanged.

## Phases

### Phase 30: Dead Code Cleanup

**Goal:** The codebase is free of the 8 dead stage classes and all vestigial "refactored_pipeline" / "old pipeline" naming artifacts that accumulated before v0.15.0.
**Depends on:** Nothing (standalone cleanup)
**Plans:** 1 plan
**Requirements:** CLEAN-01, CLEAN-02, CLEAN-03, CLEAN-04, CLEAN-05, CLEAN-06, TD-06

Plans:
- [x] 30-01: Remove dead stage classes, synchronize registry/imports, normalize naming artifacts

---

### Phase 31: COAST Fix

**Goal:** COAST produces valid p-values for real-world cohorts where most genes lack all three variant categories (BMV/DMV/PTV), genotype matrices are reliably available to the test, and multi-transcript SnpEff effect strings are handled correctly.
**Depends on:** Nothing (bug fix)
**Plans:** 2 plans
**Requirements:** COAST-01, COAST-02, COAST-03, COAST-04, COAST-05, COAST-06, COAST-07

Plans:
- [x] 31-01: Fix genotype matrix fallback (COAST-01) and partial-category logic (COAST-03)
- [x] 31-02: Fix &-concatenated effect strings, configurable classification scoring, auto-field injection (COAST-02, COAST-04, COAST-05, COAST-06, COAST-07)

---

### Phase 32: Region Restriction and PCA Wiring

**Goal:** Users can restrict variant extraction to callable regions via a BED file, and PCA covariates computed by the pipeline are automatically available to association tests without manual file passing.
**Depends on:** Nothing (both features are standalone)
**Plans:** 2 plans
**Requirements:** REGION-01, REGION-02, REGION-03, REGION-04, PCA-01, PCA-02, PCA-03

Plans:
- [x] 32-01: Add --regions-bed CLI flag and BED intersection in GeneBedCreationStage with chr mismatch detection
- [x] 32-02: Add PCAComputationStage, unified --pca CLI flag, pipeline wiring, AssociationAnalysisStage integration

---

### Phase 33: Gene-Level FDR Weighting

**Goal:** Users with biological prior knowledge (pLI scores, GWAS signals) can increase statistical power by providing per-gene weights for weighted Benjamini-Hochberg FDR correction, with correct weight normalization and transparent diagnostics.
**Depends on:** Nothing (standalone; pure correction.py addition)
**Plans:** 1 plan
**Requirements:** FDR-01, FDR-02, FDR-03, FDR-05, FDR-06

Plans:
- [x] 33-01: Implement weighted BH in correction.py, CLI flag, weight file loader, and diagnostics

---

### Phase 34: Tech Debt

**Goal:** The association subsystem config mapping is correct, COAST has R golden values for regression testing, SKAT-O column naming is consistent, and Fisher lambda_GC scope is documented.
**Depends on:** Phase 31 (COAST golden values require a working COAST implementation)
**Plans:** 3 plans
**Requirements:** TD-02, TD-03, TD-04, TD-05

Plans:
- [x] 34-01: Fix create_stages_from_config mapping (TD-02) and document lambda_GC Fisher exemption (TD-05)
- [x] 34-02: Standardize column naming: _pvalue/_qvalue convention across engine, diagnostics, tests, and docs (TD-04)
- [x] 34-03: Generate COAST R golden values from GCKD data and add tolerance comparison test (TD-03)

---

### Phase 35: Case-Confidence Weights — DEFERRED

**Reason:** HPO count mode needs HPO infrastructure not yet available; file-only mode too narrow for standalone phase.
**Deferred requirements:** CONF-01 through CONF-07

---

### Phase 36: Sparse Genotype Matrices — DEFERRED

**Reason:** Phase 37 streaming solves OOM problem; centering destroys sparsity for SKAT; benefit only materializes at 10K+ samples with native backend.
**Deferred requirements:** PERF-01 through PERF-03

---

### Phase 37: Association Resource Management & Memory Streaming

**Goal:** The pipeline has a single shared ResourceManager in PipelineContext used by all stages, the GT column drop/recover antipattern is eliminated so genotype data flows cleanly through analysis stages, and genotype matrices are streamed per-gene (build-test-discard) to prevent OOM on large panels.
**Depends on:** Phase 34 (builds on fixes already applied)
**Plans:** 3 plans
**Requirements:** PERF-04, PERF-05, PERF-06

Plans:
- [x] 37-01: Shared ResourceManager in PipelineContext (PERF-04)
- [x] 37-02: GT lifecycle cleanup: eliminate drop/recover antipattern (PERF-05)
- [x] 37-03: Streaming genotype matrix construction per-gene (PERF-06)

---

## Milestone Summary

**Key Decisions:**

- COAST-03: skip threshold changed from "any category missing" to "ALL categories missing" — matches R reference (insitro/AllelicSeries drop_empty=TRUE)
- COAST classification configs use formula engine with normalized COAST_* column names
- Weighted BH renormalization at correction time (not load time) — allows reuse across gene subsets
- IHW not implemented — no Python implementation exists; deferred to backlog
- GT Lifecycle Invariant: per-sample GEN_N__GT columns survive through all analysis stages
- _GenotypeMatrixBuilder is module-level dataclass for ProcessPoolExecutor picklability
- ResourceManager initialized once in pipeline.py, shared via context; fallback pattern in stages for test compat

**Issues Resolved:**

- COAST p=None on partial-category genes (GCKD cohort had 80%+ genes with missing categories)
- Silent config mapping bugs in create_stages_from_config() (association/gene_burden stages never activated)
- GT column drop/recover antipattern causing fragile context state across analysis stages
- OOM risk on large gene panels from pre-building all genotype matrices

**Issues Deferred:**

- Case-confidence weights (CONF-01 through CONF-07) — HPO infrastructure prerequisite
- Sparse genotype matrices (PERF-01 through PERF-03) — streaming solves OOM; sparsity destroyed by centering
- IHW (FDR-04) — no Python implementation exists

**Technical Debt Incurred:**

- docs/source/guides/association_testing.md line 334 lists skat_pvalue but default output is skat_o_pvalue
- Pre-existing TODO(12-02) in analysis_stages.py line 760

---

_For current project status, see .planning/ROADMAP.md_
