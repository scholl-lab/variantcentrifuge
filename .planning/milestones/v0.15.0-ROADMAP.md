# Milestone v0.15.0: Modular Rare Variant Association Framework

**Status:** SHIPPED 2026-02-23
**Phases:** 18-29
**Total Plans:** 35

## Overview

Upgrade the existing Fisher's exact gene burden pipeline to a multi-test association engine supporting SKAT, SKAT-O, ACAT-O, logistic/linear burden tests, covariate adjustment, PCA integration, and variant weighting — all backward compatible with existing `--perform-gene-burden` behavior.

## Phases

### Phase 18: Foundation — Core Abstractions and Fisher Refactor

**Goal:** Users can run `--perform-association --association-tests fisher` and receive output bit-identical to `--perform-gene-burden`, establishing the association package skeleton and pipeline integration.
**Depends on:** None (foundation phase)
**Plans:** 4 plans
**Requirements:** CORE-01, CORE-02, CORE-03, CORE-04, CORE-05, CORE-06, CORE-07, CORE-08

Plans:
- [x] 18-01: association/ package skeleton (base.py, engine.py, correction.py, fisher.py)
- [x] 18-02: Pipeline integration (AssociationAnalysisStage, PipelineContext, stage registry, gene_burden.py correction rewire)
- [x] 18-03: CLI args (--perform-association, --association-tests, --skat-backend) and ExcelReportStage Association sheet
- [x] 18-04: Unit tests: bit-identity Fisher parity, edge cases, correction, stage behavior

---

### Phase 19: Covariate System and Burden Tests

**Goal:** Users can run logistic or linear regression burden tests with covariate adjustment, and the genotype matrix builder handles all real-world genotype encodings correctly.
**Depends on:** Phase 18
**Plans:** 3 plans
**Requirements:** COV-01, COV-02, COV-03, COV-04, BURDEN-01, BURDEN-02, BURDEN-03, WEIGHT-01, WEIGHT-02

Plans:
- [x] 19-01: covariates.py, genotype_matrix.py, weights.py, and AssociationConfig extension
- [x] 19-02: LogisticBurdenTest + LinearBurdenTest implementations, engine registry, CLI args
- [x] 19-03: Unit tests: covariate alignment, genotype edge cases, burden test validation against manual statsmodels

---

### Phase 20: R SKAT Backend

**Goal:** Users with R and the SKAT package installed can run SKAT and SKAT-O via rpy2, with SKATBinary for binary traits, moment adjustment for small samples, and R memory management.
**Depends on:** Phase 19
**Plans:** 3 plans
**Requirements:** SKAT-01, SKAT-02, SKAT-03, SKAT-04, SKAT-08, SKAT-09

Plans:
- [x] 20-01: Backend ABC, RSKATBackend skeleton with R/SKAT detection, RSKATTest wrapper
- [x] 20-02: RSKATBackend core: fit_null_model, test_gene (SKATBinary/SKAT dispatch, SKAT-O), R memory management
- [x] 20-03: Unit tests: mocked rpy2 backend tests, RSKATTest wrapper tests, engine SKAT integration tests

---

### Phase 21: Pure Python SKAT Backend

**Goal:** Users without R can run SKAT and SKAT-O via pure Python, matching R output within tiered tolerance, using Davies CFFI for exact p-values with Kuonen saddlepoint and Liu moment-matching fallbacks.
**Depends on:** Phase 20 (R backend as correctness oracle)
**Plans:** 3 plans
**Requirements:** SKAT-05, SKAT-06, SKAT-07, SKAT-10

Plans:
- [x] 21-01: davies.py p-value layer (Liu + Kuonen + Davies fallback chain), qfc.cpp bundling, CFFI build script
- [x] 21-02: PythonSKATBackend (null model, score test, SKAT-O rho grid), PurePythonSKATTest wrapper
- [x] 21-03: Unit tests: p-value math validation, backend behavior tests, analytical reference comparisons

---

### Phase 22: ACAT-O and Diagnostics

**Goal:** ACAT-O p-values combining burden and SKAT results per gene, single FDR correction, and diagnostics directory with lambda_GC and QQ plot data.
**Depends on:** Phase 19 (burden), Phase 20/21 (SKAT)
**Plans:** 3 plans
**Requirements:** OMNI-01, OMNI-02, OMNI-03, DIAG-01, DIAG-02, DIAG-03, DIAG-05, DIAG-06

Plans:
- [x] 22-01: ACAT Cauchy combination (acat.py), ACAT-O post-loop engine integration, FDR strategy
- [x] 22-02: Diagnostics module (lambda_GC, QQ data, sample size warnings), --diagnostics-output CLI arg
- [x] 22-03: Tests: ACAT formula validation, lambda_GC calibration, engine ACAT-O integration

---

### Phase 23: PCA Integration, Functional Weights, Allelic Series, and JSON Config

**Goal:** PCA file parsing + AKT computation, CADD/REVEL functional weights, COAST allelic series test, JSON config mode, and matplotlib QQ plots.
**Depends on:** Phase 19 (covariates/weights), Phase 22 (diagnostics)
**Plans:** 4 plans
**Requirements:** DIAG-04, PCA-01, PCA-02, PCA-03, PCA-04, SERIES-01, SERIES-02, CONFIG-01, CONFIG-02, WEIGHT-03, WEIGHT-04, WEIGHT-05

Plans:
- [x] 23-01: PCA file parsing (PLINK .eigenvec, AKT, generic TSV), PCAComputationStage, CLI args
- [x] 23-02: Functional weights (CADD-normalized, REVEL-based, combined), CLI args
- [x] 23-03: COAST allelic series test (BMV/DMV/PTV classification, R AllelicSeries wrapper)
- [x] 23-04: JSON config mode (association section in config.json, validation) + matplotlib QQ plot

---

### Phase 24: Pure Python COAST Backend

**Goal:** Pure Python COAST matching R AllelicSeries::COAST() within tiered tolerance, enabling parallel_safe=True and eliminating R dependency.
**Depends on:** Phase 23 (R COAST wrapper), Phase 21 (Python SKAT), Phase 19 (burden regression)
**Plans:** 3 plans
**Requirements:** COAST-PY-01, COAST-PY-02, COAST-PY-03, COAST-PY-04, COAST-PY-05

Plans:
- [x] 24-01: PythonCOASTBackend (6 burden + 1 allelic SKAT + Cauchy omnibus)
- [x] 24-02: Engine/registry coast backend swap, CLI --coast-backend argument
- [x] 24-03: R golden file generation script, unit tests, R reference comparison tests

---

### Phase 25: Python Default Backends and Quick Wins

**Goal:** Python backends become default, R deprecated with opt-in, saddlepoint-before-Liu fallback, ACAT-V per-variant score test.
**Depends on:** Phase 24, Phase 21
**Plans:** 2 plans

Plans:
- [x] 25-01: Default backend swap (Python-first), R deprecation warnings, saddlepoint fallback
- [x] 25-02: ACAT-V per-variant score test and ACAT-O integration

---

### Phase 26: Association Testing Documentation

**Goal:** Comprehensive user guide, updated docs, API reference stubs, changelog.
**Depends on:** Phase 25
**Plans:** 2 plans

Plans:
- [x] 26-01: Comprehensive association testing user guide
- [x] 26-02: API reference stubs, cross-references, changelog, README

---

### Phase 27: Association Performance Optimizations

**Goal:** 128-node GL quadrature (46x SKAT-O speedup), gene-level ProcessPoolExecutor parallelization.
**Depends on:** Phase 25, Phase 26
**Plans:** 3 plans

Plans:
- [x] 27-01: GL quadrature in SKAT-O, parallel_safe attributes
- [x] 27-02: --association-workers CLI arg, AssociationConfig field
- [x] 27-03: ProcessPoolExecutor parallel gene loop with null model pre-fitting

---

### Phase 28: Tech Debt Cleanup

**Goal:** Fix accumulated tech debt: RSKATTest parallel_safe, CLI args for skat_method and diagnostic thresholds.
**Depends on:** Phase 27
**Plans:** 2 plans

Plans:
- [x] 28-01: RSKATTest parallel_safe attribute + ROADMAP criterion typo fix
- [x] 28-02: CLI args for skat_method and diagnostic thresholds

---

### Phase 29: Classic Pipeline Deprecation and Removal

**Goal:** Remove vestigial classic pipeline naming, rename run_refactored_pipeline to run_pipeline, remove --use-new-pipeline, update docs.
**Depends on:** Phase 28
**Plans:** 3 plans

Plans:
- [x] 29-01: Rename run_refactored_pipeline to run_pipeline
- [x] 29-02: Remove --use-new-pipeline references from tests
- [x] 29-03: Update CLAUDE.md and README.md for single pipeline architecture

---

## Milestone Summary

**Key Decisions:**

- Dual SKAT backend (R + Python): R is gold standard for validation; Python for portability
- Compiled Davies via ctypes: Exact p-values without R dependency; Liu fallback for safety
- Single FDR on ACAT-O across genes: Applying FDR separately per test is statistically incorrect
- Binary trait gating at null model construction: SKATBinary vs SKAT decision locked early
- Clean reimplementation (not delegation) for FisherExactTest: Correct coupling direction
- Python default backends: Auto mode selects Python directly (no R probe)
- GL quadrature replaces adaptive quad: 46x speedup for SKAT-O integration
- ProcessPoolExecutor for gene parallelization: Near-linear wall-clock speedup

**Issues Resolved:**

- rpy2 3.6.x removed `rpy2.__version__` — use importlib.metadata
- R cleanup regex must be `'^\\._vc_'` not `'\\._vc_'`
- SKAT-O rho: `param$rho_est` is optimal rho; `param$rho` is the search grid
- Davies C ext returns CDF not SF for some eigenvalue/Q combinations
- Zero-variant guard needed before matrix_rank in SKAT/SKATO
- SKAT projection: project Z_tilde through hat matrix; eigenvalues /2
- Davies compute_pvalue matches R Get_PValue.Lambda: acc=1e-6, lim=10000

**Issues Deferred:**

- PCAComputationStage not wired in pipeline.py (`--pca-tool akt` silently does nothing; `--pca-file` workaround functional)
- create_stages_from_config() missing association/gene_burden mapping (programmatic API only; CLI unaffected)
- R golden values for COAST comparison not generated (requires R + AllelicSeries)
- Two internal "refactored_pipeline" strings remain in checkpoint fallback defaults (unreachable in normal operation)

**Technical Debt Incurred:**

- skat_o_p_value naming: implementation uses `skat_p_value` for all SKAT methods (naming convention difference, not behavioral)
- Fisher lambda_GC ~0.85 on null (inherently conservative; criterion applies to score-based tests only)

---

_For current project status, see .planning/MILESTONES.md_
