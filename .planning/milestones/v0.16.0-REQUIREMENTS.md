# Requirements Archive: v0.16.0 Association Hardening & Multi-Cohort Features

**Archived:** 2026-02-26
**Status:** SHIPPED

This is the archived requirements specification for v0.16.0.
For current requirements, see the next milestone's requirements file in `.planning/` (created via `/gsd:new-milestone`).

---

## v1 Requirements

### COAST Fix (#87)

- [x] **COAST-01**: Genotype matrix is available to all regression-based tests (SKAT, burden, COAST) when per-sample GT columns exist in the DataFrame
- [x] **COAST-02**: When `--association-tests coast` is specified, SIFT and PolyPhen annotation fields are auto-injected into field extraction
- [x] **COAST-03**: COAST test produces valid p-values when 1 or 2 of 3 variant categories (BMV/DMV/PTV) are missing, with a warning logged (matching R AllelicSeries behavior)
- [x] **COAST-04**: COAST classification handles SnpEff "&"-concatenated effect strings (e.g., `stop_gained&splice_region_variant`)
- [x] **COAST-05**: User can select a COAST classification model via `--coast-classification <model-name>` (default: `sift_polyphen`)
- [x] **COAST-06**: A `scoring/coast_classification/` config defines BMV/DMV/PTV thresholds as configuration, supporting SIFT+PolyPhen, CADD-based, and REVEL-based classification strategies
- [x] **COAST-07**: Multi-transcript annotation conflicts use configurable resolution strategy (default: majority-vote) in the classification scoring model

### Gene-Level FDR Weighting (#86)

- [x] **FDR-01**: User can provide a gene-to-weight TSV file via `--gene-prior-weights <file>` for weighted FDR correction
- [x] **FDR-02**: Weighted BH (Genovese 2006) is applied when weights are provided: p-values adjusted by gene weight, weights renormalized to average=1.0
- [x] **FDR-03**: Genes absent from the weight file receive weight=1.0 (neutral); warning emitted if >50% of tested genes are missing
- [x] **FDR-04**: IHW — Excluded per project decision (no Python IHW implementation exists)
- [x] **FDR-05**: Effective number of tests (`sum(w)^2 / sum(w^2)`) is reported in diagnostics output
- [x] **FDR-06**: When `--gene-prior-weights` is not provided, all genes receive equal weight (identical to current plain BH/Bonferroni)

### Case-Confidence Weights (#85) — DEFERRED

- [ ] **CONF-01**: Per-sample confidence weights from phenotype file — deferred (HPO infra not ready)
- [ ] **CONF-02**: Auto-compute confidence from HPO term overlap — deferred
- [ ] **CONF-03**: Logistic burden weighted regression — deferred
- [ ] **CONF-04**: Linear burden WLS — deferred
- [ ] **CONF-05**: Fisher ignores sample weights — deferred
- [ ] **CONF-06**: Effective sample size in diagnostics — deferred
- [ ] **CONF-07**: --case-confidence equal default — deferred

### Region Restriction (#84)

- [x] **REGION-01**: User can restrict variant extraction to a BED file via `--regions-bed <bed_file>`
- [x] **REGION-02**: The gene BED is intersected with the restriction BED via `bedtools intersect` before `bcftools view -R`
- [x] **REGION-03**: Chromosome naming mismatches between BED files are detected and reported as an error
- [x] **REGION-04**: The intersection happens once before chunk splitting (all chunks respect the restriction)

### PCA Pipeline Integration (TD-01)

- [x] **PCA-01**: `PCAComputationStage` is wired into `pipeline.py` and executes when `--pca` is set
- [x] **PCA-02**: PCA eigenvectors computed by the stage are available to `AssociationAnalysisStage` via `context.stage_results`
- [x] **PCA-03**: `--pca akt` runs AKT via subprocess and produces eigenvec output

### Performance Optimization — DEFERRED

- [ ] **PERF-01**: Sparse genotype matrices — deferred (streaming solves OOM; centering destroys sparsity)
- [ ] **PERF-02**: SKAT sparse input — deferred
- [ ] **PERF-03**: SKAT-O eigendecomposition — deferred

### Dead Code Cleanup (#88)

- [x] **CLEAN-01**: 8 dead stage classes removed from processing_stages.py, analysis_stages.py, output_stages.py
- [x] **CLEAN-02**: Corresponding `register_stage()` calls removed from stage_registry.py
- [x] **CLEAN-03**: Corresponding imports and `__all__` entries removed from stages/__init__.py
- [x] **CLEAN-04**: `"refactored_pipeline"` default strings replaced with `"pipeline"` in pipeline.py and runner.py
- [x] **CLEAN-05**: "Old pipeline" comments (~15 occurrences) reworded or removed
- [x] **CLEAN-06**: "Refactored" docstrings updated in error_handling.py and analyze_variants.py

### Tech Debt

- [x] **TD-02**: `create_stages_from_config()` maps `perform_association` and `perform_gene_burden` keys from config dict
- [x] **TD-03**: COAST R golden values generated and hardcoded in test file for Python-vs-R comparison
- [x] **TD-04**: SKAT-O output uses `skat_o_pvalue` column name when `skat_method=SKATO`
- [x] **TD-05**: Fisher lambda_GC criterion clarified (excluded from Fisher, applied to score-based tests)
- [x] **TD-06**: Internal `"refactored_pipeline"` checkpoint strings replaced (covered by CLEAN-04)

---

## Traceability

| Requirement | Phase | Status |
|-------------|-------|--------|
| COAST-01 | Phase 31 | Complete |
| COAST-02 | Phase 31 | Complete |
| COAST-03 | Phase 31 | Complete |
| COAST-04 | Phase 31 | Complete |
| COAST-05 | Phase 31 | Complete |
| COAST-06 | Phase 31 | Complete |
| COAST-07 | Phase 31 | Complete |
| FDR-01 | Phase 33 | Complete |
| FDR-02 | Phase 33 | Complete |
| FDR-03 | Phase 33 | Complete |
| FDR-04 | Phase 33 | Excluded (IHW deferred) |
| FDR-05 | Phase 33 | Complete |
| FDR-06 | Phase 33 | Complete |
| CONF-01-07 | Phase 35 | Deferred |
| REGION-01 | Phase 32 | Complete |
| REGION-02 | Phase 32 | Complete |
| REGION-03 | Phase 32 | Complete |
| REGION-04 | Phase 32 | Complete |
| PCA-01 | Phase 32 | Complete |
| PCA-02 | Phase 32 | Complete |
| PCA-03 | Phase 32 | Complete |
| PERF-01-03 | Phase 36 | Deferred |
| CLEAN-01 | Phase 30 | Complete |
| CLEAN-02 | Phase 30 | Complete |
| CLEAN-03 | Phase 30 | Complete |
| CLEAN-04 | Phase 30 | Complete |
| CLEAN-05 | Phase 30 | Complete |
| CLEAN-06 | Phase 30 | Complete |
| TD-02 | Phase 34 | Complete |
| TD-03 | Phase 34 | Complete |
| TD-04 | Phase 34 | Complete |
| TD-05 | Phase 34 | Complete |
| TD-06 | Phase 30 | Complete |

## Milestone Summary

**Shipped:** 30 of 41 v1 requirements
**Excluded:** 1 (FDR-04 IHW — no Python implementation)
**Deferred:** 10 (CONF-01-07 to future milestone, PERF-01-03 to future milestone)
**Adjusted:** COAST-03 threshold changed from "any missing" to "all missing" (matches R reference)

---
*Archived: 2026-02-26 as part of v0.16.0 milestone completion*
