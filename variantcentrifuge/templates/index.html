<!-- File: variantcentrifuge/templates/index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VariantCentrifuge Report</title>

    <!-- Inlined CSS Assets -->
    <style>{{ assets['css/datatables.min'] }}</style>
    <style>{{ assets['css/buttons.dataTables.min'] }}</style>
    <style>{{ assets['css/tippy'] }}</style>

    <style>
    /* Base Styles */
    body {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        line-height: 1.6;
        color: #333;
        margin: 0;
        padding: 0;
        background-color: #f4f7f9;
    }
    .container {
        max-width: 95%;
        margin: 0 auto;
        padding: 20px;
    }
    header {
        background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
        color: white;
        padding: 2rem 1.5rem;
        margin-bottom: 2rem;
        border-radius: 8px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    header h1 {
        margin: 0 0 0.5rem 0;
        font-size: 28px;
        font-weight: 600;
    }
    header p {
        margin: 0.25rem 0;
        opacity: 0.9;
        font-size: 14px;
    }
    .summary-section, .chart-section, .table-section {
        background-color: white;
        border-radius: 8px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        padding: 20px;
        margin-bottom: 20px;
    }
    .summary-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        grid-gap: 20px;
        margin-bottom: 20px;
    }
    .stats-card {
        background-color: #fff;
        border-radius: 8px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        padding: 20px;
        text-align: center;
        border-left: 5px solid #007bff;
    }
    .stats-card h3 {
        margin-top: 0;
        color: #6c757d;
        font-size: 1rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    .stats-card p {
        margin: 0;
        font-size: 2.25rem;
        font-weight: 700;
        color: #343a40;
    }
    footer {
        text-align: center;
        margin-top: 30px;
        padding: 20px;
        font-size: 12px;
        color: #777;
    }

    /* Chart Container */
    .chart-container {
        position: relative;
        height: 300px;
        width: 100%;
    }

    /* Table Styles */
    #variants_table {
        font-size: 13px;
        width: 100% !important;
    }
    #variants_table th {
        white-space: normal !important;
        word-wrap: break-word;
        text-align: left;
        vertical-align: middle;
        line-height: 1.3;
    }
    #variants_table.compact th,
    #variants_table.compact td {
        padding: 4px 6px;
    }
    #variants_table td {
        text-align: left;
        vertical-align: top;
        line-height: 1.3;
    }

    /* Link Styles */
    .link-icon {
        text-decoration: none;
        margin-right: 3px;
        color: #007bff;
        font-size: 0.9em;
    }
    .igv-individual-link {
        margin-right: 5px;
        text-decoration: underline;
        color: #0066cc;
        display: inline-block;
        white-space: nowrap;
    }
    .igv-individual-link .link-icon {
        color: #5cb85c;
    }

    /* Loading Skeleton */
    .skeleton-wrapper {
        background-color: white;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
    }
    .skeleton-row {
        display: flex;
        gap: 10px;
        margin-bottom: 12px;
        animation: shimmer 1.5s infinite;
    }
    .skeleton-cell {
        height: 24px;
        background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
        background-size: 200% 100%;
        border-radius: 4px;
        flex: 1;
    }
    .skeleton-cell:nth-child(1) { flex: 0.8; }
    .skeleton-cell:nth-child(2) { flex: 1.2; }
    .skeleton-cell:nth-child(3) { flex: 1; }
    @keyframes shimmer {
        0% { background-position: 200% 0; }
        100% { background-position: -200% 0; }
    }

    /* Alert Styles */
    .alert {
        padding: 15px;
        border: 1px solid transparent;
        border-radius: 4px;
        margin-bottom: 20px;
    }
    .alert-info {
        color: #31708f;
        background-color: #d9edf7;
        border-color: #bce8f1;
    }

    /* Tippy.js Tooltip Customization */
    .tippy-box[data-theme~='variantcentrifuge'] {
        background-color: #333;
        color: #fff;
        max-width: 400px;
        font-size: 13px;
    }
    .tippy-box[data-theme~='variantcentrifuge'][data-placement^='top'] > .tippy-arrow::before {
        border-top-color: #333;
    }
    .tippy-box[data-theme~='variantcentrifuge'][data-placement^='bottom'] > .tippy-arrow::before {
        border-bottom-color: #333;
    }
    .tippy-box[data-theme~='variantcentrifuge'][data-placement^='left'] > .tippy-arrow::before {
        border-left-color: #333;
    }
    .tippy-box[data-theme~='variantcentrifuge'][data-placement^='right'] > .tippy-arrow::before {
        border-right-color: #333;
    }

    /* Truncated Cell Styles */
    .truncated-cell {
        max-width: 150px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        display: inline-block;
        vertical-align: bottom;
    }
    </style>
</head>
<body>
<div class="container">
    <header>
        <h1>VariantCentrifuge Report</h1>
        <p>Generated on {{ generation_date }}</p>
        <p>VariantCentrifuge v{{ version }}</p>
    </header>

    <div class="table-section">
        <h2>Variants Table</h2>

        <!-- Loading Skeleton -->
        <div id="table-skeleton" class="skeleton-wrapper" style="display: none;">
            {% for i in range(7) %}
            <div class="skeleton-row">
                <div class="skeleton-cell"></div>
                <div class="skeleton-cell"></div>
                <div class="skeleton-cell"></div>
                <div class="skeleton-cell"></div>
                <div class="skeleton-cell"></div>
            </div>
            {% endfor %}
        </div>

        {% if variants and variants|length > 0 %}
        <table id="variants_table" class="display compact" style="display: none;">
            <thead>
                <tr>
                    {% for col_info in column_data %}
                        <th>{{ col_info.display_name }}</th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% for v_row in variants %}
                <tr>
                    {% for col_info in column_data %}
                        <td>
                            {% if col_info.is_igv_link_column %}
                                {# Handle structured igv_links data which is a list of dicts #}
                                {% if v_row[col_info.original_name] and v_row[col_info.original_name]|length > 0 %}
                                    {% for igv_link_detail in v_row[col_info.original_name] %}
                                        <a href="{{ igv_link_detail.report_path }}" target="_blank" class="igv-individual-link" title="IGV report for {{ igv_link_detail.sample_id }}">
                                            <span class="link-icon">ðŸ”—</span>{{ igv_link_detail.sample_id }}
                                        </a>{% if not loop.last %} {% endif %}
                                    {% endfor %}
                                {% else %}
                                    N/A
                                {% endif %}
                            {% elif col_info.is_standard_link_column and v_row[col_info.original_name] and v_row[col_info.original_name] | string | trim != "" %}
                                <a href="{{ v_row[col_info.original_name] }}" target="_blank" title="{{ v_row[col_info.original_name] }}">
                                    <span class="link-icon">ðŸ”—</span>{{ col_info.link_display_text }}
                                </a>
                            {% elif col_info.apply_hover_expand and col_info.max_width_px %}
                                <span class="truncated-cell" style="max-width: {{ col_info.max_width_px }}px;" data-tippy-content="{{ v_row[col_info.original_name] }}">{{ v_row[col_info.original_name] }}</span>
                            {% else %}
                                {{ v_row[col_info.original_name] }}
                            {% endif %}
                        </td>
                    {% endfor %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div class="alert alert-info">
            <p><strong>No variants found matching the filtering criteria.</strong></p>
            <p>The filtering process completed successfully but no variants remained after applying all filters. This may be due to:</p>
            <ul>
                <li>Strict filtering criteria</li>
                <li>Specific gene selection with no matching variants</li>
                <li>Sample-specific filters excluding all variants</li>
            </ul>
            <p>You may want to try adjusting your filtering parameters or check your input data.</p>
        </div>
        {% endif %}
    </div>

    <div class="summary-section">
        <h2>Summary</h2>
        <div class="summary-grid">
            <div class="stats-card">
                <h3>Total Variants</h3>
                <p>{{ summary.num_variants }}</p>
            </div>
            <div class="stats-card">
                <h3>Unique Genes</h3>
                <p>{{ summary.num_genes }}</p>
            </div>
        </div>
    </div>

    <div class="chart-section">
        <h2>Impact Distribution</h2>
        <div class="chart-container">
            <canvas id="impact_chart"></canvas>
        </div>
    </div>

    <footer>
        <p>Created with VariantCentrifuge</p>
    </footer>
</div>

<!-- Inlined JavaScript Assets -->
<script>{{ assets['js/jquery.slim.min'] }}</script>
<script>{{ assets['js/datatables.min'] }}</script>
<script>{{ assets['js/datatables.buttons.min'] }}</script>
<script>{{ assets['js/buttons.colVis.min'] }}</script>
<script>{{ assets['js/chart.umd.min'] }}</script>
<script>{{ assets['js/chartjs-plugin-datalabels.min'] }}</script>
<script>{{ assets['js/tippy-bundle.umd.min'] }}</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Early exit if no variants table
    if (!document.getElementById('variants_table')) {
        return;
    }

    // Show loading skeleton
    var skeleton = document.getElementById('table-skeleton');
    if (skeleton) {
        skeleton.style.display = 'block';
    }

    // Get column configuration from Jinja2
    var allColumnOriginalNames = {{ column_data | map(attribute='original_name') | list | tojson }};
    var defaultHiddenColumnOriginalNames = {{ default_hidden_columns | tojson }};
    var columnData = {{ column_data | tojson }};
    var hiddenColumnIndices = [];
    var dtColumnDefs = [];

    // Find indices of columns to hide by default
    defaultHiddenColumnOriginalNames.forEach(function(hiddenColName) {
        var index = allColumnOriginalNames.indexOf(hiddenColName);
        if (index !== -1) {
            hiddenColumnIndices.push(index);
        }
    });

    // Setup default hidden columns
    if (hiddenColumnIndices.length > 0) {
        dtColumnDefs.push({
            targets: hiddenColumnIndices,
            visible: false
        });
    }

    // Initialize DataTables v2
    var table = new DataTable('#variants_table', {
        autoWidth: false,
        pageLength: 25,
        scrollX: true,
        layout: {
            topStart: {
                pageLength: {
                    menu: [10, 25, 50, 100, -1]
                }
            },
            topEnd: {
                buttons: [
                    {
                        extend: 'colvis',
                        text: 'Show/Hide Columns'
                    }
                ]
            }
        },
        columnDefs: dtColumnDefs,
        initComplete: function() {
            // Hide skeleton and show table
            if (skeleton) {
                skeleton.style.display = 'none';
            }
            document.getElementById('variants_table').style.display = 'table';
        },
        drawCallback: function(settings) {
            // Force column width adjustment
            this.api().columns.adjust();

            // Initialize Tippy tooltips for truncated cells
            initTippyTooltips();
        }
    });

    // Initialize Tippy.js tooltips
    function initTippyTooltips() {
        var truncatedCells = document.querySelectorAll('.truncated-cell[data-tippy-content]');
        truncatedCells.forEach(function(cell) {
            // Only attach tippy if content is actually truncated
            if (cell.offsetWidth < cell.scrollWidth || cell.offsetHeight < cell.scrollHeight) {
                if (!cell._tippy) {
                    tippy(cell, {
                        theme: 'variantcentrifuge',
                        placement: 'top',
                        allowHTML: false,
                        maxWidth: 400,
                        interactive: false
                    });
                }
            } else {
                // Remove tippy if content is not truncated
                if (cell._tippy) {
                    cell._tippy.destroy();
                }
            }
        });
    }

    // Initialize Chart.js horizontal bar chart
    var impactDistribution = {{ summary.impact_distribution | tojson }};
    var impactCategories = Object.keys(impactDistribution);
    var impactCounts = Object.values(impactDistribution);

    // Define semantic colors for impact levels
    var colorMap = {
        'HIGH': '#dc3545',      // Red
        'MODERATE': '#fd7e14',  // Orange
        'LOW': '#ffc107',       // Amber
        'MODIFIER': '#6c757d'   // Gray
    };

    // Map colors to categories
    var backgroundColors = impactCategories.map(function(category) {
        return colorMap[category] || '#007bff'; // Default blue if unknown category
    });

    var ctx = document.getElementById('impact_chart').getContext('2d');
    var impactChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: impactCategories,
            datasets: [{
                label: 'Number of Variants',
                data: impactCounts,
                backgroundColor: backgroundColors,
                borderWidth: 0
            }]
        },
        options: {
            indexAxis: 'y', // Horizontal bar chart
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                title: {
                    display: false
                },
                datalabels: {
                    anchor: 'end',
                    align: 'end',
                    color: '#333',
                    font: {
                        weight: 'bold',
                        size: 12
                    },
                    formatter: function(value) {
                        return value;
                    }
                }
            },
            scales: {
                x: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Number of Variants'
                    },
                    ticks: {
                        precision: 0
                    }
                },
                y: {
                    title: {
                        display: true,
                        text: 'Impact Level'
                    }
                }
            }
        },
        plugins: [ChartDataLabels]
    });
});
</script>

</body>
</html>
