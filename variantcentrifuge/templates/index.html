<!-- File: variantcentrifuge/templates/index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VariantCentrifuge Report</title>

    <!-- Inlined CSS Assets -->
    <style>{{ assets['css/datatables.min'] }}</style>
    <style>{{ assets['css/buttons.dataTables.min'] }}</style>
    <style>{{ assets['css/fixedcolumns.dataTables.min'] }}</style>
    <style>{{ assets['css/tippy'] }}</style>

    <style>
    /* Base Styles */
    body {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        line-height: 1.6;
        color: #333;
        margin: 0;
        padding: 0;
        background-color: #f4f7f9;
    }
    .container {
        max-width: 95%;
        margin: 0 auto;
        padding: 20px;
    }
    header {
        background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
        color: white;
        padding: 2rem 1.5rem;
        margin-bottom: 2rem;
        border-radius: 8px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    header h1 {
        margin: 0 0 0.5rem 0;
        font-size: 28px;
        font-weight: 600;
    }
    header p {
        margin: 0.25rem 0;
        opacity: 0.9;
        font-size: 14px;
    }
    .table-section {
        background-color: white;
        border-radius: 8px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        padding: 20px;
        margin-bottom: 20px;
    }
    footer {
        text-align: center;
        margin-top: 30px;
        padding: 20px;
        font-size: 12px;
        color: #777;
    }

    /* Chart Container */
    .chart-container {
        position: relative;
        height: 300px;
        width: 100%;
    }
    .chart-container-sm {
        position: relative;
        height: 220px;
        width: 100%;
    }

    /* Dashboard Styles */
    .dashboard { margin-bottom: 24px; }
    .cards-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 12px;
        margin-bottom: 16px;
    }
    .charts-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
    }

    /* Metric Card Styles */
    .metric-card {
        background: white;
        border-radius: 8px;
        padding: 14px 16px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.06);
    }
    .metric-card h3 {
        margin: 0 0 4px 0;
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: #6c757d;
        font-weight: 600;
    }
    .metric-card .metric-value {
        margin: 0;
        font-size: 1.75rem;
        font-weight: 700;
        line-height: 1.2;
    }
    .metric-card .gene-list {
        list-style: none;
        padding: 0;
        margin: 0;
        font-size: 13px;
        line-height: 1.5;
    }
    .metric-card .gene-list li {
        display: flex;
        justify-content: space-between;
    }

    /* Impact Breakdown Styles */
    .impact-breakdown { list-style: none; padding: 0; margin: 0; font-size: 13px; }
    .impact-breakdown li { display: flex; justify-content: space-between; align-items: center; padding: 2px 0; }
    .impact-dot { display: inline-block; width: 10px; height: 10px; border-radius: 50%; margin-right: 6px; }

    /* Chart Wrapper Styles */
    .chart-wrapper {
        background: white;
        border-radius: 8px;
        padding: 14px 16px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.06);
    }
    .chart-wrapper h3 {
        margin: 0 0 8px 0;
        font-size: 14px;
        font-weight: 600;
        color: #333;
    }

    /* Table Styles â€” apply to both body table and DataTables scroll header clone */
    #variants_table,
    .dt-scroll-head table,
    .dataTables_scrollHead table {
        font-size: 13px;
        width: 100% !important;
    }

    /* TABLE-05: Dark header with white text and accent bottom border */
    #variants_table thead th,
    .dt-scroll-head thead th,
    .dataTables_scrollHead thead th {
        background: linear-gradient(180deg, #2c3e50 0%, #1a252f 100%);
        color: white;
        border-bottom: 3px solid #007bff;
        white-space: nowrap !important;
        text-align: left !important;
        vertical-align: middle;
        line-height: 1.3;
        padding: 10px 22px 10px 8px !important;
        font-weight: 600;
    }

    /* Override DataTables numeric right-alignment */
    .dt-type-numeric {
        text-align: left !important;
    }

    /* Hide the duplicate thead inside the scroll body (DataTables clones it to scroll-head) */
    .dt-scroll-body thead,
    .dataTables_scrollBody thead {
        display: none;
    }

    /* TABLE-04: Zebra striping */
    #variants_table tbody tr:nth-child(odd) {
        background-color: #f8f9fa;
    }
    #variants_table tbody tr:nth-child(even) {
        background-color: white;
    }
    #variants_table tbody tr:hover {
        background-color: #e3f2fd;
    }
    /* Child row should not get zebra color */
    #variants_table tbody tr.dt-hasChild + tr > td {
        background-color: transparent !important;
    }

    #variants_table td {
        text-align: left;
        vertical-align: top;
        line-height: 1.3;
        padding: 4px 6px;
    }

    /* TABLE-07: Content density modes */
    #variants_table.density-compact td { padding: 4px 6px; line-height: 1.3; }
    #variants_table.density-compact th { padding: 8px 22px 8px 6px !important; }
    #variants_table.density-regular td { padding: 8px 10px; line-height: 1.5; }
    #variants_table.density-regular th { padding: 10px 22px 10px 10px !important; }
    #variants_table.density-relaxed td { padding: 12px 14px; line-height: 1.7; }
    #variants_table.density-relaxed th { padding: 12px 22px 12px 14px !important; }

    /* TABLE-06/08: Column type classes */
    .monospace {
        font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
    }
    .dt-right {
        text-align: right !important;
    }
    .middle-truncate {
        display: inline-block;
        max-width: 120px;
    }

    /* TABLE-02: FixedColumns shadow separator */
    .dtfc-fixed-left {
        box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
        z-index: 2;
    }

    /* TABLE-03: Chevron control column */
    td.dt-control {
        cursor: pointer;
        text-align: center !important;
        width: 30px;
        user-select: none;
    }
    td.dt-control .chevron {
        display: inline-block;
        font-size: 18px;
        font-weight: bold;
        color: #007bff;
        transition: transform 200ms ease-in-out;
    }
    tr.shown td.dt-control .chevron {
        transform: rotate(90deg);
    }

    /* TABLE-03: Detail panel grid layout */
    .detail-panel {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 16px;
        padding: 16px;
        background-color: #f8f9fa;
        border-left: 3px solid #007bff;
        animation: slideDown 200ms ease-out;
    }
    @keyframes slideDown {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    .detail-section {
        background: white;
        padding: 12px 14px;
        border-radius: 6px;
        border: 1px solid #dee2e6;
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }
    .detail-section h4 {
        margin: 0 0 10px 0;
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: #6c757d;
        font-weight: 700;
    }
    .detail-section dl {
        display: grid;
        grid-template-columns: auto 1fr;
        gap: 6px 12px;
        margin: 0;
        font-size: 13px;
    }
    .detail-section dt {
        font-weight: 600;
        color: #495057;
    }
    .detail-section dd {
        margin: 0;
        word-break: break-word;
        color: #212529;
    }
    .detail-section a {
        color: #007bff;
        text-decoration: none;
    }
    .detail-section a:hover {
        text-decoration: underline;
    }

    /* TABLE-09: Prominent record count */
    .dt-info,
    .dataTables_info {
        font-size: 14px;
        font-weight: 600;
        color: #212529;
        padding: 8px 0;
    }

    /* Link Styles */
    .link-icon-svg {
        display: inline-block;
        vertical-align: middle;
        margin-right: 3px;
        fill: currentColor;
    }
    .igv-individual-link {
        margin-right: 5px;
        text-decoration: underline;
        color: #0066cc;
        display: inline-block;
        white-space: nowrap;
    }
    .igv-individual-link .link-icon-svg {
        fill: #5cb85c;
    }

    /* Loading Skeleton */
    .skeleton-wrapper {
        background-color: white;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
    }
    .skeleton-row {
        display: flex;
        gap: 10px;
        margin-bottom: 12px;
        animation: shimmer 1.5s infinite;
    }
    .skeleton-cell {
        height: 24px;
        background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
        background-size: 200% 100%;
        border-radius: 4px;
        flex: 1;
    }
    .skeleton-cell:nth-child(1) { flex: 0.8; }
    .skeleton-cell:nth-child(2) { flex: 1.2; }
    .skeleton-cell:nth-child(3) { flex: 1; }
    @keyframes shimmer {
        0% { background-position: 200% 0; }
        100% { background-position: -200% 0; }
    }

    /* Alert Styles */
    .alert {
        padding: 15px;
        border: 1px solid transparent;
        border-radius: 4px;
        margin-bottom: 20px;
    }
    .alert-info {
        color: #31708f;
        background-color: #d9edf7;
        border-color: #bce8f1;
    }

    /* Tippy.js Tooltip Customization */
    .tippy-box[data-theme~='variantcentrifuge'] {
        background-color: #333;
        color: #fff;
        max-width: 300px;
        font-size: 13px;
        line-height: 1.5;
        word-break: break-word;
    }
    .tippy-box[data-theme~='variantcentrifuge'][data-placement^='top'] > .tippy-arrow::before {
        border-top-color: #333;
    }
    .tippy-box[data-theme~='variantcentrifuge'][data-placement^='bottom'] > .tippy-arrow::before {
        border-bottom-color: #333;
    }
    .tippy-box[data-theme~='variantcentrifuge'][data-placement^='left'] > .tippy-arrow::before {
        border-left-color: #333;
    }
    .tippy-box[data-theme~='variantcentrifuge'][data-placement^='right'] > .tippy-arrow::before {
        border-right-color: #333;
    }

    /* Truncated Cell Styles */
    .truncated-cell {
        max-width: 180px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        display: inline-block;
        vertical-align: bottom;
    }

    /* Accessibility: Screen Reader Only */
    .sr-only {
        position: absolute;
        left: -10000px;
        width: 1px;
        height: 1px;
        overflow: hidden;
    }

    /* Accessibility: Skip Link */
    .skip-link {
        position: absolute;
        left: -10000px;
        top: auto;
        width: 1px;
        height: 1px;
        overflow: hidden;
    }
    .skip-link:focus {
        position: fixed;
        top: 10px;
        left: 10px;
        z-index: 9999;
        padding: 12px 20px;
        background-color: #007bff;
        color: white;
        text-decoration: none;
        border-radius: 4px;
        box-shadow: 0 0 10px rgba(0,0,0,0.3);
        width: auto;
        height: auto;
        overflow: visible;
    }

    /* Pill Badge Base */
    .badge {
        display: inline-block;
        padding: 3px 10px;
        font-size: 11px;
        font-weight: 600;
        line-height: 1.2;
        text-align: center;
        white-space: nowrap;
        border-radius: 12px;
        color: white;
        vertical-align: middle;
    }

    /* Metadata Footer */
    .metadata-footer {
        background-color: #f8f9fa;
        border-top: 1px solid #dee2e6;
        padding: 12px 20px;
        margin-top: 30px;
        font-size: 11px;
        color: #6c757d;
    }
    .metadata-content {
        display: flex;
        flex-wrap: wrap;
        gap: 16px;
        max-width: 95%;
        margin: 0 auto;
        align-items: baseline;
    }
    .metadata-item { display: inline-block; }
    .metadata-item strong { color: #495057; }
    .filter-expr {
        background-color: #e9ecef;
        padding: 2px 6px;
        border-radius: 3px;
        font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
        font-size: 10px;
        max-width: 500px;
        display: inline-block;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        vertical-align: middle;
    }
    </style>
</head>
<body>
<a href="#main-content" class="skip-link">Skip to main content</a>

<!-- SVG Icon Sprite (A11Y-05) -->
<svg style="display: none;" aria-hidden="true">
    <defs>
        <symbol id="icon-external-link" viewBox="0 0 16 16">
            <path d="M14 2H10V4H12.59L6.29 10.29L7.71 11.71L14 5.41V8H16V2H14Z"/>
            <path d="M14 14H2V2H8V0H2C0.9 0 0 0.9 0 2V14C0 15.1 0.9 16 2 16H14C15.1 16 16 15.1 16 14V8H14V14Z"/>
        </symbol>
    </defs>
</svg>

<div class="container">
    <header>
        <h1>VariantCentrifuge Report</h1>
        <p>Generated on {{ generation_date }}</p>
        <p>VariantCentrifuge v{{ version }}</p>
    </header>

    <main id="main-content" tabindex="-1">
    <!-- Dashboard Section -->
    <div class="dashboard">
        <!-- Cards Row -->
        <div class="cards-grid">
            <div class="metric-card">
                <h3>Total Variants</h3>
                <p class="metric-value" style="color: #007bff;">{{ summary.num_variants }}</p>
            </div>
            <div class="metric-card">
                <h3>Unique Genes</h3>
                <p class="metric-value" style="color: #17a2b8;">{{ summary.num_genes }}</p>
            </div>
            <div class="metric-card">
                <h3>Samples</h3>
                <p class="metric-value" style="color: #28a745;">{{ summary.num_samples | default(0) }}</p>
            </div>
            <div class="metric-card">
                <h3>Impact Breakdown</h3>
                <ul class="impact-breakdown">
                    {% for level in ['HIGH', 'MODERATE', 'LOW', 'MODIFIER'] %}
                    <li>
                        <span><span class="impact-dot" style="background-color: {{ {'HIGH':'#dc3545','MODERATE':'#c05000','LOW':'#b45309','MODIFIER':'#6c757d'}[level] }};"></span>{{ level }}</span>
                        <strong>{{ summary.impact_distribution.get(level, 0) if summary.impact_distribution is mapping else 0 }}</strong>
                    </li>
                    {% endfor %}
                </ul>
            </div>
            <div class="metric-card">
                <h3>Top Genes</h3>
                {% if summary.top_genes is defined and summary.top_genes|length > 0 %}
                <ul class="gene-list">
                    {% for gene_info in summary.top_genes[:5] %}
                    <li><span>{{ gene_info.gene }}</span><strong>{{ gene_info.count }}</strong></li>
                    {% endfor %}
                </ul>
                {% else %}
                <p style="color: #6c757d; font-size: 13px; margin: 0;">No gene data available</p>
                {% endif %}
            </div>
        </div>

        <!-- Charts Row -->
        <div class="charts-grid">
            <div class="chart-wrapper">
                <h3>Impact Distribution</h3>
                <div class="chart-container-sm">
                    <canvas id="impact_chart"></canvas>
                </div>
            </div>
            <div class="chart-wrapper">
                <h3>Inheritance Patterns</h3>
                <div class="chart-container-sm" id="inheritance_chart_container">
                    {% if summary.inheritance_distribution is defined and summary.inheritance_distribution|length > 0 %}
                    <canvas id="inheritance_chart"></canvas>
                    {% else %}
                    <p style="color: #6c757d; font-style: italic; text-align: center; padding-top: 80px;">Inheritance analysis not available (no pedigree provided)</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <div class="table-section">
        <h2>Variants Table</h2>

        <!-- Loading Skeleton -->
        <div id="table-skeleton" class="skeleton-wrapper">
            {% for i in range(7) %}
            <div class="skeleton-row">
                <div class="skeleton-cell"></div>
                <div class="skeleton-cell"></div>
                <div class="skeleton-cell"></div>
                <div class="skeleton-cell"></div>
                <div class="skeleton-cell"></div>
            </div>
            {% endfor %}
        </div>

        {% if variants and variants|length > 0 %}
        <table id="variants_table" class="display compact">
            <thead>
                <tr>
                    <th></th>
                    {% for col_info in column_data %}
                        <th>{{ col_info.display_name }}</th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% for v_row in variants %}
                <tr>
                    <td></td>
                    {% for col_info in column_data %}
                        <td>
                            {% if col_info.is_igv_link_column %}
                                {# Handle structured igv_links data which is a list of dicts #}
                                {% if v_row[col_info.original_name] and v_row[col_info.original_name]|length > 0 %}
                                    {% for igv_link_detail in v_row[col_info.original_name] %}
                                        <a href="{{ igv_link_detail.report_path }}" target="_blank" class="igv-individual-link" title="IGV report for {{ igv_link_detail.sample_id }}">
                                            <svg aria-hidden="true" focusable="false" class="link-icon-svg" width="14" height="14"><use href="#icon-external-link"/></svg>
                                            <span class="sr-only">IGV report for {{ igv_link_detail.sample_id }} (opens in new tab)</span>
                                            {{ igv_link_detail.sample_id }}
                                        </a>{% if not loop.last %} {% endif %}
                                    {% endfor %}
                                {% else %}
                                    N/A
                                {% endif %}
                            {% elif col_info.is_standard_link_column and v_row[col_info.original_name] and v_row[col_info.original_name] | string | trim != "" %}
                                <a href="{{ v_row[col_info.original_name] }}" target="_blank" title="{{ v_row[col_info.original_name] }}">
                                    <svg aria-hidden="true" focusable="false" class="link-icon-svg" width="14" height="14"><use href="#icon-external-link"/></svg>
                                    <span class="sr-only">{{ col_info.link_display_text }} (opens in new tab)</span>
                                    {{ col_info.link_display_text }}
                                </a>
                            {% elif col_info.apply_hover_expand and col_info.max_width_px %}
                                <span class="truncated-cell" tabindex="0" style="max-width: {{ col_info.max_width_px }}px;" data-tippy-content="{{ v_row[col_info.original_name] }}">{{ v_row[col_info.original_name] }}</span>
                            {% else %}
                                {{ v_row[col_info.original_name] }}
                            {% endif %}
                        </td>
                    {% endfor %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div class="alert alert-info">
            <p><strong>No variants found matching the filtering criteria.</strong></p>
            <p>The filtering process completed successfully but no variants remained after applying all filters. This may be due to:</p>
            <ul>
                <li>Strict filtering criteria</li>
                <li>Specific gene selection with no matching variants</li>
                <li>Sample-specific filters excluding all variants</li>
            </ul>
            <p>You may want to try adjusting your filtering parameters or check your input data.</p>
        </div>
        {% endif %}
    </div>
    </main>

    <footer class="metadata-footer">
        <div class="metadata-content">
            <div class="metadata-item">
                <strong>Filter:</strong>
                <code class="filter-expr" title="{{ filter_expression | default('None', true) }}">{{ filter_expression | default('None', true) }}</code>
            </div>
            <div class="metadata-item">
                <strong>VCF:</strong> {{ vcf_source | default('Unknown', true) }}
            </div>
            <div class="metadata-item">
                <strong>Reference:</strong> {{ reference_genome | default('Unknown', true) }}
            </div>
            <div class="metadata-item">
                <strong>Pipeline:</strong> VariantCentrifuge v{{ version }}
            </div>
            <div class="metadata-item">
                <strong>Generated:</strong> {{ generation_date }}
            </div>
        </div>
    </footer>
</div>

<!-- Inlined JavaScript Assets -->
<script>{{ assets['js/jquery.slim.min'] }}</script>
<script>{{ assets['js/datatables.min'] }}</script>
<script>{{ assets['js/fixedcolumns.min'] }}</script>
<script>{{ assets['js/datatables.buttons.min'] }}</script>
<script>{{ assets['js/buttons.colVis.min'] }}</script>
<script>{{ assets['js/chart.umd.min'] }}</script>
<script>{{ assets['js/chartjs-plugin-datalabels.min'] }}</script>
<script>{{ assets['js/popper.min'] }}</script>
<script>{{ assets['js/tippy-bundle.umd.min'] }}</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Early exit if no variants table
    if (!document.getElementById('variants_table')) {
        return;
    }

    var skeleton = document.getElementById('table-skeleton');

    // Get column configuration from Jinja2
    var allColumnOriginalNames = {{ column_data | map(attribute='original_name') | list | tojson }};
    var defaultHiddenColumnOriginalNames = {{ default_hidden_columns | tojson }};
    var columnData = {{ column_data | tojson }};
    var hiddenColumnIndices = [];
    var dtColumnDefs = [];

    // Find indices of columns to hide by default
    defaultHiddenColumnOriginalNames.forEach(function(hiddenColName) {
        var index = allColumnOriginalNames.indexOf(hiddenColName);
        if (index !== -1) {
            hiddenColumnIndices.push(index);
        }
    });

    // TABLE-03: Add control column (chevron) as first column
    // This shifts ALL data column indices by +1
    dtColumnDefs.unshift({
        targets: 0,
        className: 'dt-control',
        orderable: false,
        searchable: false,
        data: null,
        defaultContent: '<span class="chevron">&#x203A;</span>',
        width: '30px'
    });

    // Setup default hidden columns (shift indices by +1 for control column)
    if (hiddenColumnIndices.length > 0) {
        dtColumnDefs.push({
            targets: hiddenColumnIndices.map(function(i) { return i + 1; }),
            visible: false
        });
    }

    // Badge render functions for semantic color coding
    columnData.forEach(function(col, index) {
        // IMPACT column badge rendering
        if (col.original_name === 'IMPACT') {
            dtColumnDefs.push({
                targets: index + 1,
                render: function(data, type, row) {
                    if (type === 'display' && data) {
                        var colors = {
                            'HIGH': '#dc3545',
                            'MODERATE': '#c05000',
                            'LOW': '#b45309',
                            'MODIFIER': '#6c757d'
                        };
                        var color = colors[data] || '#6c757d';
                        return '<span class="badge" style="background-color:' + color + ';">' + data + '</span>';
                    }
                    return data;
                }
            });
        }

        // ClinVar classification badge rendering
        if (col.original_name === 'dbNSFP_clinvar_clnsig' || col.original_name === 'ClinVar_CLNSIG') {
            dtColumnDefs.push({
                targets: index + 1,
                render: function(data, type, row) {
                    if (type === 'display' && data && String(data).trim() !== '') {
                        var str = String(data);
                        var lower = str.toLowerCase();
                        var color = '#6c757d';
                        if (lower.indexOf('pathogenic') !== -1 && lower.indexOf('likely') === -1 && lower.indexOf('conflicting') === -1) {
                            color = '#dc3545';
                        } else if (lower.indexOf('likely_pathogenic') !== -1 || lower.indexOf('likely pathogenic') !== -1) {
                            color = '#c0392b';
                        } else if (lower.indexOf('uncertain') !== -1 || lower === 'vus') {
                            color = '#b45309';
                        } else if (lower.indexOf('likely_benign') !== -1 || lower.indexOf('likely benign') !== -1) {
                            color = '#558b2f';
                        } else if (lower.indexOf('benign') !== -1 && lower.indexOf('likely') === -1) {
                            color = '#2e7d32';
                        } else if (lower.indexOf('conflicting') !== -1) {
                            color = '#bf5600';
                        }
                        var displayText = str.replace(/_/g, ' ');
                        return '<span class="badge" style="background-color:' + color + ';">' + displayText + '</span>';
                    }
                    return '';
                }
            });
        }

        // Inheritance Pattern badge rendering
        if (col.original_name === 'Inheritance_Pattern') {
            dtColumnDefs.push({
                targets: index + 1,
                render: function(data, type, row) {
                    if (type === 'display') {
                        if (!data || String(data).trim() === '' || data === 'none' || data === 'reference') {
                            return '<span class="badge" style="background-color:#6c757d;">Unknown</span>';
                        }
                        var str = String(data);
                        var lower = str.toLowerCase();
                        var color = '#6c757d';
                        if (lower === 'de_novo' || lower === 'de_novo_candidate') {
                            color = '#dc3545';
                        } else if (lower.indexOf('compound_heterozygous') !== -1) {
                            color = '#9c27b0';
                        } else if (lower.indexOf('autosomal_dominant') !== -1) {
                            color = '#1565c0';
                        } else if (lower.indexOf('autosomal_recessive') !== -1) {
                            color = '#2e7d32';
                        } else if (lower.indexOf('x_linked') !== -1) {
                            color = '#00838f';
                        } else if (lower === 'mitochondrial') {
                            color = '#bf5600';
                        } else if (lower === 'homozygous') {
                            color = '#546e7a';
                        } else if (lower === 'non_mendelian') {
                            color = '#c62828';
                        }
                        var displayText = str.replace(/_/g, ' ');
                        return '<span class="badge" style="background-color:' + color + ';">' + displayText + '</span>';
                    }
                    return data;
                }
            });
        }

        // TABLE-06: Fixed width for CHROM
        if (col.original_name === 'CHROM') {
            dtColumnDefs.push({
                targets: index + 1,
                width: '70px',
                className: 'monospace'
            });
        }

        // TABLE-06: Fixed width for POS, right-aligned
        if (col.original_name === 'POS') {
            dtColumnDefs.push({
                targets: index + 1,
                width: '90px',
                className: 'monospace dt-right'
            });
        }

        // TABLE-06: Grow for GENE (no fixed width)
        if (col.original_name === 'GENE') {
            dtColumnDefs.push({
                targets: index + 1,
                className: 'gene-column'
            });
        }

        // TABLE-08: Monospace for REF/ALT
        if (col.original_name === 'REF' || col.original_name === 'ALT') {
            dtColumnDefs.push({
                targets: index + 1,
                className: 'monospace'
            });
        }

        // TABLE-08: End truncation for HGVS with monospace
        if (col.original_name === 'HGVS_C' || col.original_name === 'HGVS_P') {
            dtColumnDefs.push({
                targets: index + 1,
                width: '180px',
                className: 'monospace',
                render: function(data, type, row) {
                    if (type === 'display' && data) {
                        var str = String(data);
                        if (str.length > 30) {
                            var truncated = str.substring(0, 30) + '...';
                            return '<span class="truncated-cell" tabindex="0" data-tippy-content="' +
                                str.replace(/"/g, '&quot;') + '">' + truncated + '</span>';
                        }
                    }
                    return data;
                }
            });
        }

        // TABLE-08: Middle truncation for variant IDs
        if (col.original_name === 'VAR_ID') {
            dtColumnDefs.push({
                targets: index + 1,
                width: '120px',
                render: function(data, type, row) {
                    if (type === 'display' && data) {
                        var str = String(data);
                        if (str.length > 18) {
                            var start = str.substring(0, 10);
                            var end = str.substring(str.length - 6);
                            return '<span class="truncated-cell middle-truncate" tabindex="0" data-tippy-content="' +
                                str.replace(/"/g, '&quot;') + '">' + start + '...' + end + '</span>';
                        }
                    }
                    return data;
                }
            });
        }

        // TABLE-06: Right-align numeric score columns
        // Match columns with score/phred/AF patterns (but not link columns or text columns)
        if (col.original_name.match(/(_score|_phred|_AF|_freq|_frequency|CADD|REVEL|SpliceAI)/) &&
            !col.original_name.match(/(link|url|http)/i)) {
            dtColumnDefs.push({
                targets: index + 1,
                className: 'dt-right',
                render: function(data, type, row) {
                    if (type === 'display' && data !== null && data !== '' && !isNaN(data)) {
                        return parseFloat(data).toFixed(3);
                    }
                    return data;
                }
            });
        }
    });

    // TABLE-07: Density mode management
    var densityModes = ['compact', 'regular', 'relaxed'];
    var savedDensity = localStorage.getItem('variantTableDensity') || 'compact';
    var currentDensityIndex = densityModes.indexOf(savedDensity);
    if (currentDensityIndex === -1) { currentDensityIndex = 0; savedDensity = 'compact'; }

    // Apply density class before DataTable init
    var tableElement = document.getElementById('variants_table');
    if (tableElement) {
        tableElement.classList.add('density-' + savedDensity);
    }

    // TABLE-03: Format function for expandable row details
    function formatChildRow(rowData, columns) {
        // Build field-to-value map using column data
        var fields = {};
        columns.forEach(function(col, i) {
            // rowData is an array; column 0 is control column (null), data starts at index 1
            var value = rowData[i + 1];
            if (value !== null && value !== undefined && String(value).trim() !== '') {
                fields[col.original_name] = String(value);
            }
        });

        // Define field categories
        var categories = {
            'Identifiers': ['CHROM', 'POS', 'REF', 'ALT', 'ID', 'VAR_ID', 'GENE', 'FEATUREID'],
            'Annotations': ['EFFECT', 'IMPACT', 'HGVS_C', 'HGVS_P', 'BIOTYPE', 'RANK', 'ERRORS'],
            'Scores': [],
            'Links': []
        };

        // Auto-categorize remaining fields
        var categorized = {};
        Object.keys(categories).forEach(function(cat) {
            categories[cat].forEach(function(f) { categorized[f] = true; });
        });

        columns.forEach(function(col) {
            var name = col.original_name;
            if (categorized[name]) return;
            if (!fields[name]) return;

            // Detect links (columns with URL values or link-related names)
            if (fields[name] && (fields[name].indexOf('http') === 0 || name.match(/(ClinVar|gnomAD|Varsome|Franklin|SpliceAI_link|autopvs1)/i))) {
                categories['Links'].push(name);
            }
            // Detect scores
            else if (name.match(/(_score|_phred|_AF|_freq|_frequency|CADD|REVEL|GERP|phyloP|SpliceAI|candidate_score|inheritance_score)/i)) {
                categories['Scores'].push(name);
            }
            // Everything else goes to Annotations
            else {
                categories['Annotations'].push(name);
            }
        });

        var html = '<div class="detail-panel">';

        Object.keys(categories).forEach(function(catName) {
            var catFields = categories[catName];
            // Filter to fields that have values
            var fieldsWithValues = catFields.filter(function(f) { return fields[f]; });
            if (fieldsWithValues.length === 0) return;

            html += '<div class="detail-section">';
            html += '<h4>' + catName + '</h4>';
            html += '<dl>';

            fieldsWithValues.forEach(function(fieldName) {
                var value = fields[fieldName];
                var displayName = fieldName.replace(/_/g, ' ');
                html += '<dt>' + displayName + '</dt>';

                // Render links as clickable
                if (value && value.indexOf('http') === 0) {
                    html += '<dd><a href="' + value + '" target="_blank" rel="noopener">' + displayName + ' &#x2197;</a></dd>';
                } else {
                    html += '<dd>' + value + '</dd>';
                }
            });

            html += '</dl></div>';
        });

        html += '</div>';
        return html;
    }

    // Initialize DataTables v2 on the visible table (required for correct header sizing with scrollX)
    try {
        var table = new DataTable('#variants_table', {
            autoWidth: false,
            pageLength: 25,
            scrollX: true,
            fixedColumns: {
                left: 2  // TABLE-02: Freeze chevron (col 0) and GENE (col 1 for GENE, assuming it's the first data column after control)
            },
            layout: {
                topStart: {
                    pageLength: {
                        menu: [10, 25, 50, 100, -1]
                    }
                },
                topEnd: {
                    search: true,
                    buttons: [
                        {
                            text: 'Density: ' + savedDensity.charAt(0).toUpperCase() + savedDensity.slice(1),
                            action: function(e, dt, node, config) {
                                var tableNode = dt.table().node();
                                tableNode.classList.remove('density-' + densityModes[currentDensityIndex]);
                                currentDensityIndex = (currentDensityIndex + 1) % densityModes.length;
                                var newDensity = densityModes[currentDensityIndex];
                                tableNode.classList.add('density-' + newDensity);
                                localStorage.setItem('variantTableDensity', newDensity);
                                node.text('Density: ' + newDensity.charAt(0).toUpperCase() + newDensity.slice(1));
                                dt.columns.adjust().draw(false);
                            }
                        },
                        {
                            extend: 'colvis',
                            text: 'Show/Hide Columns'
                        }
                    ]
                }
            },
            columnDefs: dtColumnDefs,
            initComplete: function() {
                if (skeleton) { skeleton.style.display = 'none'; }
                this.api().columns.adjust();

                // A11Y-01: Add ARIA roles and labels
                var tableEl = document.getElementById('variants_table');
                if (tableEl) {
                    tableEl.setAttribute('role', 'table');
                    var thead = tableEl.querySelector('thead');
                    var tbody = tableEl.querySelector('tbody');
                    if (thead) {
                        thead.setAttribute('role', 'rowgroup');
                        var ths = thead.querySelectorAll('th');
                        ths.forEach(function(th) { th.setAttribute('role', 'columnheader'); });
                    }
                    if (tbody) {
                        tbody.setAttribute('role', 'rowgroup');
                        var tds = tbody.querySelectorAll('td');
                        tds.forEach(function(td) { td.setAttribute('role', 'cell'); });
                    }
                }

                // ARIA labels for DataTables controls
                var searchInput = document.querySelector('.dt-search input');
                if (searchInput) {
                    searchInput.setAttribute('aria-label', 'Search variants');
                    searchInput.setAttribute('type', 'search');
                }
                var lengthSelect = document.querySelector('.dt-length select');
                if (lengthSelect) {
                    lengthSelect.setAttribute('aria-label', 'Number of variants per page');
                }
                var colvisButton = document.querySelector('.buttons-colvis');
                if (colvisButton) {
                    colvisButton.setAttribute('aria-label', 'Show or hide columns');
                }
                var infoDiv = document.querySelector('.dt-info');
                if (infoDiv) {
                    infoDiv.setAttribute('role', 'status');
                    infoDiv.setAttribute('aria-live', 'polite');
                }

                // Density toggle button ARIA label
                var densityButton = document.querySelector('.dt-buttons button');
                if (densityButton && densityButton.textContent.indexOf('Density') !== -1) {
                    densityButton.setAttribute('aria-label', 'Toggle table density');
                }
            },
            drawCallback: function(settings) {
                initTippyTooltips();
            }
        });
    } catch (e) {
        console.error('DataTables initialization failed:', e);
        if (skeleton) { skeleton.style.display = 'none'; }
    }

    // TABLE-03: Toggle child row on chevron click
    table.on('click', 'tbody td.dt-control', function(e) {
        var tr = e.target.closest('tr');
        var row = table.row(tr);

        if (row.child.isShown()) {
            row.child.hide();
            tr.classList.remove('shown');
        } else {
            row.child(formatChildRow(row.data(), columnData)).show();
            tr.classList.add('shown');
        }
    });

    // Initialize Tippy.js tooltips on truncated cells
    function initTippyTooltips() {
        var truncatedCells = document.querySelectorAll('.truncated-cell[data-tippy-content]');
        truncatedCells.forEach(function(cell) {
            if (!cell._tippy) {
                tippy(cell, {
                    theme: 'variantcentrifuge',
                    placement: 'top',
                    allowHTML: false,
                    maxWidth: 300,
                    interactive: false,
                    delay: [0, 0],
                    trigger: 'mouseenter focus',
                    touch: ['hold', 500],
                    appendTo: document.body,
                    onShow: function(instance) {
                        // Format content with line breaks at separators
                        var content = instance.props.content;
                        if (content) {
                            content = String(content)
                                .replace(/;/g, ';\n')
                                .replace(/\|/g, '|\n');
                            instance.setContent(content);
                        }
                    }
                });
            }
        });
    }

    // Initialize Chart.js horizontal bar chart for Impact Distribution
    var impactDistribution = {{ summary.impact_distribution | tojson }};
    var impactCategories = Object.keys(impactDistribution);
    var impactCounts = Object.values(impactDistribution);

    // Define semantic colors for impact levels (WCAG AA 4.5:1 contrast)
    var impactColorMap = {
        'HIGH': '#dc3545',      // Red
        'MODERATE': '#c05000',  // Dark orange (4.6:1)
        'LOW': '#b45309',       // Dark amber (5.2:1)
        'MODIFIER': '#6c757d'   // Gray
    };

    // Map colors to categories
    var impactBackgroundColors = impactCategories.map(function(category) {
        return impactColorMap[category] || '#007bff'; // Default blue if unknown category
    });

    var impactCtx = document.getElementById('impact_chart').getContext('2d');
    var impactChart = new Chart(impactCtx, {
        type: 'bar',
        data: {
            labels: impactCategories,
            datasets: [{
                label: 'Number of Variants',
                data: impactCounts,
                backgroundColor: impactBackgroundColors,
                borderWidth: 0
            }]
        },
        options: {
            indexAxis: 'y', // Horizontal bar chart
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                title: {
                    display: false
                },
                datalabels: {
                    anchor: 'end',
                    align: 'end',
                    color: '#333',
                    font: {
                        weight: 'bold',
                        size: 12
                    },
                    formatter: function(value) {
                        return value;
                    }
                }
            },
            scales: {
                x: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Number of Variants'
                    },
                    ticks: {
                        precision: 0
                    }
                },
                y: {
                    title: {
                        display: true,
                        text: 'Impact Level'
                    }
                }
            }
        },
        plugins: [ChartDataLabels]
    });

    // Initialize Chart.js horizontal bar chart for Inheritance Patterns
    if (document.getElementById('inheritance_chart')) {
        var inheritanceDistribution = {{ summary.inheritance_distribution | default({}) | tojson }};
        var inheritanceCategories = Object.keys(inheritanceDistribution);
        var inheritanceCounts = Object.values(inheritanceDistribution);

        // Define semantic colors for inheritance patterns (WCAG AA 4.5:1 contrast)
        var inheritanceColorMap = {
            'de_novo': '#dc3545',
            'de_novo_candidate': '#e57373',
            'compound_heterozygous': '#9c27b0',
            'compound_heterozygous_possible': '#ba68c8',
            'compound_heterozygous_possible_no_pedigree': '#ba68c8',
            'compound_heterozygous_possible_missing_parents': '#ba68c8',
            'compound_heterozygous_possible_missing_parent_genotypes': '#ba68c8',
            'autosomal_recessive': '#2e7d32',
            'autosomal_recessive_possible': '#81c784',
            'autosomal_dominant': '#1565c0',
            'autosomal_dominant_possible': '#64b5f6',
            'x_linked_recessive': '#00838f',
            'x_linked_dominant': '#00838f',
            'x_linked_recessive_possible': '#4dd0e1',
            'x_linked_dominant_possible': '#4dd0e1',
            'mitochondrial': '#bf5600',
            'homozygous': '#546e7a',
            'non_mendelian': '#c62828',
            'unknown': '#6c757d'
        };

        // Map colors to categories
        var inheritanceBackgroundColors = inheritanceCategories.map(function(category) {
            return inheritanceColorMap[category] || '#6c757d'; // Default gray if unknown
        });

        // Replace underscores with spaces in labels for readability
        var inheritanceLabels = inheritanceCategories.map(function(label) {
            return label.replace(/_/g, ' ');
        });

        var inheritanceCtx = document.getElementById('inheritance_chart').getContext('2d');
        var inheritanceChart = new Chart(inheritanceCtx, {
            type: 'bar',
            data: {
                labels: inheritanceLabels,
                datasets: [{
                    label: 'Number of Variants',
                    data: inheritanceCounts,
                    backgroundColor: inheritanceBackgroundColors,
                    borderWidth: 0
                }]
            },
            options: {
                indexAxis: 'y', // Horizontal bar chart
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    title: {
                        display: false
                    },
                    datalabels: {
                        anchor: 'end',
                        align: 'end',
                        color: '#333',
                        font: {
                            weight: 'bold',
                            size: 12
                        },
                        formatter: function(value) {
                            return value;
                        }
                    }
                },
                scales: {
                    x: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Number of Variants'
                        },
                        ticks: {
                            precision: 0
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Inheritance Pattern'
                        }
                    }
                }
            },
            plugins: [ChartDataLabels]
        });
    }
});
</script>

</body>
</html>
