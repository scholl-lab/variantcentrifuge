<!-- File: variantcentrifuge/templates/index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VariantCentrifuge Report</title>

    <!-- Inlined CSS Assets -->
    <style>{{ assets['css/datatables.min'] }}</style>
    <style>{{ assets['css/buttons.dataTables.min'] }}</style>
    <style>{{ assets['css/tippy'] }}</style>

    <style>
    /* Base Styles */
    body {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        line-height: 1.6;
        color: #333;
        margin: 0;
        padding: 0;
        background-color: #f4f7f9;
    }
    .container {
        max-width: 95%;
        margin: 0 auto;
        padding: 20px;
    }
    header {
        background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
        color: white;
        padding: 2rem 1.5rem;
        margin-bottom: 2rem;
        border-radius: 8px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    header h1 {
        margin: 0 0 0.5rem 0;
        font-size: 28px;
        font-weight: 600;
    }
    header p {
        margin: 0.25rem 0;
        opacity: 0.9;
        font-size: 14px;
    }
    .table-section {
        background-color: white;
        border-radius: 8px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        padding: 20px;
        margin-bottom: 20px;
    }
    footer {
        text-align: center;
        margin-top: 30px;
        padding: 20px;
        font-size: 12px;
        color: #777;
    }

    /* Chart Container */
    .chart-container {
        position: relative;
        height: 300px;
        width: 100%;
    }
    .chart-container-sm {
        position: relative;
        height: 220px;
        width: 100%;
    }

    /* Dashboard Styles */
    .dashboard { margin-bottom: 24px; }
    .cards-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 12px;
        margin-bottom: 16px;
    }
    .charts-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
    }

    /* Metric Card Styles */
    .metric-card {
        background: white;
        border-radius: 8px;
        padding: 14px 16px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.06);
    }
    .metric-card h3 {
        margin: 0 0 4px 0;
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: #6c757d;
        font-weight: 600;
    }
    .metric-card .metric-value {
        margin: 0;
        font-size: 1.75rem;
        font-weight: 700;
        line-height: 1.2;
    }
    .metric-card .gene-list {
        list-style: none;
        padding: 0;
        margin: 0;
        font-size: 13px;
        line-height: 1.5;
    }
    .metric-card .gene-list li {
        display: flex;
        justify-content: space-between;
    }

    /* Impact Breakdown Styles */
    .impact-breakdown { list-style: none; padding: 0; margin: 0; font-size: 13px; }
    .impact-breakdown li { display: flex; justify-content: space-between; align-items: center; padding: 2px 0; }
    .impact-dot { display: inline-block; width: 10px; height: 10px; border-radius: 50%; margin-right: 6px; }

    /* Chart Wrapper Styles */
    .chart-wrapper {
        background: white;
        border-radius: 8px;
        padding: 14px 16px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.06);
    }
    .chart-wrapper h3 {
        margin: 0 0 8px 0;
        font-size: 14px;
        font-weight: 600;
        color: #333;
    }

    /* Table Styles â€” apply to both body table and DataTables scroll header clone */
    #variants_table,
    .dt-scroll-head table,
    .dataTables_scrollHead table {
        font-size: 13px;
        width: 100% !important;
    }
    #variants_table th,
    .dt-scroll-head th,
    .dataTables_scrollHead th {
        white-space: nowrap !important;
        text-align: left !important;
        vertical-align: middle;
        line-height: 1.3;
        padding: 8px 22px 8px 8px !important;
        font-weight: 600;
    }
    /* Override DataTables numeric right-alignment */
    .dt-type-numeric {
        text-align: left !important;
    }
    /* Hide the duplicate thead inside the scroll body (DataTables clones it to scroll-head) */
    .dt-scroll-body thead,
    .dataTables_scrollBody thead {
        display: none;
    }
    #variants_table td {
        text-align: left;
        vertical-align: top;
        line-height: 1.3;
        padding: 4px 6px;
    }

    /* Link Styles */
    .link-icon {
        text-decoration: none;
        margin-right: 3px;
        color: #007bff;
        font-size: 0.9em;
    }
    .igv-individual-link {
        margin-right: 5px;
        text-decoration: underline;
        color: #0066cc;
        display: inline-block;
        white-space: nowrap;
    }
    .igv-individual-link .link-icon {
        color: #5cb85c;
    }

    /* Loading Skeleton */
    .skeleton-wrapper {
        background-color: white;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
    }
    .skeleton-row {
        display: flex;
        gap: 10px;
        margin-bottom: 12px;
        animation: shimmer 1.5s infinite;
    }
    .skeleton-cell {
        height: 24px;
        background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
        background-size: 200% 100%;
        border-radius: 4px;
        flex: 1;
    }
    .skeleton-cell:nth-child(1) { flex: 0.8; }
    .skeleton-cell:nth-child(2) { flex: 1.2; }
    .skeleton-cell:nth-child(3) { flex: 1; }
    @keyframes shimmer {
        0% { background-position: 200% 0; }
        100% { background-position: -200% 0; }
    }

    /* Alert Styles */
    .alert {
        padding: 15px;
        border: 1px solid transparent;
        border-radius: 4px;
        margin-bottom: 20px;
    }
    .alert-info {
        color: #31708f;
        background-color: #d9edf7;
        border-color: #bce8f1;
    }

    /* Tippy.js Tooltip Customization */
    .tippy-box[data-theme~='variantcentrifuge'] {
        background-color: #333;
        color: #fff;
        max-width: 400px;
        font-size: 13px;
    }
    .tippy-box[data-theme~='variantcentrifuge'][data-placement^='top'] > .tippy-arrow::before {
        border-top-color: #333;
    }
    .tippy-box[data-theme~='variantcentrifuge'][data-placement^='bottom'] > .tippy-arrow::before {
        border-bottom-color: #333;
    }
    .tippy-box[data-theme~='variantcentrifuge'][data-placement^='left'] > .tippy-arrow::before {
        border-left-color: #333;
    }
    .tippy-box[data-theme~='variantcentrifuge'][data-placement^='right'] > .tippy-arrow::before {
        border-right-color: #333;
    }

    /* Truncated Cell Styles */
    .truncated-cell {
        max-width: 150px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        display: inline-block;
        vertical-align: bottom;
    }
    </style>
</head>
<body>
<div class="container">
    <header>
        <h1>VariantCentrifuge Report</h1>
        <p>Generated on {{ generation_date }}</p>
        <p>VariantCentrifuge v{{ version }}</p>
    </header>

    <!-- Dashboard Section -->
    <div class="dashboard">
        <!-- Cards Row -->
        <div class="cards-grid">
            <div class="metric-card">
                <h3>Total Variants</h3>
                <p class="metric-value" style="color: #007bff;">{{ summary.num_variants }}</p>
            </div>
            <div class="metric-card">
                <h3>Unique Genes</h3>
                <p class="metric-value" style="color: #17a2b8;">{{ summary.num_genes }}</p>
            </div>
            <div class="metric-card">
                <h3>Samples</h3>
                <p class="metric-value" style="color: #28a745;">{{ summary.num_samples | default(0) }}</p>
            </div>
            <div class="metric-card">
                <h3>Impact Breakdown</h3>
                <ul class="impact-breakdown">
                    {% for level in ['HIGH', 'MODERATE', 'LOW', 'MODIFIER'] %}
                    <li>
                        <span><span class="impact-dot" style="background-color: {{ {'HIGH':'#dc3545','MODERATE':'#fd7e14','LOW':'#ffc107','MODIFIER':'#6c757d'}[level] }};"></span>{{ level }}</span>
                        <strong>{{ summary.impact_distribution.get(level, 0) if summary.impact_distribution is mapping else 0 }}</strong>
                    </li>
                    {% endfor %}
                </ul>
            </div>
            <div class="metric-card">
                <h3>Top Genes</h3>
                {% if summary.top_genes is defined and summary.top_genes|length > 0 %}
                <ul class="gene-list">
                    {% for gene_info in summary.top_genes[:5] %}
                    <li><span>{{ gene_info.gene }}</span><strong>{{ gene_info.count }}</strong></li>
                    {% endfor %}
                </ul>
                {% else %}
                <p style="color: #6c757d; font-size: 13px; margin: 0;">No gene data available</p>
                {% endif %}
            </div>
        </div>

        <!-- Charts Row -->
        <div class="charts-grid">
            <div class="chart-wrapper">
                <h3>Impact Distribution</h3>
                <div class="chart-container-sm">
                    <canvas id="impact_chart"></canvas>
                </div>
            </div>
            <div class="chart-wrapper">
                <h3>Inheritance Patterns</h3>
                <div class="chart-container-sm" id="inheritance_chart_container">
                    {% if summary.inheritance_distribution is defined and summary.inheritance_distribution|length > 0 %}
                    <canvas id="inheritance_chart"></canvas>
                    {% else %}
                    <p style="color: #6c757d; font-style: italic; text-align: center; padding-top: 80px;">Inheritance analysis not available (no pedigree provided)</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <div class="table-section">
        <h2>Variants Table</h2>

        <!-- Loading Skeleton -->
        <div id="table-skeleton" class="skeleton-wrapper">
            {% for i in range(7) %}
            <div class="skeleton-row">
                <div class="skeleton-cell"></div>
                <div class="skeleton-cell"></div>
                <div class="skeleton-cell"></div>
                <div class="skeleton-cell"></div>
                <div class="skeleton-cell"></div>
            </div>
            {% endfor %}
        </div>

        {% if variants and variants|length > 0 %}
        <table id="variants_table" class="display compact">
            <thead>
                <tr>
                    {% for col_info in column_data %}
                        <th>{{ col_info.display_name }}</th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% for v_row in variants %}
                <tr>
                    {% for col_info in column_data %}
                        <td>
                            {% if col_info.is_igv_link_column %}
                                {# Handle structured igv_links data which is a list of dicts #}
                                {% if v_row[col_info.original_name] and v_row[col_info.original_name]|length > 0 %}
                                    {% for igv_link_detail in v_row[col_info.original_name] %}
                                        <a href="{{ igv_link_detail.report_path }}" target="_blank" class="igv-individual-link" title="IGV report for {{ igv_link_detail.sample_id }}">
                                            <span class="link-icon">ðŸ”—</span>{{ igv_link_detail.sample_id }}
                                        </a>{% if not loop.last %} {% endif %}
                                    {% endfor %}
                                {% else %}
                                    N/A
                                {% endif %}
                            {% elif col_info.is_standard_link_column and v_row[col_info.original_name] and v_row[col_info.original_name] | string | trim != "" %}
                                <a href="{{ v_row[col_info.original_name] }}" target="_blank" title="{{ v_row[col_info.original_name] }}">
                                    <span class="link-icon">ðŸ”—</span>{{ col_info.link_display_text }}
                                </a>
                            {% elif col_info.apply_hover_expand and col_info.max_width_px %}
                                <span class="truncated-cell" style="max-width: {{ col_info.max_width_px }}px;" data-tippy-content="{{ v_row[col_info.original_name] }}">{{ v_row[col_info.original_name] }}</span>
                            {% else %}
                                {{ v_row[col_info.original_name] }}
                            {% endif %}
                        </td>
                    {% endfor %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div class="alert alert-info">
            <p><strong>No variants found matching the filtering criteria.</strong></p>
            <p>The filtering process completed successfully but no variants remained after applying all filters. This may be due to:</p>
            <ul>
                <li>Strict filtering criteria</li>
                <li>Specific gene selection with no matching variants</li>
                <li>Sample-specific filters excluding all variants</li>
            </ul>
            <p>You may want to try adjusting your filtering parameters or check your input data.</p>
        </div>
        {% endif %}
    </div>

    <footer>
        <p>Created with VariantCentrifuge</p>
    </footer>
</div>

<!-- Inlined JavaScript Assets -->
<script>{{ assets['js/jquery.slim.min'] }}</script>
<script>{{ assets['js/datatables.min'] }}</script>
<script>{{ assets['js/datatables.buttons.min'] }}</script>
<script>{{ assets['js/buttons.colVis.min'] }}</script>
<script>{{ assets['js/chart.umd.min'] }}</script>
<script>{{ assets['js/chartjs-plugin-datalabels.min'] }}</script>
<script>{{ assets['js/popper.min'] }}</script>
<script>{{ assets['js/tippy-bundle.umd.min'] }}</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Early exit if no variants table
    if (!document.getElementById('variants_table')) {
        return;
    }

    var skeleton = document.getElementById('table-skeleton');

    // Get column configuration from Jinja2
    var allColumnOriginalNames = {{ column_data | map(attribute='original_name') | list | tojson }};
    var defaultHiddenColumnOriginalNames = {{ default_hidden_columns | tojson }};
    var columnData = {{ column_data | tojson }};
    var hiddenColumnIndices = [];
    var dtColumnDefs = [];

    // Find indices of columns to hide by default
    defaultHiddenColumnOriginalNames.forEach(function(hiddenColName) {
        var index = allColumnOriginalNames.indexOf(hiddenColName);
        if (index !== -1) {
            hiddenColumnIndices.push(index);
        }
    });

    // Setup default hidden columns
    if (hiddenColumnIndices.length > 0) {
        dtColumnDefs.push({
            targets: hiddenColumnIndices,
            visible: false
        });
    }

    // Initialize DataTables v2 on the visible table (required for correct header sizing with scrollX)
    try {
        var table = new DataTable('#variants_table', {
            autoWidth: false,
            pageLength: 25,
            scrollX: true,
            layout: {
                topStart: {
                    pageLength: {
                        menu: [10, 25, 50, 100, -1]
                    }
                },
                topEnd: {
                    search: true,
                    buttons: [
                        {
                            extend: 'colvis',
                            text: 'Show/Hide Columns'
                        }
                    ]
                }
            },
            columnDefs: dtColumnDefs,
            initComplete: function() {
                if (skeleton) { skeleton.style.display = 'none'; }
                this.api().columns.adjust();
            },
            drawCallback: function(settings) {
                initTippyTooltips();
            }
        });
    } catch (e) {
        console.error('DataTables initialization failed:', e);
        if (skeleton) { skeleton.style.display = 'none'; }
    }

    // Initialize Tippy.js tooltips on truncated cells
    function initTippyTooltips() {
        var truncatedCells = document.querySelectorAll('.truncated-cell[data-tippy-content]');
        truncatedCells.forEach(function(cell) {
            if (!cell._tippy) {
                tippy(cell, {
                    theme: 'variantcentrifuge',
                    placement: 'top',
                    allowHTML: false,
                    maxWidth: 400,
                    interactive: false,
                    onShow: function(instance) {
                        // Only show if content is actually truncated
                        if (cell.offsetWidth >= cell.scrollWidth && cell.offsetHeight >= cell.scrollHeight) {
                            return false;
                        }
                    }
                });
            }
        });
    }

    // Initialize Chart.js horizontal bar chart for Impact Distribution
    var impactDistribution = {{ summary.impact_distribution | tojson }};
    var impactCategories = Object.keys(impactDistribution);
    var impactCounts = Object.values(impactDistribution);

    // Define semantic colors for impact levels
    var impactColorMap = {
        'HIGH': '#dc3545',      // Red
        'MODERATE': '#fd7e14',  // Orange
        'LOW': '#ffc107',       // Amber
        'MODIFIER': '#6c757d'   // Gray
    };

    // Map colors to categories
    var impactBackgroundColors = impactCategories.map(function(category) {
        return impactColorMap[category] || '#007bff'; // Default blue if unknown category
    });

    var impactCtx = document.getElementById('impact_chart').getContext('2d');
    var impactChart = new Chart(impactCtx, {
        type: 'bar',
        data: {
            labels: impactCategories,
            datasets: [{
                label: 'Number of Variants',
                data: impactCounts,
                backgroundColor: impactBackgroundColors,
                borderWidth: 0
            }]
        },
        options: {
            indexAxis: 'y', // Horizontal bar chart
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                title: {
                    display: false
                },
                datalabels: {
                    anchor: 'end',
                    align: 'end',
                    color: '#333',
                    font: {
                        weight: 'bold',
                        size: 12
                    },
                    formatter: function(value) {
                        return value;
                    }
                }
            },
            scales: {
                x: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Number of Variants'
                    },
                    ticks: {
                        precision: 0
                    }
                },
                y: {
                    title: {
                        display: true,
                        text: 'Impact Level'
                    }
                }
            }
        },
        plugins: [ChartDataLabels]
    });

    // Initialize Chart.js horizontal bar chart for Inheritance Patterns
    if (document.getElementById('inheritance_chart')) {
        var inheritanceDistribution = {{ summary.inheritance_distribution | default({}) | tojson }};
        var inheritanceCategories = Object.keys(inheritanceDistribution);
        var inheritanceCounts = Object.values(inheritanceDistribution);

        // Define semantic colors for inheritance patterns
        var inheritanceColorMap = {
            'de_novo': '#dc3545',
            'de_novo_candidate': '#e57373',
            'compound_heterozygous': '#9c27b0',
            'compound_heterozygous_possible': '#ba68c8',
            'compound_heterozygous_possible_no_pedigree': '#ba68c8',
            'compound_heterozygous_possible_missing_parents': '#ba68c8',
            'compound_heterozygous_possible_missing_parent_genotypes': '#ba68c8',
            'autosomal_recessive': '#4caf50',
            'autosomal_recessive_possible': '#81c784',
            'autosomal_dominant': '#2196f3',
            'autosomal_dominant_possible': '#64b5f6',
            'x_linked_recessive': '#00acc1',
            'x_linked_dominant': '#00acc1',
            'x_linked_recessive_possible': '#4dd0e1',
            'x_linked_dominant_possible': '#4dd0e1',
            'mitochondrial': '#ff9800',
            'homozygous': '#78909c',
            'non_mendelian': '#ef5350',
            'unknown': '#6c757d'
        };

        // Map colors to categories
        var inheritanceBackgroundColors = inheritanceCategories.map(function(category) {
            return inheritanceColorMap[category] || '#6c757d'; // Default gray if unknown
        });

        // Replace underscores with spaces in labels for readability
        var inheritanceLabels = inheritanceCategories.map(function(label) {
            return label.replace(/_/g, ' ');
        });

        var inheritanceCtx = document.getElementById('inheritance_chart').getContext('2d');
        var inheritanceChart = new Chart(inheritanceCtx, {
            type: 'bar',
            data: {
                labels: inheritanceLabels,
                datasets: [{
                    label: 'Number of Variants',
                    data: inheritanceCounts,
                    backgroundColor: inheritanceBackgroundColors,
                    borderWidth: 0
                }]
            },
            options: {
                indexAxis: 'y', // Horizontal bar chart
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    title: {
                        display: false
                    },
                    datalabels: {
                        anchor: 'end',
                        align: 'end',
                        color: '#333',
                        font: {
                            weight: 'bold',
                            size: 12
                        },
                        formatter: function(value) {
                            return value;
                        }
                    }
                },
                scales: {
                    x: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Number of Variants'
                        },
                        ticks: {
                            precision: 0
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Inheritance Pattern'
                        }
                    }
                }
            },
            plugins: [ChartDataLabels]
        });
    }
});
</script>

</body>
</html>
