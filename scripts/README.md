# VariantCentrifuge Cohort Report Generator

This directory contains helper scripts for post-processing and aggregating results from the main `variantcentrifuge` pipeline.

## `create_cohort_report.py`

### Overview

This script is a powerful tool designed to aggregate the results from multiple single-sample `variantcentrifuge` analyses into a single, interactive HTML report. It addresses the common need to analyze variants across an entire cohort, identify recurrently mutated genes, and dynamically filter the complete dataset based on various criteria.

The script works by parsing all specified single-sample TSV files, merging them into a master dataset, pre-computing cohort-wide statistics, and then generating a self-contained HTML report that uses JavaScript libraries like DataTables.js and Plotly.js for a performant and interactive user experience.

### Key Features

- **Cohort Aggregation:** Automatically finds and merges data from numerous `variantcentrifuge` TSV output files using a simple glob pattern.
- **Interactive HTML Report:** Produces a modern, single-file HTML report that can be easily shared and viewed in any web browser without needing a backend server.
- **Dynamic Filtering:** Provides per-column filtering controls, including text search for fields like `Gene` and interactive range sliders for numeric fields like `SampleAF` and `CADD_PHRED`.
- **Interactive Visualization:** Displays a bar chart of the most frequently mutated genes in the cohort. Clicking on a gene in the plot instantly filters the main variant table.
- **Dynamic Statistics:** The summary dashboard and plot update in real-time as you apply filters, always reflecting the currently visible data subset.
- **High-Performance Table:** Uses the DataTables.js library to handle potentially thousands of variant rows smoothly, with features like pagination, global search, column visibility, and data export (CSV/Excel).

### Prerequisites

1.  **Python 3** with the following packages installed:
    -   `pandas`
    -   `Jinja2`
    You can install them via pip:
    ```sh
    pip install pandas Jinja2
    ```
2.  **A collection of output files** generated by the main `variantcentrifuge` pipeline. The script is designed to work with the final TSV reports (e.g., `APA12_TvsN.filtered.annotated.vc_analysis.tsv`).

### Usage

The script is run from the command line from the root of the `variantcentrifuge` project.

```sh
python scripts/create_cohort_report.py [OPTIONS]
```

#### Arguments:

-   `--input-pattern` **(Required)**: A glob pattern enclosed in quotes to find all the input TSV files. The pattern should be relative to your current directory.
    -   *Example:* `'output/variantcentrifuge_analysis/**/*.vc_analysis.tsv'`

-   `--output-dir` **(Required)**: The path to the directory where the final report and its associated data will be saved. The directory will be created if it doesn't exist.
    -   *Example:* `cohort_analysis_report`

-   `--report-name` (Optional): A custom name for the report that will be displayed as the title in the HTML file.
    -   *Default:* `"Variant Cohort Analysis"`
    -   *Example:* `"My TCGA Cohort - Kinase Genes"`

-   `--sample-regex` **(Required)**: A Python regular expression (enclosed in quotes) used to extract a clean sample identifier from the full path of each input file. The regex **must contain one capturing group** (`(...)`) that isolates the sample ID.
    -   **Example:** For a file path like `output/variantcentrifuge_analysis/results/exomes/variantcentrifuge_analysis/APA12_TvsN.filtered.annotated/APA12_TvsN.filtered.annotated.vc_analysis.tsv`, a good regex would be: `'variantcentrifuge_analysis/([^/]+)/'`. This captures the sample directory name `APA12_TvsN.filtered.annotated` as the ID.

### Example Command

This example command assumes you have run the Snakemake workflow, and your results are in the `output/` directory.

```bash
python scripts/create_cohort_report.py \
  --input-pattern 'output/variantcentrifuge_analysis/results/exomes/variantcentrifuge_analysis/*/*.vc_analysis.tsv' \
  --output-dir 'cohort_report_final' \
  --report-name 'APA Somatic Variant Cohort' \
  --sample-regex 'variantcentrifuge_analysis/([^/]+)/'
```

### Output Structure

After running the script, the specified output directory will have the following structure:

```
cohort_report_final/
├── cohort_report.html      # The final, interactive HTML report file.
└── data/
    ├── variants.json       # A large JSON file containing all aggregated variant data.
    └── summary.json        # A small JSON file with pre-computed summary statistics.
