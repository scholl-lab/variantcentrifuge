#!/usr/bin/env Rscript
# =============================================================================
# generate_coast_golden.R
# =============================================================================
# Generate golden reference p-values for COAST validation tests.
#
# Usage:
#   Rscript scripts/generate_coast_golden.R
#
# Requirements:
#   R (>= 4.1) with AllelicSeries package installed:
#     install.packages("AllelicSeries")
#     # or from Bioconductor/GitHub per AllelicSeries installation instructions
#
# Output:
#   Prints structured golden reference values to stdout.
#   Copy-paste the output into tests/unit/test_coast_python_comparison.py
#   as constants in the _R_GOLDEN_* dicts.
#
# Used by:
#   tests/unit/test_coast_python_comparison.py
#
# Note:
#   This script is NOT run in CI. It is for offline execution by developers
#   who have R + AllelicSeries installed. The output values are hardcoded
#   as constants in the Python comparison test.
#
# Version history:
#   2026-02-22  Initial version for Phase 24 validation (COAST-PY-01)
# =============================================================================

suppressPackageStartupMessages({
  if (!requireNamespace("AllelicSeries", quietly = TRUE)) {
    stop(paste0(
      "AllelicSeries R package not found.\n",
      "Install with: install.packages('AllelicSeries')\n",
      "or follow installation instructions at:\n",
      "  https://github.com/insitro/AllelicSeries"
    ))
  }
  library(AllelicSeries)
})

cat("# =============================================================================\n")
cat("# COAST Golden Reference Values\n")
cat("# Generated by: Rscript scripts/generate_coast_golden.R\n")
cat(sprintf("# AllelicSeries version: %s\n",
            as.character(packageVersion("AllelicSeries"))))
cat(sprintf("# R version: %s\n", R.version.string))
cat(sprintf("# Date: %s\n", format(Sys.time(), "%Y-%m-%d")))
cat("# =============================================================================\n\n")

# Helper: run one COAST scenario and print results
run_scenario <- function(
    scenario_name, seed, n, n_bmv, n_dmv, n_ptv,
    trait_type = "binary", signal = FALSE,
    weights = c(1, 2, 3)
) {
  k <- n_bmv + n_dmv + n_ptv

  set.seed(seed)

  # Genotype matrix: HWE-like distribution (ref=0.6, het=0.3, hom_alt=0.1)
  geno <- matrix(
    sample(0:2, n * k, replace = TRUE, prob = c(0.6, 0.3, 0.1)),
    nrow = n, ncol = k
  )

  # Annotation codes: 1=BMV, 2=DMV, 3=PTV
  anno <- c(rep(1L, n_bmv), rep(2L, n_dmv), rep(3L, n_ptv))

  # Phenotype generation
  if (trait_type == "binary") {
    pheno <- sample(0:1, n, replace = TRUE)
    if (signal) {
      # Enrich cases for alt alleles in PTV variants
      case_idx <- which(pheno == 1)
      ptv_cols <- (n_bmv + n_dmv + 1):k
      for (j in ptv_cols) {
        geno[case_idx, j] <- pmin(
          geno[case_idx, j] + rbinom(length(case_idx), 1, 0.5), 2
        )
      }
    }
  } else {
    pheno <- rnorm(n)
  }

  is_binary <- (trait_type == "binary")

  # Run COAST
  result <- tryCatch({
    COAST(
      anno  = anno,
      geno  = geno,
      pheno = pheno,
      covar = NULL,
      weights = weights,
      is_pheno_binary = is_binary
    )
  }, error = function(e) {
    cat(sprintf("ERROR in scenario %s: %s\n", scenario_name, conditionMessage(e)))
    NULL
  })

  if (is.null(result)) return(invisible(NULL))

  # Extract p-values from the result
  # AllelicSeries COAST() returns an object with a Pvals slot
  pvals <- tryCatch(result@Pvals, error = function(e) NULL)
  if (is.null(pvals)) {
    # Try alternative accessor patterns
    pvals <- tryCatch(result$Pvals, error = function(e) NULL)
  }

  cat(sprintf("# --- Scenario: %s ---\n", scenario_name))
  cat(sprintf("# Seed=%d, n=%d, n_bmv=%d, n_dmv=%d, n_ptv=%d, trait=%s, signal=%s\n",
              seed, n, n_bmv, n_dmv, n_ptv, trait_type, signal))
  cat(sprintf("# Weights: [%s]\n", paste(weights, collapse=", ")))

  if (!is.null(pvals) && is.data.frame(pvals)) {
    # COAST() returns a data.frame with columns: test, type, pval
    pval_names <- pvals$test
    pval_values <- pvals$pval
    cat(sprintf("_R_GOLDEN_%s = {\n", toupper(gsub("[^A-Za-z0-9]", "_", scenario_name))))
    for (i in seq_along(pval_values)) {
      cat(sprintf('    "%s": %.15e,\n', pval_names[i], as.numeric(pval_values[i])))
    }
    cat("}\n\n")
  } else if (!is.null(pvals)) {
    # Fallback for other return formats
    pval_names <- names(pvals)
    pvals <- unlist(pvals, use.names = FALSE)
    if (is.null(pval_names)) {
      pval_names <- paste0("component_", seq_along(pvals))
    }
    cat(sprintf("_R_GOLDEN_%s = {\n", toupper(gsub("[^A-Za-z0-9]", "_", scenario_name))))
    for (i in seq_along(pvals)) {
      cat(sprintf('    "%s": %.15e,\n', pval_names[i], as.numeric(pvals[i])))
    }
    cat("}\n\n")
  } else {
    cat(sprintf("# WARNING: Could not extract Pvals from COAST result for %s\n", scenario_name))
    cat(sprintf("# Result class: %s\n", class(result)))
    cat(sprintf("# Result names/slots: %s\n\n",
                paste(slotNames(result), collapse=", ")))
  }

  invisible(result)
}

# =============================================================================
# Scenario 1: Binary trait, null phenotype (no signal)
# seed=42, n=100, 3 BMV + 3 DMV + 3 PTV
# Expected: omnibus p should be moderate to large (no signal)
# =============================================================================
cat("# Scenario 1: Binary null (no signal)\n")
run_scenario(
  scenario_name = "scenario_1_binary_null",
  seed = 42, n = 100,
  n_bmv = 3, n_dmv = 3, n_ptv = 3,
  trait_type = "binary", signal = FALSE
)

# =============================================================================
# Scenario 2: Binary trait, with signal (cases enriched for alt PTV alleles)
# seed=123, n=100, 3 BMV + 3 DMV + 3 PTV
# Expected: omnibus p should be small (signal present)
# =============================================================================
cat("# Scenario 2: Binary with signal\n")
run_scenario(
  scenario_name = "scenario_2_binary_signal",
  seed = 123, n = 100,
  n_bmv = 3, n_dmv = 3, n_ptv = 3,
  trait_type = "binary", signal = TRUE
)

# =============================================================================
# Scenario 3: Quantitative trait, null phenotype
# seed=77, n=100, 3 BMV + 3 DMV + 3 PTV
# Expected: omnibus p should be moderate to large (no signal)
# =============================================================================
cat("# Scenario 3: Quantitative null\n")
run_scenario(
  scenario_name = "scenario_3_quantitative_null",
  seed = 77, n = 100,
  n_bmv = 3, n_dmv = 3, n_ptv = 3,
  trait_type = "quantitative", signal = FALSE
)

# =============================================================================
# Scenario 4: Unequal category sizes
# seed=200, n=100, 2 BMV + 4 DMV + 6 PTV
# Expected: valid omnibus p (tests robustness to unequal counts)
# =============================================================================
cat("# Scenario 4: Unequal category sizes\n")
run_scenario(
  scenario_name = "scenario_4_unequal_sizes",
  seed = 200, n = 100,
  n_bmv = 2, n_dmv = 4, n_ptv = 6,
  trait_type = "binary", signal = FALSE
)

# =============================================================================
# Scenario 5: Single variant per category (minimum viable COAST input)
# seed=300, n=100, 1 BMV + 1 DMV + 1 PTV
# Expected: valid omnibus p (edge case)
# =============================================================================
cat("# Scenario 5: Single variant per category\n")
run_scenario(
  scenario_name = "scenario_5_single_variant",
  seed = 300, n = 100,
  n_bmv = 1, n_dmv = 1, n_ptv = 1,
  trait_type = "binary", signal = FALSE
)

# =============================================================================
# Print raw data for Scenario 1 (for Python test reconstruction)
# =============================================================================
cat("# =============================================================================\n")
cat("# Raw data for Scenario 1 (seed=42, n=100, 3+3+3 variants)\n")
cat("# Used to verify Python data generation matches R data generation.\n")
cat("# =============================================================================\n")

set.seed(42)
n <- 100L
k <- 9L  # 3 BMV + 3 DMV + 3 PTV
geno_s1 <- matrix(
  sample(0:2, n * k, replace = TRUE, prob = c(0.6, 0.3, 0.1)),
  nrow = n, ncol = k
)
pheno_s1 <- sample(0:1, n, replace = TRUE)

# Print first 10 rows of genotype matrix for verification
cat("# First 5 rows of genotype matrix (verify Python rng matches R rng):\n")
cat("# NOTE: R uses base::sample() - Python uses numpy default_rng(seed)\n")
cat("# These will NOT match exactly. Comparison is via p-value ranges, not exact data.\n")
cat("# Genotype first row: [", paste(geno_s1[1,], collapse=", "), "]\n")
cat("# Phenotype first 10: [", paste(pheno_s1[1:10], collapse=", "), "]\n\n")

cat("# =============================================================================\n")
cat("# INSTRUCTIONS:\n")
cat("# 1. Copy the _R_GOLDEN_* dicts above into test_coast_python_comparison.py\n")
cat("# 2. Update the _R_GOLDEN_* constants in the test file\n")
cat("# 3. Re-run tests: pytest tests/unit/test_coast_python_comparison.py\n")
cat("# NOTE: R uses different RNG than Python numpy, so Python and R genotype\n")
cat("#       matrices will differ. Validation is via statistical behavior ranges.\n")
cat("# =============================================================================\n")

# =============================================================================
# GCKD-Derived Golden Value Generation (TD-03)
# =============================================================================
#
# These scenarios are derived from GCKD study characteristics:
#   - Data source: testing/gckd_all.GRCh37.annotated.vcf.gz
#   - Cohort: GCKD study, ~5125 samples (235 PKD cases, 4889 controls)
#   - Case prevalence: ~4.6% (highly imbalanced binary phenotype)
#   - Genes: PKD1 (645 variants), PKD2 (87 variants), COL4A5 (66 variants)
#   - COAST categories from IMPACT: HIGH->PTV(3), MODERATE damaging->DMV(2),
#     MODERATE benign->BMV(1)
#
# These scenarios use representative small extracts (n=200, ~9 cases) that
# preserve the GCKD data characteristics — variant density, rare-variant
# distribution, case fraction — in a computationally tractable test size.
#
# Run this section to generate golden omnibus p-values:
#   Rscript scripts/generate_coast_golden.R
#
# Then copy the _GCKD_GOLDEN_* dict values into:
#   tests/unit/test_coast_python_comparison.py
#   class TestCOASTGCKDGoldenComparison, _GCKD_GOLDEN_SCENARIOS
#   field: r_omnibus_p
# =============================================================================

cat("\n")
cat("# =============================================================================\n")
cat("# GCKD-Derived Golden Values (TD-03)\n")
cat("# Scenarios derived from testing/gckd_all.GRCh37.annotated.vcf.gz characteristics\n")
cat("# n=200 samples, ~9 cases (4.5% prevalence, mimicking GCKD 235/5125 ratio)\n")
cat("# =============================================================================\n\n")

# Helper to generate GCKD-like data: rare variant genotypes with realistic MAF
# GCKD variants are rare: typically AC=1-10 in ~5125 samples -> MAF ~0.001-0.002
# In n=200 samples with similar rarity: 0-2 carriers per variant
gckd_geno <- function(seed, n, k_bmv, k_dmv, k_ptv, n_cases,
                       maf_bmv = 0.015, maf_dmv = 0.010, maf_ptv = 0.005) {
  set.seed(seed)
  k <- k_bmv + k_dmv + k_ptv
  # Simulate rare variants: each variant drawn from binomial(2, maf)
  # This gives mostly 0 (homozygous ref) with occasional carriers
  geno <- matrix(0L, nrow = n, ncol = k)
  for (j in seq_len(k)) {
    if (j <= k_bmv) {
      maf <- maf_bmv
    } else if (j <= k_bmv + k_dmv) {
      maf <- maf_dmv
    } else {
      maf <- maf_ptv
    }
    geno[, j] <- rbinom(n, 2, maf)
    # Enforce max dosage of 2 (not needed for binomial(2, p) but defensive)
    geno[, j] <- pmin(geno[, j], 2L)
  }
  # Annotation codes: 1=BMV, 2=DMV, 3=PTV
  anno <- c(rep(1L, k_bmv), rep(2L, k_dmv), rep(3L, k_ptv))
  # GCKD-like phenotype: ~4.5% cases (imbalanced)
  pheno <- rep(0L, n)
  case_idx <- sample.int(n, n_cases)
  pheno[case_idx] <- 1L
  list(geno = geno, anno = anno, pheno = pheno)
}

# Helper to run COAST on GCKD-derived data and print golden value
run_gckd_scenario <- function(scenario_name, description, seed, n, k_bmv, k_dmv, k_ptv,
                               n_cases, weights = c(1, 2, 3), trait_type = "binary") {
  dat <- gckd_geno(seed, n, k_bmv, k_dmv, k_ptv, n_cases)
  is_binary <- (trait_type == "binary")

  result <- tryCatch({
    COAST(
      anno  = dat$anno,
      geno  = dat$geno,
      pheno = dat$pheno,
      covar = NULL,
      weights = weights,
      is_pheno_binary = is_binary
    )
  }, error = function(e) {
    cat(sprintf("# ERROR in GCKD scenario %s: %s\n", scenario_name, conditionMessage(e)))
    NULL
  })

  cat(sprintf("# --- GCKD Scenario: %s ---\n", scenario_name))
  cat(sprintf("# Description: %s\n", description))
  cat(sprintf("# Seed=%d, n=%d, n_cases=%d (~%.1f%%), BMV=%d, DMV=%d, PTV=%d\n",
              seed, n, n_cases, 100 * n_cases / n, k_bmv, k_dmv, k_ptv))

  if (is.null(result)) {
    cat(sprintf('# "%s": 0.999,  # ERROR - replace with correct value\n\n', scenario_name))
    return(invisible(NULL))
  }

  # Extract omnibus p-value
  pvals <- tryCatch(result@Pvals, error = function(e) NULL)
  if (is.null(pvals)) pvals <- tryCatch(result$Pvals, error = function(e) NULL)

  omnibus_p <- NA_real_
  if (!is.null(pvals) && is.data.frame(pvals)) {
    omni_row <- pvals[pvals$test == "omni", , drop = FALSE]
    if (nrow(omni_row) > 0) omnibus_p <- as.numeric(omni_row$pval[1])
  } else if (!is.null(pvals)) {
    pvals_vec <- unlist(pvals, use.names = TRUE)
    if ("omni" %in% names(pvals_vec)) omnibus_p <- as.numeric(pvals_vec["omni"])
  }

  if (is.na(omnibus_p)) {
    cat(sprintf("# WARNING: could not extract omnibus p from COAST result\n"))
    cat(sprintf("# Result class: %s\n", class(result)))
    cat(sprintf('# "r_omnibus_p": 0.999,  # FILL IN MANUALLY\n\n'))
  } else {
    cat(sprintf('# "r_omnibus_p": %.15e,\n\n', omnibus_p))
  }

  # Also print all component p-values for diagnostics
  if (!is.null(pvals) && is.data.frame(pvals)) {
    cat("# All component p-values:\n")
    for (i in seq_len(nrow(pvals))) {
      cat(sprintf('#   %s: %.6e\n', pvals$test[i], as.numeric(pvals$pval[i])))
    }
    cat("\n")
  }

  invisible(result)
}

# =============================================================================
# GCKD Scenario G1: All 3 categories present (PKD1-like gene)
# PKD1 has ~645 variants in GCKD: mostly MODERATE (missense) BMV/DMV, some HIGH PTV
# Proportions: ~70% BMV, ~20% DMV, ~10% PTV (similar to PKD1 impact distribution)
# n_bmv=7, n_dmv=2, n_ptv=1 represents a small gene extract
# =============================================================================
cat("# GCKD Scenario G1: All 3 categories present (PKD1-like)\n")
run_gckd_scenario(
  scenario_name = "gckd_g1_all_categories",
  description   = "All 3 categories present: PKD1-like gene with BMV/DMV/PTV variants",
  seed = 1001, n = 200, n_cases = 9,
  k_bmv = 7, k_dmv = 2, k_ptv = 1,
  weights = c(1, 2, 3)
)

# =============================================================================
# GCKD Scenario G2: Partial categories - BMV and PTV only, no DMV
# Some smaller genes have no damaging missense (DMV category missing)
# Represents a 'partial' COAST run (should produce p-value, not skip)
# =============================================================================
cat("# GCKD Scenario G2: Partial categories (BMV + PTV only, DMV missing)\n")
run_gckd_scenario(
  scenario_name = "gckd_g2_partial_bmv_ptv",
  description   = "Partial categories: BMV and PTV present, DMV missing",
  seed = 1002, n = 200, n_cases = 9,
  k_bmv = 5, k_dmv = 0, k_ptv = 2,
  weights = c(1, 2, 3)
)

# =============================================================================
# GCKD Scenario G3: Single-variant gene
# Small gene in GCKD panel with only 1 classifiable variant
# Tests COAST edge case: 1 variant per test
# =============================================================================
cat("# GCKD Scenario G3: Single-variant gene\n")
run_gckd_scenario(
  scenario_name = "gckd_g3_single_variant",
  description   = "Single variant in PTV category only",
  seed = 1003, n = 200, n_cases = 9,
  k_bmv = 0, k_dmv = 0, k_ptv = 1,
  weights = c(1, 2, 3)
)

# =============================================================================
# GCKD Scenario G4: All variants in one category (BMV-only gene)
# COL4A5-like: all missense, classified as BMV (benign missense)
# Tests COAST with single-category input
# =============================================================================
cat("# GCKD Scenario G4: All variants in one category (BMV-only)\n")
run_gckd_scenario(
  scenario_name = "gckd_g4_all_bmv",
  description   = "All variants in BMV category (benign missense only gene)",
  seed = 1004, n = 200, n_cases = 9,
  k_bmv = 8, k_dmv = 0, k_ptv = 0,
  weights = c(1, 2, 3)
)

# =============================================================================
# GCKD Scenario G5: Tied scores across categories (equal MAF per category)
# Tests COAST behavior when variant characteristics are balanced across categories
# Equal MAF simulates tied SIFT/PolyPhen scores where BMV/DMV distinction is marginal
# =============================================================================
cat("# GCKD Scenario G5: Tied scores across categories (equal MAF)\n")
{
  set.seed(1005)
  n <- 200L; n_cases <- 9L
  # Equal MAF across all variants (tied classification boundary)
  equal_maf <- 0.010
  k_bmv <- 3; k_dmv <- 3; k_ptv <- 3; k <- k_bmv + k_dmv + k_ptv
  geno_g5 <- matrix(rbinom(n * k, 2, equal_maf), nrow = n, ncol = k)
  anno_g5 <- c(rep(1L, k_bmv), rep(2L, k_dmv), rep(3L, k_ptv))
  pheno_g5 <- rep(0L, n)
  pheno_g5[sample.int(n, n_cases)] <- 1L

  cat("# GCKD Scenario G5: Tied scores across categories (equal MAF = 0.010)\n")
  cat("# Description: Equal MAF for BMV/DMV/PTV simulates tied SIFT/PolyPhen boundary\n")
  cat(sprintf("# Seed=1005, n=%d, n_cases=%d, BMV=%d, DMV=%d, PTV=%d\n",
              n, n_cases, k_bmv, k_dmv, k_ptv))

  result_g5 <- tryCatch({
    COAST(anno = anno_g5, geno = geno_g5, pheno = pheno_g5, covar = NULL,
          weights = c(1, 2, 3), is_pheno_binary = TRUE)
  }, error = function(e) {
    cat(sprintf("# ERROR: %s\n", conditionMessage(e)))
    NULL
  })

  if (!is.null(result_g5)) {
    pvals_g5 <- tryCatch(result_g5@Pvals, error = function(e) NULL)
    if (is.null(pvals_g5)) pvals_g5 <- tryCatch(result_g5$Pvals, error = function(e) NULL)
    if (!is.null(pvals_g5) && is.data.frame(pvals_g5)) {
      omni_row <- pvals_g5[pvals_g5$test == "omni", , drop = FALSE]
      if (nrow(omni_row) > 0) {
        cat(sprintf('# "r_omnibus_p": %.15e,\n\n', as.numeric(omni_row$pval[1])))
        cat("# All component p-values:\n")
        for (i in seq_len(nrow(pvals_g5))) {
          cat(sprintf('#   %s: %.6e\n', pvals_g5$test[i], as.numeric(pvals_g5$pval[i])))
        }
        cat("\n")
      }
    }
  }
}

# =============================================================================
# Print Python dict literal for easy copy-paste into test file
# =============================================================================

cat("# =============================================================================\n")
cat("# GCKD Golden Values Summary\n")
cat("# Copy the r_omnibus_p values above into _GCKD_GOLDEN_SCENARIOS in:\n")
cat("#   tests/unit/test_coast_python_comparison.py\n")
cat("#   class TestCOASTGCKDGoldenComparison\n")
cat("#\n")
cat("# Replace placeholder values (0.999) with the values printed above.\n")
cat("# Run: pytest tests/unit/test_coast_python_comparison.py::TestCOASTGCKDGoldenComparison\n")
cat("# Expected: all 5 scenarios pass with abs(py_p - r_p) / r_p < 0.10\n")
cat("# =============================================================================\n")
