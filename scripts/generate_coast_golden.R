#!/usr/bin/env Rscript
# =============================================================================
# generate_coast_golden.R
# =============================================================================
# Generate golden reference p-values for COAST validation tests.
#
# Usage:
#   Rscript scripts/generate_coast_golden.R
#
# Requirements:
#   R (>= 4.1) with AllelicSeries package installed:
#     install.packages("AllelicSeries")
#     # or from Bioconductor/GitHub per AllelicSeries installation instructions
#
# Output:
#   Prints structured golden reference values to stdout.
#   Copy-paste the output into tests/unit/test_coast_python_comparison.py
#   as constants in the _R_GOLDEN_* dicts.
#
# Used by:
#   tests/unit/test_coast_python_comparison.py
#
# Note:
#   This script is NOT run in CI. It is for offline execution by developers
#   who have R + AllelicSeries installed. The output values are hardcoded
#   as constants in the Python comparison test.
#
# Version history:
#   2026-02-22  Initial version for Phase 24 validation (COAST-PY-01)
# =============================================================================

suppressPackageStartupMessages({
  if (!requireNamespace("AllelicSeries", quietly = TRUE)) {
    stop(paste0(
      "AllelicSeries R package not found.\n",
      "Install with: install.packages('AllelicSeries')\n",
      "or follow installation instructions at:\n",
      "  https://github.com/insitro/AllelicSeries"
    ))
  }
  library(AllelicSeries)
})

cat("# =============================================================================\n")
cat("# COAST Golden Reference Values\n")
cat("# Generated by: Rscript scripts/generate_coast_golden.R\n")
cat(sprintf("# AllelicSeries version: %s\n",
            as.character(packageVersion("AllelicSeries"))))
cat(sprintf("# R version: %s\n", R.version.string))
cat(sprintf("# Date: %s\n", format(Sys.time(), "%Y-%m-%d")))
cat("# =============================================================================\n\n")

# Helper: run one COAST scenario and print results
run_scenario <- function(
    scenario_name, seed, n, n_bmv, n_dmv, n_ptv,
    trait_type = "binary", signal = FALSE,
    weights = c(1, 2, 3)
) {
  k <- n_bmv + n_dmv + n_ptv

  set.seed(seed)

  # Genotype matrix: HWE-like distribution (ref=0.6, het=0.3, hom_alt=0.1)
  geno <- matrix(
    sample(0:2, n * k, replace = TRUE, prob = c(0.6, 0.3, 0.1)),
    nrow = n, ncol = k
  )

  # Annotation codes: 1=BMV, 2=DMV, 3=PTV
  anno <- c(rep(1L, n_bmv), rep(2L, n_dmv), rep(3L, n_ptv))

  # Phenotype generation
  if (trait_type == "binary") {
    pheno <- sample(0:1, n, replace = TRUE)
    if (signal) {
      # Enrich cases for alt alleles in PTV variants
      case_idx <- which(pheno == 1)
      ptv_cols <- (n_bmv + n_dmv + 1):k
      for (j in ptv_cols) {
        geno[case_idx, j] <- pmin(
          geno[case_idx, j] + rbinom(length(case_idx), 1, 0.5), 2
        )
      }
    }
  } else {
    pheno <- rnorm(n)
  }

  is_binary <- (trait_type == "binary")

  # Run COAST
  result <- tryCatch({
    COAST(
      anno  = anno,
      geno  = geno,
      pheno = pheno,
      covar = NULL,
      weights = weights,
      is_pheno_binary = is_binary
    )
  }, error = function(e) {
    cat(sprintf("ERROR in scenario %s: %s\n", scenario_name, conditionMessage(e)))
    NULL
  })

  if (is.null(result)) return(invisible(NULL))

  # Extract p-values from the result
  # AllelicSeries COAST() returns an object with a Pvals slot
  pvals <- tryCatch(result@Pvals, error = function(e) NULL)
  if (is.null(pvals)) {
    # Try alternative accessor patterns
    pvals <- tryCatch(result$Pvals, error = function(e) NULL)
  }

  cat(sprintf("# --- Scenario: %s ---\n", scenario_name))
  cat(sprintf("# Seed=%d, n=%d, n_bmv=%d, n_dmv=%d, n_ptv=%d, trait=%s, signal=%s\n",
              seed, n, n_bmv, n_dmv, n_ptv, trait_type, signal))
  cat(sprintf("# Weights: [%s]\n", paste(weights, collapse=", ")))

  if (!is.null(pvals) && is.data.frame(pvals)) {
    # COAST() returns a data.frame with columns: test, type, pval
    pval_names <- pvals$test
    pval_values <- pvals$pval
    cat(sprintf("_R_GOLDEN_%s = {\n", toupper(gsub("[^A-Za-z0-9]", "_", scenario_name))))
    for (i in seq_along(pval_values)) {
      cat(sprintf('    "%s": %.15e,\n', pval_names[i], as.numeric(pval_values[i])))
    }
    cat("}\n\n")
  } else if (!is.null(pvals)) {
    # Fallback for other return formats
    pval_names <- names(pvals)
    pvals <- unlist(pvals, use.names = FALSE)
    if (is.null(pval_names)) {
      pval_names <- paste0("component_", seq_along(pvals))
    }
    cat(sprintf("_R_GOLDEN_%s = {\n", toupper(gsub("[^A-Za-z0-9]", "_", scenario_name))))
    for (i in seq_along(pvals)) {
      cat(sprintf('    "%s": %.15e,\n', pval_names[i], as.numeric(pvals[i])))
    }
    cat("}\n\n")
  } else {
    cat(sprintf("# WARNING: Could not extract Pvals from COAST result for %s\n", scenario_name))
    cat(sprintf("# Result class: %s\n", class(result)))
    cat(sprintf("# Result names/slots: %s\n\n",
                paste(slotNames(result), collapse=", ")))
  }

  invisible(result)
}

# =============================================================================
# Scenario 1: Binary trait, null phenotype (no signal)
# seed=42, n=100, 3 BMV + 3 DMV + 3 PTV
# Expected: omnibus p should be moderate to large (no signal)
# =============================================================================
cat("# Scenario 1: Binary null (no signal)\n")
run_scenario(
  scenario_name = "scenario_1_binary_null",
  seed = 42, n = 100,
  n_bmv = 3, n_dmv = 3, n_ptv = 3,
  trait_type = "binary", signal = FALSE
)

# =============================================================================
# Scenario 2: Binary trait, with signal (cases enriched for alt PTV alleles)
# seed=123, n=100, 3 BMV + 3 DMV + 3 PTV
# Expected: omnibus p should be small (signal present)
# =============================================================================
cat("# Scenario 2: Binary with signal\n")
run_scenario(
  scenario_name = "scenario_2_binary_signal",
  seed = 123, n = 100,
  n_bmv = 3, n_dmv = 3, n_ptv = 3,
  trait_type = "binary", signal = TRUE
)

# =============================================================================
# Scenario 3: Quantitative trait, null phenotype
# seed=77, n=100, 3 BMV + 3 DMV + 3 PTV
# Expected: omnibus p should be moderate to large (no signal)
# =============================================================================
cat("# Scenario 3: Quantitative null\n")
run_scenario(
  scenario_name = "scenario_3_quantitative_null",
  seed = 77, n = 100,
  n_bmv = 3, n_dmv = 3, n_ptv = 3,
  trait_type = "quantitative", signal = FALSE
)

# =============================================================================
# Scenario 4: Unequal category sizes
# seed=200, n=100, 2 BMV + 4 DMV + 6 PTV
# Expected: valid omnibus p (tests robustness to unequal counts)
# =============================================================================
cat("# Scenario 4: Unequal category sizes\n")
run_scenario(
  scenario_name = "scenario_4_unequal_sizes",
  seed = 200, n = 100,
  n_bmv = 2, n_dmv = 4, n_ptv = 6,
  trait_type = "binary", signal = FALSE
)

# =============================================================================
# Scenario 5: Single variant per category (minimum viable COAST input)
# seed=300, n=100, 1 BMV + 1 DMV + 1 PTV
# Expected: valid omnibus p (edge case)
# =============================================================================
cat("# Scenario 5: Single variant per category\n")
run_scenario(
  scenario_name = "scenario_5_single_variant",
  seed = 300, n = 100,
  n_bmv = 1, n_dmv = 1, n_ptv = 1,
  trait_type = "binary", signal = FALSE
)

# =============================================================================
# Print raw data for Scenario 1 (for Python test reconstruction)
# =============================================================================
cat("# =============================================================================\n")
cat("# Raw data for Scenario 1 (seed=42, n=100, 3+3+3 variants)\n")
cat("# Used to verify Python data generation matches R data generation.\n")
cat("# =============================================================================\n")

set.seed(42)
n <- 100L
k <- 9L  # 3 BMV + 3 DMV + 3 PTV
geno_s1 <- matrix(
  sample(0:2, n * k, replace = TRUE, prob = c(0.6, 0.3, 0.1)),
  nrow = n, ncol = k
)
pheno_s1 <- sample(0:1, n, replace = TRUE)

# Print first 10 rows of genotype matrix for verification
cat("# First 5 rows of genotype matrix (verify Python rng matches R rng):\n")
cat("# NOTE: R uses base::sample() - Python uses numpy default_rng(seed)\n")
cat("# These will NOT match exactly. Comparison is via p-value ranges, not exact data.\n")
cat("# Genotype first row: [", paste(geno_s1[1,], collapse=", "), "]\n")
cat("# Phenotype first 10: [", paste(pheno_s1[1:10], collapse=", "), "]\n\n")

cat("# =============================================================================\n")
cat("# INSTRUCTIONS:\n")
cat("# 1. Copy the _R_GOLDEN_* dicts above into test_coast_python_comparison.py\n")
cat("# 2. Update the _R_GOLDEN_* constants in the test file\n")
cat("# 3. Re-run tests: pytest tests/unit/test_coast_python_comparison.py\n")
cat("# NOTE: R uses different RNG than Python numpy, so Python and R genotype\n")
cat("#       matrices will differ. Validation is via statistical behavior ranges.\n")
cat("# =============================================================================\n")
